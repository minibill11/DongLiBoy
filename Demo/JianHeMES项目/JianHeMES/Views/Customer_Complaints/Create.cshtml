@model JianHeMES.Models.Customer_Complaints

@{
    ViewBag.Title = "编辑客诉订单";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Scripts/Bootstraps/Element-ui.css" rel="stylesheet" />
<link href="~/Content/styleFile/packaging/index.css" rel="stylesheet" />
<link href="~/Content/styleFile/solder/solderStyle.css" rel="stylesheet" />
<script src="~/Content/styleFile/packaging/index.js"></script>
<script src="~/Scripts/axios.min.js"></script>
<script src="~/Scripts/Bootstraps/Element-ui.js"></script>
<script src="~/Content/styleFile/solder/solderJavascript.js"></script>

<style>
    .tableContainer {
        width: 75%;
        margin: 25px auto;
    }

    .el-input {
        width: auto !important;
    }

    table {
        width: 100%;
        font-size: 16px;
    }

    table {
        table-layout: fixed;
        width: 100%;
    }

    td {
        word-break: break-all;
        text-align: center;
    }

    textarea {
        max-height: 550px !important;
        max-width: 100% !important;
        border: none;
        padding: 2px;
    }

    input {
        border: none;
        padding: 2px;
    }
</style>


@RenderPage("~/Views/Users/_groupSelect.cshtml")
<div id="app">
    <h2 style="text-align:center;margin-top:15px;margin-bottom:5px;font-size:18px;">创建客诉订单</h2>
    <div style="margin:10px auto;text-align:center;">
        <group-select></group-select>
    </div>
    <div class="tableContainer">
        <div style="display:flex;justify-content:flex-end;">
            <span>客诉编号:</span>
            <span style="display:inline-block;width:200px;"><input v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.ComplaintNumber" /></span>
        </div>
        <table border="1">
            <tbody>
                @* 申 请 单 位 填 写 *@
                <tr style="height:40px">
                    <td rowspan="7">申 请 单 位 填 写</td>
                    <td>客户名称</td>
                    <td><input v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.CustomerName" /></td>
                    <td>订单号</td>
                    <td class="test">
                        @*<input v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.OrderNum" />*@
                        <el-select v-model="dataInfos.OrderNum"
                                   filterable
                                   allow-create
                                   clearable
                                   style="width:100%;height:100%;"
                                   placeholder="请选择订单号">
                            <el-option v-for="item in orderList"
                                       v-bind:key="item.value"
                                       v-bind:label="item.label"
                                       v-bind:value="item.value">
                            </el-option>
                        </el-select>
                    </td>
                    <td>模组数量/面积</td>
                    <td><input v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.ModuleNumber" /></td>
                </tr>
                <tr style="height:40px">
                    <td>所需区域</td>
                    <td><input v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.RequiredArea" /></td>
                    <td>产品型号</td>
                    <td><input v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.ProductModel" /></td>
                    <td>发货日期</td>
                    <td>
                        <el-date-picker v-model="dataInfos.DeliveryDate"
                                        type="date"
                                        v-bind:disabled="!alreadyDone"
                                        style="width:100%;height:100%;"
                                        placeholder="选择日期">
                        </el-date-picker>
                    </td>
                </tr>
                <tr style="height:40px">
                    <td>投诉日期</td>
                    <td>
                        <el-date-picker v-model="dataInfos.ComplaintsDate"
                                        type="date"
                                        v-bind:disabled="!alreadyDone"
                                        style="width:100%;height:100%;"
                                        placeholder="选择日期">
                        </el-date-picker>
                    </td>
                    <td>屏体面积</td>
                    <td><input v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.ScreenArea" /></td>
                    <td>控制系统及电源</td>
                    <td><input v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.Control" /></td>
                </tr>
                <tr style="height:40px">
                    <td>投诉内容</td>
                    <td colspan="5">
                        <textarea v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.Complaint_Content"></textarea>
                    </td>
                </tr>
                <tr style="height:150px">
                    <td>异常描述</td>
                    <td colspan="5">
                        <textarea v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.Abnormal_Describe"></textarea>
                    </td>
                </tr>
                <tr style="height:150px">
                    <td>投诉代码</td>
                    <td colspan="5" style="text-align:left;padding:25px;">
                        @*<span style="margin:8px;display:inline-block;" v-for="(item,index) in dataInfos.targetData">
                                <input v-bind:disabled="item.flag || !alreadyDone" v-on:change="checkboxChanged(item,index)" v-model="item.flag" type="checkbox" />
                                <span style="cursor:pointer;" v-on:click="uploadImg(item,index)">{{item.code}}<span v-show="item.flag">【<span style="color:red;">{{item.CodeNumber}}</span>】</span></span>
                            </span>
                            <span>
                                <el-button size="mini" @@click="showAddOtherCode = true">其它</el-button>
                            </span>*@
                        <el-button size="mini" @@click="checkboxChanged({flag:true},0)">填写投诉代码</el-button>
                    </td>
                </tr>
                <tr style="height:150px">
                    <td>异常图片</td>
                    <td colspan="5">
                        <el-carousel v-show="showJPG" height="150px" style="width:60%;margin:0 auto;" trigger="click" v-bind:interval="4000">
                            <el-carousel-item v-for="(item,index) in dataInfos.Picture_jpg" key="item">
                                <img style="width:100%;height:78%;" v-on:click="showBigImg(item,index,'JPG')" v-bind:src="item" />
                                <span style="z-index:99">{{getCustomerCode(item,'JPG')}}</span>
                            </el-carousel-item>
                        </el-carousel>
                        <el-carousel v-show="showPDF" height="150px" style="width:60%;margin:0 auto;" trigger="click" v-bind:interval="4000">
                            <el-carousel-item v-for="(item,index) in dataInfos.Picture_pdf" key="item">
                                <img style="width:100%;height:78%;" v-on:click="showBigImg(item,index,'PDF')" v-bind:src="item" />
                                <span style="z-index:99">{{getCustomerCode(item,'PDF')}}</span>
                            </el-carousel-item>
                        </el-carousel>
                    </td>
                </tr>

                @* 接单部门填写 *@
                <tr style="height:50px">
                    <td rowspan="7">接单部门填写</td>
                    <td>原因分析</td>
                    <td colspan="5"><textarea v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.Cause_Analysis"></textarea></td>
                </tr>
                <tr style="height:50px">
                    <td>临时处理措施</td>
                    <td colspan="5"><textarea v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.Interim_Disposal"></textarea></td>
                </tr>
                <tr style="height:50px">
                    <td>长期处理措施</td>
                    <td colspan="5"><textarea v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.Longterm_Treatment"></textarea></td>
                </tr>
                <tr style="height:50px">
                    <td>责任归属</td>
                    <td colspan="5"><textarea v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.Liability"></textarea></td>
                </tr>
                <tr style="height:50px">
                    <td>最终处理结果</td>
                    <td colspan="5"><textarea v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.Final_Result"></textarea></td>
                </tr>
                <tr style="height:50px">
                    <td>备注</td>
                    <td colspan="5"><textarea v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.Remark"></textarea></td>
                </tr>
                <tr style="height:50px">
                    <td>结案日期</td>
                    <td colspan="5">
                        <el-date-picker v-model="dataInfos.SettlementDate"
                                        type="date"
                                        v-bind:disabled="!alreadyDone"
                                        style="width:100%;height:100%;"
                                        placeholder="选择日期">
                        </el-date-picker>
                    </td>
                </tr>
                @* 处理意见会签栏 *@
                <tr style="height:70px">
                    <td rowspan="7">处理意见会签栏</td>
                    <td>责任部门</td>
                    <td colspan="5"><textarea v-bind:disabled="!alreadyDone" style="width:100%;height:100%;" v-model="dataInfos.ResponDepartment"></textarea></td>
                </tr>
                <tr style="height:70px">
                    <td>国内/外工程部</td>
                    <td colspan="5"><textarea style="width:100%;height:100%;" v-model="dataInfos.EngineDepartment"></textarea></td>
                </tr>
                <tr style="height:70px">
                    <td>品质部</td>
                    <td colspan="5"><textarea style="width:100%;height:100%;" v-model="dataInfos.QualityDepartment"></textarea></td>
                </tr>
                <tr style="height:70px">
                    <td>品技中心</td>
                    <td colspan="5"><textarea style="width:100%;height:100%;" v-model="dataInfos.Quality_TechDepartment"></textarea></td>
                </tr>
                <tr style="height:70px">
                    <td>运营副总</td>
                    <td colspan="5"><textarea style="width:100%;height:100%;" v-model="dataInfos.Operation"></textarea></td>
                </tr>
                <tr style="height:70px">
                    <td>副总经理</td>
                    <td colspan="5"><textarea style="width:100%;height:100%;" v-model="dataInfos.VicePresident"></textarea></td>
                </tr>
                <tr style="height:70px">
                    <td>总经理</td>
                    <td colspan="5"><textarea style="width:100%;height:100%;" v-model="dataInfos.General_Manager"></textarea></td>
                </tr>
            </tbody>
        </table>

        <div style="display:flex;justify-content:space-between;margin-top:8px;">
            <div style="margin-left:10px;font-size:11px;">（申请条件说明：当生产交付产品出现重大品质问题解决后存在隐患退货或无法改善使用时）</div>
            <div style="font-size:12px;">表单编号：QD-039-E</div>
        </div>
        <div>
            <el-button style="float:right;" size="mini" type="success" @@click="saveData">保存</el-button>
        </div>

        @* 添加错误代码弹框 *@
        <el-dialog title="添加客诉代码"
                   v-bind:visible.sync="showAddCode"
                   width="30%"
                   v-bind:before-close="handleClose">
            <div>
                <span>投诉代码：</span>
                <span>{{selectCode.code}}</span>
            </div>
            <div>
                <span>代码数量：</span>
                <span>
                    <input style="border:1px solid #ccc;" type="text" v-model="selectCode.CodeNumber" />
                </span>
            </div>
            <div>
                <span>tips：多选请按CTRL键</span>
                <form action="/Customer_Complaints/UploadFile_Abnormal" method="post">
                    <input type="file" id="files" multiple="multiple" name="pictureFile" />
                    <input style="display:none;" name="orderNum" v-model="dataInfos.OrderNum" />
                    <input style="display:none;" name="complaintsDate" v-model="dataInfos.ComplaintsDate" />
                    <input style="display:none;" name="complaintscode" v-model="uploadCode.code" />
                    <input style="display:none;" type="submit" value="submit" class="upload" />
                </form>
            </div>
            <span slot="footer" class="dialog-footer">
                <el-button @@click="cancelAdd">取 消</el-button>
                <el-button type="primary" @@click="comfirmAddCode">确 定</el-button>
            </span>
        </el-dialog>

        @* 上传图片弹框 *@
        <el-dialog title="上传图片"
                   v-bind:visible.sync="showUpLoad"
                   width="30%"
                   v-bind:before-close="handleClose">
            <div>
                <span>tips：多选请按CTRL键</span>
                <form action="/Customer_Complaints/UploadFile_Abnormal" method="post">
                    <input type="file" id="files" multiple="multiple" name="pictureFile" />
                    <input style="display:none;" name="orderNum" v-model="dataInfos.OrderNum" />
                    <input style="display:none;" name="complaintsDate" v-model="dataInfos.ComplaintsDate" />
                    <input style="display:none;" name="complaintscode" v-model="uploadCode.code" />
                    <input style="display:none;" type="submit" value="submit" class="upload" />
                </form>
            </div>
            <span slot="footer" class="dialog-footer">
                <el-button @@click="cancelUpLoad">取 消</el-button>
                <el-button type="primary" @@click="comfirmUpLoad">确 定</el-button>
            </span>
        </el-dialog>

        @* 查看大图弹框 *@
        <el-dialog title="大图预览"
                   v-bind:visible.sync="showBigImaDialog"
                   width="80%"
                   center>
            <el-carousel trigger="click" v-bind:interval="8000">
                <el-carousel-item v-for="(item,index) in fullPath" key="item">
                    <img style="width:100%;height:78%;" v-bind:src="item" />
                    <span style="z-index:99;display:inline-block;width:100%;text-align:center;">{{getCustomerCode(item)}}</span>
                </el-carousel-item>
            </el-carousel>
        </el-dialog>

        @* 其它错误代码弹框 *@
        <el-dialog title="其它错误代码"
                   v-bind:visible.sync="showAddOtherCode"
                   width="30%"
                   v-bind:before-close="handleClose">
            <div>
                <span>投诉代码：</span>
                <span>
                    <input style="border:1px solid #ccc;" type="text" v-model="otherCode" />
                </span>
            </div>
            <div style="margin-top:15px;">
                <span>代码数量：</span>
                <span>
                    <input style="border:1px solid #ccc;" type="text" v-model="otherCodeNums" />
                </span>
            </div>
            <span slot="footer" class="dialog-footer">
                <el-button @@click="showAddOtherCode = false;otherCode='';otherCodeNums=''">取 消</el-button>
                <el-button type="primary" @@click="comfirmAddOtherCode">确 定</el-button>
            </span>
        </el-dialog>
    </div>
</div>

<script>
    const app = new Vue({
        el: "#app",
        data: {
            dataInfos: {},
            alreadyDone: true,
            showAddCode: false,
            showUpLoad: false,
            selectCode: {},
            uploadCode: {},
            uploadFile: null,
            showJPG: false,
            showPDF: false,
            fullPath: "",
            showBigImaDialog: false,
            showAddOtherCode: false,

            otherCode: "",
            otherCodeNums: "",
            orderList: []
        },
        created() {
            this.dataInfos.targetData = [];
            let targetDatas = []
            for (let i = 1; i < 33; i++) {
                let els = i.toString().length > 1 ? `0${i}` : `00${i}`;
                let obj = { CodeNumber: '', flag: false, code: els }
                targetDatas.push(obj);
            }
            this.dataInfos.targetData = targetDatas;
            this.getOrderList();
        },
        mounted() {
            // 获取地址栏id
            //let id = getQueryVariable("id");
            //this.getData(id)
            //console.log(this.dataInfos.targetData);
        },
        methods: {
            // 获取数据
            getData(id) {
                axios.post("/Customer_Complaints/QueryCustomer", { id: id }).then(res => {
                    console.log(res.data);
                    this.dataInfos = res.data[0];
                    if (this.dataInfos.Picture_jpg) {
                        if (this.dataInfos.Picture_jpg.length > 0) {
                            this.showJPG = true;
                        }
                    }
                    if (this.dataInfos.Picture_pdf) {
                        if (this.dataInfos.Picture_pdf.length > 0) {
                            this.showPDF = true;
                        }
                    }
                    if (this.dataInfos.ResponDepartment == '' || this.dataInfos.ResponDepartment == null) {
                        this.alreadyDone = true;
                    }
                    let targetData = []
                    for (let i = 1; i < 33; i++) {
                        let els = i.toString().length > 1 ? `0${i}` : `00${i}`;
                        let obj = { CodeNumber: '', flag: false, code: els }
                        targetData.push(obj);
                    }
                    targetData.forEach(item => {
                        if (res.data[0].Table.length > 0) {
                            res.data[0].Table.forEach(itemIn => {
                                if (itemIn.Complaintscode == item.code) {
                                    item.CodeNumber = itemIn.CodeNumber;
                                    item.flag = true;
                                }
                            });
                        } else {
                            //alert("sss")
                        }

                    });
                    this.dataInfos.targetData = targetData;
                }).catch(err => {
                    this.$message({
                        message: "网络错误",
                        type: "warning"
                    });
                })
            },
            // 保存
            saveData() {
                if (true) {
                    axios.post("/Customer_Complaints/ModifyProcessing", { complaints: this.dataInfos }).then(res => {
                        console.log(res.data)
                        if (res.data.repairbill == true) {
                            this.$message({
                                message: "操作成功!",
                                type: "success"
                            });
                            window.location.href = `/Customer_Complaints/Details/?id=${getQueryVariable("id")}`
                        } else {
                            this.$message({
                                message: "修改失败!",
                                type: "warning"
                            });
                        }
                    }).catch(err => {
                        this.$message({
                            message: "网络错误",
                            type: "warning"
                        });
                    })
                } else {
                    this.$message({
                        message: "责任部门已签字，不能再修改!",
                        type: "warning"
                    });
                }
            },
            // checkbox 改变
            checkboxChanged(item, index) {
                //console.log(item)
                //console.log(index)
                if (item.flag == true) {
                    console.log($("#banzuGroup").val())
                    if ($("#banzuGroup").val() == "") {
                        this.$message.warning("请选择班组");
                        this.loading = false;
                        return;
                    };
                    if ($("#banzuGroup").val() != "") {
                        this.dataInfos.Group = $("#banzuGroup").val();
                        this.dataInfos.Department = $("#banzuDepartment").val();
                        this.saveCreate(this.dataInfos);
                    }
                }
            },
            // 确认添加代码
            comfirmAddCode() {

            },
            // 取消保存
            cancelAdd() {
                this.dataInfos.targetData.forEach(item => {
                    if (item.code == this.selectCode.code) {
                        item.flag = false;
                        item.CodeNumber = null;
                        this.showAddCode = false;
                        return false;
                    }
                });

            },
            // 点击投诉代码显示上传图片框
            uploadImg(item, index) {
                console.log(item)
                console.log(index)

                if (item.flag == false) {
                    this.$message({
                        message: "未勾选客诉代码不能上传图片",
                        type: "warning"
                    });
                } else {
                    this.uploadCode = item;
                    this.showUpLoad = true
                }
            },
            // 取消上传
            cancelUpLoad() {
                this.showUpLoad = false;
                this.uploadCode = {};
                this.uploadFile = null;
            },
            comfirmUpLoad() {
                this.showUpLoad = false
                //$(".files")[0].files

                let images = $("#files")[0].files;
                let arr = [];
                for (item in images) {
                    arr.push(images[item])
                }
                arr.pop();
                arr.pop();
                let form = new FormData()
                const config = {
                    headers: { "Content-Type": "multipart/form-data" }
                };
                form.append('complaintscode', this.uploadCode.code);
                form.append('complaintsDate', this.dataInfos.ComplaintsDate);
                form.append('orderNum', this.dataInfos.OrderNum);
                for (let i = 0; i < arr.length; i++) {
                    form.append('UploadFile_Abnormal' + i, arr[i]);
                    form.append('pictureFile', arr[i].name);
                }
                axios.post("/Customer_Complaints/UploadFile_Abnormal", form, config).then(res => {
                    console.log(res.data)
                    if (res.data == 'True') {
                        this.$message({
                            message: "上传成功！",
                            type: "success"
                        });
                        window.location.reload();
                    } else {
                        this.$message({
                            message: "上传图片失败",
                            type: "warning"
                        });
                    }
                }).catch(err => {
                    this.$message({
                        message: "网络错误",
                        type: "warning"
                    });
                });
            },
            handleClose(done) {
                this.$confirm('确认关闭？')
                    .then(_ => {
                        this.cancelAdd();
                        done();
                    })
                    .catch(_ => { });
            },
            // 截取文件名中的客诉代码
            getCustomerCode(val, types) {
                if (val.length > 0) {
                    let str = val.split('/');
                    let str2 = str.pop().split('.')
                    console.log(str2[0])
                    if (types == 'JPG') {
                        return `客诉编码(JPG)：${str2[0]}`
                    } else if (types == 'PDF') {
                        return `客诉编码(PDF)：${str2[0]}`
                    }
                    return `客诉编码：${str2[0]}`
                } else {
                    return ''
                }
            },
            // 查看大图
            showBigImg(item, index, types) {
                if (types == 'JPG') {
                    this.fullPath = this.dataInfos.Picture_jpg;
                } else {
                    this.fullPath = this.dataInfos.Picture_pdf;
                };
                this.showBigImaDialog = true;
            },
            // 确定添加其它错误代码
            comfirmAddOtherCode() {
                if (this.otherCode != '' && this.otherCodeNums != "") {
                    let arr = [];
                    let dats = {}
                    dats.Complaintscode = this.otherCode
                    dats.OutsideKey = this.dataInfos.Id
                    dats.Id = this.dataInfos.Id
                    dats.CodeNumber = this.otherCodeNums
                    arr.push(dats);
                    axios.post("/Customer_Complaints/EditComplaintcode", {
                        customer: arr, id: this.dataInfos.Id,
                        responDepartment: this.dataInfos.ResponDepartment
                    }).then(res => {
                        if (res.data.mes == true) {
                            this.showAddCode = false;
                            this.$message({
                                message: "添加成功",
                                type: "success"
                            });
                            let obj = { CodeNumber: this.otherCodeNums, flag: true, code: this.otherCode };
                            this.dataInfos.targetData.push(obj);
                        } else {
                            this.$message({
                                message: "操作失败",
                                type: "warning"
                            });
                        }
                    }).catch(err => {
                        this.$notify({
                            message: "网络错误!",
                            type: "warning"
                        })
                    })
                } else {
                    this.$notify({
                        message: "请补全数据!",
                        type: "warning"
                    })
                }
            },


            // 创建保存主表的数据
            saveCreate(data) {
                axios.post("/Customer_Complaints/ADDCoustomer", { customer_Complaints: data }).then(res => {

                    //console.log(obj.Id);
                    if (res.data.Meg == true) {
                        let obj = JSON.parse(res.data.Customer)
                        window.location.href = '/Customer_Complaints/Edit/?id=' + obj.Id;
                    } else {
                        this.$message({
                            message: "未填写完整基本信息!",
                            type: "warning"
                        })
                    }
                }).catch(err => {
                    this.$message({
                        message: "网络错误！",
                        type: "warning"
                    })
                })
            },
            // 获取订单号
            getOrderList() {
                axios.post("/Customer_Complaints/GetOrderNumList").then(res => {
                    console.log(res.data)
                    if (res.data.length > 0) {
                        res.data.forEach(item => {
                            let obj = { label: item, value: item };
                            this.orderList.push(obj);
                        })
                    }
                })
            }
        }
    });
    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) { return pair[1]; }
        }
        return (false);
    }

</script>


<div>
    @Html.ActionLink("返回", "Index")
</div>

