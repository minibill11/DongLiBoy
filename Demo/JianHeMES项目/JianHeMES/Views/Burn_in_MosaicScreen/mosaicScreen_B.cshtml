@model JianHeMES.Models.Burn_in_MosaicScreen
@{
    ViewBag.Title = "老化拼屏";
}
<link href="~/Scripts/Bootstraps/bootstrap-select.css" rel="stylesheet" />
<script src="~/Scripts/Bootstraps/bootstrap-select.js"></script>
<h2 class="hidden-xs">@ViewBag.Title</h2>
<h5 class="visible-xs text-center">开始老化拼屏</h5>
<style>
    .color-show {
        display: flex;
        flex-wrap: wrap;
    }

    .color-box {
        width: 50%;
        text-align: center;
        transition: transform .3s;
        padding: 6px 4px;
    }

    .green {
        color: green;
    }

    .red {
        color: red;
    }

    .selectpicker {
        border: 1px solid #ccc;
    }

    .bootstrap-select:not([class*="col-"]):not([class*="form-control"]):not(.input-group-btn) {
        max-width: 280px;
    }

    .form-control {
        max-width: 280px;
    }


    .table > tbody > tr > td, .table > tbody > tr > th {
        padding: 1px;
        text-align: center;
        vertical-align: middle;
        font-size: 13px;
        height: 24px;
    }

    .table-bordered > tbody > tr > th, .table-bordered > tbody > tr > td {
        border: 1px solid #555;
    }

    .green {
        color: green;
    }

    .red {
        color: red;
    }

    .borderFlicker {
        animation: myanimate 1s;
    }

    @@keyframes myanimate {
        0% {
            border-color: #ccc;
        }

        25% {
            border-color: red;
        }

        50% {
            border-color: #ccc;
        }

        75% {
            border-color: red;
        }

        100% {
            border-color: #ccc;
        }
    }

    @@media screen and (max-width:768px) {
        .form-group, .control-label {
            margin-bottom: 0px;
        }

        h5 {
            margin-top: 5px;
            margin-bottom: 0px;
        }

        hr {
            margin: 10px 0px 0px;
        }

        .xsnum, .table {
            margin-bottom: 5px;
        }

        .color-box {
            padding: 4px 0 !important;
            height: 25px;
        }
    }
</style>
@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()
    <div id="app" class="form-horizontal">
        <h4 class="hidden-xs">开始老化拼屏工作</h4>
        <hr class="hidden-xs" />
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        <div class="form-group">
            <div class="col-md-6">
                @Html.LabelFor(model => model.OrderNum, htmlAttributes: new { @class = "control-label col-md-4" })
                <div class="col-md-8">
                    @Html.DropDownListFor(model => model.OrderNum,
 ViewBag.OrderList as IEnumerable<SelectListItem>, new { @class = "selectpicker form-control", data_live_search = "true", data_style = "form-control" })
                    @*@Html.EditorFor(model => model.OrderNum, new { htmlAttributes = new { @class = "form-control" } })*@
                    @Html.ValidationMessageFor(model => model.OrderNum, "", new { @class = "text-danger" })
                </div>
                <br /><br />
                @Html.LabelFor(model => model.BurnInShelfNum, htmlAttributes: new { @class = "control-label col-md-4" })
                <div class="col-md-8">
                    @*@Html.EditorFor(model => model.BurnInShelfNum, new { htmlAttributes = new { @class = "form-control", maxlength = "4", onkeyup = "this.value=this.value.toUpperCase().replace(/[^0-9]/g,'')" } })*@
                    <input data-val="true" data-val-length="字段 老化架号 必须是最大长度为 20 的字符串。" data-val-length-max="20" id="BurnInShelfNum" maxlength="4" name="BurnInShelfNum" onkeyup="this.value=this.value.toUpperCase().replace(/[^0-9]/g,'')" type="text" v-model="shelfVal" class="form-control text-box single-line">
                    @Html.ValidationMessageFor(model => model.BurnInShelfNum, "", new { @class = "text-danger" })
                    <span style="font-size:11px;color:#888;font-weight:300;white-space:nowrap;">
                        注：装配一部1号老化架架号为:1001<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        装配二部3号老化架架号为:2003
                    </span>
                </div>
            </div>
            <div class="col-md-6"></div>
        </div>

        <div class="form-group">
            <div class="col-md-6">
                <label class="control-label col-md-4" for="content">输入模块条码</label>
                <div class="col-md-8">
                    <input type="text" class="form-control" placeholder="请输入模块条码" v-model.trim="newTask" maxlength="15" id="content" onKeyUp="value = value.replace(/[^A-Za-z0-9]/g, '')" style="display:inline;text-transform:uppercase" autocomplete="off">
                    <button id="addclick" class="btn btn-default" v-on:click="addTask">添加</button>
                    <br class="hidden-xs" /><span v-show="prompt" style="color: red;">不能输入相同条码</span>
                </div>
                <div class="form-group"><div class="col-md-12"></div></div>
                <div class="col-md-8 col-md-offset-4">
                    <button class="btn btn-default" style="color:dodgerblue" v-on:click="inspect">检查条码</button>
                    @*<input type="submit" value="开始老化" class="btn btn-default" v-on:click="clearTask" />*@
                    <input type="button" value="开始老化" class="btn btn-default" v-on:click="submitANDclearTask" v-show="beginShow" />
                </div>
                <div class="form-group"><div class="col-md-12"></div></div>
                <hr />
                <label class="control-label col-md-4 hidden-xs">模块条码清单:</label>
                <label class="control-label text-center visible-xs">模块条码清单</label>
                <div class="col-md-8 hidden-xs" style="height:450px;overflow:auto">
                    <div class="form-group color-show">
                        <template v-for="(task,index) in tasks">
                            <li v-if="tasks.length>0" readonly="readonly" class="color-box form-control">
                                <span>{{task}}</span>
                                <button type="button" v-on:click="removeTask(task)" title="移除条码" style="border: none; float: right;">✗</button>
                            </li>
                        </template>
                    </div>
                </div>
                <div class="col-md-8 visible-xs xsnum">
                    <div class="form-group color-show">
                        <template v-for="(task,index) in tasks">
                            <li v-if="tasks.length>0" readonly="readonly" class="color-box form-control" style="font-size:12px; padding:7px 5px">
                                <span>{{task}}</span>
                                <button type="button" v-on:click="removeTask(task)" title="移除条码" style="border: none; float: right;padding:0;width:20px;">✗</button>
                            </li>
                        </template>
                    </div>
                </div>
            </div>

            <div class="col-md-6" style="overflow:auto;">
                <div class="col-md-6" style="overflow:auto;" v-if="shelfVal.length==4">
                    <table class="table table-bordered">
                        <colgroup>
                            <col width="180" />
                            <col width="180" />
                        </colgroup>
                        <tr>
                            <th colspan="2">老化架号"{{shelfVal}}" 已拼屏条码</th>
                        </tr>
                        <tr>
                            <th>老化状态</th>
                            <th>条码号</th>
                        </tr>

                        <template v-for="item in pinpinglist">
                            <tr v-for="(v,i) in item.barcode">
                                <td v-if="i==0" v-bind:rowspan="item.barcode.length">{{item.state}}</td>
                                <td><span>{{v}}</span></td>
                            </tr>
                        </template>
                    </table>
                </div>
                <div class="col-md-6" style="overflow:auto;" v-if="commonalitylist!=''">
                    <table class="table table-bordered">
                        <colgroup>
                            <col width="180" />
                            <col width="180" />
                        </colgroup>
                        <tr>
                            <th>条码号</th>
                            <th>条码状态</th>
                        </tr>
                        <tr v-for="item in commonalitylist">
                            <td>{{item.order}}</td>
                            <td><span v-bind:class="item.state=='正常'?trueclass:falseclass">{{item.state}}</span></td>
                        </tr>
                    </table>
                </div>

            </div>
        </div>
        @*<span class="glyphicon glyphicon-ok green"></span>
            <span class="glyphicon glyphicon-remove red"></span>
            <span class="badge pull-right">✓</span>
            <span class="badge pull-right">✗</span>*@
        <div class="col-md-4" style="display:none">
            <textarea autofocus="autofocus" cols="5" id="BarCodesNum" name="BarCodesNum" rows="15" class="form-control" v-model="tasks"></textarea>
            @Html.ValidationMessageFor(model => model.BarCodesNum, "", new { @class = "text-danger" })
        </div>
        <div class="form-group"><div class="col-md-12"></div></div>
    </div>
}
<div>
    @Html.ActionLink("返回", "Index")
</div>

<script type="text/javascript">
    var app = new Vue({ //创建Vue对象实例
        el: "#app", //挂载DOM元素的ID
        data: {
            tasks: [],
            newTask: "", //input默认值
            same: true,
            prompt: false,
            beginShow: false,
            okList: [],
            commonalitylist: [],
            trueclass: {
                'glyphicon': true,
                'glyphicon-ok': true,
                'green': true
            },
            falseclass: {
                'glyphicon': true,
                'glyphicon-remove': true,
                'red': true
            },
            shelfVal: "",
            pinpinglist: []
        },
        methods: {
            addTask: function (event) {
                event.preventDefault();
                this.beginShow = false;
                this.prompt = false;
                sames = app.same;
                if (app.newTask != "") {
                    app.newTask = app.newTask.toUpperCase();
                    app.newTask = app.newTask.substr(0, 15);
                    app.newTask = app.newTask.replace(/[^A-Za-z0-9]/g, '');
                    app.tasks.forEach(function (item, index) {
                        if (app.newTask == item) {
                            console.log(index);
                            sames = false;
                            app.prompt = true;
                            app.newTask = "";
                        }
                    });
                    if (sames) { //没有相同数据才允许添加
                        app.tasks.push(app.newTask);
                        app.newTask = "";
                        $("#content").focus();
                        console.log(app.tasks); //数组
                    }
                }
            },
            removeTask: function (task) { //删除条码，重新排序数组，焦点回到input，保存删除后的数据
                this.beginShow = false;
                this.prompt = false;
                //指向Vue实例中的tasks
                removetasks = this.tasks;
                //remove
                removetasks.forEach(function (item, index) {
                    if (item == task) {
                        removetasks.splice(index, 1);
                    }
                });
                console.log(app.tasks); //数组
                $("#content").focus();
            },
            submitANDclearTask: function (event) { //提交post内容，清空本地存储表单
                event.preventDefault();
                $.ajax({
                    type: 'post',
                    url: '/Burn_in_MosaicScreen/mosaicScreen_Begin',
                    data: {
                        OrderNum: $("#OrderNum").val(),
                        BurnInShelfNum: $("#BurnInShelfNum").val(),
                        BarCodesNumList: app.tasks
                    },
                    success: function (data) {
                        //console.log(data);
                        app.beginShow = false;
                        app.tasks = [];
                        app.okList = [];
                        alert(data);
                        location.reload();
                        $("#BurnInShelfNum").focus();
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        alert("老化拼屏失败");
                        $("#content").focus();
                    }
                });
            },
            inspect: function (event) {
                event.preventDefault();
                this.beginShow = false;
                this.prompt = false;
                this.commonalitylist = [];
                //var cut = this.NumList.substr(0, this.NumList.length - 1).split("\n");
                //console.log(JSON.stringify(app.tasks));
                if (app.tasks != '') {
                    $.ajax({
                        type: 'post',
                        url: '/Burn_in_MosaicScreen/CheckFQC',
                        data: {
                            ordernum: $("#OrderNum").val(),
                            barcodeList: app.tasks
                        },
                        success: function (data) {
                            //console.log(data);
                            let returnData = JSON.parse(data);
                            app.okList = [];
                            for (let item in returnData) {
                                if (returnData[item] == "正常") {
                                    app.okList.push(item);
                                };
                                app.commonalitylist.push({
                                    order: item,
                                    state: returnData[item],
                                });
                            };

                            if (app.commonalitylist.length == app.okList.length) {
                                let shelfNum = $("#BurnInShelfNum");
                                if (shelfNum.val() != "" && shelfNum.val().length == 4) {
                                    app.beginShow = true;
                                } else {
                                    shelfNum.addClass("borderFlicker");
                                    setTimeout(() => shelfNum.removeClass("borderFlicker"), 1000);
                                }
                            };
                            $("#content").focus();
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            alert("请输入条码");
                            $("#content").focus();
                        }
                    });
                } else { $("#content").focus(); };
            }
        },
        watch: {
            newTask: function (val) {
                if (val.length >= 15) {
                    val.substr(0, 15);
                    val.replace(/[^A-Za-z0-9]/g, '');
                    $("#addclick").click();
                };
            },
            shelfVal: function (val) {
                if (val.length == 4) {
                    $.ajax({
                        type: 'post',
                        url: '/Burn_in_MosaicScreen/disPlayMosaicScreenList',
                        data: {
                            BurnInShelfNum: val
                        },
                        success: function (data) {
                            let returnData = JSON.parse(data);
                            //console.log(data);
                            let list = [];
                            for (let i in returnData) {
                                if (i == "startburn_in") {
                                    list.push({
                                        state: "已开始老化",
                                        barcode: returnData[i],
                                    });
                                } else if (i == "notstartburn_in") {
                                    list.push({
                                        state: "未开始老化",
                                        barcode: returnData[i],
                                    });
                                };
                            };
                            app.pinpinglist = list;
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                        }
                    });
                } else {
                    this.pinpinglist = [];
                };
            }
        }
    });
</script>
<script>
    var localOrder = localStorage.getItem('Order');
    if (localOrder != null) {
        $("#OrderNum").val(localOrder);
    }
    $("#OrderNum").change(function (val) {
        localStorage.setItem('Order', val.target.value);
        $("#BurnInShelfNum").select();
    })
    $("#BurnInShelfNum").focus();
    $("#BurnInShelfNum").keypress(function (e) {
        if (e.which == 13) {// 判断所按是否回车键
            if ($("#BurnInShelfNum").val() != '') {
                $("#content").select();
                return false;// 取消默认的提交行为
            } else {
                return false;
            }
        };
    });

    $(function () {
        $('.selectpicker').selectpicker();
    });
</script>

