@{
    ViewBag.Title = "仓库入库信息";
}
<link href="~/Content/styleFile/packaging/index.css" rel="stylesheet" />
<script src="~/Content/styleFile/packaging/index.js"></script>
<style>
    .body-content, .container {
        padding-left: 0px;
        padding-right: 0px;
    }

    .el-header {
        height: auto !important;
        padding: 0;
    }

    [v-cloak] {
        display: none;
    }

    .el-input, .el-textarea {
        width: 220px;
    }

    .inputtext {
        font-weight: 600;
        font-size: 15px;
    }

    .inputframe {
        width: 320px;
        text-align: right;
        margin: 1px auto;
    }
</style>
<div id="app" v-cloak>
    <el-container>
        <el-header class="text-center">
            <div v-show="screenSize>=768">
                <h2 class="text-center">@ViewBag.Title</h2>
                <a href="/Warehouse_Material/MaterialBasicInfo"><el-button size="small">仓库入库信息</el-button></a>
                <a href="/Warehouse_Material/QueryData"><el-button size="small">物料看板</el-button></a>
                <a href="/Warehouse_Material/MaterialInput"><el-button size="small">入库</el-button></a>
                <a href="/Warehouse_Material/Index"><el-button size="small">物料查询</el-button></a>
            </div>
            <div v-show="screenSize<768">
                <h3>@ViewBag.Title</h3>
                <el-dropdown placement="bottom">
                    <el-button size="medium ">
                        更多菜单<i class="el-icon-arrow-down el-icon--right"></i>
                    </el-button>
                    <el-dropdown-menu slot="dropdown">
                        <a href="/Warehouse_Material/mcBoard"><el-dropdown-item>仓库入库信息</el-dropdown-item></a>
                        <a href="/Warehouse_Material/QueryData"><el-dropdown-item>物料看板</el-dropdown-item></a>
                        <a href="/Warehouse_Material/MaterialInput"><el-dropdown-item>入库</el-dropdown-item></a>
                        <a href="/Warehouse_Material/Index"><el-dropdown-item>物料查询</el-dropdown-item></a>
                    </el-dropdown-menu>
                </el-dropdown>
            </div>
        </el-header>
        <el-main v-loading="loading">
            <el-row>
                <div class="inputframe">
                    <span class="inputtext">班组</span>
                    <el-select v-model="Material.Group"
                               placeholder="请选择班组"
                               size="medium">
                        <el-option v-for="item in groupOptions"
                                   :key="item"
                                   :label="item"
                                   :value="item">
                        </el-option>
                    </el-select>
                </div>
                <div class="inputframe">
                    <span class="inputtext">物料编号</span>
                    <el-input placeholder="请输入物料编号"
                              v-model.trim="Material.MaterialNumber"
                              size="medium"
                              autofocus
                              clearable>
                    </el-input>
                </div>
                <div class="inputframe">
                    <span class="inputtext">物料类型</span>
                    <el-input placeholder="请输入物料类型"
                              v-model.trim="Material.MaterialType"
                              size="medium"
                              clearable>
                    </el-input>
                </div>
                <div class="inputframe">
                    <span class="inputtext">单位</span>
                    <el-input placeholder="请输入单位"
                              v-model.trim="Material.Unit"
                              size="medium"
                              clearable>
                    </el-input>
                </div>
                <div class="inputframe">
                    <span class="inputtext">供应商</span>
                    <el-input placeholder="请输入供应商"
                              v-model.trim="Material.Supplier"
                              size="medium"
                              clearable>
                    </el-input>
                </div>
                <div class="inputframe">
                    <span class="inputtext">生产日期</span>
                    <el-date-picker v-model="Material.LeaveFactoryTime"
                                    type="date"
                                    placeholder="选择生产日期"
                                    size="medium">
                    </el-date-picker>
                </div>
                <div class="inputframe">
                    <span class="inputtext">来料数量</span>
                    <el-input-number v-model.trim="Material.MaterialNum"
                                     size="mudium"
                                     :min="0"
                                     style="width:auto"
                                     clearable>
                    </el-input-number>
                </div>
                <div class="inputframe">
                    <span class="inputtext">来料日期</span>
                    <el-date-picker v-model="Material.InvoiceDate"
                                    type="date"
                                    placeholder="选择来料日期"
                                    size="medium">
                    </el-date-picker>
                </div>
                <div class="inputframe">
                    <span class="inputtext">收料人姓名</span>
                    <el-input placeholder="请输入收料人姓名"
                              v-model.trim="Material.ReceivingClerk"
                              size="medium"
                              clearable>
                    </el-input>
                </div>
                <div class="inputframe">
                    <span class="inputtext">批次</span>
                    <el-input placeholder="请输入批次"
                              v-model.trim="Material.Batch"
                              size="medium"
                              clearable>
                    </el-input>
                </div>
                <div class="inputframe">
                    <span class="inputtext">物料规格描述</span>
                    <el-input placeholder="请输入物料规格描述"
                              v-model.trim="Material.MaterialDiscription"
                              type="textarea"
                              autofocus
                              clearable>
                    </el-input>
                </div>
                <div class="inputframe">
                    <span class="inputtext">有效期(天)</span>
                    <el-input-number v-model.trim="Material.EffectiveDay"
                                     size="medium"
                                     :min="0"
                                     style="width:auto"
                                     clearable>
                    </el-input-number>
                </div>
                <div class="inputframe">
                    <span class="inputtext">追加有效期(天)</span>
                    <el-input-number v-model.trim="Material.AddEffectiveDay"
                                     size="medium"
                                     :min="0"
                                     style="width:auto"
                                     clearable>
                    </el-input-number>
                </div>
                <div class="inputframe">
                    <span class="inputtext">物料条码所包含物料个数</span>
                    <el-input-number v-model.trim="materialContainNum"
                                     size="medium"
                                     :min="0"
                                     style="width:auto"
                                     clearable>
                    </el-input-number>
                </div>
                <div class="inputframe">
                    <span>选打印机：</span>
                    <el-select v-model="printSelect" clearable placeholder="选择打印机" size="medium">
                        <el-option v-for="item in printOptions"
                                   :key="item.value"
                                   :label="item.label"
                                   :value="item.value">
                        </el-option>
                    </el-select>
                </div>
                <div class="inputframe" v-show="printSelect!='0'&&printSelect!=''">
                    <span>左偏移量：</span>
                    <el-input size="medium" v-model.trim="leftdissmenion"></el-input>
                </div>
                <div class="inputframe" v-show="printSelect!='0'&&printSelect!=''">
                    <span>打印浓度：</span>
                    <el-slider :max="30"
                               :min="-30"
                               v-model="nongDu"></el-slider>
                </div>
                <div class="inputframe" v-show="printSelect!='0'&&printSelect!=''">
                    <span>打印数量：</span>
                    <el-input-number v-model.trim="pageCount"
                                     size="medium"
                                     :min="1"
                                     :max="5"
                                     style="width:220px"
                                     clearable>
                    </el-input-number>
                </div>
                <div class="inputframe">
                    <el-button size="medium" @@click="postPrint">确认</el-button>
                </div>
            </el-row>
        </el-main>
    </el-container>
</div>

<script>
    var app = new Vue({
        el: "#app",
        data: {
            loading: false,
            screenSize: document.body.clientWidth,
            //入库
            Material: {
                MaterialNumber: "",
                MaterialDiscription: "",
                Batch: "",
                MaterialNum: 0,
                Unit: "",
                Department: "",
                Group: "",
                ReceivingClerk: "",
                InvoiceDate: "",
                LeaveFactoryTime: "",
                Supplier: "",
                MaterialType: "",
                EffectiveDay: 180,
                AddEffectiveDay: 0,
            },
            materialContainNum: 0,
            groupOptions: [],
            // 打印
            pageCount: 1,
            nongDu: 30,
            printOptions: printIpAddress,
            printSelect: '',
            leftdissmenion: 100,
        },
        created: function () {
            window.onresize = function () {
                app.screenSize = document.body.clientWidth;
            };
            this.getGroup();
        },
        mounted: function () {
            let printIP = localStorage.getItem('printIP');
            if (printIP != null) {
                this.printSelect = printIP;
            };
            let localpage = localStorage.getItem('printPageCount');
            if (localpage != null) {
                this.pageCount = localpage;
            };
            this.leftdissmenion = localStorage.getItem('cassoadd_leftdissmenion', '');
            if (this.leftdissmenion == null || this.leftdissmenion == "") {
                this.leftdissmenion = 100;
            } else {
                this.leftdissmenion = localStorage.getItem('cassoadd_leftdissmenion', '');
            };
            let localnongdu = localStorage.getItem('printNongDuCount');
            if (localnongdu != null) {
                this.nongDu = +localnongdu;
            };
        },
        methods: {
            printBarcode(list) {
                localStorage.setItem('printPageCount', this.pageCount);
                localStorage.setItem('printNongDuCount', this.nongDu);
                axios.post('/SMT_Sulderpaster/InsideBoxLable_Print', {
                    barcodelist: list,
                    pagecount: this.pageCount,
                    concentration: this.nongDu,
                    ip: this.printSelect,
                    port: 9101,
                    leftdissmenion: this.leftdissmenion
                }).then(res => {
                    console.log(res.data)
                    let rtm = res.data[0].message;
                    //成功存储和打印
                    if (rtm == '打印成功！') {
                        this.$confirm('打印完成，是否进行下一组录入?', "入库成功", {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'success',
                            center: true,
                        }).then(() => {
                            this.clear();
                        }).catch(() => {
                        });
                        this.loading = false;
                    } else {
                        this.$confirm(rtm + "稍后请重新打印条码。", "入库已成功,未完成打印！", {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning',
                            center: true,
                        }).then(() => {
                            this.clear();
                        }).catch(() => {
                        });
                        this.loading = false;
                    };
                }).catch(err => {
                    console.warn("打印出错");
                    this.loading = false;
                });
            },
            //验证条码，录入信息，打印条码，
            postPrint() {
                this.loading = true;
                //录入数据
                axios.post('/Warehouse_Material/MaterialBasicInfo', {
                    materialBasicInfo_Collection: this.Material,
                    materialContainNum: this.materialContainNum
                }).then(res => {
                    if (res.data.Res) {
                        console.log(res.data.BarcodeList);
                        console.log(res.data.MaterialDiscription);
                        //this.printBarcode(res.data.BarcodeList,res.data.MaterialDiscription);
                        this.loading = false;
                    } else {
                        this.$alert(res.data.Meg, {
                            closeOnClickModal: true,
                            closeOnPressEscape: true,
                            type: "error",
                        });
                        this.loading = false;
                    };
                }).catch(err => {
                    console.warn("post失败")
                    this.loading = false;
                });
            },
            //清空
            clear() {
                this.Material = {
                    MaterialNumber: "",
                    MaterialDiscription: "",
                    Batch: "",
                    MaterialNum: 0,
                    Unit: "",
                    Department: "",
                    Group: "",
                    ReceivingClerk: "",
                    InvoiceDate: "",
                    LeaveFactoryTime: "",
                    Supplier: "",
                    MaterialType: "",
                    EffectiveDay: 180,
                    AddEffectiveDay: 0,
                };
                this.materialContainNum = 0;
            },
            //获取账号班组列表
            getGroup() {
                axios.post("/Users/DisplayGroup").then(res => {
                    //未登陆则返回null
                    if (res.data == '') {
                        this.$message.warning("请登陆！")
                    } else {
                        this.groupOptions = res.data.Group;
                        this.Material.Department = res.data.department;
                        //查看班组列表里是否存在本地存储的值
                        let localsg = localStorage.getItem('selectgroup');
                        if (localsg != null) {
                            for (let i of this.groupOptions) {
                                if (i == localsg) {
                                    this.Material.Group = localsg;
                                };
                            };
                        };
                    };
                }).catch(err => {
                    console.warn(err);
                });
            },
        },
        watch: {
            printSelect(v) {
                localStorage.setItem('printIP', v);
            },
            leftdissmenion() {
                if (this.leftdissmenion != '') {
                    localStorage.setItem("cassoadd_leftdissmenion", this.leftdissmenion)
                } else if (this.leftdissmenion == null || this.leftdissmenion == "") {
                    localStorage.setItem("cassoadd_leftdissmenion", 100)
                }
            }
        }
    });
</script>