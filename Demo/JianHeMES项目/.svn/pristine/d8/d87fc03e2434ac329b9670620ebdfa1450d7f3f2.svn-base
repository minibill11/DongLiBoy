@{
    ViewBag.Title = "库存金额";
}
@* css放置处 *@
@section cssStyle {
    <link rel="stylesheet/less" type="text/css" href="~/Content/tableStyle/StockAmount.less" />
    <style>
        #app {
            padding: 15px 15px 0 15px;
            font-family: '微软雅黑';
        }

        .select {
            margin: 20px;
        }

        .el-table .warning-row {
            background: #eff2f7;
            font-size: 25px !important;
            font-weight: 700;
        }

        .table {
            width: 100%;
        }

        .el-table__header tr, .el-table__header th {
            padding: 0;
            height: 25px;
            line-height: 20px;
        }

        .el-table td div {
            font-size: 12px;
            color: #293038
        }

        .el-form-item {
            font-weight: 200
        }

        .bt_form_flex {
            display: flex;
            flex-flow: row wrap;
            margin-top: 10px;
        }

            .bt_form_flex > .el-form-item {
                width: 380px;
            }

            .bt_form_flex .el-input__inner {
                width: 150px;
            }

        .el-form-item__label {
            color: #000000;
            font-weight: 600
        }
        .el-button--success.is-disabled, .el-button--success.is-disabled:active, .el-button--success.is-disabled:focus, .el-button--success.is-disabled:hover {
            color: #FFF;
            background-color: #CCD3DE;
            border-color: #CCD3DE;
        }
    </style>
}
    <div id="app">
        <el-header class="text-center">
            <sa-header :active="active"></sa-header>
        </el-header>
        <div class="select">
            <span style="font-size:small">已生成报告：</span>
            <el-date-picker v-model="inputDate"
                            type="month"
                            placeholder="选择录入日期"
                            size="small"
                            style="width:150px">
            </el-date-picker>
            <el-button type="primary" size="small" v-on:click="GetData">查询</el-button>
            <el-button type="danger" size="small" plain @@click="deleteReport" v-bind:disabled="deleteRoles==false||tableDate.length==0">删除</el-button>
        </div>
        <el-table :data="tableDate" max-height="574" class="table" :row-class-name="tableRowClassName" :header-cell-style="{'text-align':'center'}">
            <el-table-column prop=""
                             label="类别"
                             width="100"
                             fixed>
                <template slot-scope="scope">
                    <u style="color:#409eff" type="text" size="middle" v-on:click="LookExcelFile(scope.row.Category)">{{scope.row.Category}}</u>
                </template>
            </el-table-column>
            <el-table-column prop="Category_Detail"
                             label="分类明细"
                             width="140"
                             fixed>
            </el-table-column>
            <el-table-column prop=""
                             label="库龄"
                             width="180">
                <el-table-column prop="OneMonth"
                                 label="1个月以内"
                                 width="130"
                                 align="right">
                </el-table-column>
                <el-table-column prop="TwoMonths"
                                 label="2-3个月"
                                 width="130"
                                 align="right">
                </el-table-column>
                <el-table-column prop="FourMonths"
                                 label="4-6个月"
                                 width="130"
                                 align="right">
                </el-table-column>
                <el-table-column prop="SevenMonths"
                                 label="7-12个月"
                                 width="130"
                                 align="right">
                </el-table-column>
                <el-table-column prop="OneYear"
                                 label="1-2年"
                                 width="130"
                                 align="right">
                </el-table-column>
                <el-table-column prop="TwoYears"
                                 label="2-3年"
                                 width="130"
                                 align="right">
                </el-table-column>
                <el-table-column prop="ThreeYears"
                                 label="3-5年"
                                 width="130"
                                 align="right">
                </el-table-column>
                <el-table-column prop="FiveYears"
                                 label="5年以上"
                                 width="125"
                                 align="right">
                </el-table-column>
                <el-table-column prop="AmountTotal"
                                 label="合计金额"
                                 width="140"
                                 align="right">
                </el-table-column>
            </el-table-column>
            <el-table-column prop="RecordNum"
                             label="记录条数"
                             width="105"
                             align="right">
            </el-table-column>
            <el-table-column prop="Remark"
                             label="备注">
            </el-table-column>
        </el-table>
        <span style="font-size:small;">注：每月8号计算出上一个月份的库龄表数据(财务部),每月10号前完成财务核对、PMC核对及财务审核。</span>
        <el-row class="table-bottom">
            <div class="table-bottom-left">
                <el-form class="bt_form_flex" size="small">
                    <el-form-item label="财务核对：">
                        <el-select v-model="finance_Proofread"
                                   placeholder="请选择" v-show="(finance_Proofread==null||finance_Proofread=='通过'||finance_Proofread=='不通过')&&caiwu_hedui==true" :disabled="tableDate.length==0">
                            <el-option v-for="item in Options"
                                       :key="item.value"
                                       :value="item.label">
                            </el-option>
                        </el-select>
                        <lable v-show="finance_Proofread!=null&&(finance_Proofread==1||finance_Proofread==2)">{{arr.Finance_Proofreader+" / "}}{{arr.Finance_Proofread_Date|timeFilter}}{{" "+arr.Finance_Proofread_Reason}}</lable>
                        <el-button type="success" v-show="(finance_Proofread==null||finance_Proofread=='通过'||finance_Proofread=='不通过')&&caiwu_hedui==true" @@click="Confirm(1)" :disabled="tableDate.length==0">确认</el-button>
                    </el-form-item>

                    <el-form-item label="PMC核对：">
                        <el-select v-model="pmc_Proofread"
                                   placeholder="请选择" v-show="(pmc_Proofread==null||pmc_Proofread=='通过'||pmc_Proofread=='不通过')&&pmc_hedui==true" :disabled="tableDate.length==0">
                            <el-option v-for="item in Options"
                                       :key="item.value"
                                       :value="item.label">
                            </el-option>
                        </el-select>
                        <lable v-show="pmc_Proofread!=null&&(pmc_Proofread==1||pmc_Proofread==2)">{{arr.Finance_Finance_Proofreader+" / "}}{{arr.PMC_Proofread_Date|timeFilter}}{{" "+arr.PMC_Proofread_Reason}}</lable>
                        <el-button type="success" v-show="(pmc_Proofread==null||pmc_Proofread=='通过'||pmc_Proofread=='不通过')&&pmc_hedui==true" @@click="Confirm(2)" :disabled="tableDate.length==0">确认</el-button>
                    </el-form-item>

                    <el-form-item label="财务审核：">
                        <el-select v-model="finance_Assessed"
                                   placeholder="请选择" v-show="(finance_Assessed==null||finance_Assessed=='通过'||finance_Assessed=='不通过')&&caiwu==true" v-bind:disabled="pmc_Proofread==null||pmc_Proofread=='通过'||pmc_Proofread=='不通过'||finance_Proofread==null||finance_Proofread=='通过'||finance_Proofread=='不通过'">
                            <el-option v-for="item in Options"
                                       :key="item.value"
                                       :value="item.label">
                            </el-option>
                        </el-select>
                        <lable v-show="finance_Assessed!=null&&(finance_Assessed==1||finance_Assessed==2)">{{arr.Finance_Assessor+" / "}}{{arr.Finance_Assessed_Date|timeFilter}}{{" "+arr.Finance_Assessed_Reason}}</lable>
                        <el-button type="success" v-show="(finance_Assessed==null||finance_Assessed=='通过'||finance_Assessed=='不通过')&&caiwu==true" @@click="Confirm(3)" v-bind:disabled="finance_Assessed==null">确认</el-button>
                    </el-form-item>
                </el-form>
            </div>
            <div class="table-bottom-right">
            </div>
        </el-row>
        <el-dialog title="提示" v-bind:visible.sync="assVisible" width="400px">
            <span slot="title">
                <h3 style="text-align:center;">不通过原因</h3>
                <el-form label-position="labelPosition" label-width="80px">
                    <el-form-item label="原因：" style="margin-top:25px">
                        <el-input v-model="reason" size="small" style="width:250px;" type="textarea"></el-input>
                    </el-form-item>
                </el-form>
            </span>
            <span slot="footer" class="dialog-footer">
                <el-button v-on:click="assVisible=false" size="small">取 消</el-button>
                <el-button type="primary" v-on:click="assVisible=false" size="small">添 加</el-button>
            </span>
        </el-dialog>
    </div>
@* 分部页放置处 *@
@section renderPage {
    @RenderPage("~/Views/Warehouse_Material/_SA_Header.cshtml")
}
@* js放置处 *@
@section jsScript {
    <script>
        Vue.filter("timeFilter", function (val) {
            if (!val) return '';
            let dd = new Date(val);
            let yy = dd.getFullYear();
            let mm = (dd.getMonth() + 1).toString().padStart(2, 0);
            let ds = dd.getDate().toString().padStart(2, 0);
            let hour = dd.getHours().toString().padStart(2, 0);
            let minium = dd.getMinutes().toString().padStart(2, 0);
            let seconds = dd.getSeconds().toString().padStart(2, 0);
            return `${yy}-${mm}-${ds} ${hour}:${minium}:${seconds}`
        })
        const app = {
            data: function () {
                return {
                    active: "",
                    tableDate: [],
                    inputDate: "",
                    finance_Proofread: null,//财务核对
                    pmc_Proofread: null,//PMC核对
                    finance_Assessed: null,//财务审核
                    Options: [{ value: '选项1', label: '通过' }, { value: '选项2', label: '不通过' }],
                    arr: {},
                    assVisible: false,
                    reason: '',
                    caiwu: false,//财务审核
                    pmc_hedui: false,//PMC核对
                    caiwu_hedui: false,//财务核对
                    //changzhang: false,//工厂厂长核准
                    deleteRoles: false,//删除报告权限
                }
            },
            mounted: function () {
                //权限设置
                var roles = JSON.parse(localStorage.getItem("rigths"))
                if (checkRoles(roles, '财务审核')) {
                    this.caiwu = true
                };
                if (checkRoles(roles, 'PMC核对')) {
                    this.pmc_hedui = true
                };
                if (checkRoles(roles, '财务核对')) {
                    this.caiwu_hedui = true
                };
                if (checkRoles(roles, '删除库存金额报告')) {
                    this.deleteRoles = true
                };

                // 若是从修改包装页面进来，就获取地址栏上的外箱号
                let lastUrl = document.referrer;
                if (lastUrl.toLowerCase().indexOf("StockAmount_Index") == -1) {
                    this.inputDate = getUrlParam('time')
                    this.GetData()
                };
            },
            methods: {
                //查询
                GetData() {
                    if (this.inputDate == "" || this.inputDate == null) {
                        return;
                    }
                    this.tableDate = []
                    this.finance_Assessed = this.pmc_Proofread = this.finance_Proofread = null;
                    axios.post("/Warehouse_Material/StockAmount_Query", { date: this.inputDate }).then(res => {
                        this.tableDate = JSON.parse(res.data.table)
                        if (this.tableDate.length > 0) {
                            this.$message.success("查询成功！");
                        } else {
                            this.$message.error("暂无数据！");
                        }
                        let obj = JSON.parse(res.data.res);
                        this.arr = obj[0]
                        let record = obj[0]
                        //财务审核
                        if (record.Finance_Assessed == true) {
                            this.finance_Assessed = '1'
                        } else if (record.Finance_Assessed == false) {
                            this.finance_Assessed = '2'
                        };
                        //PMC核对
                        if (record.PMC_Proofread == true) {
                            this.pmc_Proofread = '1'
                        } else if (record.PMC_Proofread == false) {
                            this.pmc_Proofread = '2'
                        };
                        //财务核对
                        if (record.Finance_Proofread == true) {
                            this.finance_Proofread = '1'
                        } else if (record.Finance_Proofread == false) {
                            this.finance_Proofread = '2'
                        };
                    })
                },
                //处理合计行的样式
                tableRowClassName({ row, rowIndex }) {
                    if (row.FiveYears == "全部合计" || row.FiveYears == "汇总结果求和") {
                        return 'warning-row';
                    }
                    return '';
                },
                //审核、核准方法
                Confirm(str) {
                    let res = null;
                    if (this.finance_Assessed == "通过" || this.pmc_Proofread == "通过" || this.finance_Proofread == "通过") {
                        res = true
                    } else if (this.finance_Assessed == "不通过" || this.pmc_Proofread == "不通过" || this.finance_Proofread == "不通过") {
                        res = false
                        if (this.reason == '') {
                            this.$message.error("原因不能为空！");
                            return;
                        }
                    } else {
                        str == 3 ? this.$message.error("请选择审核内容") : this.$message.error("请选择核对内容");
                        return;
                    }
                    axios.post("/Warehouse_Material/Approve", { id: this.arr.Id, reason: this.reason, approve_Type: str, approve_Result: res }).then(res => {
                        console.log(res.data)
                        if (res.data == "核对成功！" || res.data == "审核成功！") {
                            this.$message.success(res.data);
                            this.reason = '';
                            this.GetData()
                        }
                        else {
                            this.$message.error(res.data);
                        }
                    })
                },
                //删除报告
                deleteReport() {
                    let comfirm = confirm(`确认删除此报告吗？`);
                    if (comfirm) {
                        axios.post("/Warehouse_Material/DeleteReport", { date: this.inputDate }).then(res => {
                            if (res.data == "删除成功！") {
                                this.$message.success(res.data);
                                this.tableDate = []
                                this.finance_Assessed = this.pmc_Proofread = this.finance_Proofread= null;
                            } else {
                                this.$message.error(res.data);
                            }
                        })
                    }
                },
                //下载表格
                LookExcelFile(row) {
                    console.log(row)
                    let dd = new Date(this.inputDate);
                    axios.post("/Warehouse_Material/LookExcel", {
                        category: row,
                        date: this.inputDate,
                    }).then(function (res) {
                        let fileName = dd.getFullYear() + '年' + (dd.getMonth() + 1) + '月' + row + '.xlsx'
                        let url = res.data
                        let link = document.createElement('a')
                        link.style.display = 'none'
                        link.href = url
                        link.setAttribute('download', fileName)
                        document.body.appendChild(link)
                        link.click()
                    })
                }
            },
            watch: {
                //控制弹框显示
                finance_Assessed() {
                    if (this.finance_Assessed == "不通过") {
                        this.assVisible = true
                    }
                },
                pmc_Proofread() {
                    if (this.pmc_Proofread == "不通过") {
                        this.assVisible = true
                    }
                },
                finance_Proofread() {
                    if (this.finance_Proofread == "不通过") {
                        this.assVisible = true
                    }
                },
                inputDate() {
                    if (this.inputDate == null) {
                        this.tableDate = []
                        this.finance_Assessed = this.pmc_Proofread = this.finance_Proofread = null;
                    };
                },
            }
        };
        //检测权限方法
        function checkRoles(list, roleName) {
            var flag = false
            if (list && roleName) {
                for (let item in list) {
                    if (list[item] == roleName) {
                        flag = true
                    }
                }
            }
            return flag
        }
        // 解析地址栏参数
        function getUrlParam(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return decodeURI(r[2]); return '';
        }
    </script>
}