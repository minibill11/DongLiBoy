@{
    ViewBag.Title = "模块实时看板";
}
@* css放置处 *@
@section cssStyle {
    <link rel="stylesheet/less" type="text/css" href="~/Content/styleFile/moduleManagement/module.less" />
    <link rel="stylesheet/less" type="text/css" href="~/Content/styleFile/moduleManagement/module-board.less" />
}

<el-container id="app" v-cloak>
    <el-header>
        <h1 class="title">@ViewBag.Title</h1>
    </el-header>
    <el-main>
        <el-row class="table-top">
            <el-select v-model="ordernum.value"
                       placeholder="订单筛选"
                       size="medium"
                       multiple
                       collapse-tags
                       filterable
                       clearable>
                <el-option v-for="item in ordernum.list"
                           :key="item"
                           :label="item"
                           :value="item">
                </el-option>
            </el-select>
            <el-select v-model="platformType.value"
                       placeholder="平台筛选"
                       size="medium"
                       multiple
                       collapse-tags
                       filterable
                       clearable>
                <el-option v-for="item in platformType.list"
                           :key="item"
                           :label="item"
                           :value="item">
                </el-option>
            </el-select>
        </el-row>
        <el-row class="table-mid">
            <el-table :data="filterTableList"
                      row-class-name="zero-padding"
                      max-height="600"
                      size="small"
                      stripe
                      border>
                <el-table-column type="index" label="序号" min-width="50"></el-table-column>
                <el-table-column prop="OrderNum" label="订单号" min-width="100"></el-table-column>
                <el-table-column prop="PlatformType" label="平台型号" min-width="80"></el-table-column>
                <el-table-column prop="Models" label="模块数" min-width="80"></el-table-column>
                <el-table-column prop="PlanInputTime" label="开始生产时间" min-width="80">
                    <template slot-scope="scope">
                        {{scope.row.PlanInputTime.split('T')[0]}}
                    </template>
                </el-table-column>
                <el-table-column label="SMT">
                    <el-table-column prop="SMTFirstSample_Description" label="首件"></el-table-column>
                    @*<el-table-column prop="SMTFirstSample_DescriptionJpg" label="首件"></el-table-column>
                        <el-table-column prop="SMTFirstSample_DescriptionPdf" label="首件"></el-table-column>*@
                    <el-table-column prop="HandSampleScedule" label="小样"></el-table-column>
                    @*<el-table-column prop="HandSampleSceduleJpg" label="小样"></el-table-column>
                        <el-table-column prop="HandSampleScedulePdf" label="小样"></el-table-column>*@
                    @*<el-table-column prop="HandSampleSceduleReport" label="小样"></el-table-column>*@
                    <el-table-column label="线别">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.SmtArray">
                                <div>{{item.Line}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="完成率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.SmtArray">
                                <div>{{item.CompleteRate}}</div>
                                <div>{{item.CompleteInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="合格率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.SmtArray">
                                <div>{{item.PassRate}}</div>
                                <div>{{item.PassInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="抽检率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.SmtArray">
                                <div>{{item.SamplingRate}}</div>
                                <div>{{item.SamplingInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column prop="SMTAbnormal_Description" label="异常"></el-table-column>
                    @*<el-table-column prop="SMTAbnormal_DescriptionJpg" label="异常"></el-table-column>
                        <el-table-column prop="SMTAbnormal_DescriptionPdf" label="异常"></el-table-column>*@
                </el-table-column>
                <el-table-column label="AI">
                    <el-table-column label="线别">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.AI">
                                <div>{{item.Line}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="完成率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.AI">
                                <div>{{item.CompleteRate}}</div>
                                <div>{{item.CompleteInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="合格率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.AI">
                                <div>{{item.PassRate}}</div>
                                <div>{{item.PassInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="抽检率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.AI">
                                <div>{{item.SamplingRate}}</div>
                                <div>{{item.SamplingInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                </el-table-column>
                <el-table-column label="后焊">
                    <el-table-column label="线别">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.After">
                                <div>{{item.Line}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="完成率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.After">
                                <div>{{item.CompleteRate}}</div>
                                <div>{{item.CompleteInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="合格率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.After">
                                <div>{{item.PassRate}}</div>
                                <div>{{item.PassInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="抽检率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.After">
                                <div>{{item.SamplingRate}}</div>
                                <div>{{item.SamplingInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                </el-table-column>
                <el-table-column label="灌胶前电测">
                    <el-table-column label="线别">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.Before">
                                <div>{{item.Line}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="完成率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.Before">
                                <div>{{item.CompleteRate}}</div>
                                <div>{{item.CompleteInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="合格率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.Before">
                                <div>{{item.PassRate}}</div>
                                <div>{{item.PassInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="抽检率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.Before">
                                <div>{{item.SamplingRate}}</div>
                                <div>{{item.SamplingInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                </el-table-column>
                <el-table-column label="灌胶后电测">
                    <el-table-column label="线别">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.Later">
                                <div>{{item.Line}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="完成率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.Later">
                                <div>{{item.CompleteRate}}</div>
                                <div>{{item.CompleteInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="合格率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.Later">
                                <div>{{item.PassRate}}</div>
                                <div>{{item.PassInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="抽检率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.Later">
                                <div>{{item.SamplingRate}}</div>
                                <div>{{item.SamplingInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                </el-table-column>
                <el-table-column label="老化">
                    <el-table-column label="线别">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.BurnIn">
                                <div>{{item.Line}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="完成率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.BurnIn">
                                <div>{{item.CompleteRate}}</div>
                                <div>{{item.CompleteInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="合格率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.BurnIn">
                                <div>{{item.PassRate}}</div>
                                <div>{{item.PassInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="抽检率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.BurnIn">
                                <div>{{item.SamplingRate}}</div>
                                <div>{{item.SamplingInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                </el-table-column>
                <el-table-column label="外观电测">
                    <el-table-column label="线别">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.Appearance">
                                <div>{{item.Line}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="完成率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.Appearance">
                                <div>{{item.CompleteRate}}</div>
                                <div>{{item.CompleteInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="合格率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.Appearance">
                                <div>{{item.PassRate}}</div>
                                <div>{{item.PassInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column label="抽检率">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.Appearance">
                                <div>{{item.SamplingRate}}</div>
                                <div>{{item.SamplingInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                </el-table-column>
                <el-table-column label="包装">
                    <el-table-column prop="InsideTheBox" label="内箱">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.InsideTheBox">
                                <div>{{item.CompleteRate}}</div>
                                <div>{{item.CompleteInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                    <el-table-column prop="OutsideTheBox" label="外箱">
                        <template slot-scope="scope">
                            <template v-for="(item,index) in scope.row.OutsideTheBox">
                                <div>{{item.CompleteRate}}</div>
                                <div>{{item.CompleteInfo}}</div>
                            </template>
                        </template>
                    </el-table-column>
                </el-table-column>
                <el-table-column prop="Warehouse" label="入库/出库">
                    <template slot-scope="scope">
                        <template v-for="(item,index) in scope.row.Warehouse">
                            <div>{{item.CompleteRate}}</div>
                            <div>{{item.CompleteInfo}}</div>
                        </template>
                    </template>
                </el-table-column>
                <el-table-column prop="CompleteTime" label="完成时间"></el-table-column>
                <el-table-column prop="Timespan" label="生产时长"></el-table-column>

            </el-table>
        </el-row>
        <el-row class="table-bottom">
            <div class="boxcolor green"></div><div>达到100%    &nbsp;&nbsp;</div>
            <div class="boxcolor yellow"></div><div> 合格率范围为80%~90%      &nbsp;&nbsp;</div>
            <div class="boxcolor red"></div><div> 合格率范围为< 80%&nbsp;&nbsp;</div>
        </el-row>
    </el-main>
</el-container>
@* 分部页放置处 *@
@section renderPage {
}
@* js放置处 *@
@section jsScript {
    <script src="~/Scripts/jquery-1.11.3.min.js"></script>
    <script src="~/Scripts/jquery.signalR-2.3.0.min.js"></script>
    <script src="~/signalr/hubs"></script>
    <script>
        const app = {
            data: function () {
                return {
                    tableList: [],
                    ordernum: { value: '', list: [] },
                    platformType: { value: '', list: [] },
                }
            },
            mounted() { this.hubConnection() },
            computed: {
                filterTableList() {
                    const ini = this.tableList, ov = this.ordernum.value, pv = this.platformType.value; let o, p;
                    o = ini.filter(r => { if (ov == null || ov == '') { return r } else { if (ov.includes(r.OrderNum)) return r } });
                    p = o.filter(r => { if (pv == null || pv == '') { return r } else { if (pv.includes(r.PlatformType)) return r } });
                    return p;
                },
            },
            methods: {
                handleData(v) {
                    let vd = v.splice(20, 50), ol = [], pl = [];
                    for (let i of vd) { ol.push(i.OrderNum); pl.push(i.PlatformType); };
                    this.ordernum.list = [...new Set(ol)]; this.platformType.list = [...new Set(pl)];
                    this.tableList = vd;
                },
                hubConnection() {
                    //读取JSON文件数据
                    $.getJSON("/MES_Data/TemDate/ModuleProductionController.json", v => {
                        this.handleData(v);
                        console.log(v);
                    });

                    //如果前后端为同一个端口,可不填参数;如果前后端分离,这里参数为服务器端的URL.
                    const connection = $.hubConnection(), Proxy = connection.createHubProxy('ModuleProductionControlIndex');
                    Proxy.on('sendProductionControlIndex', v => {
                        this.handleData(v);
                        console.log(v);
                    });
                    connection.start().done(v => { console.log('启动连接成功！' + v); }).fail(v => { console.log('启动连接失败' + v); });
                    connection.error(err => { console.log("连接出错！" + err) });
                    connection.reconnected(() => { console.log('连接重新启动！') });
                    connection.disconnected(() => { console.log('断开连接！') });
                    connection.received((data) => { console.log('接收数据成功！') });
                    connection.connectionSlow(() => { console.log('数据连接流！') });
                },
            }
        };
    </script>
}