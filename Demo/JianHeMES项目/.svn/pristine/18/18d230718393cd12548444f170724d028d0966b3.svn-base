using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Entity;
using System.Linq;
using System.Threading.Tasks;
using System.Net;
using System.Web;
using System.Web.Mvc;
using JianHeMES.Models;
using System.Drawing;
using System.IO;
using Newtonsoft.Json.Linq;
using Newtonsoft.Json;

namespace JianHeMES.Controllers
{
    public class ModuleManagementController : Controller
    {
        private ApplicationDbContext db = new ApplicationDbContext();

        #region------模块看板
        //模块看板首页
        public async Task<ActionResult> Index()
        {
            if (Session["User"] == null)
            {
                return RedirectToAction("Login", "Users", new { col = "ModuleManagement", act = "Index" });
            }
            return View();
        }
        #endregion
        public class CheckList
        {
            public string Barcode { get; set; }
            public bool Finshi { get; set; }
        }
        #region------各工序功能

        #region------ 工段通用方法
        #region    --------------------查询订单已完成、未完成、未开始条码
        [HttpPost]
        public ActionResult Checklist(string orderNum, string statue)
        {
            if (Session["User"] == null)
            {
                return RedirectToAction("Login", "Users");
            }
            JObject stationResult = new JObject();//输出结果JObject

            switch (statue)
            {
                case "后焊":
                    var value = db.AfterWelding.Where(c => c.Ordernum == orderNum).OrderBy(c => c.ModuleBarcode).Select(c => new CheckList { Barcode = c.ModuleBarcode, Finshi = c.IsSampling }).ToList();
                    stationResult = ChecklistItem(value, orderNum);
                    break;
                case "电测":
                    var value2 = db.ElectricInspection.Where(c => c.Ordernum == orderNum).OrderBy(c => c.ModuleBarcode).Select(c => new CheckList { Barcode = c.ModuleBarcode, Finshi = c.IsSampling }).ToList();
                    stationResult = ChecklistItem(value2, orderNum);
                    break;

            }
            return Content(JsonConvert.SerializeObject(stationResult));
        }

        public JObject ChecklistItem(List<CheckList> value, string orderNum)
        {

            List<string> NotDoList = new List<string>();//未开始做条码清单
            List<string> NeverFinish = new List<string>();//未完成条码清单
            List<string> FinishList = new List<string>();//已完成条码清单
            JObject stationResult = new JObject();//输出结果JObject
            //调出订单所有条码清单
            List<string> barcodelist = db.BarCodes.Where(c => c.OrderNum == orderNum && c.BarCodeType == "模块").OrderBy(c => c.BarCodesNum).Select(c => c.BarCodesNum).ToList();
            List<string> recordlist = new List<string>();
            if (value .Count==0)
            {
                JArray array = new JArray();
                barcodelist.ForEach(c => array.Add(c));
                stationResult.Add("NotDoList", array);
                stationResult.Add("NeverFinish", null);
                stationResult.Add("FinishList", null);
            }
            else
            {
                recordlist = value.Select(c => c.Barcode).Distinct().ToList();
                //未开始做条码清单
                NotDoList = barcodelist.Except(recordlist).ToList();
                //已完成条码清单
                FinishList = value.Where(c => c.Finshi == true).Select(c => c.Barcode).Distinct().ToList();
                //未完成条码清单
                NeverFinish = value.Where(c => c.Finshi == false).Select(c => c.Barcode).Distinct().ToList().Except(FinishList).ToList();
                JArray NotDoListarray = new JArray();
                JArray NeverFinisharray = new JArray();
                JArray FinishListarray = new JArray();

                NotDoList.ForEach(c => NotDoListarray.Add(c));
                NeverFinish.ForEach(c => NeverFinisharray.Add(c));
                FinishList.ForEach(c => FinishListarray.Add(c));

                stationResult.Add("NotDoList", NotDoListarray);
                stationResult.Add("NeverFinish", NeverFinisharray);
                stationResult.Add("FinishList", FinishListarray);
            }
            return stationResult;
        }
        #endregion

        #region ----------条码验证检查
        public ActionResult AfterWeldingCheckBarcode(string orderNum, string barcode)
        {
            JObject result = new JObject();
            JArray array = new JArray();
            var info = db.BarCodes.Where(c => c.BarCodesNum == barcode).FirstOrDefault();
            if (info == null)
            {
                result.Add("result", false);
                result.Add("message", "没有找到条码信息");
                result.Add("period", null);
            }
            else
            {
                if (info.OrderNum != orderNum)
                {
                    result.Add("result", false);
                    result.Add("message", "此条码与订单不符,该条码的订单是" + info.OrderNum);
                    result.Add("period", null);
                }
                else
                {
                    result.Add("result", true);
                    result.Add("message", null);
                    JObject item = new JObject();
                    //后焊
                    var afterWelding = db.AfterWelding.Where(c => c.ModuleBarcode == barcode).ToList();
                    item.Add("Name", "后焊");
                    item.Add("Have", afterWelding.Count == 0 ? false : true);
                    array.Add(item);
                    item = new JObject();

                    //电检
                    var electricInspection = db.ElectricInspection.Where(c => c.ModuleBarcode == barcode).ToList();
                    item.Add("Name", "电检");
                    item.Add("Have", electricInspection.Count == 0 ? false : true);
                    array.Add(item);
                    item = new JObject();

                    //老化
                    var moduleBurnIn = db.ModuleBurnIn.Where(c => c.ModuleBarcode == barcode).ToList();
                    item.Add("Name", "老化");
                    item.Add("Have", moduleBurnIn.Count == 0 ? false : true);
                    array.Add(item);
                    item = new JObject();

                    //外观
                    var moduleAppearance = db.ModuleAppearance.Where(c => c.ModuleBarcode == barcode).ToList();
                    item.Add("Name", "外观");
                    item.Add("Have", moduleAppearance.Count == 0 ? false : true);
                    array.Add(item);
                    item = new JObject();

                    result.Add("period", array);
                }
            }
            return Content(JsonConvert.SerializeObject(result));
        }
        #endregion

        #region ------抽检前条码检查
        public ActionResult CheckSampling(string ordernum, string barcode, string statue)
        {
            int count = 0;
            JObject result = new JObject();
            switch (statue)
            {
                case "后焊":
                    count = db.AfterWelding.Count(c => c.Ordernum == ordernum && c.ModuleBarcode == barcode);

                    break;
                case "电检":
                    count = db.ElectricInspection.Count(c => c.Ordernum == ordernum && c.ModuleBarcode == barcode);
                    break;
            }
            if (count == 0)
            {
                result.Add("result", false);
                result.Add("mes", "没有找到该条码信息");
            }
            else
            {
                result.Add("result", true);
                result.Add("mes", "成功");
            }
            return Content(JsonConvert.SerializeObject(result));
        }


        #endregion

        #endregion

        #region ------后焊
        #region----------后焊创建新数据
        public ActionResult AfterWeldingCreate()
        {
            if (Session["User"] == null)
            {
                return RedirectToAction("Login", "Users", new { col = "ModuleManagement", act = "AfterWeldingCreate" });
            }
            return View();
        }

        // POST: ModuleManagement/AfterWeldingCreate
        [HttpPost]
        //[ValidateAntiForgeryToken]
        public async Task<ActionResult> AfterWeldingCreate(AfterWelding afterWelding)
        {
            JObject result = new JObject();
            if (ModelState.IsValid)
            {
                if (db.AfterWelding.Count(c => c.ModuleBarcode == afterWelding.ModuleBarcode) > 0)
                {
                    result.Add("result", false);
                    result.Add("mes", "该条码已有后焊记录");
                    return Content(JsonConvert.SerializeObject(result));
                }
                afterWelding.AfterWeldingTime = DateTime.Now;
                afterWelding.AfterWeldingor = ((Users)Session["User"]).UserName;
                db.AfterWelding.Add(afterWelding);
                await db.SaveChangesAsync();
                result.Add("result", true);
                result.Add("mes", "成功");
                return Content(JsonConvert.SerializeObject(result));
            }
            result.Add("result", false);
            result.Add("mes", "错误,数据格式不对");
            return Content(JsonConvert.SerializeObject(result));
        }
        #endregion

        #region----------后焊抽样送检工序
        //后焊工序
        // GET: ModuleManagement/AfterWeldingCreate
        public ActionResult AfterWeldingSampling()
        {
            if (Session["User"] == null)
            {
                return RedirectToAction("Login", "Users", new { col = "ModuleManagement", act = "AfterWeldingSampling" });
            }
            return View();
        }

        // POST: ModuleManagement/AfterWeldingCreate
        [HttpPost]
        //[ValidateAntiForgeryToken]
        public async Task<ActionResult> AfterWeldingSampling(AfterWelding afterWelding)
        {
            JObject result = new JObject();
            if (ModelState.IsValid)
            {
                afterWelding.SamplingTime = DateTime.Now;
                afterWelding.Samplingor = ((Users)Session["User"]).UserName;
                db.Entry(afterWelding).State = EntityState.Modified;
                await db.SaveChangesAsync();
                result.Add("result", true);
                result.Add("mes", "成功");
                return Content(JsonConvert.SerializeObject(result));
            }
            result.Add("result", false);
            result.Add("mes", "错误,数据格式不对");
            return Content(JsonConvert.SerializeObject(result));
        }
        #endregion

        #region ----------后焊首页
        public ActionResult AfterWeldingIndex()
        {
            if (Session["User"] == null)
            {
                return RedirectToAction("Login", "Users", new { col = "ModuleManagement", act = "AfterWeldingIndex" });
            }
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult AfterWeldingIndex(string ordernum, string barcode)
        {
            var afterWelding = db.AfterWelding.ToList();
            if (!string.IsNullOrEmpty(ordernum))
            {
                afterWelding = afterWelding.Where(c => c.Ordernum == ordernum).ToList();
            }
            if (!string.IsNullOrEmpty(barcode))
            {
                afterWelding = afterWelding.Where(c => c.ModuleBarcode == barcode).ToList();
            }


            return View(afterWelding);
        }
        #endregion


        //#region ----------后焊进行中和异常录入
        ////public async Task<ActionResult> AfterWeldingAbnormal(AfterWelding afterWelding)
        ////{
        ////    if (ModelState.IsValid)
        ////    {
        ////        db.Entry(afterWelding).State = EntityState.Modified;
        ////        await db.SaveChangesAsync();
        ////        return RedirectToAction("AfterWeldingCreate");
        ////    }
        ////    return View(afterWelding);
        ////}

        //#endregion
        
        #endregion

        #region------灌胶前电检工序
        //灌胶前电检工序
        // GET: ModuleManagement/ElectricInspectionBeforeGlueFillingCreate
        public ActionResult ElectricInspectionBeforeGlueFillingCreate()
        {
            if (Session["User"] == null)
            {
                return RedirectToAction("Login", "Users", new { col = "ModuleManagement", act = "ElectricInspectionBeforeGlueFillingCreate" });
            }
            return View();
        }

        // POST: ModuleManagement/ElectricInspectionBeforeGlueFillingCreate
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<ActionResult> ElectricInspectionBeforeGlueFillingCreate(ElectricInspection electricInspectionBeforeGlueFilling)
        {
            if (ModelState.IsValid)
            {
                db.ElectricInspection.Add(electricInspectionBeforeGlueFilling);
                await db.SaveChangesAsync();
                return RedirectToAction("ElectricInspectionBeforeGlueFillingCreate");
            }
            return View(electricInspectionBeforeGlueFilling);
        }
        #endregion

        #region------灌胶后电检工序
        //灌胶后电检工序
        // GET: ModuleManagement/ElectricInspectionAfterGlueFillingCreate
        public ActionResult ElectricInspectionAfterGlueFillingCreate()
        {
            if (Session["User"] == null)
            {
                return RedirectToAction("Login", "Users", new { col = "ModuleManagement", act = "ElectricInspectionAfterGlueFillingCreate" });
            }
            return View();
        }

        // POST: ModuleManagement/ElectricInspectionAfterGlueFillingCreate
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<ActionResult> ElectricInspectionAfterGlueFillingCreate(ElectricInspection electricInspectionAfterGlueFilling)
        {
            if (ModelState.IsValid)
            {
                db.ElectricInspection.Add(electricInspectionAfterGlueFilling);
                await db.SaveChangesAsync();
                return RedirectToAction("ElectricInspectionAfterGlueFillingCreate");
            }
            return View(electricInspectionAfterGlueFilling);
        }
        #endregion

        #region ------老化

        #region 老化新增
        public ActionResult BurninCreate()
        {
            if (Session["User"] == null)
            {
                return RedirectToAction("Login", "Users", new { col = "ModuleManagement", act = "BurninCreate" });
            }
            return View();
        }
        // POST: ModuleManagement/AfterWeldingCreate
        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<ActionResult> BurninCreate(ModuleBurnIn moduleBurn)
        {
            if (ModelState.IsValid)
            {
                db.ModuleBurnIn.Add(moduleBurn);
                await db.SaveChangesAsync();
                return RedirectToAction("AfterWeldingCreate");
            }
            return View(moduleBurn);
        }
        #endregion

        #region 老化异常输入
        public ActionResult BurninAbnormal()
        {
            if (Session["User"] == null)
            {
                return RedirectToAction("Login", "Users", new { col = "ModuleManagement", act = "BurninAbnormal" });
            }
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<ActionResult> BurninAbnormal(ModuleBurnIn moduleBurn)
        {
            if (ModelState.IsValid)
            {
                db.Entry(moduleBurn).State = EntityState.Modified;
                await db.SaveChangesAsync();
                return RedirectToAction("AfterWeldingCreate");
            }
            return View(moduleBurn);
        }

        #region 老化完成
        public ActionResult BurninComplete()
        {
            if (Session["User"] == null)
            {
                return RedirectToAction("Login", "Users", new { col = "ModuleManagement", act = "BurninComplete" });
            }
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<ActionResult> BurninComplete(ModuleBurnIn moduleBurn)
        {
            if (ModelState.IsValid)
            {
                db.Entry(moduleBurn).State = EntityState.Modified;
                await db.SaveChangesAsync();
                return RedirectToAction("AfterWeldingCreate");
            }
            return View(moduleBurn);
        }
        #endregion
        #endregion

        #endregion

        #region ------外观电检
        public ActionResult AppearanceCreate()
        {
            if (Session["User"] == null)
            {
                return RedirectToAction("Login", "Users", new { col = "ModuleManagement", act = "AppearanceCreate" });
            }
            return View();
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task<ActionResult> AppearanceCreate(ModuleAppearance moduleAppearance)
        {
            if (ModelState.IsValid)
            {
                db.ModuleAppearance.Add(moduleAppearance);
                await db.SaveChangesAsync();
                return RedirectToAction("AfterWeldingCreate");
            }
            return View(moduleAppearance);
        }
        #endregion
        
        #region ------装箱记录
        //public ActionResult GetInnerInfo(string ordernum)
        //{

        //}

        //#endregion

        //#region ------内箱记录
        //public ActionResult GetInnerInfo(string ordernum)
        //{

        //}

        #endregion

        #endregion

        //列表选择

        public ActionResult GetOrderNumList()
        {
            var orders = db.OrderMgm.OrderByDescending(m => m.ID).Where(c => c.Models != 0).Select(m => m.OrderNum).ToList();    //增加.Distinct()后会重新按OrderNum升序排序
            JArray result = new JArray();
            foreach (var item in orders)
            {
                JObject List = new JObject();
                List.Add("value", item);

                result.Add(List);
            }
            return Content(JsonConvert.SerializeObject(result));
        }


        #region 内箱标签打印
        /// <summary>
        /// 后台绘图后打印方法
        /// </summary>
        /// <param name="pagecount"></param>
        /// <param name="barcode"></param>
        /// <param name="modulenum"></param>
        /// <param name="concentration">浓度</param>

        /// <returns></returns>

        public ActionResult InsideBoxLablePrint(string modulenum, string orderNum, int pagecount, string language, string sntn, string barcode = "", string ip = "", int port = 0, int concentration = 5, bool testswitch = false)
        {
            var list = modulenum.Split(',');
            //开始绘制图片
            int initialWidth = 510, initialHeight = 250;//宽2高1
            Bitmap theBitmap = new Bitmap(initialWidth, initialHeight);
            Graphics theGraphics = Graphics.FromImage(theBitmap);
            Brush bush = new SolidBrush(System.Drawing.Color.Black);//填充的颜色
            //呈现质量
            theGraphics.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
            //背景色
            theGraphics.Clear(System.Drawing.Color.FromArgb(120, 240, 180));

            Pen pen = new Pen(Color.Black, 3);
            theGraphics.DrawRectangle(pen, 36, 10, 460, 220); //460矩形的宽度 220矩形的高度
            //横线            
            theGraphics.DrawLine(pen, 36, 35, 495, 35);
            theGraphics.DrawLine(pen, 36, 60, 495, 60);
            theGraphics.DrawLine(pen, 36, 110, 495, 110);

            //竖线
            theGraphics.DrawLine(pen, 240, 10, 240, 60);

            //引入订单号文字
            StringFormat format = new StringFormat();
            format.Alignment = StringAlignment.Center; //居中 
            Rectangle orderRectangle = new Rectangle(14, 12, 245, 105);//文本矩形
            System.Drawing.Font myFont_order;
            myFont_order = new System.Drawing.Font("Microsoft YaHei UI", 14, FontStyle.Regular);
            if (language == "中")
            {
                theGraphics.DrawString("订   单   号", myFont_order, bush, orderRectangle, format);
            }
            else if (language == "英")
            {
                theGraphics.DrawString("Order  No", myFont_order, bush, orderRectangle, format);
            }
            else
            {
                Rectangle orderRectangle1 = new Rectangle(13, 12, 245, 105);//文本矩形
                theGraphics.DrawString("订单号 Order NO", myFont_order, bush, orderRectangle1, format);
            }

            //引入订单号值
            Rectangle orderNumberRectangle = new Rectangle(245, 12, 245, 105);
            theGraphics.DrawString(orderNum, myFont_order, bush, orderNumberRectangle, format);

            //引入件号、数文字
            if (language == "中")
            {
                Rectangle sntnRectangle = new Rectangle(12, 36, 245, 105);
                theGraphics.DrawString("件号 / 数", myFont_order, bush, sntnRectangle, format);
            }
            else if (language == "英")
            {
                Rectangle sntnRectangle = new Rectangle(12, 36, 245, 105);
                theGraphics.DrawString("SN / TN", myFont_order, bush, sntnRectangle, format);
            }
            else
            {
                Rectangle sntnRectangle = new Rectangle(21, 36, 245, 105);
                theGraphics.DrawString("件号 / 数（SN / TN）", myFont_order, bush, sntnRectangle, format);
            }

            //引入件号/数值
            Rectangle sntnValueRectangle = new Rectangle(245, 35, 245, 105);
            theGraphics.DrawString(sntn, myFont_order, bush, sntnValueRectangle, format);

            //引入条码
            StringFormat geshi = new StringFormat();
            geshi.Alignment = StringAlignment.Center; //居中
            Bitmap bmp_barcode = BarCodeLablePrint.BarCodeToImg(barcode, 380, 30);
            theGraphics.DrawImage(bmp_barcode, 80, 65, (float)(bmp_barcode.Width), (float)(bmp_barcode.Height));

            //引入条码号
            System.Drawing.Font myFont_modulebarcodenum;
            myFont_modulebarcodenum = new System.Drawing.Font("Malgun Gothic", 11, FontStyle.Regular);
            StringFormat geshi1 = new StringFormat();
            geshi1.Alignment = StringAlignment.Center; //居中
            theGraphics.DrawString(barcode, myFont_modulebarcodenum, bush, 260, 92, geshi);

            //// 引入模组号
            if (list.Length <= 4)
            {
                System.Drawing.Font myFont_modulenum_list;
                myFont_modulenum_list = new System.Drawing.Font("Microsoft YaHei UI", 20, FontStyle.Bold);
                StringFormat listformat = new StringFormat();
                listformat.Alignment = StringAlignment.Center;
                int top_y = 150;
                int left_x = 100;
                for (int i = 1; i < list.Count() + 1; i++)
                {
                    theGraphics.DrawString(list[i - 1], myFont_modulenum_list, bush, left_x, top_y, listformat);
                    left_x += 110;
                }
            }
            else if (list.Length > 4 && list.Length <= 8)
            {
                System.Drawing.Font myFont_modulenum_list;
                myFont_modulenum_list = new System.Drawing.Font("Microsoft YaHei UI", 18, FontStyle.Bold);
                StringFormat listformat = new StringFormat();
                listformat.Alignment = StringAlignment.Center;
                int top_y = 135;
                int left_x = 120;
                for (int i = 1; i < list.Count() + 1; i++)
                {
                    theGraphics.DrawString(list[i - 1], myFont_modulenum_list, bush, left_x, top_y, listformat);
                    if ((i % 4) != 0)
                    {
                        left_x += 100;
                    }
                    else
                    {
                        top_y += 40;
                        left_x -= 300;
                    }
                }
            }
            else if (list.Length > 8 && list.Length <= 12)
            {
                System.Drawing.Font myFont_modulenum_list;
                myFont_modulenum_list = new System.Drawing.Font("Microsoft YaHei UI", 18, FontStyle.Bold);
                StringFormat listformat = new StringFormat();
                listformat.Alignment = StringAlignment.Center;
                int top_y = 115;
                int left_x = 120;
                for (int i = 1; i < list.Count() + 1; i++)
                {
                    theGraphics.DrawString(list[i - 1], myFont_modulenum_list, bush, left_x, top_y, listformat);
                    if ((i % 4) != 0)
                    {
                        left_x += 100;
                    }
                    else
                    {
                        top_y += 40;
                        left_x -= 300;
                    }
                }
            }
            else if (list.Length > 12 && list.Length <= 16)
            {
                System.Drawing.Font myFont_modulenum_list;
                myFont_modulenum_list = new System.Drawing.Font("Microsoft YaHei UI", 14, FontStyle.Bold);
                StringFormat listformat = new StringFormat();
                listformat.Alignment = StringAlignment.Center;
                int top_y = 115;
                int left_x = 120;
                for (int i = 1; i < list.Count() + 1; i++)
                {
                    theGraphics.DrawString(list[i - 1], myFont_modulenum_list, bush, left_x, top_y, listformat);
                    if ((i % 4) != 0)
                    {
                        left_x += 100;
                    }
                    else
                    {
                        top_y += 30;
                        left_x -= 300;
                    }
                }
            }
            else
            {

            }

            string data = "^XA^MD" + concentration + "~DGR:ZONE.GRF,";//^MD5浓度
            Bitmap bm = new Bitmap(BarCodeLablePrint.ConvertTo1Bpp1(BarCodeLablePrint.ToGray(theBitmap)));//图形转二值

            //string ip = "172.16.99.240";//打印机IP地址
            //int port = 9101;//打印机端口

            if (testswitch == true)
            {
                MemoryStream ms = new MemoryStream();
                theBitmap.Save(ms, System.Drawing.Imaging.ImageFormat.Png);
                theBitmap.Dispose();
                return File(ms.ToArray(), "image/Png");
            }
            else
            {
                int totalbytes = bm.ToString().Length;
                int rowbytes = 10;
                string hex = ZebraUnity.BmpToZpl(bm, out totalbytes, out rowbytes);
                data += totalbytes + "," + rowbytes + "," + hex;
                data += "^LH0,0^FO150,0^XGR:ZONE.GRF^FS^XZ";
                string result = ZebraUnity.IPPrint(data.ToString(), pagecount, ip, port);
                return Content(result);
            }
        }

        #endregion

        #region---模块条码打印---30*40
        public ActionResult ModuleBarcodePrinting1(string[] modulenum, int pagecount, string barcode = "", string ip = "", int port = 0, int concentration = 5, bool testswitch = false)
        {
            //开始绘制图片
            int initialWidth = 520, initialHeight = 250;//宽2高1
            Bitmap theBitmap = new Bitmap(initialWidth, initialHeight);
            Graphics theGraphics = Graphics.FromImage(theBitmap);
            Brush bush = new SolidBrush(System.Drawing.Color.Black);//填充的颜色
            //呈现质量
            theGraphics.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
            //背景色
            theGraphics.Clear(System.Drawing.Color.FromArgb(120, 240, 180));

            Pen pen = new Pen(Color.Black, 1);
            theGraphics.DrawRectangle(pen, 32, 8, 475, 238); //460矩形的宽度 220矩形的高度
            //横线            
            theGraphics.DrawLine(pen, 32, 40, 502, 40);
            theGraphics.DrawLine(pen, 32, 40, 502, 40);
            theGraphics.DrawLine(pen, 32, 72, 502, 72);
            theGraphics.DrawLine(pen, 32, 104, 502, 104);
            theGraphics.DrawLine(pen, 32, 136, 502, 136);
            theGraphics.DrawLine(pen, 32, 168, 502, 168);
            theGraphics.DrawLine(pen, 32, 200, 502, 200);
            //竖线
            theGraphics.DrawLine(pen, 260, 0, 260, 235);

            //引入条码
            int cout = 0;
            int left_x = 10;
            int top_y = 50;
            int left_xx = 23;
            int top_yy = 140;
            foreach (var item in modulenum)
            {
                if (cout <= 5)
                {
                    //条形码
                    StringFormat geshi = new StringFormat();
                    geshi.Alignment = StringAlignment.Center; //居中
                    Bitmap bmp_barcode = BarCodeLablePrint.BarCodeToImg(item, 200, 16);
                    theGraphics.DrawImage(bmp_barcode, top_y, left_x, (float)(bmp_barcode.Width), (float)(bmp_barcode.Height));

                    //条码号
                    System.Drawing.Font myFont_modulebarcodenum;
                    myFont_modulebarcodenum = new System.Drawing.Font("Malgun Gothic", 8, FontStyle.Regular);
                    StringFormat geshi1 = new StringFormat();
                    geshi1.Alignment = StringAlignment.Center; //居中
                    theGraphics.DrawString(item, myFont_modulebarcodenum, bush, top_yy, left_xx, geshi);
                    cout++;
                    left_x += 32;
                    left_xx += 32;
                }
                else if (cout >= 6 && cout <= 11)
                {
                    if (cout == 6)
                    {
                        left_x = 10;
                        left_xx = 23;
                        top_y = 290;
                        top_yy = 385;
                    }
                    //条形码
                    StringFormat geshi = new StringFormat();
                    geshi.Alignment = StringAlignment.Center; //居中
                    Bitmap bmp_barcode = BarCodeLablePrint.BarCodeToImg(item, 200, 16);
                    theGraphics.DrawImage(bmp_barcode, top_y, left_x, (float)(bmp_barcode.Width), (float)(bmp_barcode.Height));

                    //条码号
                    System.Drawing.Font myFont_modulebarcodenum;
                    myFont_modulebarcodenum = new System.Drawing.Font("Malgun Gothic", 8, FontStyle.Regular);
                    StringFormat geshi1 = new StringFormat();
                    geshi1.Alignment = StringAlignment.Center; //居中
                    theGraphics.DrawString(item, myFont_modulebarcodenum, bush, top_yy, left_xx, geshi);
                    cout++;
                    if (cout > 6)
                    {
                        left_x += 32;
                        left_xx += 32;
                    }
                }
            }

            string data = "^XA^MD" + concentration + "~DGR:ZONE.GRF,";//^MD5浓度
            Bitmap bm = new Bitmap(BarCodeLablePrint.ConvertTo1Bpp1(BarCodeLablePrint.ToGray(theBitmap)));//图形转二值

            if (testswitch == true)
            {
                MemoryStream ms = new MemoryStream();
                theBitmap.Save(ms, System.Drawing.Imaging.ImageFormat.Png);
                theBitmap.Dispose();
                return File(ms.ToArray(), "image/Png");
            }
            else
            {
                int totalbytes = bm.ToString().Length;
                int rowbytes = 10;
                string hex = ZebraUnity.BmpToZpl(bm, out totalbytes, out rowbytes);
                data += totalbytes + "," + rowbytes + "," + hex;
                data += "^LH0,0^FO150,0^XGR:ZONE.GRF^FS^XZ";
                string result = ZebraUnity.IPPrint(data.ToString(), pagecount, ip, port);
                return Content(result);
            }
        }
        #endregion

        #region---模块条码打印
        public ActionResult ModuleBarcodePrinting(string[] modulenum, int pagecount, string barcode = "", string ip = "", int port = 0, int concentration = 5, bool testswitch = false)
        {
            //开始绘制图片
            int initialWidth = 750, initialHeight = 1000;//宽2高1
            Bitmap theBitmap = new Bitmap(initialWidth, initialHeight);
            Graphics theGraphics = Graphics.FromImage(theBitmap);
            Brush bush = new SolidBrush(System.Drawing.Color.Black);//填充的颜色
            //Brush bush1 = new SolidBrush(System.Drawing.Color.Black);//填充的颜色
            //呈现质量
            theGraphics.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
            //背景色
            theGraphics.Clear(System.Drawing.Color.FromArgb(255, 255, 255));

            Pen pen = new Pen(Color.Black, 3);
            theGraphics.DrawRectangle(pen, 5, 40, 675, 895); //460矩形的宽度 220矩形的高度

            ////横线 
            int x_axis = 5;
            int y_axis = 72;
            int high = 678;
            for (var i = 0; i < 27; i++)
            {
                theGraphics.DrawLine(pen, x_axis, y_axis, high, y_axis);
                y_axis += 32;
            }

            ////竖线
            theGraphics.DrawLine(pen, 229, 40, 229, 935);
            theGraphics.DrawLine(pen, 453, 40, 453, 935);

            //引入条码
            int cout = 0;
            int left_x = 44;
            int top_y = 19;
            int left_xx = 57;
            int top_yy = 120;
            foreach (var item in modulenum)
            {
                if (cout <= 27)
                {
                    //条形码
                    StringFormat geshi = new StringFormat();
                    geshi.Alignment = StringAlignment.Center; //居中
                    Bitmap bmp_barcode = BarCodeLablePrint.BarCodeToImg(item, 200, 16);
                    theGraphics.DrawImage(bmp_barcode, top_y, left_x, (float)(bmp_barcode.Width), (float)(bmp_barcode.Height));

                    //条码号
                    System.Drawing.Font myFont_modulebarcodenum;
                    myFont_modulebarcodenum = new System.Drawing.Font("Malgun Gothic", 8, FontStyle.Regular);
                    theGraphics.DrawString(item, myFont_modulebarcodenum, bush, top_yy, left_xx, geshi);
                    cout++;
                    left_x += 32;
                    left_xx += 32;
                }
                else if (cout >= 28 && cout <= 55)
                {
                    if (cout == 28)
                    {
                        left_x = 44;
                        top_y = 245;

                        left_xx = 57;
                        top_yy = 350;
                    }
                    //条形码
                    StringFormat geshi = new StringFormat();
                    geshi.Alignment = StringAlignment.Center; //居中
                    Bitmap bmp_barcode = BarCodeLablePrint.BarCodeToImg(item, 200, 16);
                    theGraphics.DrawImage(bmp_barcode, top_y, left_x, (float)(bmp_barcode.Width), (float)(bmp_barcode.Height));

                    //条码号
                    System.Drawing.Font myFont_modulebarcodenum;
                    myFont_modulebarcodenum = new System.Drawing.Font("Malgun Gothic", 8, FontStyle.Regular);
                    theGraphics.DrawString(item, myFont_modulebarcodenum, bush, top_yy, left_xx, geshi);
                    cout++;
                    if (cout > 28 && cout <= 55)
                    {
                        left_x += 32;
                        left_xx += 32;
                    }
                }
                else if (cout >= 56 && cout <= 83)
                {
                    if (cout == 56)
                    {
                        left_x = 44;
                        top_y = 471;

                        left_xx = 57;
                        top_yy = 580;
                    }
                    //条形码
                    StringFormat geshi = new StringFormat();
                    geshi.Alignment = StringAlignment.Center; //居中
                    Bitmap bmp_barcode = BarCodeLablePrint.BarCodeToImg(item, 200, 16);
                    theGraphics.DrawImage(bmp_barcode, top_y, left_x, (float)(bmp_barcode.Width), (float)(bmp_barcode.Height));

                    //条码号
                    System.Drawing.Font myFont_modulebarcodenum;
                    myFont_modulebarcodenum = new System.Drawing.Font("Malgun Gothic", 8, FontStyle.Regular);
                    theGraphics.DrawString(item, myFont_modulebarcodenum, bush, top_yy, left_xx, geshi);
                    cout++;
                    if (cout > 56 && cout <= 83)
                    {
                        left_x += 32;
                        left_xx += 32;
                    }

                }
            }

            string data = "^XA^MD" + concentration + "~DGR:ZONE.GRF,";//^MD5浓度
            Bitmap bm = new Bitmap(BarCodeLablePrint.ConvertTo1Bpp1(BarCodeLablePrint.ToGray(theBitmap)));//图形转二值

            if (testswitch == true)
            {
                MemoryStream ms = new MemoryStream();
                theBitmap.Save(ms, System.Drawing.Imaging.ImageFormat.Png);
                theBitmap.Dispose();
                return File(ms.ToArray(), "image/Png");
            }
            else
            {
                int totalbytes = bm.ToString().Length;
                int rowbytes = 10;
                string hex = ZebraUnity.BmpToZpl(bm, out totalbytes, out rowbytes);
                data += totalbytes + "," + rowbytes + "," + hex;
                data += "^LH0,0^FO70,0^XGR:ZONE.GRF^FS^XZ";
                string result = ZebraUnity.IPPrint(data.ToString(), pagecount, ip, port);
                return Content(result);
            }
        }

        public ActionResult ModuleBarcodePrinting2(string[] modulenum, int pagecount, string barcode = "", string ip = "", int port = 0, int concentration = 5, bool testswitch = false)
        {
            string[] modulelist = new string[6];
            modulelist[0] = "2019YA00101B00001";
            modulelist[1] = "2019YA00101B00002";
            modulelist[2] = "2019YA00101B00003";
            //modulelist[3] = "2019YA00101B00004";
            //modulelist[4] = "2019YA00101B00005";
            //modulelist[5] = "2019YA00101B00006";

            //开始绘制图片
            int initialWidth = 716, initialHeight = 33;//宽2高1
            Bitmap theBitmap = new Bitmap(initialWidth, initialHeight);
            Graphics theGraphics = Graphics.FromImage(theBitmap);
            Brush bush = new SolidBrush(System.Drawing.Color.Black);//填充的颜色
            //Brush bush1 = new SolidBrush(System.Drawing.Color.Black);//填充的颜色
            //呈现质量
            theGraphics.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
            //背景色
            theGraphics.Clear(System.Drawing.Color.FromArgb(255, 255, 255));

            Pen pen = new Pen(Color.Black, 1);
            //theGraphics.DrawRectangle(pen, 0, 0, 700, 33); //460矩形的宽度 220矩形的高度
            ////横线 
            //theGraphics.DrawLine(pen, 0, 30, 932, 30);
            ////竖线
            //theGraphics.DrawLine(pen, 229, 0, 229, 28);
            //theGraphics.DrawLine(pen, 453, 0, 453, 28);

            //引入条码
            int default_left_y = 0;
            int default_top_x = 5;
            double default_left_yy = 9;
            int default_top_xx = 90;
            //int left_y = 0;
            int top_x = 5;
            //int left_yy = 13;
            int top_xx = 90;
            StringFormat geshi = new StringFormat();
            geshi.Alignment = StringAlignment.Center; //居中
            System.Drawing.Font myFont_modulebarcodenum;
            myFont_modulebarcodenum = new System.Drawing.Font("Malgun Gothic", 10, FontStyle.Bold);
            for (var i = 1; i < modulenum.Count() + 1; i++)
            {
                if ((i % 3) == 0)
                {
                    //条形码
                    Bitmap bmp_barcode = BarCodeLablePrint.BarCodeToImg(modulenum[i - 1], 200, 14);
                    theGraphics.DrawImage(bmp_barcode, top_x, default_left_y, (float)(bmp_barcode.Width), (float)(bmp_barcode.Height));

                    //条码号
                    theGraphics.DrawString(modulenum[i - 1], myFont_modulebarcodenum, bush, top_xx, (float)default_left_yy, geshi);
                    top_x = default_top_x;
                    top_xx = default_top_xx;
                }
                else
                {
                    //条形码
                    Bitmap bmp_barcode = BarCodeLablePrint.BarCodeToImg(modulenum[i - 1], 200, 14);
                    theGraphics.DrawImage(bmp_barcode, top_x, default_left_y, (float)(bmp_barcode.Width), (float)(bmp_barcode.Height));

                    //条码号
                    theGraphics.DrawString(modulenum[i - 1], myFont_modulebarcodenum, bush, top_xx, (float)default_left_yy, geshi);
                    top_x += 228;
                    top_xx += 239;
                }
            }

            string data = "^XA^MD" + concentration + "~DGR:ZONE.GRF,";//^MD5浓度
            Bitmap bm = new Bitmap(BarCodeLablePrint.ConvertTo1Bpp1(BarCodeLablePrint.ToGray(theBitmap)));//图形转二值

            if (testswitch == true)
            {
                MemoryStream ms = new MemoryStream();
                theBitmap.Save(ms, System.Drawing.Imaging.ImageFormat.Png);
                theBitmap.Dispose();
                return File(ms.ToArray(), "image/Png");
            }
            else
            {
                int totalbytes = bm.ToString().Length;
                int rowbytes = 10;
                string hex = ZebraUnity.BmpToZpl(bm, out totalbytes, out rowbytes);
                data += totalbytes + "," + rowbytes + "," + hex;
                data += "^LH0,0^FO60,0^XGR:ZONE.GRF^FS^XZ";

                ////指令输出打印
                //concentration = 10;
                //data = "^XA^MD" + concentration + "^LH0,0.5^FO58,5^BCN,14,N,N^BY1,1,14^FD2019YA00101B00001^FS";//第一个条码
                //data += "^FO290,5^BCN,14,N,N^BY1,1,14^FD2019YA00101B00002^FS";//第二个条码
                //data += "^FO523,5^BCN,14,N,N^BY1,1,14^FD" + modulelist[2] + "^FS";// +^FSXZ第三个条码
                //data += "^FO90,20^A@N,9,5^FD2019YA00101B00001^FS";//第一个条码的字符数字
                //data += "^FO330,20^A@N,9,5^FD2019YA00101B00002^FS";//第二个条码的字符数字
                //data += "^FO570,20^A@N,9,5^FD" + modulelist[2] + "^FS^XZ";//第三个条码的字符数字


                string result = ZebraUnity.IPPrint(data.ToString(), pagecount, ip, port);
                return Content(result);

                /*条码打印命令说明
                ^XA //条码打印指令开始
                ^MD30 //设置色带颜色的深度, 取值范围从-30到30
                ^LH60,10 //设置条码纸的边距
                ^FO20,10 //设置条码左上角的位置
                ^ACN,18,10 //设置字体
                ^BY1.4,3,50 //设置条码样式。1.4是条码的缩放级别，3是条码中粗细柱的比例, 50是条码高度
                ^BC,,Y,N //打印code128的指令
                ^FD12345678^FS //设置要打印的内容, ^FD是要打印的条码内容^FS表示换行
                ^XZ //条码打印指令结束
                */
                //上面的指令会打印12345678的CODE128的条码
            }
        }

        #endregion

    }
}
