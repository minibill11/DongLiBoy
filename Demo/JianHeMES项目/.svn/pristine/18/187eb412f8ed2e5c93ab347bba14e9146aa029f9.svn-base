@model IEnumerable<JianHeMES.Models.Burn_in_MosaicScreen>

@{
    ViewBag.Title = "老化拼屏查询";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script src="~/Scripts/Bootstraps/Element-ui.js"></script>
<link href="~/Scripts/Bootstraps/Element-ui.css" rel="stylesheet" />
<script src="~/Scripts/axios.min.js"></script>
<style>
    * {
        margin: 0;
        padding: 0;
    }

    .grid-card {
        margin-bottom: 10px;
    }

    .el-card {
        border: 1px solid #9C9791;
    }

    .el-main, .el-aside {
        padding: 8px 15px;
    }

    .el-header {
        padding: 0 15px;
        height: auto !important;
    }

    .el-card__header {
        text-align: center;
        border-bottom: 1px solid #9C9791;
        padding: 8px 15px;
    }

    .cardbody {
        border: 1px solid #D2CFCF;
        margin: -1px;
    }

    .el-card__body {
        height: 250px;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 0px;
    }

    .cardbody-right {
        padding: 5px;
        text-align: center
    }

    .cardbody-left {
        padding: 5px 0px;
        border-right: 1px solid #D2CFCF;
        text-align: center;
        vertical-align: middle;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .barcodeSpan {
        /*cursor: pointer;*/
        padding: 1px 3px;
        display: inline-block;
        border-radius: 6px;
    }

        .barcodeSpan:hover {
            background-color: #efe2c5;
        }

    .statuinfo {
        float: right;
        margin: 0 5px;
        height: 28px;
        line-height: 28px;
    }

    @@media screen and (max-width:768px) {
        .statuinfo {
            float: left;
        }
    }
</style>

<div id="app" v-cloak>
    <h2 class="text-center">@ViewBag.Title</h2>
    <el-container>
        <el-header>
            <el-row>
                <a href="/Burn_in_MosaicScreen/mosaicScreen_B"><el-button size="mini">开始拼屏</el-button></a>
                <a href="/Burn_in_MosaicScreen/mosaicScreen_ShelfQueryHistory"><el-button size="mini">历史记录</el-button></a>
                @*<el-button size="small">@Html.ActionLink("结束拼屏", "mosaicScreen_F")</el-button>*@
                <div class="statuinfo">
                    <span style="display: inline-block; background: green;width: 10px;height: 10px;"></span> 正常&nbsp;
                    <span style="display: inline-block; background: red;width: 10px;height: 10px;"></span> 异常&nbsp;
                    <span style="display: inline-block; background: black;width: 10px;height: 10px;"></span> 未开始老化
                </div>
            </el-row>
        </el-header>
        <el-main v-loading="loading" style="min-height:600px;">
            <el-row :gutter="10">
                <template v-for="item in dataList">
                    <el-col :xs="24" :sm="12" :md="8" :lg="6" :xl="6">
                        <el-card shadow="hover" class="grid-card">
                            <div slot="header" v-on:click="editShelfNum(item.ShelfNum)" style="cursor:pointer">
                                <span>{{'老化架号:'+item.ShelfNum+' (总数:'+ shelfCount(item.content)+')'}}</span>
                                @*<el-button size="mini" round style="font-size:11px;padding:5px;">修改架号</el-button>*@
                            </div>
                            <div v-for="order in item.content">
                                <el-container class="cardbody">
                                    <el-aside style="width:100px;" class="cardbody-left">{{order.ordernum}}<br />(数量:{{Object.keys(order.barcodelist).length}})</el-aside>
                                    <el-main class="cardbody-right">
                                        <template v-for="i in order.barcodelist">
                                            <el-popover placement="right"
                                                        title="条码异常信息"
                                                        trigger="hover"
                                                        v-bind:disabled="i.status=='2'?false:true">
                                                <div>{{i.Abnormal}}</div>
                                                <div class="barcodeSpan" slot="reference" v-bind:style="(i.status=='1')?({color:'green'}):(i.status=='2')?({color:'red'}):''">{{i.barcode}}</div>
                                            </el-popover>
                                        </template>
                                    </el-main>
                                </el-container>
                            </div>
                        </el-card>
                    </el-col>
                </template>
            </el-row>
            <el-row v-show="isData==false">
                <el-alert title="目前没有拼屏记录！"
                          type="info"
                          :closable="false"
                          center
                          show-icon>
                </el-alert>
            </el-row>
        </el-main>
    </el-container>
</div>
<script>
    var app = new Vue({
        el: "#app",
        data: {
            dataList: [],
            isData: false,
            loading: true
        },
        methods: {
            request: () => {
                this.dataList = [];
                axios.post("/Burn_in_MosaicScreen/mosaicScreen_ShelfQueryData").then(response => {
                    //console.log(response.data)
                    if (response.data == "没有数据") {
                        app.isData = false;
                    } else {
                        app.dataList = response.data;
                        app.isData = true;
                    };
                    app.loading = false;
                }).catch(error => {
                    console.warn("读取数据失败" + error)
                });
            },
            shelfCount: function (v) {
                let vCount = 0;
                for (let s in v) {
                    vCount += Object.keys(v[s].barcodelist).length;
                };
                return vCount;
            },
            editShelfNum: function (v) {
                this.$prompt('如需修改，请输入正确的老化架号:', '修改老化架号', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    inputPattern: /^\d{4}$/,
                    inputErrorMessage: '老化架号不正确！'
                }).then(({ value }) => {
                    //修改老化架号
                    axios.post("/Burn_in_MosaicScreen/editShelfNum", {
                        oldShelfNum: v,
                        newShelfNum: value
                    }).then(res => {
                        this.$message({
                            type: 'success',
                            message: '老化架号' + v + '修改为: ' + value
                        });
                    }).catch(error => {
                        console.warn("失败");
                    });
                }).catch(() => {
                    console.warn("取消");
                });
            }
        },
        created: function () {
            this.request();
            setInterval(function () {
                app.request();
            }, 10000)
        }
    });
</script>