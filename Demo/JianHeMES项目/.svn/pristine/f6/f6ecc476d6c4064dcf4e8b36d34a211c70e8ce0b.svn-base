@{
    ViewBag.Title = "仓库入库信息";
}
@* css放置处 *@
@section cssStyle {
    <link rel="stylesheet/less" type="text/css" href="~/Content/styleFile/warehouseMaterial/warehouse.less" />
}
<div id="app" v-cloak>
    <el-container>
        <el-header class="text-center">
            @*菜单*@
            <module-menu-component name="MaterialBasicInfo" title="@ViewBag.Title"></module-menu-component>
        </el-header>
        <el-main v-loading="loading">
            <el-row class="main">
                <el-col :span="12" :xs="24">
                    <div class="flex-item">
                        <label class="typeblue">查询方式</label>
                        <div>
                            <el-select v-model="queryType"
                                       placeholder="请选择查询类型"
                                       class="typeblue"
                                       size="medium">
                                <el-option label="采购合同单号" value="合同单号"></el-option>
                                <el-option label="物料编号" value="物料编号"></el-option>
                            </el-select>
                        </div>
                    </div>
                    <div class="flex-item barcodeDiv" v-bind:class="message!=''?'is-error':''">
                        <label>{{queryType}}</label>
                        <div>
                            <el-input v-if="queryType=='合同单号'"
                                      placeholder="输入号码后回车查询"
                                      v-model.trim="hetongQuery.value"
                                      @@keyup.native.enter="getErpInfo($event)"
                                      @*@@blur.native.capture="getErpInfo($event)"*@
                                      size="medium"
                                      autofocus
                                      clearable>
                            </el-input>
                            <el-input v-if="queryType=='物料编号'"
                                      placeholder="输入号码后回车查询"
                                      v-model.trim="Material.MaterialNumber"
                                      @@keyup.native.enter="getErpInfo($event)"
                                      @*@@blur.native.capture="getErpInfo($event)"*@
                                      size="medium"
                                      autofocus
                                      clearable>
                            </el-input>
                            <div class="el-form-item__error" v-show="message!=''">
                                {{message}}
                            </div>
                        </div>
                    </div>
                    <div class="flex-item" v-if="queryType=='合同单号'&&hetongQuery.list.length>0">
                        <label>物料编号</label>
                        <div>
                            <el-select v-model="Material.MaterialNumber"
                                       placeholder="请选择查询类型"
                                       @@change="hetongChange"
                                       size="medium">
                                <el-option v-for="item in hetongQuery.list"
                                           :key="item"
                                           :label="item"
                                           :value="item">
                                </el-option>
                            </el-select>
                        </div>
                    </div>
                    <div class="flex-item">
                        <label>班组</label>
                        <div>
                            <el-select v-model="Group"
                                       placeholder="请选择班组"
                                       @*:disabled="disabledState"*@
                                       size="medium">
                                <el-option v-for="item in groupOptions"
                                           :key="item"
                                           :label="item"
                                           :value="item">
                                </el-option>
                            </el-select>
                        </div>
                    </div>
                    <div class="flex-item">
                        <label>物料类型</label>
                        <div>
                            <el-input placeholder="请输入物料类型"
                                      v-model.trim="Material.MaterialType"
                                      size="medium"
                                      clearable>
                            </el-input>
                        </div>
                    </div>
                    <div class="flex-item">
                        <label>单位</label>
                        <div>
                            <el-input placeholder="请输入单位"
                                      v-model.trim="Material.Unit"
                                      size="medium"
                                      clearable>
                            </el-input>
                        </div>
                    </div>
                    <div class="flex-item">
                        <label>供应商</label>
                        <div>
                            <el-input placeholder="请输入供应商"
                                      v-model.trim="Material.Supplier"
                                      size="medium"
                                      clearable>
                            </el-input>
                        </div>
                    </div>
                    <div class="flex-item">
                        <label>收料人姓名</label>
                        <div>
                            <el-input placeholder="请输入收料人姓名"
                                      v-model.trim="Material.ReceivingClerk"
                                      size="medium"
                                      clearable>
                            </el-input>
                        </div>
                    </div>
                    <div class="flex-item">
                        <label>来料数量</label>
                        <div>
                            <el-input-number v-model.trim="Material.MaterialNum"
                                             size="small"
                                             :min="0"
                                             style="width:auto"
                                             clearable>
                            </el-input-number>
                        </div>
                    </div>
                    <div class="flex-item">
                        <label>来料日期</label>
                        <div>
                            <el-date-picker v-model="Material.InvoiceDate"
                                            @@change="changeInvoiceDate"
                                            type="date"
                                            placeholder="选择来料日期"
                                            size="medium">
                            </el-date-picker>
                        </div>
                    </div>
                    <div class="flex-item">
                        <label>生产日期</label>
                        <div>
                            <el-date-picker v-model="Material.LeaveFactoryTime"
                                            type="date"
                                            placeholder="选择生产日期"
                                            size="medium">
                            </el-date-picker>
                        </div>
                    </div>
                    <div class="flex-item">
                        <label>批次</label>
                        <div>
                            <el-input placeholder="请输入批次"
                                      v-model.trim="Material.Batch"
                                      size="medium"
                                      clearable>
                            </el-input>
                        </div>
                    </div>
                    <div class="flex-item">
                        <label>物料规格描述</label>
                        <div>
                            <el-input placeholder="请输入物料规格描述"
                                      v-model.trim="Material.MaterialDiscription"
                                      type="textarea"
                                      autofocus
                                      clearable>
                            </el-input>
                        </div>
                    </div>
                    <div class="flex-item">
                        <label>有效期(天)</label>
                        <div>
                            <el-input-number v-model.trim="Material.EffectiveDay"
                                             size="small"
                                             :min="0"
                                             style="width:auto"
                                             clearable>
                            </el-input-number>
                        </div>
                    </div>
                    @*<div class="flex-item">
                            <label>追加有效期(天)</label>
                            <div>
                                <el-input-number v-model.trim="Material.AddEffectiveDay"
                                                 size="small"
                                                 :min="0"
                                                 style="width:auto"
                                                 clearable>
                                </el-input-number>
                            </div>
                        </div>*@
                    <div class="flex-item">
                        <label>物料条码所包含物料个数</label>
                        <div>
                            <el-input-number v-model.trim="materialContainNum"
                                             size="small"
                                             :min="0"
                                             style="width:auto"
                                             clearable>
                            </el-input-number>
                        </div>
                    </div>
                    <div class="flex-item">
                        <div>
                            <el-button v-on:click="clear" type="primary" size="small">重置</el-button>
                            <el-button v-on:click="postPrint" type="primary" size="small">确认</el-button>
                        </div>
                    </div>
                </el-col>
                <el-col :span="12" :xs="24" class="rightFrame">
                    <ware-print-component v-model="printData">
                        <print-component v-model="printInfo"></print-component>
                    </ware-print-component>
                </el-col>
            </el-row>
        </el-main>
    </el-container>
</div>
@* 分部页放置处 *@
@section renderPage {
    @RenderPage("_warehouseMenu.cshtml")
    @RenderPage("~/Views/ModuleManagement/_print.cshtml")
    @RenderPage("_warePrint.cshtml")
    @RenderPage("_wareEdit.cshtml")
}
@* js放置处 *@
@section jsScript {
    <script src="~/Scripts/printJS/JsBarcode.all.min.js"></script>
    <script src="~/Content/styleFile/warehouseMaterial/warehouse.js"></script>
    <script>
        const app = {
            data: function () {
                return {
                    //入库
                    Material: {
                        MaterialNumber: "",
                        MaterialDiscription: "",
                        Batch: "",
                        MaterialNum: 0,
                        Unit: "",
                        Department: "",
                        Group: "",
                        ReceivingClerk: "",
                        InvoiceDate: "",
                        LeaveFactoryTime: "",
                        Supplier: "",
                        MaterialType: "",
                        EffectiveDay: 180,
                        AddEffectiveDay: 0,
                    },
                    materialContainNum: 0,
                    printData: {
                        list: [],
                        num: '',
                        discription: ''
                    },
                    queryType: '',
                    message: "",
                    hetongQuery: {
                        value: '',
                        list: [],
                        deco: []
                    }
                }
            },
            mixins: [warehouse],
            mounted() {
                let localQueryType = localStorage.getItem('cangkuQueryType');
                if (localQueryType != null) {
                    this.queryType = localQueryType;
                };
            },
            watch: {
                queryType(v) {
                    localStorage.setItem('cangkuQueryType', v);
                    this.message = '';
                    this.Material.MaterialNumber = '';
                    this.hetongQuery = {
                        value: '',
                        list: [],
                        deco: []
                    };
                },
                'Material.MaterialNumber'(v) {
                    this.message = '';
                }
            },
            methods: {
                //验证条码，录入信息，打印条码，
                postPrint() {
                    this.loading = true;
                    this.Material.Group = this.Group;
                    this.Material.Department = this.Department;
                    //录入数据
                    axios.post('/Warehouse_Material/MaterialBasicInfo', {
                        materialBasicInfo_Collection: this.Material,
                        materialContainNum: this.materialContainNum
                    }).then(res => {
                        if (res.data.Res) {
                            this.printData = {
                                list: res.data.BarcodeList,
                                num: res.data.bacrcodNum,
                                discription: res.data.MaterialDiscription,
                                materialNumber: this.Material.MaterialNumber,
                                batch: this.Material.Batch,
                            };
                            this.message.success(res.data.Meg);
                            this.clear();
                            this.loading = false;
                        } else {
                            this.$alert(res.data.Meg, {
                                closeOnClickModal: true,
                                closeOnPressEscape: true,
                                type: "error",
                            });
                            this.loading = false;
                        };
                    }).catch(err => {
                        console.warn("post失败")
                        this.loading = false;
                    });
                },
                //清空
                clear() {
                    this.Material = {
                        MaterialNumber: "",
                        MaterialDiscription: "",
                        Batch: "",
                        MaterialNum: 0,
                        Unit: "",
                        Department: this.Department,
                        Group: this.Group,
                        ReceivingClerk: "",
                        InvoiceDate: "",
                        LeaveFactoryTime: "",
                        Supplier: "",
                        MaterialType: "",
                        EffectiveDay: 180,
                        AddEffectiveDay: 0,
                    };
                    this.materialContainNum = 0;
                    this.message = '';
                },
                changeInvoiceDate(v) {
                    if (v) {
                        this.Material.LeaveFactoryTime = v;
                        let y = v.getFullYear().toString(),
                            m = (v.getMonth() + 1).toString().padStart(2, "0"),
                            d = v.getDate().toString().padStart(2, "0");
                        this.Material.Batch = `${y.substr(y.length - 2)}${m}${d}`;
                    } else {
                        this.Material.Batch = '';
                    };
                },
                getErpInfo(v) {
                    this.message = '';
                    if (v.target.value == '') {
                        this.message = `${this.queryType}为空`;
                        return;
                    };
                    let url = '', paramName = '';
                    if (this.queryType == '合同单号') {
                        url = '/Warehouse_Material/AccordContract';
                        paramName = 'purchaseNumber';
                    } else if (this.queryType == '物料编号') {
                        url = '/Warehouse_Material/AccordInspection';
                        paramName = 'materialNumber';
                    };
                    if (url == '' || paramName == '') {
                        this.message = '没有选择查询方式';
                        return;
                    };

                    axios.post(url, { [paramName]: v.target.value }).then(res => {
                        if (this.queryType == '合同单号') {
                            if (Object.keys(res.data).length > 0) {
                                this.hetongQuery.list = res.data.retul;
                                this.hetongQuery.deco = res.data.deco;
                                if (res.data.retul.length == 1) {
                                    this.Material.MaterialNumber = res.data.retul[0];
                                    this.Material.MaterialType = res.data.deco[0].type;
                                    this.Material.Unit = res.data.deco[0].pmn07;
                                    this.Material.Supplier = res.data.deco[0].rva05;
                                    this.Material.MaterialNum = res.data.deco[0].pmn20;
                                    this.Material.MaterialDiscription = res.data.deco[0].specification;
                                };
                                console.log(res.data);
                            } else {
                                this.message = `此${this.queryType}查不到信息，请手动录入`
                            };
                        } else if (this.queryType == '物料编号') {
                            if (res.data.length > 0) {
                                this.Material.MaterialType = res.data[0].type;
                                this.Material.Unit = res.data[0].img07;
                                this.Material.Supplier = res.data[0].rva05;
                                this.Material.MaterialNum = res.data[0].img08;
                                this.Material.MaterialDiscription = res.data[0].ima021;
                            } else {
                                this.message = `此${this.queryType}查不到信息，请手动录入`
                            };
                        };
                    }).catch(err => {
                        //this.message = '查询失败,请检查网络';
                        console.warn("post失败");
                    });
                },
                //
                hetongChange() {
                    if (this.Material.MaterialNumber == '') {
                        this.Material.MaterialType = '';
                        this.Material.Unit = '';
                        this.Material.Supplier = '';
                        this.Material.MaterialNum = '';
                        this.Material.MaterialDiscription = '';
                        return;
                    };
                    for (let i of this.hetongQuery.deco) {
                        if (i.rvb05 == this.Material.MaterialNumber) {
                            this.Material.MaterialType = i.type;
                            this.Material.Unit = i.pmn07;
                            this.Material.Supplier = i.rva05;
                            this.Material.MaterialNum = i.pmn20;
                            this.Material.MaterialDiscription = i.specification;
                        };
                    };
                }
            },
        };
    </script>
}