@{
    ViewBag.Title = "班组人员流失汇总";
}
@* css放置处 *@
@section cssStyle {
    <style>
        .el-table th > .cell {
            font-size: 14px;
        }

        .top_title {
            font-size: 24px;
            color: #293038;
            text-align: left;
        }
        /*统一表格字体*/
        .el-table thead {
            font-family: '微软雅黑 Bold', '微软雅黑';
            font-weight: 700;
            font-style: normal;
            color: #5E5E5E;
            height: 34px;
            background-color: rgba(228, 236, 248, 1);
        }

        .rightMain .rightMainContent {
            padding-top: 30px;
        }

        .table_top {
            display: flex;
            margin-bottom: 20px;
        }

        .el-input--medium .el-input__inner {
            height: 40px;
            line-height: 40px;
        }

        .m_left {
            width: 240px !important;
            height: 40px;
            margin-right: 10px;
        }

        .marginRight {
            margin-right: 10px;
            width: 240px;
        }

        .bottomInfo {
            padding: 5px 20px 20px;
            display: flex;
            justify-content: space-between;
        }

        .el-table__footer tbody td {
            background-color: #F0FAFF;
            border-top-color: rgba(64, 158, 255, 1);
            border-bottom-color: rgba(64, 158, 255, 1);
            font-weight: 700;
            z-index: 1;
        }
        .DuplicateData {
            color: red;
        }
    </style>
}

<div id="app" v-cloak>
    <el-container>
        <el-header>
            <span class="top_title">流失人数录入</span>
        </el-header>
        <el-main>
            <el-row class="table_top">
                @*日期选择框 *@
                <el-date-picker v-model="selectTime"
                                class="m_left"
                                type="date"
                                size="medium"
                                style="width:150px;"
                                placeholder="请选择日期">
                </el-date-picker>
                @*批量添加粘贴处 *@
                <textarea class="marginRight" v-model="inputText" placeholder="表格粘贴处..."></textarea>
                <el-button size="medium" v-on:click="goback2">返回</el-button>
            </el-row>
            <el-row class="text-center">
                <el-table :data="tableData"
                          min-height="234"
                          max-height="560"
                          size="small"
                          align="center"
                          cell-class-name="cellParent"
                          :summary-method="getSummaries"
                          show-summary
                          stripe
                          border>
                    <el-table-column prop="SerialNumber"
                                     label="序号"
                                     min-width="52"
                                     height="100">
                    </el-table-column>
                    <el-table-column prop="Department"
                                     label="部门"
                                     align="center"
                                     min-width="78">
                    </el-table-column>
                    <el-table-column prop="Group"
                                     label="班组"
                                     align="center"
                                     min-width="78">
                    </el-table-column>
                    <el-table-column prop="BeginNumber"
                                     label="月初人数"
                                     align="center"
                                     min-width="78">
                    </el-table-column>
                    <el-table-column prop="EndNumber"
                                     label="月末人数"
                                     align="center"
                                     min-width="78">
                    </el-table-column>
                    <el-table-column prop="AverageNum"
                                     label="月平均人数"
                                     align="center"
                                     min-width="100">
                    </el-table-column>
                    <el-table-column prop="LossNumber"
                                     label="流失人数"
                                     align="center"
                                     min-width="100">
                    </el-table-column>
                    <el-table-column label="操作" align="center">
                        <template slot-scope="scope">
                            <el-button v-bind:class="scope.row.color==200?'red':''" v-on:click.native.prevent="deleteRow(scope.$index, tableData)"
                                       class="delLine"
                                       type="text"
                                       size="small">
                                移除
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </el-row>
        </el-main>
    </el-container>
    @* 表格信息概述 *@
    <div class="bottomInfo" v-if="flag">
        <p class="pone">
            本次共提交
            <span style="color:red;font-size:18px;">{{count}}</span>条数据！
            <span v-if="flags" class="DuplicateData">存在{{numberOfzf}}条重复数据，请先手动移除其中重复数据再重新上传！</span>
        </p>
        <div>
            <el-button size="medium" @@click="delated">取消</el-button>
            <el-button type="primary" size="medium" @@click="postData">确认</el-button>
        </div>
    </div>
</div>
@* 分部页放置处 *@
@section renderPage {
}
@* js放置处 *@
@section jsScript {
    <script>
        // 返回上一页
        function goback2() {
            window.history.back();
        }
        const app = {
            data: function () {
                return {
                    selectTime: null,   // 所选时间
                    inputText: null,    // 批量上传班组流失率
                    tableData: [],      // 表格数据
                    numberOfzf: null,   //重复的数据数目
                    count: null,         //数据总条数
                    flag: false,       // 批量添加时为true
                    flags: false,      // 筛选重复的数据开关
                }
            },
            created: function () {
            },
            mounted: function () {
            },
            //函数方法
            methods: {
                //总计
                getSummaries(param) {
                    const { columns, data } = param;
                    const sums = [];
                    let sumData = this.sumList;
                    columns.forEach((column, index) => {
                        if (index === 6) {
                            sums[index] = '流失人数合计:';
                            return;
                        }
                    });
                    return sums;
                },

                // 删除单独行
                deleteRow(index) {
                    this.numberOfzf--;
                    if (this.numberOfzf > 0) {
                        this.flags = true;
                    } else if (this.numberOfzf <= 0) {
                        this.flags = false;
                    }
                    this.tableData.splice(index, 1);
                    this.count--;
                },

                // 取消上传
                delated() {
                    this.tableData = [];
                    this.count = 0;
                    this.numberOfzf = 0;
                    this.flags = false;
                },  

                //保存添加的数据
                postData() {
                    if (this.count > 0) {  //批量上传
                        if (this.selectTime != null) {
                            let dd = new Date(this.selectTime);
                            let year = dd.getFullYear();
                            let month = dd.getMonth() + 1;
                            let date = dd.getDate();
                            let dateLoss = year + '-' + month + '-' + date;
                            let dateLoss1 = year + '/' + month + '/' + date;
                            axios.post("/KPI/DeparturesNum", { turnoverRates: this.tableData, dateLoss: dateLoss }).then(res => {
                                console.log(res.data, 8)
                                if (res.data.meg == true) {
                                    this.$message({
                                        message: "录入成功！",
                                        type: "success"
                                    });
                                    this.tableData = [];
                                } else if (res.data.meg == false) {
                                    this.res1 = res.data.feg;
                                    this.numberOfzf = this.res1.length;
                                    if (this.numberOfzf > 0) {
                                        this.flags = true;
                                    } else if (this.numberOfzf <= 0) {
                                        this.flags = false;
                                    }
                                    console.log(this.numberOfzf, 56)
                                    for (let i = 0; i < this.res1.length; i++) {
                                        let str = this.res1[this.res1.length - 1];
                                        let Arr = str.split(";");
                                        console.log(Arr)
                                        //时间处理
                                        for (let j = 0; j < Arr.length - 1; j++) {
                                            let arr0 = Arr[j].split(",");
                                            let dates = arr0[2].split(" ");
                                            this.tableData.forEach(item => {
                                                if (arr0[0] == item.Department && arr0[1] == item.Group && dates[0] == dateLoss1) {
                                                    item.color = 200
                                                }
                                            })
                                        }
                                        this.$message({
                                            message: "存在重复信息，请手动移除！",
                                            type: "warning"
                                        });
                                    }
                                }
                            })
                        } else {
                            this.$message({
                                message: "请选择年月!",
                                type: "warning"
                            })
                        }
                    } else {
                        this.$message({
                            message: "请导入数据再上传!",
                            type: "warning"
                        })
                    }
                },
            },
            watch: {
                // 监听客诉损失粘贴框-- 渲染表格
                inputText(val) {
                    var valOfPaste = val.split("\n");
                    valOfPaste.pop();
                    var initDatas = []
                    valOfPaste.forEach((item, i) => {
                        var items = item.split("\t");
                        initDatas.push(items)
                    });
                    initDatas.forEach(item => {
                        let obj = {
                            SerialNumber: item[0], Department: item[1], Group: item[2], BeginNumber: item[3],
                            EndNumber: item[4], AverageNum: item[5], LossNumber: item[6], color: 202
                        };
                        this.tableData.push(obj);
                    });
                    this.count = this.tableData.length;
                    if (this.count <= 0) {
                        this.flag = false;
                    } else {
                        this.flag = true;
                    }
                    this.inputText = null;
                },
            }
        };
    </script>
}