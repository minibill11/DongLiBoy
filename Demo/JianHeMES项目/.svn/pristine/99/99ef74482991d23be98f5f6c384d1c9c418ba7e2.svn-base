@{
    ViewBag.Title = "7S评比得分汇总表";
}
@* css放置处 *@
@section cssStyle {
    <link href="~/Content/vxe.css" rel="stylesheet" />
    <style>
        #app {
            padding: 20px 20px 0 20px;
            font-family: '微软雅黑';
        }

        .title {
            font-weight: 400;
            font-size: 24px;
        }

        .action-box {
            width: 100%;
            padding: 20px 0;
            display: flex;
            align-content: center;
            justify-content: space-between;
        }

        .table-height {
            width: 100%;
            height: 70vh;
        }
        /*        表格*/
        .col-blue {
            background-color: #2db7f5;
            color: #fff;
        }

        .col--gutter {
            background-color: #2db7f5;
        }

        .col-color-red {
            color: red;
        }

            .col-color-red:hover {
                cursor: pointer;
                text-decoration: underline;
            }

        .note {
            color: #8a8a8a;
            padding-top: 8px;
            font-size: 12px;
        }
    </style>
}

<div id="app">
    <div class="title">
        7S评比得分汇总表
    </div>

    @*操作栏*@
    <div class="action-box">
        <div class="action-box-left">
            <el-select size="small" v-model="select_department" placeholder="请选择部门" style="width:150px;">
                <el-option v-for="item in department_options"
                           :key="item.value"
                           :label="item.label"
                           :value="item.value">
                </el-option>
            </el-select>
            <el-select size="small" v-model="select_position" placeholder="请选择位置" style="width:150px;">
                <el-option v-for="item in position_options"
                           :key="item.value"
                           :label="item.label"
                           :value="item.value">
                </el-option>
            </el-select>
            <el-select size="small" v-model="select_district" placeholder="请选择区域号" style="width:150px;">
                <el-option v-for="item in district_options"
                           :key="item.value"
                           :label="item.label"
                           :value="item.value">
                </el-option>
            </el-select>
            <el-date-picker size="small" v-model="select_month"
                            type="month"
                            placeholder="请选择月份" style="width:150px;">
            </el-date-picker>
            <el-button size="small" type="primary" @@click="onQueryData">查询</el-button>

        </div>
        <div class="action-box-right">
            <el-button v-if="showStandard" size="small" type="primary" plain @@click="onToTurn(0)">扣分标准录入</el-button>
            <el-button v-if="showRegion" size="small" type="primary" plain @@click="onToTurn(1)">数据区域录入</el-button>
            <el-button v-if="showRecordInput" size="small" type="primary" plain @@click="onToTurn(2)">扣分录入</el-button>
            <el-button v-if="showSummarizing" size="small" type="primary" plain @@click="onToTurn(3)">日/周/巡检汇总表</el-button>
            <el-button size="small" type="success" plain @@click="onExport">导出EXCEL表</el-button>
        </div>
    </div>

    @*表格*@
    <div class="table-height">
        <vxe-table border
                   show-footer
                   show-overflow
                   size="mini"
                   height="auto"
                   align="center"
                   :header-cell-class-name="headerCellClassName"
                   :data="tableData">
            <vxe-table-column type="seq" title="序号" width="50"></vxe-table-column>
            <vxe-table-column title="部门" field="Department" width="100"></vxe-table-column>
            <vxe-table-column title="位置" field="Position" width="100"></vxe-table-column>
            <vxe-table-column title="区域号" field="District" width="60"></vxe-table-column>
            <vxe-table-column title="日检扣分" field="Grade_daily">
                <template v-slot="{ row }">
                    <div :class="[showSummarizing?'col-color-red':'']" v-if="row.Grade_daily!=''" @@click="onSelectData(row,'日检')">-{{row.Grade_daily}}</div>
                </template>
            </vxe-table-column>
            <vxe-table-column title="周检扣分">
                <vxe-table-column title="周检正常扣分" field="Grade_week" :formatter="formatterPoints"></vxe-table-column>
                <vxe-table-column title="周检未整改扣分" field="Week_NotCorrected" :formatter="formatterPoints"></vxe-table-column>
                <vxe-table-column title="周检重复出现扣分" field="Week_Repetition" :formatter="formatterPoints"></vxe-table-column>
                <vxe-table-column title="周检扣分合计" field="Week_Sum">
                    <template v-slot="{ row }">
                        <div :class="[showSummarizing?'col-color-red':'']" v-if="row.Week_Sum!=''" @@click="onSelectData(row,'周检')">-{{row.Week_Sum}}</div>
                    </template>
                </vxe-table-column>
            </vxe-table-column>
            <vxe-table-column title="巡检扣分">
                <vxe-table-column title="巡检正常扣分" field="Grade_random" :formatter="formatterPoints"></vxe-table-column>
                <vxe-table-column title="巡检未整改扣分" field="Random_NotCorrected" :formatter="formatterPoints"></vxe-table-column>
                <vxe-table-column title="巡检重复出现扣分" field="Random_Repetition" :formatter="formatterPoints"></vxe-table-column>
                <vxe-table-column title="巡检扣分合计" field="Random_Sum">
                    <template v-slot="{ row }">
                        <div :class="[showSummarizing?'col-color-red':'']" v-if="row.Random_Sum!=''" @@click="onSelectData(row,'巡检')">-{{row.Random_Sum}}</div>
                    </template>
                </vxe-table-column>
            </vxe-table-column>
            <vxe-table-column title="月末得分" field="TotalPoints" width="80"></vxe-table-column>
        </vxe-table>
    </div>
    <div class="note">备注：月末得分 = 100 - 日检扣分 - 周检扣分合计 - 巡检扣分合计</div>
</div>
@* 分部页放置处 *@
@section renderPage {
}
@* js放置处 *@
@section jsScript {
    <script src="https://cdn.jsdelivr.net/npm/xe-utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/vxe-table"></script>
    <script>
        const app = {
            data: function () {
                return {
                    select_department: '全部部门',
                    department_options: [],
                    select_position: '',
                    position_options: [],
                    select_district: '',
                    district_options: [],
                    select_month: new Date(),
                    tableData: [],
                    //权限
                    showRecordInput: false,
                    showSummarizing: false,
                    showStandard: false,
                    showRegion: false,
                }
            },
            created: function () {
                this.onGetDepartmentData();
                this.onQueryData();
            },
            mounted: function () {
                this.onPermissions();
            },
            watch: {
                select_department(val) {
                    if (val != '') {
                        this.select_position = '',
                            this.select_district = ''
                        this.onGetPosition();
                    }
                },
                select_position(val) {
                    if (val != '') {
                        this.select_district = ''
                        this.onGetDistrictData();
                    }
                }
            },
            //函数方法
            methods: {
                //获取初始化下拉数据
                onGetDepartmentData() {
                    axios.post('/KPI/GetDepartmentList').then(res => {
                        //console.log(res)
                        //res.data.shift();
                        this.department_options = res.data;
                    })
                },
                onGetDistrictData() {
                    axios.post('/KPI/GetDistrictList', { department: this.select_department, position: this.select_position }).then(res => {
                        //console.log(res)
                        this.district_options = res.data;
                    })
                },
                onGetPosition() {
                    axios.post('/KPI/GetPositionList', { department: this.select_department }).then(res => {
                        //console.log(res)
                        //res.data.shift();
                        this.position_options = res.data;
                    })
                },
                //判断权限
                onPermissions() {
                    var roles = JSON.parse(localStorage.getItem("rigths"))
                    if (checkRoles(roles, '录入7S日/周/巡检数据')) {
                        this.showRecordInput = true
                    }
                    if (checkRoles(roles, '查看7S日/周/巡检汇总表')) {
                        this.showSummarizing = true
                    }
                    if (checkRoles(roles, '查看7S参考标准') || checkRoles(roles, '录入7S参考标准')) {
                        this.showStandard = true
                    }
                    if (checkRoles(roles, '查看7S区域数据') || checkRoles(roles, '录入7S区域数据')) {
                        this.showRegion = true
                    }
                },
                //判断筛选
                onTip() {
                    if (this.select_department == '') {
                        this.$message.warning('请选择部门！');
                        return false;
                    }
                    else if (this.select_month == '') {
                        this.$message.warning('请选择月份！');
                        return false;
                    } else {
                        return true;
                    }
                },
                //查询数据
                onQueryData() {
                    if (this.onTip()) {
                        let param = {
                            department: this.select_department,
                            position: this.select_position,
                            district: this.select_district,
                            date: this.select_month
                        }
                        axios.post('/KPI/KPI_7S_SummarySheet', param).then(res => {
                            //console.log(res)
                            this.tableData = res.data;
                        })
                    }
                },
                //表头
                headerCellClassName({ column }) {
                    if (column.property === 'TotalPoints') {
                        return 'col-blue'
                    }
                },
                //格式化
                formatterPoints({ cellValue }) {
                    if (cellValue != '' || cellValue != 0) {
                        return -cellValue;
                    }
                },
                //选择分数查询
                onSelectData(row, val) {
                    //console.log(val);
                    if (this.showSummarizing) {
                        window.open("/KPI/KPI_7S_Summarizing_Daily?check_type=" + val + "&department=" + row.Department + "&position=" + row.Position + "&district=" + row.District + "&date=" + this.select_month);
                    }
                },
                //跳转
                onToTurn(val) {
                    //console.log(val);
                    if (val == 0) {
                        window.open("/KPI/KPI_7S_GradeStandardInput");
                    }
                    if (val == 1) {
                        window.open("/KPI/KPI_7S_RegionInput");
                    }
                    if (val == 2) {
                        window.open("/KPI/KPI_7S_RecordInput");
                    }
                    if (val == 3) {
                        window.open("/KPI/KPI_7S_Summarizing_Daily");
                    }

                },
                //导出excel表
                onExport() {
                    //console.log(this.tableData)
                    let tableData = this.tableData;
                    if (tableData.length == 0) {
                        this.$message.error('暂无数据，请选查询！');
                    } else {
                        newd = JSON.stringify(tableData, ['Department', 'Position', 'District', 'Grade_daily', 'Grade_week', 'Week_NotCorrected', 'Week_Repetition', 'Week_Sum', 'Grade_random', 'Random_NotCorrected', 'Random_Repetition', 'Random_Sum', 'TotalPoints']);
                        let param = {
                            value: newd,
                            check_date: new Date(this.select_month),
                            check_type: ''
                        }
                        //console.log(param);
                        axios.post("/KPI/ExportExcel", param, {
                            responseType: "blob",
                        }).then(res => {
                            //console.log(res.data)
                            let fileName = ' 7S评比得分汇总表.xlsx'
                            let url = window.URL.createObjectURL(new Blob([res.data]))
                            let link = document.createElement('a')
                            link.style.display = 'none'
                            link.href = url
                            link.setAttribute('download', fileName)
                            document.body.appendChild(link)
                            link.click()
                        })
                    }
                }
            }
        };
        //检测权限
        function checkRoles(list, roleName) {
            var flag = false
            if (list && roleName) {
                for (let item in list) {
                    if (list[item] == roleName) {
                        flag = true
                    }
                }
            }
            return flag
        }

    </script>
}