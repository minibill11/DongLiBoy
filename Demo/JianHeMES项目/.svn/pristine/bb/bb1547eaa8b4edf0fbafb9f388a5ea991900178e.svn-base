
@{
    ViewBag.Title = "SPC_MaterialLablePrint";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Content/styleFile/packaging/index.css" rel="stylesheet" />
<script src="~/Content/styleFile/packaging/index.js"></script>
<script src="~/Scripts/axios.min.js"></script>
<script src="~/Scripts/printJS/JsBarcode.all.min.js"></script>
<style>
    .query {
        width: 300px;
        text-align: right;
        margin: 2px auto;
    }

    .affirm {
        margin-left: 370px;
    }

    .outerdiv {
        margin: 0 auto;
        border: 1px solid #000;
        width: 400px;
        height: 400px;
        font-size: 16px;
    }

        .outerdiv .onediv {
            height: 50px;border: none;
            border-bottom: 1px solid #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .outerdiv .twodiv {
            height: 50px;border: none;
            border-bottom: 1px solid #000;
            display: inline-flex;
        }

            .outerdiv .twodiv .child1 {
                width: 110px;display: flex;
                justify-content: center;
                align-items: center;
            }

            .outerdiv .twodiv .child2 {
                border-left: 1px solid #000;
                display: flex;
                justify-content: center;
                align-items: center;
            }

        .outerdiv .threediv {
            height: 50px;border: none;
            border-bottom: 1px solid #000;
            display: inline-flex;
        }

            .outerdiv .threediv .child1 {
                width: 110px;display: flex;
                justify-content: center;
                align-items: center;
            }

            .outerdiv .threediv .child2 {
                border-left: 1px solid #000;
                display: flex;
                justify-content: center;
                align-items: center;
            }

        .outerdiv .fourdiv {
            height: 80px;border: none;
            border-bottom: 1px solid #000;
            display: inline-flex;
        }

            .outerdiv .fourdiv .child1 {
                width: 110px;display: flex;
                justify-content: center;
                align-items: center;
            }

            .outerdiv .fourdiv .child2 {
                border-left: 1px solid #000;
                display: flex;
                justify-content: center;
                align-items: center;
            }

        .outerdiv .fivediv {
            height: 120px;border: none;
            border-bottom: 1px solid #000;
            display: inline-flex;
        }

            .outerdiv .fivediv .child1 {
                width: 110px; display: flex;
                justify-content: center;
                align-items: center;
            }

            .outerdiv .fivediv .child2 {              
                border-left: 1px solid #000;
                display: flex;
                justify-content: center;
                align-items: center;
            }

        .outerdiv .sixdiv {
            height: 49px;border: none;
            display: inline-flex;
        }

            .outerdiv .sixdiv .child1 {
                width: 110px;display: flex;
                justify-content: center;
                align-items: center;
            }

            .outerdiv .sixdiv .child2 {               
                border-left: 1px solid #000;
                display: flex;
                justify-content: center;
                align-items: center;
            }

    .affirm1 {
        margin-top:5px;
        margin-left: 395px;
    }
</style>
<div id="app">
    <div style="text-align:center">
        <h2>备品、配件物料标签打印</h2>
    </div>
    <el-main>
        <el-col :md="12">
            <div class="query">
                选择类型：
                <el-select v-model="spcType" placeholder="请选择类型" size="medium" allow-create filterable clearable>
                    <el-option v-for="item in optionType"
                               :key="item.value"
                               :value="item.value">
                    </el-option>
                </el-select>
            </div>
            <div class="query">
                订单号：
                <el-select v-model="orderNum" placeholder="请选择订单号" size="medium" allow-create filterable clearable>
                    <el-option v-for="item in options"
                               :key="item.value"
                               :value="item.value">
                    </el-option>
                </el-select>
            </div>
            <div class="query">
                <span>选打印机：</span>
                <el-select v-model="printProt" clearable placeholder="选择打印机" size="medium">
                    <el-option v-for="item in printOptions"
                               :key="item.value"
                               :label="item.label"
                               :value="item.value">
                    </el-option>
                </el-select>
            </div>
            <div class="query">
                物料号：<el-input v-model.trim="materialNumber" placeholder="请输物料条码" style="width:191px" size="medium" v-on:keyup.enter.native="" clearable></el-input>
            </div>
            <div class="query">
                数量：<el-input v-model.trim="quantity" placeholder="请输入数量" style="width:191px" size="medium"></el-input>
            </div>
            <el-button class="affirm" size="mini" type="primary" v-on:click="confirm">保存</el-button>
        </el-col>
        <el-col :md="12">
            <div class="outerdiv">
                <div class="outerdiv onediv">{{spcType}}</div>
                <div class="outerdiv twodiv">
                    <div class="outerdiv twodiv child1"><span>订单号</span></div>
                    <div class="outerdiv twodiv child2">{{orderNum}}</div>
                </div>
                <div class="outerdiv threediv">
                    <div class="outerdiv threediv child1"><span>物料名称</span></div>
                    <div class="outerdiv threediv child2"><span v-model="materialName">{{materialName}}</span></div>
                </div>
                <div class="outerdiv fourdiv">
                    <div class="outerdiv fourdiv child1"><span>物料编号</span></div>
                    <div class="outerdiv fourdiv child2"> <svg id="imgcode"></svg></div>
                </div>
                <div class="outerdiv fivediv">
                    <div class="outerdiv fivediv child1"><span>规格描述</span></div>
                    <div class="outerdiv fivediv child2"><span v-model="specifications" style="font-size:12px">{{specifications}}</span></div>
                </div>
                <div class="outerdiv sixdiv">
                    <div class="outerdiv sixdiv child1"><span>数&nbsp;&nbsp;量</span></div>
                    <div class="outerdiv sixdiv child2"><span>{{quantity}}</span></div>
                </div>
            </div>
            <div>
                <el-button class="affirm1" size="mini" type="primary" v-on:click="printMaterial">打印标签</el-button>
            </div>
        </el-col>
    </el-main>
    <div>
        <img id="cc" />
    </div>
</div>
<script>
    var app = new Vue({
        el: '#app',
        data: {
            orderNum: '', //订单号
            options: [],  //订单号选项
            printProt: '',//打印机
            printOptions: printIpAddress, //打印机选项
            materialNumber: [],//物料号
            quantity: '', //物料数量
            spcType: '',
            optionType: [{ value: '选项1', value: '备品' }, { value: '选项2', value: '配件' }],
            materialName: '',
            specifications: '',
            
        },
        //获取订单号
        mounted() {
            axios.post('/Packagings/GetOrderList').then(res => {
                this.options = res.data;
            }).catch(err => {
                console.warn("获取选择列表失败")
            });
            let printIP = localStorage.getItem('printIP');
            if (printIP != null) {
                this.printProt = printIP;
            };
        },
        methods: {
            //打印标签
            printMaterial() {
                //if (this.orderNum != '' && this.materialNumber != '' && this.printProt != '' && this.quantity != '') {
                    axios.post("/Packagings/SPC_MaterialLablePrint1", {
                        orderNumber: '2019-GA660-1',
                        materialNumber: '60200-0890',
                        quantity: 20,
                        ip: 240,
                        spcType:'备品',
                    },
                        {
                            responseType: "arraybuffer",
                        }).then(function (response) {
                            return 'data:image/png;base64,' + btoa(
                                new Uint8Array(response.data).reduce((data, byte) => data + String.fromCharCode(byte), '')
                            );
                        }).then(function (data) {
                            document.getElementById("cc").setAttribute("src", data)
                        }).catch(err => {
                            console.warn("打印出错")
                        });
                //}
            },
            //保存信息
            confirm() {
                if (this.materialNumber != '' && this.quantity != '' && this.orderNum != '') {
                    axios.post("/Packagings/SPC_OutputMaterialinfo", { materialNumber: this.materialNumber, orderNum: this.orderNum, quantity: this.quantity }).then(res => {
                        console.log(res.data)
                        if (res.data != false && res.data != "{}" && res.data != "保存失败") {
                            this.$message({
                                message: '保存成功',
                                type: 'success'
                            });
                            this.specifications = res.data.Specifications
                            this.materialName = res.data.ProductName;
                            this.setmasterBarDiv(this.materialNumber)
                        } else if (res.data == false) {
                            this.$message({
                                message: '请录入物料基本信息，在打印物料标签',
                                type: 'warning'
                            });
                        } else {
                            this.$message({
                                message: '保存失败',
                                type: 'warning'
                            });
                        }
                    })                    
                } else {
                    this.$message({
                        message: '请填写完整在保存',
                        type: 'warning'
                    });
                }
            },
            //使用后端返回的条码号生成条形码
            setmasterBarDiv(val) {
                JsBarcode("#imgcode", val, {
                    height: 45,                    //条形码的高度
                    format: "CODE128",            //选择要使用的条形码类型
                    font: "monospace",           //设置文本字体
                    textAlign: "center",        //设置文本的水平对齐方式
                    textMargin: 0,             //设置条形码和文本之间的间距
                    fontSize: 17,             //设置文本的大小
                    lineColor: "#000",       //条形码颜色
                    margin: 0,              //设置条形码周围的空白边距
                    marginTop: 0
                });
            },
        },
        watch: {
            materialNumber() {
                if (this.materialNumber == '') {
                    $("#imgcode").empty();
                }
            }
        }
    })
</script>
