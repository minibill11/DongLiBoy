@{
    ViewBag.Title = "SMT订单计划";
}
<link href="~/Content/styleFile/packaging/index.css" rel="stylesheet" />
<script src="~/Content/styleFile/packaging/index.js"></script>
<style>
    .el-main {
        min-height: 600px;
    }

    .table-top {
        display: inline-flex;
        margin-bottom: 10px;
    }

        .table-top > div {
            margin-left: 5px;
        }

    .el-input, .el-input__inner, .el-date-editor.el-input {
        width: 150px;
    }
</style>
<div id="app">
    <el-container>
        <el-header class="text-center">
            <h2>@ViewBag.Title</h2>
        </el-header>
        <el-main>
            <el-row class="table-top">
                <el-select v-model="lineNum"
                           placeholder="产线号"
                           size="medium"
                           filterable
                           clearable>
                    <el-option v-for="item in lineNumlist"
                               :key="item.value"
                               :label="item.value"
                               :value="item.value">
                    </el-option>
                </el-select>
                <el-select v-model="orderNum"
                           placeholder="订单号"
                           size="medium"
                           filterable
                           clearable>
                    <el-option v-for="item in orderNumlist"
                               :key="item.value"
                               :label="item.value"
                               :value="item.value">
                    </el-option>
                </el-select>
                <el-select v-model="jobContent"
                           placeholder="工作内容"
                           size="medium"
                           filterable
                           clearable>
                    <el-option v-for="item in jobContentlist"
                               :key="item.value"
                               :label="item.value"
                               :value="item.value">
                    </el-option>
                </el-select>
                <el-date-picker v-model="planDate"
                                placeholder="计划生产日期"
                                size="medium">
                </el-date-picker>
                <el-input v-model="remark"
                          placeholder="备注"
                          size="medium" clearable></el-input>
                <el-button type="primary" @@click="onQuerySubmit" size="medium" style="margin:0 5px;">查询</el-button>
                <a href="SMT_ProductionPlanCreate" v-show="islimit('创建订单')"><el-button type="primary" size="medium" plain>创建计划</el-button></a>
            </el-row>
            <el-row class="table-mid">
                <el-table :data="tableList"
                          max-height="600"
                          size="small"
                          @@selection-change="handleSelectionChange"
                          stripe
                          border>
                    <el-table-column type="selection" width="40" fixed></el-table-column>
                    <el-table-column type="index" label="序号" width="50"></el-table-column>
                    <el-table-column prop="LineNum" label="产线" min-width="60" sortable>
                    </el-table-column>
                    <el-table-column prop="OrderNum" label="订单号" min-width="120" sortable>
                    </el-table-column>
                    <el-table-column prop="JobContent" label="工作内容" min-width="110" sortable>
                    </el-table-column>
                    <el-table-column prop="Capacity" label="计划产能" min-width="100" sortable>
                    </el-table-column>
                    <el-table-column prop="Quantity" label="计划数量" min-width="100" sortable>
                    </el-table-column>
                    <el-table-column prop="CreateDate" label="计划生产日期" min-width="120" sortable>
                    </el-table-column>
                    <el-table-column prop="Remark" label="备注" min-width="100">
                    </el-table-column>
                    <el-table-column label="操作" align="center" width="90">
                        <template slot-scope="scope">
                            <a :href="`SMT_ProductionPlanEdit?id=${scope.row.Id}`" v-show="islimit('修改订单')" target="_blank">修改</a>
                        </template>
                    </el-table-column>
                </el-table>
                <div style="margin-top: 10px">
                    <el-button @@click="deleteSelection()" v-show="islimit('删除订单')" type="danger" plain size="small">删除选中行</el-button>
                </div>
            </el-row>
        </el-main>
    </el-container>
</div>

<script type="text/javascript">
    var app = new Vue({
        el: "#app",
        data: {
            lineNum: '',
            lineNumlist: [],
            orderNum: '',
            orderNumlist: [],
            jobContent: '',
            jobContentlist: [],
            planDate: null,
            remark: '',
            tableList: [],
            multipleSelectionID: [],
        },
        mounted: function () {
            //产线列表
            axios.post('/SMT/GetLineNumArr').then(res => {
                this.lineNumlist = res.data;
            });
            //订单列表
            axios.post('/SMT/GetOrderArr').then(res => {
                this.orderNumlist = res.data;
            });
            //工作内容列表
            axios.post('/SMT/GetJobContentArr').then(res => {
                this.jobContentlist = res.data;
            });
        },
        methods: {
            onQuerySubmit() {
                if (this.orderNum == '' && this.planDate == null) {
                    this.$message('需要选择订单号 或 计划生产日期');
                    return;
                };
                axios.post('/SMT/SMT_ProductionPlan1', {
                    orderNum: this.orderNum,
                    lineNum: this.lineNum,
                    jobContent: this.jobContent,
                    planProductionDate: this.planDate,
                    remark: this.remark,
                }).then(res => {
                    this.tableList = res.data;
                    if (res.data == '') {
                        this.$message.success('查询完毕，暂无数据');
                    } else {
                        this.$message.success('查询成功');
                    };
                }).catch(err => {
                    console.warn("post失败")
                });
            },
            islimit(roleName) {
                let limitlist = JSON.parse(localStorage.getItem("rigths"));
                if (limitlist && roleName) {
                    for (let item in limitlist) {
                        if (limitlist[item] == roleName) {
                            return true;
                        };
                    };
                };
                return false;
            },
            //删除表格选择行
            deleteSelection() {
                this.$confirm(`共选中 ${this.multipleSelectionID.length} 行，请确认后删除！`, '确认删除选中行', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'error',
                    center: true,
                }).then(() => {
                    axios.post('/SMT/SMT_ProductionPlanBatchDeleteConfirmed', {
                        id: this.multipleSelectionID,
                    }).then(res => {
                        if (res.data.Result) {
                            this.$message.success(res.data.Message);
                            let list = this.tableList.filter(i => {
                                return !this.multipleSelectionID.includes(i.Id);
                            });
                            this.tableList = list;
                        } else {
                            this.$message.error(res.data.Message);
                        };
                    }).catch(err => {
                        console.warn("post失败")
                    });
                });
            },
            handleSelectionChange(val) {
                this.multipleSelectionID = val.map(i => i.Id);
            },
        },
    });
</script>
