@{
    ViewBag.Title = "报修单查询";
    Layout = "~/Views/Shared/_Layout2.cshtml";
}

@* css放置处 *@
@section cssStyle {
    <link rel="stylesheet/less" type="text/css" href="~/Content/Equipment/equipment_index.less" />
    <style>
        .topContainer {
            width: 100%;
            align-items: flex-end;
            display: flex;
            justify-content: center;
            flex-flow: row wrap;
            margin-bottom: 7px;
            font-size: 14px;
        }

            .topContainer div {
                margin-right: 5px;
            }
        /*  #search {
            margin-top: 20px;
        }*/
    </style>
}
<el-container id="app" v-cloak>
    <el-header class="text-center">
        @*标题*@
        <eq-header-component :active="active"></eq-header-component>
    </el-header>
    <el-main class="main-box">
        <div class="topContainer">
            @* 查询选择 *@
            <div>
                <span class="selectText">设备编号：</span><br />
                <el-select v-model="ENunber" size="mini" clearable filterable placeholder="请选择设备编号" style="width:140px;">
                    <el-option v-for="item in options"
                               v-bind:key="item.value"
                               v-bind:label="item.label"
                               v-bind:value="item.value">
                    </el-option>
                </el-select>
            </div>
            <div>
                <span class="selectText">使用部门：</span><br />
                <el-select v-model="userdepart" size="mini" clearable filterable placeholder="请选择使用部门" style="width:140px;">
                    <el-option v-for="item in deparlist"
                               v-bind:key="item.value"
                               v-bind:label="item.label"
                               v-bind:value="item.value">
                    </el-option>
                </el-select>
            </div>
            <div>
                <span class="selectText">设备名称：</span><br />
                <el-input v-model="EName" size="mini" placeholder="设备名称" style="width:140px;"></el-input>
            </div>
            <div>
                <span class="selectText">按故障日期查询：</span><br />
                <el-date-picker v-model="fualtTime"
                                type="date"
                                v-bind:disabled="fualtTimeFlag"
                                size="mini"
                                style="width:150px;"
                                placeholder="故障日期">
                </el-date-picker>
            </div>
            <div>
                <span class="selectText">按时间段查询：</span><br />
                <el-date-picker v-model="TimeRange"
                                type="daterange"
                                size="mini"
                                style="width:300px;"
                                v-bind:disabled="fualtTimeRangeFlag"
                                range-separator="至"
                                start-placeholder="开始日期"
                                end-placeholder="结束日期">
                </el-date-picker>
            </div>
            <div>
                <span class="selectText">按年查询已维修：</span><br />
                <el-date-picker v-model="yearSamry"
                                align="right"
                                size="mini"
                                type="year"
                                style="width:150px;"
                                v-bind:disabled="yearSamryFlag"
                                placeholder="选择年">
                </el-date-picker>
            </div>
            <div>
                <span class="selectText">按月查询已维修：</span><br />
                <el-select v-model="monthSamry" size="mini" v-bind:disabled="monthSamryFlag" clearable filterable placeholder="请选择月" style="width:150px;">
                    <el-option v-for="item in 12"
                               v-bind:key="item"
                               v-bind:label="item"
                               v-bind:value="item">
                    </el-option>
                </el-select>
            </div>
            <div>
                <el-button id="search" type="primary" size="mini" v-on:click="query" :disabled="showQuery">查询</el-button>
            </div>
        </div>
        <div class="tip-box"><span class="tip">提示：查询结果中部门（因组织架构变更）可能与当前部门不一致。</span></div>
        @* 查询结果表格 *@
        <div class="bottomContainer">
            <el-table v-bind:data="tableData"
                      size="small"
                      max-height="600"
                      style="width: 100%" border stripe>
                <el-table-column prop="index" label="序号" width="50">
                    <template slot-scope="scope">
                        <div>{{scope.$index+1}}</div>
                    </template>
                </el-table-column>
                <el-table-column prop="EquipmentNumber"
                                 label="设备编号"
                                 sortable
                                 width="120">
                </el-table-column>
                <el-table-column prop="EquipmentName"
                                 label="设备名称"
                                 sortable
                                 width="120">
                </el-table-column>
                <el-table-column prop="FaultTime"
                                 label="故障时间" width="120">
                </el-table-column>
                <el-table-column prop="Emergency"
                                 label="紧急状态" width="120">
                </el-table-column>
                <el-table-column prop="FauDescription"
                                 label="报修内容">
                </el-table-column>
                <el-table-column label="报修状态" sortable>
                    <template slot-scope="scope">
                        <div style="text-align:left;">
                            <div>{{scope.row.State?scope.row.State:''}}</div>
                            <div>{{scope.row.State1?scope.row.State1:''}}</div>
                            <div>{{scope.row.State2?scope.row.State2:''}}</div>
                        </div>
                    </template>
                </el-table-column>
                <el-table-column prop="RequirementsTime"
                                 label="要求完成时间" width="150">
                </el-table-column>
                <el-table-column prop="StateRepair"
                                 label="报修结果" width="100">
                </el-table-column>
                <el-table-column label="操作" width="100">
                    <template slot-scope="scope">
                        <el-button type="text" size="mini" @@click="showDetials(scope.row)" style="text-decoration:underline;">详细</el-button>
                        @*<a :href="showDetials(scope.row)" class="detail-style" target="_blank">详细</a>*@
                    </template>
                </el-table-column>
            </el-table>
        </div>
    </el-main>
</el-container>
@* 分部页放置处 *@
@section renderPage {
    @RenderPage("~/Views/Equipment/_Eq_Header.cshtml")
}
@* js放置处 *@
@section jsScript {
    <script>
        const app = {
            data: {
                active: "报修单查询",
                showQuery: true,
                EName: null,
                ENunber: null,
                fualtTime: null,
                TimeRange: [],
                userdepart: null,
                options: [],
                fualtTimeFlag: false,
                fualtTimeRangeFlag: false,
                yearSamryFlag: false,
                monthSamryFlag: false,
                tableData: [],
                deparlist: [],
                yearSamry: null,
                monthSamry: null
            },
            mounted() {
                if (this.islimit("查询设备报修单")) {
                    this.showQuery = false;
                } else {
                    this.showQuery = true;
                }
                // 页面加载时获取所有可选设备编号列表以及使用部门列表
                axios.post("/Equipment/InstrumentList").then(res => {
                    res.data.forEach(item => {
                        let obj = { value: item, label: item };
                        this.options.push(obj)
                    })
                }).catch(err => {
                    this.$message({
                        message: "获取设备编号列表失败",
                        type: "warning"
                    })
                });
                axios.post("/Equipment/Deparlist").then(res => {
                    res.data.forEach(item => {
                        let obj = { value: item, label: item };
                        this.deparlist.push(obj)
                    })
                }).catch(err => {
                    this.$message({
                        message: "获取设备使用部门列表失败",
                        type: "warning"
                    })
                });
                //默认时间段
                let dd = new Date();
                let y = dd.getFullYear();
                let startTime = new Date(`${y}-01-01`);
                this.TimeRange.push(startTime, dd);
                this.query();
            },
            watch: {
                // 监听故障时间
                fualtTime() {
                    if (this.fualtTime != null) {
                        this.fualtTimeRangeFlag = true;
                        this.yearSamryFlag = true
                        this.monthSamryFlag = true
                    } else {
                        this.fualtTimeRangeFlag = false;
                        this.yearSamryFlag = false
                        this.monthSamryFlag = false
                    }
                },
                //监听所选时间段
                TimeRange() {
                    if (this.TimeRange != null) {
                        this.fualtTimeFlag = true;
                        this.yearSamryFlag = true
                        this.monthSamryFlag = true
                    } else {
                        this.fualtTimeFlag = false;
                        this.yearSamryFlag = false
                        this.monthSamryFlag = false

                    }
                },
                // 监听年
                yearSamry() {
                    if (this.yearSamry != null) {
                        this.fualtTimeRangeFlag = true;
                        this.fualtTimeFlag = true;
                        //this.monthSamryFlag = true
                    } else {
                        this.fualtTimeRangeFlag = false;
                        this.fualtTimeFlag = false;
                        //this.monthSamryFlag = false
                    }
                },
                // 监听月
                monthSamry() {
                    if (this.monthSamry != null && this.monthSamry != '') {
                        this.fualtTimeRangeFlag = true;
                        //this.yearSamryFlag = true
                        this.fualtTimeFlag = true;
                    } else {
                        this.fualtTimeRangeFlag = false;
                        //this.yearSamryFlag = false
                        this.fualtTimeFlag = false;
                    }
                }

            },
            methods: {
                // 时间过滤器  年月日
                getTime(val) {
                    let dd = new Date(val);
                    let year = dd.getFullYear();
                    let month = (dd.getMonth() + 1).toString().padStart(2, 0);
                    let days = dd.getDate().toString().padStart(2, 0);
                    let hh = dd.getHours().toString().padStart(2, 0);
                    let mm = dd.getMinutes().toString().padStart(2, 0);
                    let ss = dd.getSeconds().toString().padStart(2, 0);
                    return `${year}-${month}-${days} ${hh}:${mm}:${ss}`
                },
                // 查询
                query() {
                    if (this.EName != null || this.ENunber != null || this.fualtTime != null || this.TimeRange != null || this.userdepart != null || this.yearSamry != null || (this.monthSamry != null && this.monthSamry != '')) {
                        let year = null
                        if (this.yearSamry != null) {
                            let dd = new Date(this.yearSamry)
                            year = dd.getFullYear()
                        }
                        axios.post("/Equipment/EquipmentRepairbill_Query", { month: this.monthSamry, year: year, userdepartment: this.userdepart, equnumber: this.ENunber, equipname: this.EName, date: this.fualtTime, starttime: this.TimeRange != null ? this.TimeRange[0] : null, endtime: this.TimeRange != null ? this.TimeRange[1] : null }).then(res => {
                            //console.log(res.data, 999999999)
                            if (res.data.length > 0) {
                                res.data.forEach(item => {
                                    if (item.RequirementsTime != null) {
                                        item.RequirementsTime = this.getTime(item.RequirementsTime)
                                    }
                                })
                                this.tableData = res.data
                            } else {
                                this.$message({
                                    message: "查无对应数据",
                                    type: "warning"
                                })
                            }
                        }).catch(err => {
                            console.log(err);
                            this.$message({
                                message: "查询失败",
                                type: "warning"
                            })
                        })
                    } else {
                        this.$message({
                            message: "请补全需要查询的信息",
                            type: "warning"
                        });
                    }
                },
                // 详细按钮跳转传参
                showDetials(item) {
                    //console.log(item);
                    window.open("/Equipment/Equipment_Fixbill_Detail?EquipmentNumber=" + item.EquipmentNumber + "&EquipmentName=" + item.EquipmentName + "&time=" + item.FaultTime + "&canchange=false");
                }
            }
        }
    </script>

}