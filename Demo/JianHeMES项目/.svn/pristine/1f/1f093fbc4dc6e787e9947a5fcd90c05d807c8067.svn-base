using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Entity;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Linq.Expressions;
using System.Net;
using System.Text;
using System.Web;
using System.Web.Mvc;
using JianHeMES.Models;
using Newtonsoft.Json;
using Newtonsoft.Json.Linq;
using static JianHeMES.Controllers.CommonalityController;
using static JianHeMES.Controllers.CommonERPDB;

namespace JianHeMES.Controllers
{
    public class Warehouse_MaterialController : Controller
    {
        private ApplicationDbContext db = new ApplicationDbContext();
        private CommonalityController comm = new CommonalityController();

        // GET: Warehouse_Material
        public ActionResult Index()
        {
            return View();
        }

        #region----MC部仓库物料管理

        #region ---- 页面
        public ActionResult MaterialBasicInfo()
        {
            if (Session["User"] == null)
            {
                return RedirectToAction("Login", "Users", new { col = "Warehouse_Material", act = "MaterialBasicInfo" });
            }
            return View();
        }
        public ActionResult QueryData()
        {
            if (Session["User"] == null)
            {
                return RedirectToAction("Login", "Users", new { col = "Warehouse_Material", act = "QueryData" });
            }
            return View();
        }
        public ActionResult MaterialInput()
        {
            if (Session["User"] == null)
            {
                return RedirectToAction("Login", "Users", new { col = "Warehouse_Material", act = "MaterialInput" });
            }
            return View();
        }

        #endregion

        #region ---- 查询物料信息页
        [HttpPost]
        public ActionResult QueryMaterial(string material)
        {
            JObject table = new JObject();
            var querylist = CommonERPDB.ERP_MaterialQuery(material, "").ToList();
            return Content(JsonConvert.SerializeObject(querylist));
        }

        [HttpPost]
        public ActionResult QueryMaterialNumName(string materialNumber, string materialName)
        {
            var resultlist = CommonERPDB.ERP_MaterialQuery(materialNumber, materialName).Select(c => new { c.img01, c.ima02, c.ima021, c.img02, c.img03, c.img08, c.img09, c.img10, c.img18 }).ToList();//根据物料编号到ERP里查找数据
            return Content(JsonConvert.SerializeObject(resultlist));
        }

        #endregion

        #region ----修改库位号
        public ActionResult ModifyLocation(string material, string position)
        {
            JObject table = new JObject();
            var savecount = 0;
            var security = db.Equipment_Safetystock.Where(c => c.Material == material).ToList();//获取数据
            var querylist = CommonERPDB.ERP_Query_SafetyStock(security.Select(c => c.Material).ToList());//根据物料编号到ERP里查找数据
            foreach (var item in querylist)//循环querlist
            {
                if (db.Warehouse_Modify_WarehouseNum.Count(c => c.MaterialNumber == item.img01) == 0)
                {
                    var rede = new Warehouse_Modify_WarehouseNum() { MaterialNumber = material, MaterialBacrcode = null, OldWarehouseNum = item.img03, NewWarehouseNum = position, Modifier = ((Users)Session["user"]).UserName, ModifyTime = DateTime.Now };
                    db.Warehouse_Modify_WarehouseNum.Add(rede);
                    savecount = db.SaveChanges();//保存到数据库
                }
            }
            if (savecount > 0)//判断savecount是否大于0
            {
                table.Add("Position", position);//把库位号add到table里面
                table.Add("Site", true);
            }
            else//等于0 
            {
                table.Add("Site", false);
            }
            return Content(JsonConvert.SerializeObject(table));
        }
        #endregion

        #region ----显示修改库位号清单
        public ActionResult LocationQuery()
        {
            var locationlist = db.Warehouse_Modify_WarehouseNum.Select(c => new { c.ID, c.MaterialNumber, c.MaterialBacrcode, c.OldWarehouseNum, c.NewWarehouseNum }).ToList();
            return Content(JsonConvert.SerializeObject(locationlist));
        }
        #endregion

        #region ----如果ERP里的库位号已经修改过来，就把MES里的记录删除
        public ActionResult DeleteLocation(int id)
        {
            JObject table = new JObject();
            var locationlist = db.Warehouse_Modify_WarehouseNum.Select(c => new { c.MaterialNumber, c.OldWarehouseNum, c.NewWarehouseNum });
            var querylist = CommonERPDB.ERP_Query_SafetyStock(locationlist.Select(c => c.MaterialNumber).ToList());//根据物料编号到ERP里查找数据
            foreach (var item in querylist)
            {
                if (item.img03 == locationlist.Select(c => c.NewWarehouseNum).FirstOrDefault())
                {
                    var record = db.Warehouse_Modify_WarehouseNum.Where(c => c.ID == id).FirstOrDefault();//根据ID表里查询数据
                    UserOperateLog operaterecord = new UserOperateLog();
                    operaterecord.OperateDT = DateTime.Now;//添加删除操作时间
                    operaterecord.Operator = ((Users)Session["User"]).UserName;//添加删除操作人
                    //添加操作记录（如：张三在2020年2月27日删除设备管理邮件抄送人为李四的记录）
                    operaterecord.OperateRecord = operaterecord.Operator + "在" + operaterecord.OperateDT + "删除库位号" + record.Modifier + "的记录。";
                    db.Warehouse_Modify_WarehouseNum.Remove(record);//删除对应的数据
                    db.UserOperateLog.Add(operaterecord);//添加删除操作日记数据
                    int count = db.SaveChanges();//保存到数据库
                    if (count > 0)//判断count是否大于0（有没有把数据保存到数据库）
                    {
                        table.Add("table", true);
                        table.Add("ware", "删除成功");
                        return Content(JsonConvert.SerializeObject(table));
                    }
                    else //等于0（没有把数据保存到数据库或者保存出错）
                    {
                        table.Add("table", false);
                        table.Add("ware", "删除失败");
                        return Content(JsonConvert.SerializeObject(table));
                    }
                }
                else
                {
                    table.Add("table", false);
                    table.Add("ware", "库位号不一致");
                    return Content(JsonConvert.SerializeObject(table));
                }
            }
            return Content(JsonConvert.SerializeObject(table));
        }
        #endregion

        #region---上传图片/图纸（多张上传）
        //pictureFile多张图片/图纸; pictureType文件类型（图片或者图纸）;materialNumber物料编号
        public bool UploadFile_Warehouse(List<string> pictureFile, string pictureType, string materialNumber)
        {
            var material = materialNumber.Split('-');//将物料号分隔
            if (Request.Files.Count > 0)
            {
                if (Directory.Exists(@"D:\MES_Data\Warehouse\" + material[0] + "\\") == false)//判断总路径是否存在
                {
                    Directory.CreateDirectory(@"D:\MES_Data\Warehouse\" + material[0] + "\\");//创建总路径
                }
                if (pictureType == "Picture")//判断文件类型是图片
                {
                    if (Directory.Exists(@"D:\MES_Data\Warehouse\" + material[0] + "\\" + materialNumber + "\\" + pictureType + "\\") == false)//判断图片路径是否存在
                    {
                        Directory.CreateDirectory(@"D:\MES_Data\Warehouse\" + material[0] + "\\" + materialNumber + "\\" + pictureType + "\\");//创建图片路径
                    }
                    foreach (var item in pictureFile)
                    {
                        HttpPostedFileBase fileBase = Request.Files["UploadFile_Warehouse" + pictureFile.IndexOf(item)];
                        var fileType = fileBase.FileName.Substring(fileBase.FileName.Length - 4, 4).ToLower();
                        List<FileInfo> fileInfo = comm.GetAllFilesInDirectory(@"D:\MES_Data\Warehouse\" + material[0] + "\\" + materialNumber + "\\" + pictureType + "\\");//遍历文件夹中的个数
                        if (fileType == ".jpg")
                        {
                            int JPGcount = fileInfo.Where(c => c.Name.StartsWith(materialNumber + "_") && c.Name.Substring(c.Name.Length - 4, 4) == ".jpg").Count();
                            fileBase.SaveAs(@"D:\MES_Data\Warehouse\" + material[0] + "\\" + materialNumber + "\\" + pictureType + "\\" + materialNumber + "_" + (JPGcount + 1) + fileType);//文件追加命名JPG
                        }
                        else if (fileType == ".pdf")
                        {
                            int PDFcount = fileInfo.Where(c => c.Name.StartsWith(materialNumber + "_") && c.Name.Substring(c.Name.Length - 4, 4) == ".pdf").Count();
                            fileBase.SaveAs(@"D:\MES_Data\Warehouse\" + material[0] + "\\" + materialNumber + "\\" + pictureType + "\\" + materialNumber + "_" + (PDFcount + 1) + fileType);//文件追加命名PDF
                        }
                    }
                }
                else //判断文件类型是图纸
                {
                    if (Directory.Exists(@"D:\MES_Data\Warehouse\" + material[0] + "\\" + materialNumber + "\\" + pictureType + "\\") == false)//判断图纸路径是否存在
                    {
                        Directory.CreateDirectory(@"D:\MES_Data\Warehouse\" + material[0] + "\\" + materialNumber + "\\" + pictureType + "\\");//创建图纸路径
                    }
                    foreach (var ite in pictureFile)
                    {
                        HttpPostedFileBase fileBase = Request.Files["UploadFile_Warehouse" + pictureFile.IndexOf(ite)];
                        var fileType = fileBase.FileName.Substring(fileBase.FileName.Length - 4, 4).ToLower();
                        List<FileInfo> fileInfo = comm.GetAllFilesInDirectory(@"D:\MES_Data\Warehouse" + material[0] + "\\" + materialNumber + "\\" + pictureType + "\\");//遍历文件个数
                        if (fileType == ".jpg")
                        {
                            int JPGcount = fileInfo.Where(c => c.Name.StartsWith(materialNumber + "_") && c.Name.Substring(c.Name.Length - 4, 4) == ".jpg").Count();
                            fileBase.SaveAs(@"D:\MES_Data\Warehouse\" + material[0] + "\\" + materialNumber + "\\" + pictureType + "\\" + materialNumber + "_" + (JPGcount + 1) + fileType);
                        }
                        else if (fileType == ".pdf")
                        {
                            int PDFcount = fileInfo.Where(c => c.Name.StartsWith(materialNumber + "_") && c.Name.Substring(c.Name.Length - 4, 4) == ".jpg").Count();
                            fileBase.SaveAs(@"D:\MES_Data\Warehouse\" + material[0] + "\\" + materialNumber + "\\" + pictureType + "\\" + materialNumber + "_" + (PDFcount + 1) + fileType);
                        }
                    }
                }
                return true;
            }
            return false;
        }

        #endregion

        #region---删除图片/图纸
        public ActionResult DeleteImg(string path, string materialNumber, string pictureType)//path(路径)、materialNumber（物料号）、pictureType（文件类型）
        {
            var materialList = materialNumber.Split('-');
            if (!String.IsNullOrEmpty(path))
            {
                string fileType = path.Substring(path.Length - 4, 4);//扩展名
                string OLDpath = @"D:" + path.Replace('/', '\\');//整个文件路径
                FileInfo pathFile = new FileInfo(OLDpath);//建立文件对象
                int warelist = Convert.ToInt16(pathFile.Name.Split('_')[1].Split('.')[0]);//文件序号
                string New_path = @"D:\MES_Data\Warehouse\" + materialList[0] + "\\" + materialNumber + "_DeleteFile\\";//新建目录
                if (Directory.Exists(@"D:\MES_Data\Warehouse\" + materialList[0] + "\\" + materialNumber + "_DeleteFile\\") == false)//目录是否存在
                {
                    Directory.CreateDirectory(@"D:\MES_Data\Warehouse\" + materialList[0] + "\\" + materialNumber + "_DeleteFile\\");
                    FileInfo Newfile = new FileInfo(New_path + materialNumber + "_1" + fileType);
                    pathFile.CopyTo(Newfile.FullName);//复制文件到新目录
                    pathFile.Delete();//删除原文件
                    List<FileInfo> fileInfo = comm.GetAllFilesInDirectory(@"D:\MES_Data\Warehouse" + materialList[0] + "\\" + materialNumber + "\\" + pictureType + "\\");
                    int filecount = fileInfo.Where(c => c.Extension == fileType).Count();//文件夹里的个数
                    for (int i = warelist; i < filecount + 1; i++)
                    {
                        string filepath = @"D:\MES_Data\Warehouse\" + materialList[0] + "\\" + materialNumber + "\\" + pictureType + "\\" + materialNumber + "_" + (i + 1) + fileType;
                        string NewFile_path = @"D:\MES_Data\Warehouse\" + materialList[0] + "\\" + materialNumber + "\\" + pictureType + "\\" + materialNumber + "_" + i + fileType;
                        System.IO.File.Move(filepath, NewFile_path);
                    }
                }
                else //已有删除目录时
                {
                    List<FileInfo> fileInfo = comm.GetAllFilesInDirectory(@"D:\MES_Data\Warehouse" + materialList[0] + "\\" + materialNumber + "_DeleteFile\\");
                    int count = fileInfo.Where(c => c.Extension == fileType).Count();
                    FileInfo Newfile = new FileInfo(New_path + materialNumber + "_" + (count + 1) + fileType);
                    pathFile.CopyTo(Newfile.FullName);//复制文件到新目录
                    pathFile.Delete();//删除原文件
                    List<FileInfo> pathfileInfo = comm.GetAllFilesInDirectory(@"D:\MES_Data\Warehouse" + materialList[0] + "\\" + materialNumber + "\\" + pictureType + "\\");
                    int filecount = pathfileInfo.Where(c => c.Extension == fileType).Count();//文件夹里的个数
                    for (int i = warelist; i < filecount + 1; i++)
                    {
                        string filepath = @"D:\MES_Data\Warehouse\" + materialList[0] + "\\" + materialNumber + "\\" + pictureType + "\\" + materialNumber + "_" + (i + 1) + fileType;
                        string NewFile_path = @"D:\MES_Data\Warehouse\" + materialList[0] + "\\" + materialNumber + "\\" + pictureType + "\\" + materialNumber + "_" + i + fileType;
                        System.IO.File.Move(filepath, NewFile_path);
                    }
                }
                return Content("true");//删除成功
            }
            else
            {
                return Content("false");//没有路径
            }
        }
        #endregion

        #region---仓库物料出入库

        //基本信息录入和生成条码,materialContainNum(物料条码所包含物料个数)
        [HttpPost]
        public ActionResult MaterialBasicInfo(Warehouse_MaterialBasicInfo_Collection materialBasicInfo_Collection, double materialContainNum)
        {
            JObject Table = new JObject();
            if (((Users)Session["User"]) != null)//判断是否登录
            {
                //判断数据、物料编号、批次、物料生产日、考核部门和班组是否为空
                if (materialBasicInfo_Collection != null && materialBasicInfo_Collection.MaterialNumber != null && materialBasicInfo_Collection.Batch != null && materialBasicInfo_Collection.LeaveFactoryTime != null && materialContainNum !=0 && materialBasicInfo_Collection.Department != null && materialBasicInfo_Collection.Group != null)
                {
                    //判断数据库是否有相同的物料号和批次
                    if (db.Warehouse_MaterialBasicInfo_Collection.Count(c => c.MaterialNumber == materialBasicInfo_Collection.MaterialNumber && c.Batch == materialBasicInfo_Collection.Batch) > 0)
                    {
                        Table.Add("Res", false);
                        Table.Add("Meg", "物料号和批次相同！");
                        return Content(JsonConvert.SerializeObject(Table));
                    }
                    materialBasicInfo_Collection.InvoiceDate = DateTime.Now;//来料日期
                    materialBasicInfo_Collection.ReceivingClerk = ((Users)Session["User"]).UserName;//收料人姓名
                    db.Warehouse_MaterialBasicInfo_Collection.Add(materialBasicInfo_Collection);//添加数据

                    #region--- 生产条码
                    if (!String.IsNullOrEmpty(materialBasicInfo_Collection.MaterialNumber) || materialBasicInfo_Collection.LeaveFactoryTime != null)
                    {
                        string year = materialBasicInfo_Collection.LeaveFactoryTime.Value.Year.ToString().Substring(2);//获取物料生产日期的年后两位数
                        JArray barcodeList = new JArray();
                        int count = 0;
                        for (int i = 1; i <= materialContainNum; i++) 
                        {
                            int num = 1;

                            //查找物料条码前缀一样的最后一个序列号
                            var materBacrcode = db.Warehouse_Material_Bacrcode.Where(c => c.MaterialNumber == materialBasicInfo_Collection.MaterialNumber).OrderByDescending(c => c.MaterialBacrcode).FirstOrDefault(); // 找到相同物料编号,相同生产日期符合条件的最后一个物料条码

                            if (materBacrcode != null)
                            {
                                string materNum = materBacrcode.MaterialBacrcode.Substring(materBacrcode.MaterialBacrcode.Length - 5, 5);//找到条码的最后序列号
                                num = int.Parse(materNum) + 1;//序列号加一
                            }
                            //分割物料编号
                            var arr = materialBasicInfo_Collection.MaterialNumber.Split('-');
                            string materialNumber = arr[0] + arr[1];

                            //组成条码 物料编号+生产时间的年月日+序列编号
                            string barcode = materialNumber + "-" + year + materialBasicInfo_Collection.LeaveFactoryTime.Value.Month.ToString().PadLeft(2, '0') + materialBasicInfo_Collection.LeaveFactoryTime.Value.Day.ToString().PadLeft(2, '0') + num.ToString().PadLeft(5, '0');
                            //新建条码的数据信息
                            Warehouse_Material_Bacrcode material_Bacrcode = new Warehouse_Material_Bacrcode() { MaterialBacrcode = barcode, MaterialNumber = materialBasicInfo_Collection.MaterialNumber,MaterialContainNum = materialContainNum, PrintTime = DateTime.Now, PrintName = ((Users)Session["User"]).UserName };//新建条码的数据信息
                            db.Warehouse_Material_Bacrcode.Add(materBacrcode);
                            count = db.SaveChanges();
                            barcodeList.Add(barcode);
                        }
                        if (count > 0)
                        {
                            Table.Add("Res", true);
                            Table.Add("Meg", "保存成功！");
                            Table.Add("BarcodeList", barcodeList);
                            Table.Add("MaterialDiscription", materialBasicInfo_Collection.MaterialDiscription);
                            return Content(JsonConvert.SerializeObject(Table));
                        }
                    }
                    #endregion
                }
                Table.Add("Res", false);
                Table.Add("Meg", "物料编号/批次/物料生产日期/考核部门和班组其中有为空");//判断数据、物料编号、批次、物料生产日、考核部门和班组是否为空
                return Content(JsonConvert.SerializeObject(Table));
            }
            Table.Add("Res", false);
            Table.Add("Meg", "没有登录！");
            return Content(JsonConvert.SerializeObject(Table));
        }

        //根据物料编号显示数据；materialNumber（物料编号）
        [HttpPost]
        public ActionResult QueryData(string materialNumber)
        {
            JObject Table = new JObject();
            var info = db.Warehouse_MaterialBasicInfo_Collection.Where(c => c.MaterialNumber == materialNumber).FirstOrDefault();
            var querylist = CommonERPDB.ERP_MaterialQuery(materialNumber, "").FirstOrDefault();
            if (info != null || querylist != null)
            {
                if (info == null)
                {
                    //物料编号
                    Table.Add("MaterialNumber", querylist == null ? null : querylist.img01);
                    //物料规格描述
                    Table.Add("MaterialDiscription", querylist == null ? null : querylist.ima021);
                    //批次
                    Table.Add("Batch", querylist == null ? null : querylist.img04);
                    //物料数量（收货数量）
                    Table.Add("MaterialNum", querylist == null ? null : querylist.img08);
                    //有效期
                    Table.Add("EffectiveDay", querylist == null ? null : querylist.img18);
                }
                else
                {
                    //物料编号
                    Table.Add("MaterialNumber", info == null ? null : info.MaterialNumber);
                    //物料规格描述
                    Table.Add("MaterialDiscription", info == null ? null : info.MaterialDiscription);
                    //批次
                    Table.Add("Batch", info == null ? null : info.Batch);
                    //物料数量（收货数量）
                    Table.Add("MaterialNum", info.MaterialNum == 0 ? 0 : info.MaterialNum);
                    //有效期
                    Table.Add("EffectiveDay", info.EffectiveDay == 0 ? 0 : info.EffectiveDay);
                    //追加有效期
                    Table.Add("AddEffectiveDay", info.AddEffectiveDay == 0 ? 0 : info.AddEffectiveDay);
                }
                //物料品名
                Table.Add("ima02", querylist == null ? null : querylist.ima02);
                //仓库编号
                Table.Add("Img02", querylist == null ? null : querylist.img02);
                //储位
                Table.Add("Img03", querylist == null ? null : querylist.img03);
                //物料单位
                Table.Add("Unit", info == null ? null : info.Unit);
                //单位数量换算率
                Table.Add("Img20", querylist == null ? null : querylist.img20);
                //单位数量换算率-对料件库存单
                Table.Add("Img21", querylist == null ? null : querylist.img21);
                //供应商
                Table.Add("Supplier", info == null ? null : info.Supplier);
                //物料类型
                Table.Add("MaterialType", info == null ? null : info.MaterialType);
                //生产日期
                Table.Add("LeaveFactoryTime", info == null ? null : info.LeaveFactoryTime);
                return Content(JsonConvert.SerializeObject(Table));
            }
            return Content(JsonConvert.SerializeObject(Table));
        }

        //物料入库；warehouse_putIn(条码列表)，newWarehouse（MES仓库编号），newWarehouseNum（MES库位号），group（班组）
        [HttpPost]
        public ActionResult MaterialInput(List<string> warehouse_putIn, string newWarehouse, string newWarehouseNum, string group)
        {
            JObject Ware = new JObject();
            if (((Users)Session["User"]) != null)//判断是否登录
            {
                int count = 0;
                foreach (var item in warehouse_putIn)
                {
                    Warehouse_putIn bacrcode = new Warehouse_putIn();
                    bacrcode.MaterialBacrcode = item;
                    bacrcode.NewWarehouse = newWarehouse;
                    bacrcode.NewWarehouseNum = newWarehouseNum;
                    bacrcode.CheckTime = DateTime.Now;
                    bacrcode.Username = ((Users)Session["User"]).UserName;
                    bacrcode.JobNum = ((Users)Session["User"]).UserName.ToString();
                    bacrcode.Group = group;
                    bacrcode.Department = ((Users)Session["User"]).Department;
                    db.Warehouse_putIn.Add(bacrcode);
                    count += db.SaveChanges();
                }
                if (count == warehouse_putIn.Count())
                {
                    Ware.Add("Res", true);
                    Ware.Add("Meg", warehouse_putIn.Count() + "条码入库成功");
                    return Content(JsonConvert.SerializeObject(Ware));
                }
                else
                {
                    Ware.Add("Res", false);
                    Ware.Add("Meg", "入库失败");
                    return Content(JsonConvert.SerializeObject(Ware));
                }
            }
            Ware.Add("Res", false);
            Ware.Add("Meg", "没有登录！");
            return Content(JsonConvert.SerializeObject(Ware));
        }

        #endregion

        #endregion

        #region--打印标签方法

        /// <summary>
        /// </summary>
        /// <param name="material_list">数组包括条码号、描述</param>
        /// <param name="pagecount">打印数量</param>
        /// <param name="ip">打印地址</param>
        /// <param name="port">打印端口</param>
        /// <param name="concentration">打印浓度</param>
        /// <param name="testswitch">输出图片或者打印</param>
        /// <returns></returns>
        public class MC_BarcodePrinting
        {
            public string MaterialNumber { get; set; }

            public string MaterialDiscription { get; set; }

        }
        //查看图片方法
        public ActionResult MaterialLableImages(string materialBarcode, string materialDescription)
        {
            //组织数据
            var num = db.Warehouse_Material_Bacrcode.Where(c => c.MaterialBacrcode == materialBarcode).Select(c => c.MaterialContainNum);
            var AllBitmap = CreateImages(materialBarcode, materialDescription,num.ToString());
            MemoryStream ms = new MemoryStream();
            AllBitmap.Save(ms, System.Drawing.Imaging.ImageFormat.Png);
            AllBitmap.Dispose();
            return File(ms.ToArray(), "image/Png");

        }
        //打印图片方法
        public ActionResult MaterialLablePrint(List<MC_BarcodePrinting> material_list, int pagecount = 1, string ip = "", int port = 0, int concentration = 5)
        {
            int printcount = 0;
            foreach (var item in material_list)
            {
                var list = db.Warehouse_Material_Bacrcode.Where(c => c.MaterialBacrcode == item.MaterialNumber).Select(c=>c.MaterialContainNum).FirstOrDefault();             
                var bm = CreateImages(item.MaterialNumber, item.MaterialDiscription,list.ToString());
                string data = "^XA^MD" + concentration + "~DGR:ZONE.GRF,";
                int totalbytes = bm.ToString().Length;
                int rowbytes = 10;
                string hex = ZebraUnity.BmpToZpl(bm, out totalbytes, out rowbytes);
                data += totalbytes + "," + rowbytes + "," + hex;
                data += "^LH0,0^FO130,0^XGR:ZONE.GRF^FS^XZ";
                string result = ZebraUnity.IPPrint(data.ToString(), pagecount, ip, port);
                if (result == "打印成功！")
                {
                    printcount++;
                }
            }
            string res = (printcount > 0 ? printcount + "个打印成功!" : "") + ((material_list.Count - printcount) > 0 ? (material_list.Count - printcount) + "个打印失败！" : "");
            return Content(res);
        }
        //生成图片方法
        public Bitmap CreateImages(string materialNumber, string materialDiscription,string num)
        {
            int initialWidth = 550, initialHeight = 250;
            Bitmap AllBitmap = new Bitmap(initialWidth, initialHeight);
            Graphics theGraphics = Graphics.FromImage(AllBitmap);
            Brush bush = new SolidBrush(System.Drawing.Color.Black);
            theGraphics.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
            theGraphics.Clear(System.Drawing.Color.FromArgb(120, 240, 180));
            Pen pen = new Pen(Color.Black, 3);//定义笔的大小

            //引入条码号
            StringFormat format = new StringFormat();
            format.Alignment = StringAlignment.Center; //居中
            System.Drawing.Font myFont_materialNumber;
            myFont_materialNumber = new System.Drawing.Font("Microsoft YaHei UI", 18, FontStyle.Regular);
            theGraphics.DrawString(materialNumber, myFont_materialNumber, bush, 230, 16, format);
            //引入条形码
            Bitmap spc_materialnumberBarcode = BarCodeLablePrint.BarCodeToImg(materialNumber, 400, 32);
            theGraphics.DrawImage(spc_materialnumberBarcode, 30, 50, (float)(spc_materialnumberBarcode.Width), (float)(spc_materialnumberBarcode.Height));
            //引入数量
            theGraphics.DrawString("1:"+num, myFont_materialNumber, bush, 430, 16, format);


            //引入描述
            StringFormat format1 = new StringFormat();
            format1.Alignment = StringAlignment.Near; //居中
            if (materialDiscription.Length > 0 && materialDiscription.Length < 100)
            {

                Rectangle mc_materialDiscription = new Rectangle(35, 85, 500, 85);
                myFont_materialNumber = new System.Drawing.Font("Microsoft YaHei UI", 16, FontStyle.Regular);
                theGraphics.DrawString(materialDiscription, myFont_materialNumber, bush, mc_materialDiscription, format1);
            }
            else
            {
                Rectangle mc_materialDiscription = new Rectangle(60, 85, 455, 150);
                myFont_materialNumber = new System.Drawing.Font("Microsoft YaHei UI", 10, FontStyle.Regular);
                theGraphics.DrawString(materialDiscription, myFont_materialNumber, bush, mc_materialDiscription, format1);
            }

            Bitmap bm = new Bitmap(BarCodeLablePrint.ConvertTo1Bpp1(BarCodeLablePrint.ToGray(AllBitmap)));//图形转二值
            return bm;
        }
        #endregion

        #region ---其他方法
        // GET: Warehouse_Material/Details/5
        public ActionResult Details(int? id)
        {
            if (id == null)
            {
                return new HttpStatusCodeResult(HttpStatusCode.BadRequest);
            }
            Warehouse_Material_BaseInfo warehouse_Material_BaseInfo = db.Warehouse_Material_BaseInfo.Find(id);
            if (warehouse_Material_BaseInfo == null)
            {
                return HttpNotFound();
            }
            return View(warehouse_Material_BaseInfo);
        }

        // GET: Warehouse_Material/Create
        public ActionResult Create()
        {
            return View();
        }

        // POST: Warehouse_Material/Create
        // 为了防止“过多发布”攻击，请启用要绑定到的特定属性，有关 
        // 详细信息，请参阅 https://go.microsoft.com/fwlink/?LinkId=317598。
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult Create([Bind(Include = "ID,ManufactorNum,ManufactorName,MaterialNumber,ProductName,Specifications,Type,VarietyType")] Warehouse_Material_BaseInfo warehouse_Material_BaseInfo)
        {
            if (ModelState.IsValid)
            {
                db.Warehouse_Material_BaseInfo.Add(warehouse_Material_BaseInfo);
                db.SaveChanges();
                return RedirectToAction("Index");
            }

            return View(warehouse_Material_BaseInfo);
        }

        // GET: Warehouse_Material/Edit/5
        public ActionResult Edit(int? id)
        {
            if (id == null)
            {
                return new HttpStatusCodeResult(HttpStatusCode.BadRequest);
            }
            Warehouse_Material_BaseInfo warehouse_Material_BaseInfo = db.Warehouse_Material_BaseInfo.Find(id);
            if (warehouse_Material_BaseInfo == null)
            {
                return HttpNotFound();
            }
            return View(warehouse_Material_BaseInfo);
        }

        // POST: Warehouse_Material/Edit/5
        // 为了防止“过多发布”攻击，请启用要绑定到的特定属性，有关 
        // 详细信息，请参阅 https://go.microsoft.com/fwlink/?LinkId=317598。
        [HttpPost]
        [ValidateAntiForgeryToken]
        public ActionResult Edit([Bind(Include = "ID,ManufactorNum,ManufactorName,MaterialNumber,ProductName,Specifications,Type,VarietyType")] Warehouse_Material_BaseInfo warehouse_Material_BaseInfo)
        {
            if (ModelState.IsValid)
            {
                db.Entry(warehouse_Material_BaseInfo).State = EntityState.Modified;
                db.SaveChanges();
                return RedirectToAction("Index");
            }
            return View(warehouse_Material_BaseInfo);
        }

        // GET: Warehouse_Material/Delete/5
        public ActionResult Delete(int? id)
        {
            if (id == null)
            {
                return new HttpStatusCodeResult(HttpStatusCode.BadRequest);
            }
            Warehouse_Material_BaseInfo warehouse_Material_BaseInfo = db.Warehouse_Material_BaseInfo.Find(id);
            if (warehouse_Material_BaseInfo == null)
            {
                return HttpNotFound();
            }
            return View(warehouse_Material_BaseInfo);
        }

        // POST: Warehouse_Material/Delete/5
        [HttpPost, ActionName("Delete")]
        [ValidateAntiForgeryToken]
        public ActionResult DeleteConfirmed(int id)
        {
            Warehouse_Material_BaseInfo warehouse_Material_BaseInfo = db.Warehouse_Material_BaseInfo.Find(id);
            db.Warehouse_Material_BaseInfo.Remove(warehouse_Material_BaseInfo);
            db.SaveChanges();
            return RedirectToAction("Index");
        }
        #endregion


        #region------库存金额查询

        public ActionResult StockAmountCalculate()
        {
            ViewBag.financerecordcount = 0;
            ViewBag.mcunissuerecordcount = 0;
            ViewBag.queryfinancedatatimespan = null;
            ViewBag.querymc_unissuedatatimespan = null;
            return View();
        }

        [HttpPost]
        public ActionResult StockAmountCalculateGetExcel(string outputexcelfile, DateTime inputdate, DateTime enddate)
        {
            //cxcr006 成品类表头
            string[] columns = { "料号", "品名", "规格", "面积", "本月结存数", "本月结存单价", "本月结存金额", "30天", "90天", "180天", "365天", "2年", "3年", "3-5年", "5年以上", "会计科目", "库位号", "分类明细" };
            //cxcr006_raw_material 原材料类表头
            string[] columns_raw_material = { "料号", "品名", "规格", "面积", "本月结存数", "本月结存单价", "本月结存金额", "30天", "90天", "180天", "365天", "2年", "3年", "3-5年", "5年以上", "会计科目", "库位号", "分类明细", "工单号", "工单备注", "工单录入日期", "单位", "应发数量", "已发数量", "未发数量" };
            //在制品类表头
            string[] columns_work_in_process = { "工单号", "料号", "上月结存数量", "上月结存金额", "期间", "工单年月份", "年度", "月份", "物料品名", "其他分群码四", "物料规格", "是否为重覆性生产料件 (Y/N)", "重工否(Y/N)", "备注", "分类明细" };
            //csfr008 MC表发料记录表表头
            string[] columns_raw_material_MC = { "工单号", "工单备注", "工单录入日期", "生产数量", "入库数量", "料号", "品名", "规格", "单位", "应发数量", "已发数量", "未发数量", "订单类型" };

            byte[] filecontent = null;
            string re = "";
            //财务整个月底结存表记录
            List<cxcr006> financealldata = CommonERPDB.ERP_FinanceDetialsQuery();
            //筛选出科目140501的记录
            var financedata = financealldata.Where(c => c.AccountingSubject == 140501).ToList();

            //按年月查出仓库编号是LCWC1，且库位编号是CWC01的记录
            var outsiderecord = CommonERPDB.OutsideWarehouseQuery(enddate.Year, enddate.Month);
            //取出厂外仓的所有物料号
            var mn_list = outsiderecord.Select(c => c.imk01).ToList();
            //根据厂外仓物料号统计厂外仓信息
            var outsideWS = financedata.Where(c => mn_list.Contains(c.tc_cxc01)).ToList();

            //财务上月库存结存明细表排除140501科目以外的记录：原材料-基本材料，原材料-辅助材料，半成品
            var financedata_raw_material = financealldata.Where(c => c.AccountingSubject != 140501).ToList();
            //MC发料表
            var raw_material = CommonERPDB.ERP_MC_NuIssueDetialsQuery(inputdate, enddate).Where(c => c.sfa05_sfa06 > 0).ToList();

            //MC未发料表(修改后方案)
            var raw_material_nuissus = CommonERPDB.ERP_MC_NuIssueDetialsQuery2();

            //第一优先级应该是厂外仓，然后是备库和样品，再然后是配件订单，剩下的就是销售订单了和其他的
            switch (outputexcelfile)
            {
                #region 财务分科
                case "财务科目类":
                    filecontent = ExcelExportHelper.ExportExcel(financealldata.ToList(), outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns);
                    break;
                case "原材料-基本材料":
                    var result1 = financealldata.Where(c => c.AccountingSubject == 140301).ToList();
                    result1.ForEach(a => a.Classification = outputexcelfile);
                    filecontent = ExcelExportHelper.ExportExcel(result1, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns);
                    break;
                case "原材料-辅助材料":
                    var result2 = financealldata.Where(c => c.AccountingSubject == 140302).ToList();
                    result2.ForEach(a => a.Classification = outputexcelfile);
                    filecontent = ExcelExportHelper.ExportExcel(result2, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns);
                    break;
                case "成品":
                    var result3 = financealldata.Where(c => c.AccountingSubject == 140501).ToList();
                    result3.ForEach(a => a.Classification = outputexcelfile);
                    filecontent = ExcelExportHelper.ExportExcel(result3, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns);
                    break;
                case "半成品":
                    var result4 = financealldata.Where(c => c.AccountingSubject == 140502).ToList();
                    result4.ForEach(a => a.Classification = outputexcelfile);
                    filecontent = ExcelExportHelper.ExportExcel(result4, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns);
                    break;
                #endregion

                #region 成品类
                case "成品类":
                    List<cxcr006> result0 = new List<cxcr006>();
                    //"厂外仓"
                    outsideWS.ForEach(c => c.Classification = "厂外仓");
                    result0.AddRange(outsideWS);
                    //"市场备库订单"
                    financedata = financedata.Except(outsideWS).ToList();
                    var marketInfo0 = financedata.Where(c => c.tc_cxc03.Contains("-K0") && (c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏"))).ToList();
                    marketInfo0.ForEach(c => c.Classification = "市场备库订单");
                    result0.AddRange(marketInfo0);
                    //"样品"
                    financedata = financedata.Except(marketInfo0).ToList();
                    var samples0 = financedata.Where(c => c.tc_cxc03.Contains("-J") || c.tc_cxc03.Contains("-RM") || c.tc_cxc03.Contains("-K0")).Where(c => c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏")).ToList();
                    samples0.ForEach(c => c.Classification = "样品");
                    result0.AddRange(samples0);
                    //"配件"
                    financedata = financedata.Except(samples0).ToList();
                    var assemble0 = financedata.Where(c => c.tc_cxc02.Contains("配件")).ToList();
                    assemble0.ForEach(c => c.Classification = "配件");
                    result0.AddRange(assemble0);
                    //"销售订单"
                    financedata = financedata.Except(assemble0).ToList();
                    var sales0 = financedata.Except(financedata.Where(c => c.tc_cxc03.Contains("-J") || c.tc_cxc03.Contains("-RM") || c.tc_cxc03.Contains("-K0"))).Where(c => c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏")).ToList();
                    sales0.ForEach(c => c.Classification = "销售订单");
                    result0.AddRange(sales0);
                    //"其他"
                    var others = financedata.Except(sales0).ToList();
                    others.ForEach(c => c.Classification = "其他");
                    result0.AddRange(others);
                    filecontent = ExcelExportHelper.ExportExcel(result0.ToList(), outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns);
                    break;
                case "厂外仓":
                    //待定
                    outsideWS.ForEach(c => c.Classification = outputexcelfile);
                    filecontent = ExcelExportHelper.ExportExcel(outsideWS, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns);
                    break;
                case "市场备库订单":
                    //排除厂外仓记录
                    financedata = financedata.Except(outsideWS).ToList();
                    //科目140501在排除厂外仓后筛选市场备库订单信息
                    var marketInfo = financedata.Where(c => c.tc_cxc03.Contains("-K0") && (c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏"))).ToList();
                    marketInfo.ForEach(c => c.Classification = outputexcelfile);
                    filecontent = ExcelExportHelper.ExportExcel(marketInfo, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns);
                    break;
                case "样品":
                    //排除厂外仓记录
                    financedata = financedata.Except(outsideWS).ToList();
                    //科目140501在排除厂外仓后筛选市场备库订单信息
                    var marketInfo1 = financedata.Where(c => c.tc_cxc03.Contains("-K0") && (c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏"))).ToList();
                    //排除市场备库订单信息
                    financedata = financedata.Except(marketInfo1).ToList();
                    //筛选样品信息
                    var samples = financedata.Where(c => c.tc_cxc03.Contains("-J") || c.tc_cxc03.Contains("-RM") || c.tc_cxc03.Contains("-K0")).Where(c => c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏")).ToList();
                    samples.ForEach(c => c.Classification = outputexcelfile);
                    filecontent = ExcelExportHelper.ExportExcel(samples, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns);
                    break;
                case "配件":
                    //排除厂外仓记录
                    financedata = financedata.Except(outsideWS).ToList();
                    //科目140501在排除厂外仓后筛选市场备库订单信息
                    var marketInfo2 = financedata.Where(c => c.tc_cxc03.Contains("-K0") && (c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏"))).ToList();
                    //排除市场备库订单信息
                    financedata = financedata.Except(marketInfo2).ToList();
                    //筛选样品信息
                    var samples1 = financedata.Where(c => c.tc_cxc03.Contains("-J") || c.tc_cxc03.Contains("-RM") || c.tc_cxc03.Contains("-K0")).Where(c => c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏")).ToList();
                    //排除样品信息
                    financedata = financedata.Except(samples1).ToList();
                    //筛选配件
                    var assemble = financedata.Where(c => c.tc_cxc02.Contains("配件")).ToList();
                    assemble.ForEach(c => c.Classification = outputexcelfile);
                    filecontent = ExcelExportHelper.ExportExcel(assemble, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns);
                    break;
                case "销售订单":
                    //排除厂外仓记录
                    financedata = financedata.Except(outsideWS).ToList();
                    //科目140501在排除厂外仓后筛选市场备库订单信息
                    var marketInfo3 = financedata.Where(c => c.tc_cxc03.Contains("-K0") && (c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏"))).ToList();
                    //排除市场备库订单信息
                    financedata = financedata.Except(marketInfo3).ToList();
                    //筛选样品信息
                    var samples2 = financedata.Where(c => c.tc_cxc03.Contains("-J") || c.tc_cxc03.Contains("-RM") || c.tc_cxc03.Contains("-K0")).Where(c => c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏")).ToList();
                    //排除样品信息
                    financedata = financedata.Except(samples2).ToList();
                    //筛选配件
                    var assemble1 = financedata.Where(c => c.tc_cxc02.Contains("配件")).ToList();
                    //排除配件
                    financedata = financedata.Except(assemble1).ToList();
                    //筛选销售订单信息
                    var sales = financedata.Except(financedata.Where(c => c.tc_cxc03.Contains("-J") || c.tc_cxc03.Contains("-RM") || c.tc_cxc03.Contains("-K0"))).Where(c => c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏")).ToList();
                    sales.ForEach(c => c.Classification = outputexcelfile);
                    filecontent = ExcelExportHelper.ExportExcel(sales, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns);
                    break;
                case "其他":
                    //排除厂外仓记录
                    financedata = financedata.Except(outsideWS).ToList();
                    //科目140501在排除厂外仓后筛选市场备库订单信息
                    var marketInfo4 = financedata.Where(c => c.tc_cxc03.Contains("-K0") && (c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏"))).ToList();
                    //排除市场备库订单信息
                    financedata = financedata.Except(marketInfo4).ToList();
                    //筛选样品信息
                    var samples3 = financedata.Where(c => c.tc_cxc03.Contains("-J") || c.tc_cxc03.Contains("-RM") || c.tc_cxc03.Contains("-K0")).Where(c => c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏")).ToList();
                    //排除样品信息
                    financedata = financedata.Except(samples3).ToList();
                    //筛选配件
                    var assemble2 = financedata.Where(c => c.tc_cxc02.Contains("配件")).ToList();
                    //排除配件
                    financedata = financedata.Except(assemble2).ToList();
                    //筛选销售订单信息
                    var sales2 = financedata.Except(financedata.Where(c => c.tc_cxc03.Contains("-J") || c.tc_cxc03.Contains("-RM") || c.tc_cxc03.Contains("-K0"))).Where(c => c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏")).ToList();
                    //排除销售订单信息
                    financedata = financedata.Except(sales2).ToList();
                    financedata.ForEach(c => c.Classification = outputexcelfile);
                    filecontent = ExcelExportHelper.ExportExcel(financedata, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns);
                    break;
                #endregion

                #region 在制品类
                case "在制品类":
                    var result5 = CommonERPDB.ERP_Work_in_process(inputdate, enddate);
                    result5.ForEach(c =>
                    {
                        if (c.sfbud01.Contains("-J") || c.sfbud01.Contains("RM") || c.sfbud01.Contains("-K0"))
                        {
                            c.Classification = "在制市场备库订单";
                        }
                        else
                        {
                            c.Classification = "在制销售订单";
                        }
                    });
                    filecontent = ExcelExportHelper.ExportExcel(result5, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns_work_in_process);
                    break;
                case "在制市场备库订单":
                    var work_in_process1 = CommonERPDB.ERP_Work_in_process(inputdate, enddate).Where(c => c.sfbud01.Contains("-J") || c.sfbud01.Contains("RM") || c.sfbud01.Contains("-K0")).ToList();
                    filecontent = ExcelExportHelper.ExportExcel(work_in_process1, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns_work_in_process);
                    break;
                case "在制销售订单":
                    var work_in_process = CommonERPDB.ERP_Work_in_process(inputdate, enddate);
                    var work_in_process2 = work_in_process.Except(work_in_process.Where(c => c.sfbud01.Contains("-J") || c.sfbud01.Contains("RM") || c.sfbud01.Contains("-K0"))).ToList();
                    filecontent = ExcelExportHelper.ExportExcel(work_in_process2, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns_work_in_process);
                    break;
                #endregion

                #region 原材料
                //MC表发料记录表
                case "MC表发料记录表":
                    filecontent = ExcelExportHelper.ExportExcel(raw_material, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns_raw_material_MC);
                    break;
                #region case "原材料类":
                case "原材料类":
                    List<cxcr006_raw_material> result6 = new List<cxcr006_raw_material>();
                    var financedata_Long = CXCR_ConvertType(financealldata.Where(c => c.AccountingSubject != 140501).ToList());
                    //1.把MC未发料表分成KRMJ和非KRMJ两组记录
                    //2.按物料号求和KRMJ和非KRMJ两组记录
                    //3.用财务financedata-MC未发料两组记录数量（按时间段期减），剩余>0部分转入无订单需求(f增加Classification为"无订单需求(原材料)")，减去部分的MC未发料也增加Classififcationo为"备库订单(原材料)"和"销售订单(原材料)".
                    //1.KRMJ  b
                    var raw_material_b = raw_material.Where(c => c.sfbud01.Contains("-K") || c.sfbud01.Contains("RM") || c.sfbud01.Contains("-J")).ToList();
                    //2.分组求和 b
                    var raw_material_b_sum_list = raw_material_b.GroupBy(c => c.sfa03).Select(g => (new { materinanumber = g.FirstOrDefault().sfa03, unissue_sum = g.Sum(item => item.sfa05_sfa06) })).ToList();
                    //1.非KRMJ  c
                    var raw_material_c = raw_material.Except(raw_material_b).ToList();
                    //2.求和分组  c
                    var raw_material_c_sum_list = raw_material_c.GroupBy(c => c.sfa03).Select(g => (new { materinanumber = g.FirstOrDefault().sfa03, unissue_sum = g.Sum(item => item.sfa05_sfa06) })).ToList();
                    //3.运算
                    foreach (var finance_record in financedata_Long)
                    {
                        double price = finance_record.tc_cxc06 / finance_record.tc_cxc04;//计算单价
                        Dictionary<int, double> a0_dictionary = new Dictionary<int, double> { { 0, finance_record.tc_cxc04 }, { 1, finance_record.tc_cxc07 }, { 2, finance_record.tc_cxc08 }, { 3, finance_record.tc_cxc09 }, { 4, finance_record.tc_cxc10 }, { 5, finance_record.tc_cxc11 }, { 6, finance_record.tc_cxc12 }, { 7, finance_record.tc_cxc13 }, { 8, finance_record.tc_cxc14 } };
                        Dictionary<int, double> a1_dictionary = new Dictionary<int, double>();
                        Dictionary<int, double> a_dictionary = new Dictionary<int, double>();
                        Dictionary<int, double> b_dictionary = new Dictionary<int, double>();
                        Dictionary<int, double> c_dictionary = new Dictionary<int, double>();

                        #region 条号找备库订单求和记录
                        var mc_b_sum_record = raw_material_b_sum_list.Where(c => c.materinanumber == finance_record.tc_cxc01).ToList();
                        if (mc_b_sum_record.Count() > 0)
                        {
                            var sum = mc_b_sum_record.FirstOrDefault().unissue_sum > a0_dictionary[0] ? a0_dictionary[0] : mc_b_sum_record.FirstOrDefault().unissue_sum;//求和>结存?结存：求和
                            b_dictionary.Add(0, sum);
                            a1_dictionary.Add(0, a0_dictionary[0] - sum);
                            for (int i = 8; i > 0; i--)
                            {
                                if (a0_dictionary[i] == 0)
                                {
                                    b_dictionary.Add(i, 0);
                                    a1_dictionary.Add(i, 0);
                                }
                                else if (sum >= a0_dictionary[i])
                                {
                                    b_dictionary.Add(i, a0_dictionary[i]);
                                    a1_dictionary.Add(i, 0);
                                    sum = sum - a0_dictionary[i];
                                }
                                else
                                {
                                    b_dictionary.Add(i, sum);
                                    a1_dictionary.Add(i, a0_dictionary[i] - sum);
                                    sum = 0;
                                }
                            }
                        }
                        else
                        {
                            foreach (var item in a0_dictionary)
                            {
                                a1_dictionary.Add(item.Key, item.Value);
                            }
                        }
                        #endregion

                        #region 条号找销售订单求和记录
                        var mc_c_sum_record = raw_material_c_sum_list.Where(c => c.materinanumber == finance_record.tc_cxc01).ToList();
                        if (mc_c_sum_record.Count() > 0)
                        {
                            var sum = mc_c_sum_record.FirstOrDefault().unissue_sum > a1_dictionary[0] ? a1_dictionary[0] : mc_c_sum_record.FirstOrDefault().unissue_sum;//求和>结存?结存：求和
                            c_dictionary.Add(0, sum);
                            a_dictionary.Add(0, a1_dictionary[0] - sum);
                            for (int i = 8; i > 0; i--)
                            {
                                if (a1_dictionary[i] == 0)
                                {
                                    c_dictionary.Add(i, 0);
                                    a_dictionary.Add(i, 0);
                                }
                                else if (sum >= a1_dictionary[i])
                                {
                                    c_dictionary.Add(i, a1_dictionary[i]);
                                    a_dictionary.Add(i, 0);
                                    sum = sum - a1_dictionary[i];
                                }
                                else
                                {
                                    c_dictionary.Add(i, sum);
                                    a_dictionary.Add(i, a1_dictionary[i] - sum);
                                    sum = 0;
                                }
                            }
                        }
                        else
                        {
                            foreach (var item in a1_dictionary)
                            {
                                a_dictionary.Add(item.Key, item.Value);
                            }
                        }
                        #endregion

                        #region 重建记录
                        //b_array
                        double b0value = 0;
                        b_dictionary.TryGetValue(0, out b0value);
                        if (b0value > 0)
                        {
                            var finance_record_b = CXCR_ConvertTypeSingal(finance_record);
                            finance_record_b.tc_cxc04 = b_dictionary[0];
                            finance_record_b.tc_cxc06 = b_dictionary[0] * price;
                            finance_record_b.tc_cxc07 = b_dictionary[1];
                            finance_record_b.tc_cxc08 = b_dictionary[2];
                            finance_record_b.tc_cxc09 = b_dictionary[3];
                            finance_record_b.tc_cxc10 = b_dictionary[4];
                            finance_record_b.tc_cxc11 = b_dictionary[5];
                            finance_record_b.tc_cxc12 = b_dictionary[6];
                            finance_record_b.tc_cxc13 = b_dictionary[7];
                            finance_record_b.tc_cxc14 = b_dictionary[8];
                            finance_record_b.sfa05_sfa06 = b_dictionary[0];
                            finance_record_b.sfa05 = raw_material_b.Where(c => c.sfa03 == finance_record.tc_cxc01).Sum(c => c.sfa05);
                            finance_record_b.sfa06 = raw_material_b.Where(c => c.sfa03 == finance_record.tc_cxc01).Sum(c => c.sfa06);
                            finance_record_b.Classification = "备库订单(原材料)";
                            result6.Add(finance_record_b);
                        }
                        //c_array
                        double c0value = 0;
                        c_dictionary.TryGetValue(0, out c0value);
                        if (c0value > 0)
                        {
                            var finance_record_c = CXCR_ConvertTypeSingal(finance_record);
                            finance_record_c.tc_cxc04 = c_dictionary[0];
                            finance_record_c.tc_cxc06 = c_dictionary[0] * price;
                            finance_record_c.tc_cxc07 = c_dictionary[1];
                            finance_record_c.tc_cxc08 = c_dictionary[2];
                            finance_record_c.tc_cxc09 = c_dictionary[3];
                            finance_record_c.tc_cxc10 = c_dictionary[4];
                            finance_record_c.tc_cxc11 = c_dictionary[5];
                            finance_record_c.tc_cxc12 = c_dictionary[6];
                            finance_record_c.tc_cxc13 = c_dictionary[7];
                            finance_record_c.tc_cxc14 = c_dictionary[8];
                            finance_record_c.sfa05 = raw_material_c.Where(c => c.sfa03 == finance_record.tc_cxc01).Sum(c => c.sfa05);
                            finance_record_c.sfa06 = raw_material_c.Where(c => c.sfa03 == finance_record.tc_cxc01).Sum(c => c.sfa06);
                            finance_record_c.sfa05_sfa06 = c_dictionary[0];
                            finance_record_c.Classification = "销售订单(原材料)";
                            result6.Add(finance_record_c);
                        }
                        //a_array
                        if (b0value > 0 || c0value > 0)
                        {
                            if (a_dictionary[0] > 0)
                            {
                                var finance_record_d = CXCR_ConvertTypeSingal(finance_record);
                                finance_record_d.tc_cxc04 = a_dictionary[0];
                                finance_record_d.tc_cxc06 = a_dictionary[0] * price;
                                finance_record_d.tc_cxc07 = a_dictionary[1];
                                finance_record_d.tc_cxc08 = a_dictionary[2];
                                finance_record_d.tc_cxc09 = a_dictionary[3];
                                finance_record_d.tc_cxc10 = a_dictionary[4];
                                finance_record_d.tc_cxc11 = a_dictionary[5];
                                finance_record_d.tc_cxc12 = a_dictionary[6];
                                finance_record_d.tc_cxc13 = a_dictionary[7];
                                finance_record_d.tc_cxc14 = a_dictionary[8];
                                finance_record_d.sfa05_sfa06 = a_dictionary[0];
                                finance_record_d.Classification = "无订单需求(原材料)";
                                result6.Add(finance_record_d);
                            }
                            #region 用于检验数据的原始记录
                            //finance_record.Classification = "原始记录";
                            //finance_record.sfa05 = raw_material.Where(c=>c.sfa03==finance_record.tc_cxc01).Sum(c => c.sfa05);
                            //finance_record.sfa06 = raw_material.Where(c => c.sfa03 == finance_record.tc_cxc01).Sum(c => c.sfa06);
                            //finance_record.sfa05_sfa06 = raw_material.Where(c => c.sfa03 == finance_record.tc_cxc01).Sum(c => c.sfa05_sfa06);
                            //result6.Add(finance_record);
                            #endregion
                        }
                        else
                        {
                            finance_record.Classification = "无订单需求(原材料)";
                            result6.Add(finance_record);
                        }
                        #endregion

                    }
                    filecontent = ExcelExportHelper.ExportExcel(result6, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns_raw_material);
                    break;
                #endregion

                #region 备库订单(原材料)""销售订单(原材料)""无订单需求(原材料)"
                case "备库订单(原材料)":
                    //上表转长类型
                    List<cxcr006_raw_material> financedata_raw_material_Long0 = new List<cxcr006_raw_material>();
                    List<cxcr006_raw_material> financedata_raw_material_Long_ExceptbySum = new List<cxcr006_raw_material>();
                    financedata_raw_material_Long0 = CXCR_ConvertType(financedata_raw_material);
                    //MC发料表（排除未发料为0的记录）
                    var mc_unissuedata = CommonERPDB.ERP_MC_NuIssueDetialsQuery(inputdate, enddate).Where(c => c.sfa05_sfa06 != 0).ToList();
                    //1.MC发料表（排除未发料为0的记录）带-K,RM,-J的物料编号 List<string>
                    var mc_unissuedata_K_RM_J_material_number_list = mc_unissuedata.Where(c => c.sfbud01.Contains("-K") || c.sfbud01.Contains("RM") || c.sfbud01.Contains("-J")).Select(c => c.sfa03).Distinct().ToList();
                    var mc_unissuedata_K_RM_J_material_number_list_sum_by_sfa03 = mc_unissuedata.Where(c => mc_unissuedata_K_RM_J_material_number_list.Contains(c.sfa03)).GroupBy(c => c.sfa03).Select(s => new csfr008 { sfa03 = s.FirstOrDefault().sfa03, sfa05 = s.Sum(item => item.sfa05), sfa06 = s.Sum(item => item.sfa06), sfa05_sfa06 = s.Sum(item => item.sfa05_sfa06) }).ToList();
                    //MC发料表（排除未发料为0的记录）带-K,RM,-J的物料编号 List<cxcr006_raw_material>
                    var financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list = financedata_raw_material_Long0.Where(c => mc_unissuedata_K_RM_J_material_number_list.Contains(c.tc_cxc01)).ToList();
                    //追加未发料之和
                    foreach (var item in financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list)
                    {
                        var record_add = mc_unissuedata_K_RM_J_material_number_list_sum_by_sfa03.Where(c => c.sfa03 == item.tc_cxc01).FirstOrDefault();
                        if (record_add != null)
                        {
                            item.sfb01 = record_add.sfb01;
                            item.sfbud01 = record_add.sfbud01;
                            item.sfb81 = record_add.sfb81;
                            item.sfa12 = record_add.sfa12;
                            item.sfa05 = record_add.sfa05;
                            item.sfa06 = record_add.sfa06;
                            item.sfa05_sfa06 = record_add.sfa05_sfa06;
                            //本月结存数>未发料之和,拆成两部分（未发料之和，本月结存数-未发料之和），第二部分转到无订单需求
                            if (item.tc_cxc04 > item.sfa05_sfa06)
                            {
                                //no_order_record无订单需求
                                cxcr006_raw_material no_order_record = new cxcr006_raw_material()
                                {
                                    tc_cxc01 = item.tc_cxc01,
                                    tc_cxc02 = item.tc_cxc02,
                                    tc_cxc03 = item.tc_cxc03,
                                    area = item.area,
                                    tc_cxc04 = item.tc_cxc04 - item.sfa05_sfa06,
                                    tc_cxc05 = item.tc_cxc05,
                                    tc_cxc06 = (item.tc_cxc06 / item.tc_cxc04) * (item.tc_cxc04 - item.sfa05_sfa06),
                                    tc_cxc07 = 0,
                                    tc_cxc08 = 0,
                                    tc_cxc09 = 0,
                                    tc_cxc10 = 0,
                                    tc_cxc11 = 0,
                                    tc_cxc12 = 0,
                                    tc_cxc13 = 0,
                                    tc_cxc14 = 0,
                                    AccountingSubject = item.AccountingSubject,
                                    WarehouseNumber = item.WarehouseNumber,
                                    sfb01 = item.sfb01,
                                    sfbud01 = item.sfbud01,
                                    sfb81 = item.sfb81,
                                    sfa12 = item.sfa12,
                                    sfa05 = 0,
                                    sfa06 = 0,
                                    sfa05_sfa06 = 0
                                };
                                double nu_send = item.sfa05_sfa06;
                                double endjine = item.tc_cxc06;
                                item.tc_cxc06 = (endjine / item.tc_cxc04) * item.sfa05_sfa06;
                                item.tc_cxc04 = nu_send; //备库订单.本月结存数
                                double item_tc_cxc04 = item.tc_cxc04;
                                if (item.tc_cxc14 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc14 = item.tc_cxc14;
                                        item.tc_cxc14 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc14 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc14;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc14 = item.tc_cxc14 - item_tc_cxc04;
                                        item.tc_cxc14 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc13 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc13 = item.tc_cxc13;
                                        item.tc_cxc13 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc13 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc13;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc13 = item.tc_cxc13 - item_tc_cxc04;
                                        item.tc_cxc13 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc12 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc12 = item.tc_cxc12;
                                        item.tc_cxc12 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc12 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc12;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc12 = item.tc_cxc12 - item_tc_cxc04;
                                        item.tc_cxc12 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc11 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc11 = item.tc_cxc11;
                                        item.tc_cxc11 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc11 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc11;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc11 = item.tc_cxc11 - item_tc_cxc04;
                                        item.tc_cxc11 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc10 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc10 = item.tc_cxc10;
                                        item.tc_cxc10 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc10 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc10;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc10 = item.tc_cxc10 - item_tc_cxc04;
                                        item.tc_cxc10 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc09 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc09 = item.tc_cxc09;
                                        item.tc_cxc09 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc09 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc09;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc09 = item.tc_cxc09 - item_tc_cxc04;
                                        item.tc_cxc09 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc08 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc08 = item.tc_cxc08;
                                        item.tc_cxc08 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc08 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc08;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc08 = item.tc_cxc08 - item_tc_cxc04;
                                        item.tc_cxc08 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc07 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc07 = item.tc_cxc07;
                                        item.tc_cxc07 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc07 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc07;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc07 = item.tc_cxc07 - item_tc_cxc04;
                                        item.tc_cxc07 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                financedata_raw_material_Long_ExceptbySum.Add(no_order_record);
                            }
                        }
                    }
                    financedata_raw_material_Long_ExceptbySum.ForEach(c => c.Classification = "无订单需求(原材料)");
                    financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list.ForEach(c => c.Classification = "备库订单(原材料)");
                    financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list.AddRange(financedata_raw_material_Long_ExceptbySum);
                    if (financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list == null)
                    {
                        cxcr006_raw_material newrecord = new cxcr006_raw_material();
                        newrecord.tc_cxc01 = "无记录";
                        financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list.Add(newrecord);
                    }
                    filecontent = ExcelExportHelper.ExportExcel(financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns_raw_material);
                    break;
                case "销售订单(原材料)":
                    //2.MC发料表（排除未发料为0的记录）不带-K,RM,-J的物料编号 List<string>
                    //MC发料表（排除未发料为0的记录）
                    List<cxcr006_raw_material> financedata_raw_material_Long1 = new List<cxcr006_raw_material>();
                    List<cxcr006_raw_material> financedata_raw_material_Long_ExceptbySum1 = new List<cxcr006_raw_material>();
                    financedata_raw_material_Long1 = CXCR_ConvertType(financedata_raw_material);
                    var mc_unissuedata1 = CommonERPDB.ERP_MC_NuIssueDetialsQuery(inputdate, enddate).Where(c => c.sfa05_sfa06 != 0).ToList();
                    var mc_unissuedata_K_RM_J_material_number_list1 = mc_unissuedata1.Where(c => c.sfbud01.Contains("-K") || c.sfbud01.Contains("RM") || c.sfbud01.Contains("-J")).Select(c => c.sfa03).Distinct().ToList();
                    var mc_unissuedata_Except_K_RM_J_material_number_list = mc_unissuedata1.Select(c => c.sfa03).Distinct().Except(mc_unissuedata_K_RM_J_material_number_list1).ToList();
                    var mc_unissuedata_Except_K_RM_J_material_number_list_sum_by_sfa03 = mc_unissuedata1.Where(c => mc_unissuedata_Except_K_RM_J_material_number_list.Contains(c.sfa03)).GroupBy(c => c.sfa03).Select(s => new csfr008 { sfa03 = s.FirstOrDefault().sfa03, sfa05 = s.Sum(item => item.sfa05), sfa06 = s.Sum(item => item.sfa06), sfa05_sfa06 = s.Sum(item => item.sfa05_sfa06) }).ToList();
                    //MC发料表（排除未发料为0的记录）不带-K,RM,-J的物料编号 List<cxcr006_raw_material>
                    var financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list = financedata_raw_material_Long1.Where(c => mc_unissuedata_Except_K_RM_J_material_number_list.Contains(c.tc_cxc01)).ToList();
                    //追加未发料之和
                    foreach (var item in financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list)
                    {
                        var record_add = mc_unissuedata_Except_K_RM_J_material_number_list_sum_by_sfa03.Where(c => c.sfa03 == item.tc_cxc01).FirstOrDefault();
                        if (record_add != null)
                        {
                            item.sfb01 = record_add.sfb01;
                            item.sfbud01 = record_add.sfbud01;
                            item.sfb81 = record_add.sfb81;
                            item.sfa12 = record_add.sfa12;
                            item.sfa05 = record_add.sfa05;
                            item.sfa06 = record_add.sfa06;
                            item.sfa05_sfa06 = record_add.sfa05_sfa06;
                            //本月结存数>未发料之和,拆成两部分（未发料之和，本月结存数-未发料之和），第二部分转到无订单需求
                            if (item.tc_cxc04 > item.sfa05_sfa06)
                            {
                                //no_order_record无订单需求
                                cxcr006_raw_material no_order_record = new cxcr006_raw_material()
                                {
                                    tc_cxc01 = item.tc_cxc01,
                                    tc_cxc02 = item.tc_cxc02,
                                    tc_cxc03 = item.tc_cxc03,
                                    area = item.area,
                                    tc_cxc04 = item.tc_cxc04 - item.sfa05_sfa06,
                                    tc_cxc05 = item.tc_cxc05,
                                    tc_cxc06 = (item.tc_cxc06 / item.tc_cxc04) * (item.tc_cxc04 - item.sfa05_sfa06),
                                    tc_cxc07 = 0,
                                    tc_cxc08 = 0,
                                    tc_cxc09 = 0,
                                    tc_cxc10 = 0,
                                    tc_cxc11 = 0,
                                    tc_cxc12 = 0,
                                    tc_cxc13 = 0,
                                    tc_cxc14 = 0,
                                    AccountingSubject = item.AccountingSubject,
                                    WarehouseNumber = item.WarehouseNumber,
                                    sfb01 = item.sfb01,
                                    sfbud01 = item.sfbud01,
                                    sfb81 = item.sfb81,
                                    sfa12 = item.sfa12,
                                    sfa05 = 0,
                                    sfa06 = 0,
                                    sfa05_sfa06 = 0
                                };
                                double nu_send = item.sfa05_sfa06;
                                double endjine = item.tc_cxc06;
                                item.tc_cxc06 = (endjine / item.tc_cxc04) * item.sfa05_sfa06;
                                item.tc_cxc04 = nu_send; //备库订单.本月结存数
                                double item_tc_cxc04 = item.tc_cxc04;
                                if (item.tc_cxc14 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc14 = item.tc_cxc14;
                                        item.tc_cxc14 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc14 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc14;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc14 = item.tc_cxc14 - item_tc_cxc04;
                                        item.tc_cxc14 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc13 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc13 = item.tc_cxc13;
                                        item.tc_cxc13 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc13 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc13;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc13 = item.tc_cxc13 - item_tc_cxc04;
                                        item.tc_cxc13 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc12 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc12 = item.tc_cxc12;
                                        item.tc_cxc12 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc12 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc12;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc12 = item.tc_cxc12 - item_tc_cxc04;
                                        item.tc_cxc12 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc11 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc11 = item.tc_cxc11;
                                        item.tc_cxc11 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc11 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc11;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc11 = item.tc_cxc11 - item_tc_cxc04;
                                        item.tc_cxc11 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc10 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc10 = item.tc_cxc10;
                                        item.tc_cxc10 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc10 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc10;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc10 = item.tc_cxc10 - item_tc_cxc04;
                                        item.tc_cxc10 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc09 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc09 = item.tc_cxc09;
                                        item.tc_cxc09 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc09 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc09;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc09 = item.tc_cxc09 - item_tc_cxc04;
                                        item.tc_cxc09 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc08 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc08 = item.tc_cxc08;
                                        item.tc_cxc08 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc08 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc08;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc08 = item.tc_cxc08 - item_tc_cxc04;
                                        item.tc_cxc08 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc07 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc07 = item.tc_cxc07;
                                        item.tc_cxc07 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc07 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc07;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc07 = item.tc_cxc07 - item_tc_cxc04;
                                        item.tc_cxc07 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                financedata_raw_material_Long_ExceptbySum1.Add(no_order_record);
                            }
                        }
                    }
                    financedata_raw_material_Long_ExceptbySum1.ForEach(c => c.Classification = "无订单需求(原材料)");
                    financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.ForEach(c => c.Classification = "销售订单(原材料)");
                    financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.AddRange(financedata_raw_material_Long_ExceptbySum1);
                    if (financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list == null)
                    {
                        cxcr006_raw_material newrecord = new cxcr006_raw_material();
                        newrecord.tc_cxc01 = "无记录";
                        financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.Add(newrecord);
                    }
                    filecontent = ExcelExportHelper.ExportExcel(financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns_raw_material);
                    break;
                case "无订单需求(原材料)":
                    // 财务上月库存结存明细表排除140501科目以外的记录：原材料 - 基本材料，原材料 - 辅助材料，半成品
                    var financedata_raw_material2 = financealldata.Where(c => c.AccountingSubject != 140501).ToList();
                    //上表转长类型
                    List<cxcr006_raw_material> financedata_raw_material_Long2 = new List<cxcr006_raw_material>();
                    List<cxcr006_raw_material> financedata_raw_material_Long_ExceptbySum2 = new List<cxcr006_raw_material>();
                    financedata_raw_material_Long2 = CXCR_ConvertType(financedata_raw_material);
                    //MC发料表（排除未发料为0的记录）
                    var mc_unissuedata2 = CommonERPDB.ERP_MC_NuIssueDetialsQuery(inputdate, enddate).Where(c => c.sfa05_sfa06 != 0).ToList();

                    //1.MC发料表（排除未发料为0的记录）带-K,RM,-J的物料编号 List<string>
                    var mc_unissuedata_K_RM_J_material_number_list2 = mc_unissuedata2.Where(c => c.sfbud01.Contains("-K") || c.sfbud01.Contains("RM") || c.sfbud01.Contains("-J")).Select(c => c.sfa03).Distinct().ToList();
                    var mc_unissuedata_K_RM_J_material_number_list_sum_by_sfa03_2 = mc_unissuedata2.Where(c => mc_unissuedata_K_RM_J_material_number_list2.Contains(c.sfa03)).GroupBy(c => c.sfa03).Select(s => new csfr008 { sfa03 = s.FirstOrDefault().sfa03, sfa05 = s.Sum(item => item.sfa05), sfa06 = s.Sum(item => item.sfa06), sfa05_sfa06 = s.Sum(item => item.sfa05_sfa06) }).ToList();
                    //MC发料表（排除未发料为0的记录）带-K,RM,-J的物料编号 List<cxcr006_raw_material>
                    var financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list2 = financedata_raw_material_Long2.Where(c => mc_unissuedata_K_RM_J_material_number_list2.Contains(c.tc_cxc01)).ToList();
                    //追加未发料之和
                    foreach (var item in financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list2)
                    {
                        var record_add = mc_unissuedata_K_RM_J_material_number_list_sum_by_sfa03_2.Where(c => c.sfa03 == item.tc_cxc01).FirstOrDefault();
                        if (record_add != null)
                        {
                            item.sfa05 = record_add.sfa05;
                            item.sfa06 = record_add.sfa06;
                            item.sfa05_sfa06 = record_add.sfa05_sfa06;
                            //本月结存数>未发料之和,拆成两部分（未发料之和，本月结存数-未发料之和），第二部分转到无订单需求
                            if (item.tc_cxc04 > item.sfa05_sfa06)
                            {
                                //no_order_record无订单需求
                                cxcr006_raw_material no_order_record = new cxcr006_raw_material()
                                {
                                    tc_cxc01 = item.tc_cxc01,
                                    tc_cxc02 = item.tc_cxc02,
                                    tc_cxc03 = item.tc_cxc03,
                                    area = item.area,
                                    tc_cxc04 = item.tc_cxc04 - item.sfa05_sfa06,
                                    tc_cxc05 = item.tc_cxc05,
                                    tc_cxc06 = (item.tc_cxc06 / item.tc_cxc04) * (item.tc_cxc04 - item.sfa05_sfa06),
                                    tc_cxc07 = 0,
                                    tc_cxc08 = 0,
                                    tc_cxc09 = 0,
                                    tc_cxc10 = 0,
                                    tc_cxc11 = 0,
                                    tc_cxc12 = 0,
                                    tc_cxc13 = 0,
                                    tc_cxc14 = 0,
                                    AccountingSubject = item.AccountingSubject,
                                    WarehouseNumber = item.WarehouseNumber,
                                    sfb01 = item.sfb01,
                                    sfbud01 = item.sfbud01,
                                    sfb81 = item.sfb81,
                                    sfa12 = item.sfa12,
                                    sfa05 = 0,
                                    sfa06 = 0,
                                    sfa05_sfa06 = 0
                                };
                                double nu_send = item.sfa05_sfa06;
                                double endjine = item.tc_cxc06;
                                item.tc_cxc06 = (endjine / item.tc_cxc04) * item.sfa05_sfa06;
                                item.tc_cxc04 = nu_send; //备库订单.本月结存数
                                double item_tc_cxc04 = item.tc_cxc04;
                                if (item.tc_cxc14 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc14 = item.tc_cxc14;
                                        item.tc_cxc14 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc14 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc14;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc14 = item.tc_cxc14 - item_tc_cxc04;
                                        item.tc_cxc14 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc13 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc13 = item.tc_cxc13;
                                        item.tc_cxc13 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc13 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc13;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc13 = item.tc_cxc13 - item_tc_cxc04;
                                        item.tc_cxc13 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc12 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc12 = item.tc_cxc12;
                                        item.tc_cxc12 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc12 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc12;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc12 = item.tc_cxc12 - item_tc_cxc04;
                                        item.tc_cxc12 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc11 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc11 = item.tc_cxc11;
                                        item.tc_cxc11 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc11 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc11;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc11 = item.tc_cxc11 - item_tc_cxc04;
                                        item.tc_cxc11 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc10 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc10 = item.tc_cxc10;
                                        item.tc_cxc10 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc10 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc10;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc10 = item.tc_cxc10 - item_tc_cxc04;
                                        item.tc_cxc10 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc09 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc09 = item.tc_cxc09;
                                        item.tc_cxc09 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc09 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc09;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc09 = item.tc_cxc09 - item_tc_cxc04;
                                        item.tc_cxc09 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc08 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc08 = item.tc_cxc08;
                                        item.tc_cxc08 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc08 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc08;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc08 = item.tc_cxc08 - item_tc_cxc04;
                                        item.tc_cxc08 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc07 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc07 = item.tc_cxc07;
                                        item.tc_cxc07 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc07 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc07;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc07 = item.tc_cxc07 - item_tc_cxc04;
                                        item.tc_cxc07 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                financedata_raw_material_Long_ExceptbySum2.Add(no_order_record);
                            }
                        }
                    }

                    //2.MC发料表（排除未发料为0的记录）不带-K,RM,-J的物料编号 List<string>
                    var mc_unissuedata_Except_K_RM_J_material_number_list2 = mc_unissuedata2.Select(c => c.sfa03).Distinct().Except(mc_unissuedata_K_RM_J_material_number_list2).ToList();
                    var mc_unissuedata_Except_K_RM_J_material_number_list_sum_by_sfa03_2 = mc_unissuedata2.Where(c => mc_unissuedata_Except_K_RM_J_material_number_list2.Contains(c.sfa03)).GroupBy(c => c.sfa03).Select(s => new csfr008 { sfa03 = s.FirstOrDefault().sfa03, sfa05 = s.Sum(item => item.sfa05), sfa06 = s.Sum(item => item.sfa06), sfa05_sfa06 = s.Sum(item => item.sfa05_sfa06) }).ToList();
                    //MC发料表（排除未发料为0的记录）不带-K,RM,-J的物料编号 List<cxcr006_raw_material>
                    var financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list2 = financedata_raw_material_Long2.Where(c => mc_unissuedata_Except_K_RM_J_material_number_list2.Contains(c.tc_cxc01)).ToList();
                    //追加未发料之和
                    foreach (var item in financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list2)
                    {
                        var record_add = mc_unissuedata_Except_K_RM_J_material_number_list_sum_by_sfa03_2.Where(c => c.sfa03 == item.tc_cxc01).FirstOrDefault();
                        if (record_add != null)
                        {
                            item.sfa05 = record_add.sfa05;
                            item.sfa06 = record_add.sfa06;
                            item.sfa05_sfa06 = record_add.sfa05_sfa06;
                            //本月结存数>未发料之和,拆成两部分（未发料之和，本月结存数-未发料之和），第二部分转到无订单需求
                            if (item.tc_cxc04 > item.sfa05_sfa06)
                            {
                                //no_order_record无订单需求
                                cxcr006_raw_material no_order_record = new cxcr006_raw_material()
                                {
                                    tc_cxc01 = item.tc_cxc01,
                                    tc_cxc02 = item.tc_cxc02,
                                    tc_cxc03 = item.tc_cxc03,
                                    area = item.area,
                                    tc_cxc04 = item.tc_cxc04 - item.sfa05_sfa06,
                                    tc_cxc05 = item.tc_cxc05,
                                    tc_cxc06 = (item.tc_cxc06 / item.tc_cxc04) * (item.tc_cxc04 - item.sfa05_sfa06),
                                    tc_cxc07 = 0,
                                    tc_cxc08 = 0,
                                    tc_cxc09 = 0,
                                    tc_cxc10 = 0,
                                    tc_cxc11 = 0,
                                    tc_cxc12 = 0,
                                    tc_cxc13 = 0,
                                    tc_cxc14 = 0,
                                    AccountingSubject = item.AccountingSubject,
                                    WarehouseNumber = item.WarehouseNumber,
                                    sfb01 = item.sfb01,
                                    sfbud01 = item.sfbud01,
                                    sfb81 = item.sfb81,
                                    sfa12 = item.sfa12,
                                    sfa05 = 0,
                                    sfa06 = 0,
                                    sfa05_sfa06 = 0
                                };
                                double nu_send = item.sfa05_sfa06;
                                double endjine = item.tc_cxc06;
                                item.tc_cxc06 = (endjine / item.tc_cxc04) * item.sfa05_sfa06;
                                item.tc_cxc04 = nu_send; //备库订单.本月结存数
                                double item_tc_cxc04 = item.tc_cxc04;
                                if (item.tc_cxc14 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc14 = item.tc_cxc14;
                                        item.tc_cxc14 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc14 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc14;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc14 = item.tc_cxc14 - item_tc_cxc04;
                                        item.tc_cxc14 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc13 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc13 = item.tc_cxc13;
                                        item.tc_cxc13 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc13 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc13;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc13 = item.tc_cxc13 - item_tc_cxc04;
                                        item.tc_cxc13 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc12 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc12 = item.tc_cxc12;
                                        item.tc_cxc12 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc12 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc12;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc12 = item.tc_cxc12 - item_tc_cxc04;
                                        item.tc_cxc12 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc11 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc11 = item.tc_cxc11;
                                        item.tc_cxc11 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc11 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc11;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc11 = item.tc_cxc11 - item_tc_cxc04;
                                        item.tc_cxc11 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc10 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc10 = item.tc_cxc10;
                                        item.tc_cxc10 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc10 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc10;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc10 = item.tc_cxc10 - item_tc_cxc04;
                                        item.tc_cxc10 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc09 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc09 = item.tc_cxc09;
                                        item.tc_cxc09 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc09 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc09;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc09 = item.tc_cxc09 - item_tc_cxc04;
                                        item.tc_cxc09 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc08 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc08 = item.tc_cxc08;
                                        item.tc_cxc08 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc08 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc08;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc08 = item.tc_cxc08 - item_tc_cxc04;
                                        item.tc_cxc08 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                if (item.tc_cxc07 > 0 && item_tc_cxc04 >= 0)
                                {
                                    if (item_tc_cxc04 == 0)
                                    {
                                        no_order_record.tc_cxc07 = item.tc_cxc07;
                                        item.tc_cxc07 = 0;
                                    }
                                    else if (item_tc_cxc04 - item.tc_cxc07 > 0)
                                    {
                                        item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc07;
                                    }
                                    else
                                    {
                                        no_order_record.tc_cxc07 = item.tc_cxc07 - item_tc_cxc04;
                                        item.tc_cxc07 = item_tc_cxc04;
                                        item_tc_cxc04 = 0;
                                    }
                                }
                                financedata_raw_material_Long_ExceptbySum2.Add(no_order_record);
                            }
                        }
                    }
                    //本月结存数<=未发料之和，按本月结存数统计

                    //3.MC发料表（排除未发料为0的记录）无订单需求 List<cxcr006_raw_material>
                    var exceptlist = financedata_raw_material_Long2.Where(c => mc_unissuedata2.Select(d => d.sfa03).Distinct().ToList().Contains(c.sfbud01)).ToList();
                    var financedata_raw_material_Long_Others = financedata_raw_material_Long2.Except(exceptlist).ToList();
                    financedata_raw_material_Long_Others.ForEach(c => c.Classification = "无订单需求(原材料)");

                    //追加1.备库订单与2.销售订单以外的物料清单
                    financedata_raw_material_Long_ExceptbySum2.ForEach(c => c.Classification = "无订单需求(原材料)(分离后剩余数)");
                    financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list2.ForEach(c => c.Classification = "备库订单(原材料)000");
                    financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list2.ForEach(c => c.Classification = "销售订单(原材料)000");
                    financedata_raw_material_Long_Others.AddRange(financedata_raw_material_Long_ExceptbySum2);
                    financedata_raw_material_Long_Others.AddRange(financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list2);
                    financedata_raw_material_Long_Others.AddRange(financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list2);

                    filecontent = ExcelExportHelper.ExportExcel(financedata_raw_material_Long_Others, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns_raw_material);
                    break;
                #endregion

                #endregion

                #region----修改后MC未发料方案
                case "MC表发料记录表(专用记录表)":
                    filecontent = ExcelExportHelper.ExportExcel(raw_material_nuissus, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns_raw_material_MC);
                    break;

                #region case "原材料类2":
                case "原材料类2":
                    List<cxcr006_raw_material> result7 = new List<cxcr006_raw_material>();
                    //取到原材料表记录
                    var financedata_Long2 = CXCR_ConvertType(financealldata.Where(c => c.AccountingSubject != 140501).ToList());
                    result7 = Calculate_raw(financedata_Long2, raw_material_nuissus);
                    filecontent = ExcelExportHelper.ExportExcel(result7, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）", false, columns_raw_material);
                    break;
                #endregion
                #endregion

                default:
                    re = "整个财务结存表";
                    filecontent = ExcelExportHelper.ExportExcel(financealldata, re + "(" + DateTime.Now.ToString("D") + "）", false, columns);
                    break;
            }
            return File(filecontent, ExcelExportHelper.ExcelContentType, outputexcelfile + "(" + DateTime.Now.ToString("D") + "）.xlsx");
        }

        //计算并返回库存金额记录
        public static List<cxcr006_raw_material> Calculate_raw(List<cxcr006_raw_material>financedata, List<tc_cxd_file> raw_material_nuissus)
        {
            List<cxcr006_raw_material> result = new List<cxcr006_raw_material>();

            //计算拆分
            #region 拆分计算
            foreach(var item in financedata)
            {
                cxcr006_raw_material record0 = TransExpV2<cxcr006_raw_material,cxcr006_raw_material>.Trans(item);
                //保留原始记录
                record0.Classification = "原始记录";
                result.Add(record0);

                cxcr006_raw_material record = TransExpV2<cxcr006_raw_material, cxcr006_raw_material>.Trans(item);

                #region 按物料编号汇总后再按订单类别分类汇总扣减
                //取出物料号对应的未发料记录
                var raw_material_Number_list = raw_material_nuissus.Where(c => c.tc_cxd06 == item.tc_cxc01).ToList();
                if(raw_material_Number_list.Count>0)
                {
                    //把排除物料号对应的未发料记录
                    raw_material_nuissus.Except(raw_material_Number_list);
                    Dictionary<string, string> compare_dic = new Dictionary<string, string> { { "-K0", "1.2.公司常规备库单、投标备库单" }, { "-J", "3.业务借样单" }, { "-RM", "4.5.公司展厅单、各大区展厅单" }, { "-C", "6.公司参展单" }, { "-P", "7.品质客诉单" }, { "-B", "8.出货后增加物料单" }, { "-S", "9.费用挂大区单及赠送单" }, { "-Q", "10.工厂品质单" }, { "-R0", "11.研发样品单" }, { "Sales", "销售订单"} };
                    Dictionary<string, List<tc_cxd_file>> raw_material_Number_list_Classify = new Dictionary<string, List<tc_cxd_file>>();
                    //1.2.公司常规备库单、投标备库单-K0
                    raw_material_Number_list_Classify.Add("-K0", raw_material_Number_list.Where(c => c.ordertype == "1.2.公司常规备库单、投标备库单").ToList());
                    raw_material_Number_list.Except(raw_material_Number_list_Classify["-K0"]);
                    //3.业务借样单-J
                    raw_material_Number_list_Classify.Add("-J", raw_material_Number_list.Where(c => c.ordertype == "3.业务借样单").ToList());
                    raw_material_Number_list.Except(raw_material_Number_list_Classify["-J"]);
                    //4.5.公司展厅单、各大区展厅单-RM
                    raw_material_Number_list_Classify.Add("-RM", raw_material_Number_list.Where(c => c.ordertype == "4.5.公司展厅单、各大区展厅单").ToList());
                    raw_material_Number_list.Except(raw_material_Number_list_Classify["-RM"]);
                    //6.公司参展单-C
                    raw_material_Number_list_Classify.Add("-C", raw_material_Number_list.Where(c => c.ordertype == "6.公司参展单").ToList());
                    raw_material_Number_list.Except(raw_material_Number_list_Classify["-C"]);
                    //7.品质客诉单-P
                    raw_material_Number_list_Classify.Add("-P", raw_material_Number_list.Where(c => c.ordertype == "7.品质客诉单").ToList());
                    raw_material_Number_list.Except(raw_material_Number_list_Classify["-P"]);
                    //8.出货后增加物料单-B
                    raw_material_Number_list_Classify.Add("-B", raw_material_Number_list.Where(c => c.ordertype == "8.出货后增加物料单").ToList());
                    raw_material_Number_list.Except(raw_material_Number_list_Classify["-B"]);
                    //9.费用挂大区单及赠送单-S
                    raw_material_Number_list_Classify.Add("-S", raw_material_Number_list.Where(c => c.ordertype == "9.费用挂大区单及赠送单").ToList());
                    raw_material_Number_list.Except(raw_material_Number_list_Classify["-S"]);
                    //10.工厂品质单-Q
                    raw_material_Number_list_Classify.Add("-Q", raw_material_Number_list.Where(c => c.ordertype == "10.工厂品质单").ToList());
                    raw_material_Number_list.Except(raw_material_Number_list_Classify["-Q"]);
                    //11.研发样品单-R0
                    raw_material_Number_list_Classify.Add("-R0", raw_material_Number_list.Where(c => c.ordertype == "11.研发样品单").ToList());
                    raw_material_Number_list.Except(raw_material_Number_list_Classify["-R0"]);
                    //12.其他订单
                    raw_material_Number_list_Classify.Add("Sales", raw_material_Number_list.Where(c => c.ordertype == "销售订单").ToList());
                    #endregion

                    foreach (var raw in raw_material_Number_list_Classify.Keys.ToArray())
                    {
                        List<tc_cxd_file> list = raw_material_Number_list_Classify[raw];
                        //此物料的应发料总数
                        var shuld_issue_sum = list.Sum(c => c.tc_cxd10);
                        //此物料的已发料总数
                        var issued_sum = list.Sum(c => c.tc_cxd11);
                        //此物料的未发料总数
                        var nuissue_sum = list.Sum(c => c.tc_cxd10_tc_cxd11);
                        Dictionary<string, double> issuedata = new Dictionary<string, double> { { "shuld_issue_sum", shuld_issue_sum }, { "issued_sum", issued_sum }, { "nuissue_sum", nuissue_sum } };
                        if (list.Count > 0 && nuissue_sum > 0)
                        {
                            var add_record = Abatement(record, issuedata, compare_dic[raw], out record);
                            result.Add(add_record);
                        }
                    }
                    if(record.tc_cxc04>0)
                    {
                        record.Classification = "无订单需求";
                        result.Add(record);
                    }
                }
                else
                {
                    record.Classification = "无订单需求";
                    result.Add(record);
                }
            }
            result = result.Where(c => c.tc_cxc04 > 0).ToList();
            #endregion
            return result;
        }

        public static class TransExpV2<TIn, TOut>
        {

            private static readonly Func<TIn, TOut> cache = GetFunc();
            private static Func<TIn, TOut> GetFunc()
            {
                ParameterExpression parameterExpression = Expression.Parameter(typeof(TIn), "p");
                List<MemberBinding> memberBindingList = new List<MemberBinding>();

                foreach (var item in typeof(TOut).GetProperties())
                {
                    if (!item.CanWrite)
                        continue;

                    MemberExpression property = Expression.Property(parameterExpression, typeof(TIn).GetProperty(item.Name));
                    MemberBinding memberBinding = Expression.Bind(item, property);
                    memberBindingList.Add(memberBinding);
                }

                MemberInitExpression memberInitExpression = Expression.MemberInit(Expression.New(typeof(TOut)), memberBindingList.ToArray());
                Expression<Func<TIn, TOut>> lambda = Expression.Lambda<Func<TIn, TOut>>(memberInitExpression, new ParameterExpression[] { parameterExpression });

                return lambda.Compile();
            }

            public static TOut Trans(TIn tIn)
            {
                return cache(tIn);
            }

        }

        //库存金额扣减记录
        public static cxcr006_raw_material Abatement(cxcr006_raw_material return_record, Dictionary<string, double> issuedata, string classify, out cxcr006_raw_material record)
        {
            cxcr006_raw_material record0 = TransExpV2<cxcr006_raw_material, cxcr006_raw_material>.Trans(return_record);

            return_record.sfa05 = issuedata["shuld_issue_sum"];
            return_record.sfa06 = issuedata["issued_sum"];
            return_record.sfa05_sfa06 = issuedata["nuissue_sum"];
            double price = return_record.tc_cxc06 / return_record.tc_cxc04;//计算单价
            //原始值
            Dictionary<int, double> orginal_dictionary = new Dictionary<int, double> { { 0, return_record.tc_cxc04 }, { 1, return_record.tc_cxc07 }, { 2, return_record.tc_cxc08 }, { 3, return_record.tc_cxc09 }, { 4, return_record.tc_cxc10 }, { 5, return_record.tc_cxc11 }, { 6, return_record.tc_cxc12 }, { 7, return_record.tc_cxc13 }, { 8, return_record.tc_cxc14 } };
            Dictionary<int, double> record_dic = new Dictionary<int, double>();//输出值，减完未发料后剩余的值
            Dictionary<int, double> return_dic = new Dictionary<int, double>();//返回值，需要要减的未发料对象值

            if (issuedata["nuissue_sum"] > 0)
            {
                var sum = issuedata["nuissue_sum"] > orginal_dictionary[0] ? orginal_dictionary[0] : issuedata["nuissue_sum"];//求和>结存?结存：求和
                return_dic.Add(0, sum);//返回值，需要要减的未发料对象值总和
                record_dic.Add(0, orginal_dictionary[0] - sum);//输出值，减完未发料后剩余的值总数
                for (int i = 8; i > 0; i--)
                {
                    if (orginal_dictionary[i] == 0)
                    {
                        return_dic.Add(i, 0);
                        record_dic.Add(i, 0);
                    }
                    else if (sum >= orginal_dictionary[i])
                    {
                        return_dic.Add(i, orginal_dictionary[i]);
                        record_dic.Add(i, 0);
                        sum = sum - orginal_dictionary[i];
                    }
                    else
                    {
                        return_dic.Add(i, sum);
                        record_dic.Add(i, orginal_dictionary[i] - sum);
                        sum = 0;
                    }
                }

                //修改返回对象值
                return_record.tc_cxc04 = return_dic[0];
                return_record.tc_cxc06 = return_dic[0] * price;
                return_record.tc_cxc07 = return_dic[1];
                return_record.tc_cxc08 = return_dic[2];
                return_record.tc_cxc09 = return_dic[3];
                return_record.tc_cxc10 = return_dic[4];
                return_record.tc_cxc11 = return_dic[5];
                return_record.tc_cxc12 = return_dic[6];
                return_record.tc_cxc13 = return_dic[7];
                return_record.tc_cxc14 = return_dic[8];
                return_record.Classification = classify;

                //修改输出对象值
                record0.tc_cxc04 = record_dic[0];
                record0.tc_cxc06 = record_dic[0] * price;
                record0.tc_cxc07 = record_dic[1];
                record0.tc_cxc08 = record_dic[2];
                record0.tc_cxc09 = record_dic[3];
                record0.tc_cxc10 = record_dic[4];
                record0.tc_cxc11 = record_dic[5];
                record0.tc_cxc12 = record_dic[6];
                record0.tc_cxc13 = record_dic[7];
                record0.tc_cxc14 = record_dic[8];
                //record0.Classification = classify;
            }
            else
            {
                foreach (var item in orginal_dictionary)
                {
                    record_dic.Add(item.Key, item.Value);
                }
            }

            record = record0;
            return return_record;
        }

        //"备库订单(原材料)"Case方法
        public List<cxcr006_raw_material> Raw_SpareOrder(List<cxcr006> financedata_raw_material, DateTime inputdate, DateTime enddate)
        {

            ////财务上月库存结存明细表排除140501科目以外的记录：原材料-基本材料，原材料-辅助材料，半成品
            //var financedata_raw_material = financealldata.Where(c => c.AccountingSubject != 140501).ToList();
            //上表转长类型
            List<cxcr006_raw_material> raw_material_Long = new List<cxcr006_raw_material>();
            List<cxcr006_raw_material> ExceptbySum = new List<cxcr006_raw_material>();
            raw_material_Long = CXCR_ConvertType(financedata_raw_material);
            //MC发料表（排除未发料为0的记录）
            var mc_unissuedata = CommonERPDB.ERP_MC_NuIssueDetialsQuery(inputdate, enddate).Where(c => c.sfa05_sfa06 != 0).ToList();
            //1.MC发料表（排除未发料为0的记录）带-K,RM,-J的物料编号 List<string>
            var mc_unissuedata_K_RM_J_list = mc_unissuedata.Where(c => c.sfbud01.Contains("-K") || c.sfbud01.Contains("RM") || c.sfbud01.Contains("-J")).Select(c => c.sfa03).Distinct().ToList();
            //MC发料表（排除未发料为0的记录）带-K,RM,-J的物料编号 List<cxcr006_raw_material>
            var raw_material_by_mc_unissuedata_K_RM_J_list = raw_material_Long.Where(c => mc_unissuedata_K_RM_J_list.Contains(c.tc_cxc01)).ToList();
            var mc_unissuedata_K_RM_J_material_number_list_sum_by_sfa03 = mc_unissuedata.Where(c => mc_unissuedata_K_RM_J_list.Contains(c.sfa03)).GroupBy(c => c.sfa03).Select(s => new csfr008 { sfa03 = s.FirstOrDefault().sfa03, sfa05 = s.Sum(item => item.sfa05), sfa06 = s.Sum(item => item.sfa06), sfa05_sfa06 = s.Sum(item => item.sfa05_sfa06) }).ToList();
            //追加未发料之和
            foreach (var item in raw_material_by_mc_unissuedata_K_RM_J_list)
            {
                var record_add = mc_unissuedata_K_RM_J_material_number_list_sum_by_sfa03.Where(c => c.sfa03 == item.tc_cxc01).FirstOrDefault();
                if (record_add != null)
                {
                    item.sfb01 = record_add.sfb01;
                    item.sfbud01 = record_add.sfbud01;
                    item.sfb81 = record_add.sfb81;
                    item.sfa12 = record_add.sfa12;
                    item.sfa05 = record_add.sfa05;
                    item.sfa06 = record_add.sfa06;
                    item.sfa05_sfa06 = record_add.sfa05_sfa06;
                    //本月结存数>未发料之和,拆成两部分（未发料之和，本月结存数-未发料之和），第二部分转到无订单需求
                    if (item.tc_cxc04 > item.sfa05_sfa06)
                    {
                        //no_order_record无订单需求
                        cxcr006_raw_material no_order_record = new cxcr006_raw_material()
                        {
                            tc_cxc01 = item.tc_cxc01,
                            tc_cxc02 = item.tc_cxc02,
                            tc_cxc03 = item.tc_cxc03,
                            area = item.area,
                            tc_cxc04 = item.tc_cxc04 - item.sfa05_sfa06,
                            tc_cxc05 = item.tc_cxc05,
                            tc_cxc06 = (item.tc_cxc06 / item.tc_cxc04) * (item.tc_cxc04 - item.sfa05_sfa06),
                            tc_cxc07 = 0,
                            tc_cxc08 = 0,
                            tc_cxc09 = 0,
                            tc_cxc10 = 0,
                            tc_cxc11 = 0,
                            tc_cxc12 = 0,
                            tc_cxc13 = 0,
                            tc_cxc14 = 0,
                            AccountingSubject = item.AccountingSubject,
                            WarehouseNumber = item.WarehouseNumber,
                            sfb01 = item.sfb01,
                            sfbud01 = item.sfbud01,
                            sfb81 = item.sfb81,
                            sfa12 = item.sfa12,
                            sfa05 = 0,
                            sfa06 = 0,
                            sfa05_sfa06 = 0
                        };
                        double nu_send = item.sfa05_sfa06;
                        double endjine = item.tc_cxc06;
                        item.tc_cxc06 = (endjine / item.tc_cxc04) * item.sfa05_sfa06;
                        item.tc_cxc04 = nu_send; //备库订单.本月结存数
                        double item_tc_cxc04 = item.tc_cxc04;
                        if (item.tc_cxc14 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc14 = item.tc_cxc14;
                                item.tc_cxc14 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc14 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc14;
                            }
                            else
                            {
                                no_order_record.tc_cxc14 = item.tc_cxc14 - item_tc_cxc04;
                                item.tc_cxc14 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc13 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc13 = item.tc_cxc13;
                                item.tc_cxc13 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc13 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc13;
                            }
                            else
                            {
                                no_order_record.tc_cxc13 = item.tc_cxc13 - item_tc_cxc04;
                                item.tc_cxc13 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc12 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc12 = item.tc_cxc12;
                                item.tc_cxc12 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc12 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc12;
                            }
                            else
                            {
                                no_order_record.tc_cxc12 = item.tc_cxc12 - item_tc_cxc04;
                                item.tc_cxc12 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc11 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc11 = item.tc_cxc11;
                                item.tc_cxc11 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc11 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc11;
                            }
                            else
                            {
                                no_order_record.tc_cxc11 = item.tc_cxc11 - item_tc_cxc04;
                                item.tc_cxc11 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc10 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc10 = item.tc_cxc10;
                                item.tc_cxc10 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc10 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc10;
                            }
                            else
                            {
                                no_order_record.tc_cxc10 = item.tc_cxc10 - item_tc_cxc04;
                                item.tc_cxc10 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc09 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc09 = item.tc_cxc09;
                                item.tc_cxc09 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc09 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc09;
                            }
                            else
                            {
                                no_order_record.tc_cxc09 = item.tc_cxc09 - item_tc_cxc04;
                                item.tc_cxc09 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc08 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc08 = item.tc_cxc08;
                                item.tc_cxc08 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc08 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc08;
                            }
                            else
                            {
                                no_order_record.tc_cxc08 = item.tc_cxc08 - item_tc_cxc04;
                                item.tc_cxc08 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc07 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc07 = item.tc_cxc07;
                                item.tc_cxc07 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc07 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc07;
                            }
                            else
                            {
                                no_order_record.tc_cxc07 = item.tc_cxc07 - item_tc_cxc04;
                                item.tc_cxc07 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        ExceptbySum.Add(no_order_record);
                    }
                }
            }
            ExceptbySum.ForEach(c => c.Classification = "无订单需求(原材料)");
            raw_material_by_mc_unissuedata_K_RM_J_list.ForEach(c => c.Classification = "备库订单(原材料)");
            raw_material_by_mc_unissuedata_K_RM_J_list.AddRange(ExceptbySum);
            return raw_material_by_mc_unissuedata_K_RM_J_list;
        }

        //"销售订单(原材料)"Case方法
        public List<cxcr006_raw_material> Raw_SaleOrder(List<cxcr006> financealldata, DateTime inputdate, DateTime enddate)
        {
            List<cxcr006_raw_material> financedata_raw_material_Long1 = new List<cxcr006_raw_material>();
            List<cxcr006_raw_material> financedata_raw_material_Long_ExceptbySum = new List<cxcr006_raw_material>();
            var mc_unissuedata1 = CommonERPDB.ERP_MC_NuIssueDetialsQuery(inputdate, enddate).Where(c => c.sfa05_sfa06 != 0).ToList();
            var mc_unissuedata_K_RM_J_material_number_list1 = mc_unissuedata1.Where(c => c.sfbud01.Contains("-K") || c.sfbud01.Contains("RM") || c.sfbud01.Contains("-J")).Select(c => c.sfa03).Distinct().ToList();
            var mc_unissuedata_Except_K_RM_J_material_number_list = mc_unissuedata1.Select(c => c.sfa03).Distinct().Except(mc_unissuedata_K_RM_J_material_number_list1).ToList();
            var mc_unissuedata_Except_K_RM_J_material_number_list_sum_by_sfa03 = mc_unissuedata1.Where(c => mc_unissuedata_Except_K_RM_J_material_number_list.Contains(c.sfa03)).GroupBy(c => c.sfa03).Select(s => new csfr008 { sfa03 = s.FirstOrDefault().sfa03, sfa05 = s.Sum(item => item.sfa05), sfa06 = s.Sum(item => item.sfa06), sfa05_sfa06 = s.Sum(item => item.sfa05_sfa06) }).ToList();
            //MC发料表（排除未发料为0的记录）不带-K,RM,-J的物料编号 List<cxcr006_raw_material>
            var financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list = financedata_raw_material_Long1.Where(c => mc_unissuedata_Except_K_RM_J_material_number_list.Contains(c.tc_cxc01)).ToList();
            //追加未发料之和
            foreach (var item in financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list)
            {
                var record_add = mc_unissuedata_Except_K_RM_J_material_number_list_sum_by_sfa03.Where(c => c.sfa03 == item.tc_cxc01).FirstOrDefault();
                if (record_add != null)
                {
                    item.sfb01 = record_add.sfb01;
                    item.sfbud01 = record_add.sfbud01;
                    item.sfb81 = record_add.sfb81;
                    item.sfa12 = record_add.sfa12;
                    item.sfa05 = record_add.sfa05;
                    item.sfa06 = record_add.sfa06;
                    item.sfa05_sfa06 = record_add.sfa05_sfa06;
                    //本月结存数>未发料之和,拆成两部分（未发料之和，本月结存数-未发料之和），第二部分转到无订单需求
                    if (item.tc_cxc04 > item.sfa05_sfa06)
                    {
                        //no_order_record无订单需求
                        cxcr006_raw_material no_order_record = new cxcr006_raw_material()
                        {
                            tc_cxc01 = item.tc_cxc01,
                            tc_cxc02 = item.tc_cxc02,
                            tc_cxc03 = item.tc_cxc03,
                            area = item.area,
                            tc_cxc04 = item.tc_cxc04 - item.sfa05_sfa06,
                            tc_cxc05 = item.tc_cxc05,
                            tc_cxc06 = (item.tc_cxc06 / item.tc_cxc04) * (item.tc_cxc04 - item.sfa05_sfa06),
                            tc_cxc07 = 0,
                            tc_cxc08 = 0,
                            tc_cxc09 = 0,
                            tc_cxc10 = 0,
                            tc_cxc11 = 0,
                            tc_cxc12 = 0,
                            tc_cxc13 = 0,
                            tc_cxc14 = 0,
                            AccountingSubject = item.AccountingSubject,
                            WarehouseNumber = item.WarehouseNumber,
                            sfb01 = item.sfb01,
                            sfbud01 = item.sfbud01,
                            sfb81 = item.sfb81,
                            sfa12 = item.sfa12,
                            sfa05 = 0,
                            sfa06 = 0,
                            sfa05_sfa06 = 0
                        };
                        double nu_send = item.sfa05_sfa06;
                        double endjine = item.tc_cxc06;
                        item.tc_cxc06 = (endjine / item.tc_cxc04) * item.sfa05_sfa06;
                        item.tc_cxc04 = nu_send; //备库订单.本月结存数
                        double item_tc_cxc04 = item.tc_cxc04;
                        if (item.tc_cxc14 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc14 = item.tc_cxc14;
                                item.tc_cxc14 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc14 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc14;
                            }
                            else
                            {
                                no_order_record.tc_cxc14 = item.tc_cxc14 - item_tc_cxc04;
                                item.tc_cxc14 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc13 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc13 = item.tc_cxc13;
                                item.tc_cxc13 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc13 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc13;
                            }
                            else
                            {
                                no_order_record.tc_cxc13 = item.tc_cxc13 - item_tc_cxc04;
                                item.tc_cxc13 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc12 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc12 = item.tc_cxc12;
                                item.tc_cxc12 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc12 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc12;
                            }
                            else
                            {
                                no_order_record.tc_cxc12 = item.tc_cxc12 - item_tc_cxc04;
                                item.tc_cxc12 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc11 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc11 = item.tc_cxc11;
                                item.tc_cxc11 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc11 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc11;
                            }
                            else
                            {
                                no_order_record.tc_cxc11 = item.tc_cxc11 - item_tc_cxc04;
                                item.tc_cxc11 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc10 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc10 = item.tc_cxc10;
                                item.tc_cxc10 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc10 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc10;
                            }
                            else
                            {
                                no_order_record.tc_cxc10 = item.tc_cxc10 - item_tc_cxc04;
                                item.tc_cxc10 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc09 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc09 = item.tc_cxc09;
                                item.tc_cxc09 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc09 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc09;
                            }
                            else
                            {
                                no_order_record.tc_cxc09 = item.tc_cxc09 - item_tc_cxc04;
                                item.tc_cxc09 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc08 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc08 = item.tc_cxc08;
                                item.tc_cxc08 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc08 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc08;
                            }
                            else
                            {
                                no_order_record.tc_cxc08 = item.tc_cxc08 - item_tc_cxc04;
                                item.tc_cxc08 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc07 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc07 = item.tc_cxc07;
                                item.tc_cxc07 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc07 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc07;
                            }
                            else
                            {
                                no_order_record.tc_cxc07 = item.tc_cxc07 - item_tc_cxc04;
                                item.tc_cxc07 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        financedata_raw_material_Long_ExceptbySum.Add(no_order_record);
                    }
                }
            }
            financedata_raw_material_Long_ExceptbySum.ForEach(c => c.Classification = "无订单需求(原材料)");
            financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.ForEach(c => c.Classification = "销售订单(原材料)");
            financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.AddRange(financedata_raw_material_Long_ExceptbySum);
            return financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list;
        }

        static List<cxcr006_raw_material> CXCR_ConvertType(List<cxcr006> inputlist)
        {
            List<cxcr006_raw_material> result_list = new List<cxcr006_raw_material>();
            foreach (var item in inputlist)
            {
                cxcr006_raw_material record = new cxcr006_raw_material();
                record.tc_cxc01 = item.tc_cxc01;
                record.tc_cxc02 = item.tc_cxc02;
                record.tc_cxc03 = item.tc_cxc03;
                record.area = item.area;
                record.tc_cxc04 = item.tc_cxc04;
                record.tc_cxc05 = item.tc_cxc05;
                record.tc_cxc06 = item.tc_cxc06;
                record.tc_cxc07 = item.tc_cxc07;
                record.tc_cxc08 = item.tc_cxc08;
                record.tc_cxc09 = item.tc_cxc09;
                record.tc_cxc10 = item.tc_cxc10;
                record.tc_cxc11 = item.tc_cxc11;
                record.tc_cxc12 = item.tc_cxc12;
                record.tc_cxc13 = item.tc_cxc13;
                record.tc_cxc14 = item.tc_cxc14;
                record.AccountingSubject = item.AccountingSubject;
                record.WarehouseNumber = item.WarehouseNumber;
                result_list.Add(record);
            }
            return result_list;
        }
        static cxcr006_raw_material CXCR_ConvertTypeSingal(cxcr006_raw_material inputlist)
        {
            cxcr006_raw_material record = new cxcr006_raw_material();
            record.tc_cxc01 = inputlist.tc_cxc01;
            record.tc_cxc02 = inputlist.tc_cxc02;
            record.tc_cxc03 = inputlist.tc_cxc03;
            record.area = inputlist.area;
            record.tc_cxc04 = inputlist.tc_cxc04;
            record.tc_cxc05 = inputlist.tc_cxc05;
            record.tc_cxc06 = inputlist.tc_cxc06;
            record.tc_cxc07 = inputlist.tc_cxc07;
            record.tc_cxc08 = inputlist.tc_cxc08;
            record.tc_cxc09 = inputlist.tc_cxc09;
            record.tc_cxc10 = inputlist.tc_cxc10;
            record.tc_cxc11 = inputlist.tc_cxc11;
            record.tc_cxc12 = inputlist.tc_cxc12;
            record.tc_cxc13 = inputlist.tc_cxc13;
            record.tc_cxc14 = inputlist.tc_cxc14;
            record.AccountingSubject = inputlist.AccountingSubject;
            record.WarehouseNumber = inputlist.WarehouseNumber;
            return record;
        }


        [HttpPost]
        public ActionResult StockAmountCalculate(DateTime inputdate, DateTime enddate, bool outputexcelfile = false)
        {
            //检查ERP
            var connectERPresult = CommonERPDB.TryConnectERP();
            if (connectERPresult != "连接正常")
            {
                JArray result = new JArray();//输出总结果
                JObject testResult = new JObject();
                testResult.Add("类别", "查询失败");
                testResult.Add("分类明细", connectERPresult);
                result.Add(testResult);
                return Content(JsonConvert.SerializeObject(result));
                //return Content("连接ERP数据库服务器失败！请检查网络或者ERP数据库服务器是否已启动。");//{"ORA-12541: TNS: 无监听程序"}
            }

            #region 成品部分
            //按年月查出仓库编号是LCWC1，且库位编号是CWC01的记录
            var outsiderecord = CommonERPDB.OutsideWarehouseQuery(enddate.Year, enddate.Month);
            //开始财务上月库存结存明细表查询时间
            DateTime queryfinancedatabegin = DateTime.Now;
            //var test = CommonERPDB.ERP_MaterialQueryTest2();
            //财务上月库存结存明细表查询   单价tc_cxc05
            var financealldata = CommonERPDB.ERP_FinanceDetialsQuery();
            var financedata = financealldata;
            //计算财务上月库存结存明细表查询时长
            ViewBag.queryfinancedatatimespan = DateTime.Now - queryfinancedatabegin;
            //var dt = DataTableTool.ToDataTable(financedata); //财务上月库存结存明细表转为DataTable类型
            ViewBag.financerecordcount = financedata.Count;//统计财务上月库存结存明细表记录条数
            //取出财务上月库存结存明细表物料号清单
            //List<string> tc_cxc01_list = financedata.Select(c => c.tc_cxc01).Distinct().ToList();  
            //成品金额全部合计
            decimal total = (decimal)financedata.Sum(c => c.tc_cxc06);

            //输出成品全部明细记录
            if (outputexcelfile == true)
            {
                string[] columns = { "料号", "品名", "规格", "面积", "本月结存数", "本月结存单价", "本月结存金额", "30天", "90天", "180天", "365天", "2年", "3年", "3-5年", "5年以上", "会计科目", "库位号" };
                byte[] filecontent = ExcelExportHelper.ExportExcel(financedata, "ERP导出财务月底库存结算表" + DateTime.Now.ToString("D") + "）", false, columns);
                return File(filecontent, ExcelExportHelper.ExcelContentType, "库存结算表（" + DateTime.Now.ToString("D") + "）.xlsx");
            }

            //List <CommonERPDB.Financedetails> financedetails_my = new List<CommonERPDB.Financedetails>();
            JArray results = new JArray();//输出总结果
            //科目清单
            var kemu_list = financedata.Select(c => c.AccountingSubject).Distinct().OrderBy(c => c).ToList();
            JObject resultrecord = new JObject();//单行记录
            Dictionary<int, string> dict = new Dictionary<int, string>();
            dict.Add(140301, "原材料-基本材料");
            dict.Add(140302, "原材料-辅助材料");
            dict.Add(140501, "成品");
            dict.Add(140502, "半成品");
            foreach (var item in kemu_list)
            {
                resultrecord.Add("类别", "财务科目类");
                resultrecord.Add("分类明细", dict[item]);// item==140301? "原材料-基本材料": item == 140302 ? "原材料-辅助材料" : item == 140501? "成品" : item == 140502 ? "半成品":""
                var market1month = financedata.Where(c => c.AccountingSubject == item).Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
                resultrecord.Add("1个月以内", market1month.ToString("n4"));

                var market2_3month = financedata.Where(c => c.AccountingSubject == item).Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
                resultrecord.Add("2-3个月", market2_3month.ToString("n4"));

                var market4_6month = financedata.Where(c => c.AccountingSubject == item).Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
                resultrecord.Add("4-6个月", market4_6month.ToString("n4"));

                var market7_12month = financedata.Where(c => c.AccountingSubject == item).Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
                resultrecord.Add("7-12个月", market7_12month.ToString("n4"));

                var market1_2year = financedata.Where(c => c.AccountingSubject == item).Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
                resultrecord.Add("1-2年", market1_2year.ToString("n4"));

                var market2_3year = financedata.Where(c => c.AccountingSubject == item).Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
                resultrecord.Add("2-3年", market2_3year.ToString("n4"));

                var marketr3_5year = financedata.Where(c => c.AccountingSubject == item).Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
                resultrecord.Add("3-5年", marketr3_5year.ToString("n4"));

                var marketover5year = financedata.Where(c => c.AccountingSubject == item).Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
                resultrecord.Add("5年以上", marketover5year.ToString("n4"));

                var markettotal = market1month + market2_3month + market4_6month + market7_12month + market1_2year + market2_3year + marketr3_5year + marketover5year;
                resultrecord.Add("合计金额", markettotal.ToString("n4"));
                resultrecord.Add("记录条数", financedata.Count(c => c.AccountingSubject == item));
                resultrecord.Add("备注", item);
                results.Add(resultrecord);
                resultrecord = new JObject();
            }

            resultrecord.Add("5年以上", "全部合计");
            resultrecord.Add("合计金额", total.ToString("n4"));
            resultrecord.Add("记录条数", financedata.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            //第一优先级应该是厂外仓，然后是备库和样品，再然后是配件订单，剩下的就是销售订单了和其他的
            financedata = financedata.Where(c => c.AccountingSubject == 140501).ToList();
            //成品 4.厂外仓，财务发出的厂外仓数据为依据  //财务380条，程序208条
            var mn_list = outsiderecord.Select(c => c.imk01).ToList();
            var temp4 = financedata.Where(c => mn_list.Contains(c.tc_cxc01)).ToList();
            financedata = financedata.Except(temp4).ToList(); //排除厂外仓记录
            resultrecord.Add("类别", "成品类");
            resultrecord.Add("分类明细", "厂外仓");
            var market1month4 = temp4.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", market1month4.ToString("n4"));
            var market2_3month4 = temp4.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", market2_3month4.ToString("n4"));
            var market4_6month4 = temp4.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", market4_6month4.ToString("n4"));
            var market7_12month4 = temp4.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", market7_12month4.ToString("n4"));
            var market1_2year4 = temp4.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", market1_2year4.ToString("n4"));
            var market2_3year4 = temp4.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", market2_3year4.ToString("n4"));
            var market3_5year4 = temp4.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", market3_5year4.ToString("n4"));
            var marketover5year4 = temp4.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", marketover5year4.ToString("n4"));
            var markettotal4 = market1month4 + market2_3month4 + market4_6month4 + market7_12month4 + market1_2year4 + market2_3year4 + market3_5year4 + marketover5year4;
            resultrecord.Add("合计金额", markettotal4.ToString("n4"));
            resultrecord.Add("记录条数", temp4.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            //成品 1.市场备库订单   //财务120条，程序115条
            var temp1 = financedata.Where(c => c.tc_cxc03.Contains("-K0") && (c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏"))).ToList();
            var tem1 = financedata.Where(c => c.tc_cxc03.Split(',')[0].Contains("-K0") && ((c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏")))).ToList();
            financedata = financedata.Except(temp1).ToList();//排除市场备库订单记录
            resultrecord.Add("类别", "成品类");
            resultrecord.Add("分类明细", "市场备库订单");
            var market1month1 = temp1.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", market1month1.ToString("n4"));
            var market2_3month1 = temp1.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", market2_3month1.ToString("n4"));
            var market4_6month1 = temp1.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", market4_6month1.ToString("n4"));
            var market7_12month1 = temp1.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", market7_12month1.ToString("n4"));
            var market1_2year1 = temp1.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", market1_2year1.ToString("n4"));
            var market2_3year1 = temp1.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", market2_3year1.ToString("n4"));
            var market3_5year1 = temp1.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", market3_5year1.ToString("n4"));
            var marketover5year1 = temp1.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", marketover5year1.ToString("n4"));
            var markettotal1 = market1month1 + market2_3month1 + market4_6month1 + market7_12month1 + market1_2year1 + market2_3year1 + market3_5year1 + marketover5year1;
            resultrecord.Add("合计金额", markettotal1.ToString("n4"));
            resultrecord.Add("记录条数", temp1.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            //成品 3.样品,订单带-J、-RM、-K  //财务展会样品92，客户借样订单216条，程序405条
            var temp3 = financedata.Where(c => c.tc_cxc03.Contains("-J") || c.tc_cxc03.Contains("-RM") || c.tc_cxc03.Contains("-K0")).Where(c => c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏")).ToList();
            financedata = financedata.Except(temp3).ToList();
            resultrecord.Add("类别", "成品类");
            resultrecord.Add("分类明细", "样品");
            var market1month3 = temp3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", market1month3.ToString("n4"));
            var market2_3month3 = temp3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", market2_3month3.ToString("n4"));
            var market4_6month3 = temp3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", market4_6month3.ToString("n4"));
            var market7_12month3 = temp3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", market7_12month3.ToString("n4"));
            var market1_2year3 = temp3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", market1_2year3.ToString("n4"));
            var market2_3year3 = temp3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", market2_3year3.ToString("n4"));
            var market3_5year3 = temp3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", market3_5year3.ToString("n4"));
            var marketover5year3 = temp3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", marketover5year3.ToString("n4"));
            var markettotal3 = market1month3 + market2_3month3 + market4_6month3 + market7_12month3 + market1_2year3 + market2_3year3 + market3_5year3 + marketover5year3;
            resultrecord.Add("合计金额", markettotal3.ToString("n4"));
            resultrecord.Add("记录条数", temp3.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            //成品 5.配件单，库存明细表中品名是配件的  //财务销售和配件179条，程序218条
            var temp5 = financedata.Where(c => c.tc_cxc02.Contains("配件")).ToList();
            financedata = financedata.Except(temp5).ToList();
            resultrecord.Add("类别", "成品类");
            resultrecord.Add("分类明细", "配件");
            var market1month5 = temp5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", market1month5.ToString("n4"));
            var market2_3month5 = temp5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", market2_3month5.ToString("n4"));
            var market4_6month5 = temp5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", market4_6month5.ToString("n4"));
            var market7_12month5 = temp5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", market7_12month5.ToString("n4"));
            var market1_2year5 = temp5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", market1_2year5.ToString("n4"));
            var market2_3year5 = temp5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", market2_3year5.ToString("n4"));
            var market3_5year5 = temp5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", market3_5year5.ToString("n4"));
            var marketover5year5 = temp5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", marketover5year5.ToString("n4"));
            var markettotal5 = market1month5 + market2_3month5 + market4_6month5 + market7_12month5 + market1_2year5 + market2_3year5 + market3_5year5 + marketover5year5;
            resultrecord.Add("合计金额", markettotal5.ToString("n4"));
            resultrecord.Add("记录条数", temp5.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            //成品 2.销售订单,订单不带-J、-RM、-K  //财务销售和配件179条，程序322条
            var temp2 = financedata.Except(financedata.Where(c => c.tc_cxc03.Contains("-J") || c.tc_cxc03.Contains("-RM") || c.tc_cxc03.Contains("-K0"))).Where(c => c.tc_cxc02.Contains("室内显示屏") || c.tc_cxc02.Contains("室外显示屏") || c.tc_cxc02.Contains("户外显示屏")).ToList();
            financedata = financedata.Except(temp2).ToList();//排除销售订单
            resultrecord.Add("类别", "成品类");
            resultrecord.Add("分类明细", "销售订单");
            var market1month2 = temp2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", market1month2.ToString("n4"));
            var market2_3month2 = temp2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", market2_3month2.ToString("n4"));
            var market4_6month2 = temp2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", market4_6month2.ToString("n4"));
            var market7_12month2 = temp2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", market7_12month2.ToString("n4"));
            var market1_2year2 = temp2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", market1_2year2.ToString("n4"));
            var market2_3year2 = temp2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", market2_3year2.ToString("n4"));
            var market3_5year2 = temp2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", market3_5year2.ToString("n4"));
            var marketover5year2 = temp2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", marketover5year2.ToString("n4"));
            var markettotal2 = market1month2 + market2_3month2 + market4_6month2 + market7_12month2 + market1_2year2 + market2_3year2 + market3_5year2 + marketover5year2;
            resultrecord.Add("合计金额", markettotal2.ToString("n4"));
            resultrecord.Add("记录条数", temp2.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            //成品 6.其他
            var temp6 = financedata;
            resultrecord.Add("类别", "成品类");
            resultrecord.Add("分类明细", "其他");
            var market1month6 = temp6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", market1month6.ToString("n4"));
            var market2_3month6 = temp6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", market2_3month6.ToString("n4"));
            var market4_6month6 = temp6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", market4_6month6.ToString("n4"));
            var market7_12month6 = temp6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", market7_12month6.ToString("n4"));
            var market1_2year6 = temp6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", market1_2year6.ToString("n4"));
            var market2_3year6 = temp6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", market2_3year6.ToString("n4"));
            var market3_5year6 = temp6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", market3_5year6.ToString("n4"));
            var marketover5year6 = temp6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", marketover5year6.ToString("n4"));
            var markettotal6 = market1month6 + market2_3month6 + market4_6month6 + market7_12month6 + market1_2year6 + market2_3year6 + market3_5year6 + marketover5year6;
            resultrecord.Add("合计金额", markettotal6.ToString("n4"));
            resultrecord.Add("记录条数", temp6.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            resultrecord.Add("5年以上", "全部合计");
            resultrecord.Add("合计金额", (markettotal1 + markettotal2 + markettotal3 + markettotal4 + markettotal5 + markettotal6).ToString("f3"));
            resultrecord.Add("记录条数", temp1.Count + temp2.Count + temp3.Count + temp4.Count + temp5.Count + temp6.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();
            #endregion


            #region 在制品部分
            var work_in_process = CommonERPDB.ERP_Work_in_process(inputdate, enddate);
            //在制工单明细表中备注中订单号中带"-J""RM" “-K0”
            var work_in_process_include = work_in_process.Where(c => c.sfbud01.Contains("-J") || c.sfbud01.Contains("RM") || c.sfbud01.Contains("-K0"));
            //在制工单 1.市场备库订单
            resultrecord.Add("类别", "在制品类");
            resultrecord.Add("分类明细", "在制市场备库订单");
            var workinprocess1month1 = work_in_process_include.Where(c => c.durations == "1个月以内").Sum(c => c.ccg92);
            resultrecord.Add("1个月以内", workinprocess1month1.ToString("n4"));
            var workinprocess2_3month1 = work_in_process_include.Where(c => c.durations == "2-3个月").Sum(c => c.ccg92);
            resultrecord.Add("2-3个月", workinprocess2_3month1.ToString("n4"));
            var workinprocess4_6month1 = work_in_process_include.Where(c => c.durations == "4-6个月").Sum(c => c.ccg92);
            resultrecord.Add("4-6个月", workinprocess4_6month1.ToString("n4"));
            var workinprocess7_12month1 = work_in_process_include.Where(c => c.durations == "7-12个月").Sum(c => c.ccg92);
            resultrecord.Add("7-12个月", workinprocess7_12month1.ToString("n4"));
            var workinprocess1_2year1 = work_in_process_include.Where(c => c.durations == "1-2年").Sum(c => c.ccg92);
            resultrecord.Add("1-2年", workinprocess1_2year1.ToString("n4"));
            var workinprocess2_3year1 = work_in_process_include.Where(c => c.durations == "2-3年").Sum(c => c.ccg92);
            resultrecord.Add("2-3年", workinprocess2_3year1.ToString("n4"));
            var workinprocess3_5year1 = work_in_process_include.Where(c => c.durations == "3-5年").Sum(c => c.ccg92);
            resultrecord.Add("3-5年", workinprocess3_5year1.ToString("n4"));
            var workinprocessover5year1 = work_in_process_include.Where(c => c.durations == "5年以上").Sum(c => c.ccg92);
            resultrecord.Add("5年以上", workinprocessover5year1.ToString("n4"));
            var workinprocesstotal1 = workinprocess1month1 + workinprocess2_3month1 + workinprocess4_6month1 + workinprocess7_12month1 + workinprocess1_2year1 + workinprocess2_3year1 + workinprocess3_5year1 + workinprocessover5year1;
            resultrecord.Add("合计金额", workinprocesstotal1.ToString("n4"));
            resultrecord.Add("记录条数", work_in_process_include.Count());
            results.Add(resultrecord);
            resultrecord = new JObject();

            //在制工单明细表中备注中订单号中不带"-J""RM" “-K0”
            var work_in_process_uninclude = work_in_process.Except(work_in_process_include);
            //在制工单 2.销售订单
            resultrecord.Add("类别", "在制品类");
            resultrecord.Add("分类明细", "在制销售订单");
            var workinprocess1month2 = work_in_process_uninclude.Where(c => c.durations == "1个月以内").Sum(c => c.ccg92);
            resultrecord.Add("1个月以内", workinprocess1month2.ToString("n4"));
            var workinprocess2_3month2 = work_in_process_uninclude.Where(c => c.durations == "2-3个月").Sum(c => c.ccg92);
            resultrecord.Add("2-3个月", workinprocess2_3month2.ToString("n4"));
            var workinprocess4_6month2 = work_in_process_uninclude.Where(c => c.durations == "4-6个月").Sum(c => c.ccg92);
            resultrecord.Add("4-6个月", workinprocess4_6month2.ToString("n4"));
            var workinprocess7_12month2 = work_in_process_uninclude.Where(c => c.durations == "7-12个月").Sum(c => c.ccg92);
            resultrecord.Add("7-12个月", workinprocess7_12month2.ToString("n4"));
            var workinprocess1_2year2 = work_in_process_uninclude.Where(c => c.durations == "1-2年").Sum(c => c.ccg92);
            resultrecord.Add("1-2年", workinprocess1_2year2.ToString("n4"));
            var workinprocess2_3year2 = work_in_process_uninclude.Where(c => c.durations == "2-3年").Sum(c => c.ccg92);
            resultrecord.Add("2-3年", workinprocess2_3year2.ToString("n4"));
            var workinprocess3_5year2 = work_in_process_uninclude.Where(c => c.durations == "3-5年").Sum(c => c.ccg92);
            resultrecord.Add("3-5年", workinprocess3_5year2.ToString("n4"));
            var workinprocessover5year2 = work_in_process_uninclude.Where(c => c.durations == "5年以上").Sum(c => c.ccg92);
            resultrecord.Add("5年以上", workinprocessover5year2.ToString("n4"));
            var workinprocesstotal2 = workinprocess1month2 + workinprocess2_3month2 + workinprocess4_6month2 + workinprocess7_12month2 + workinprocess1_2year2 + workinprocess2_3year2 + workinprocess3_5year2 + workinprocessover5year2;
            resultrecord.Add("合计金额", workinprocesstotal2.ToString("n4"));
            resultrecord.Add("记录条数", work_in_process_uninclude.Count());
            results.Add(resultrecord);
            resultrecord = new JObject();

            resultrecord.Add("类别", "");
            resultrecord.Add("分类明细", "");
            resultrecord.Add("合计金额", (workinprocesstotal1 + workinprocesstotal2).ToString("n4"));
            resultrecord.Add("记录条数", work_in_process.Count());
            results.Add(resultrecord);
            resultrecord = new JObject();
            #endregion



            //MC表发料记录表(原材料)
            resultrecord.Add("类别", "MC表发料记录表");
            resultrecord.Add("分类明细", "");
            results.Add(resultrecord);
            resultrecord = new JObject();


            #region 原材料部分
            //财务上月库存结存明细表排除140501科目以外的记录：原材料-基本材料，原材料-辅助材料，半成品
            var financedata_raw_material = financealldata.Where(c => c.AccountingSubject != 140501).ToList();
            //上表转长类型
            List<cxcr006_raw_material> financedata_raw_material_Long = new List<cxcr006_raw_material>();
            List<cxcr006_raw_material> financedata_raw_material_Long_ExceptbySum = new List<cxcr006_raw_material>();
            financedata_raw_material_Long = CXCR_ConvertType(financedata_raw_material);
            //MC发料表（排除未发料为0的记录）
            var mc_unissuedata = CommonERPDB.ERP_MC_NuIssueDetialsQuery(inputdate, enddate).Where(c => c.sfa05_sfa06 != 0).ToList();
            //1.MC发料表（排除未发料为0的记录）带-K,RM,-J的物料编号 List<string>
            var mc_unissuedata_K_RM_J_material_number_list = mc_unissuedata.Where(c => c.sfbud01.Contains("-K") || c.sfbud01.Contains("RM") || c.sfbud01.Contains("-J")).Select(c => c.sfa03).Distinct().ToList();
            var mc_unissuedata_K_RM_J_material_number_list_sum_by_sfa03 = mc_unissuedata.Where(c => mc_unissuedata_K_RM_J_material_number_list.Contains(c.sfa03)).GroupBy(c => c.sfa03).Select(s => new csfr008 { sfa03 = s.FirstOrDefault().sfa03, sfa05 = s.Sum(item => item.sfa05), sfa06 = s.Sum(item => item.sfa06), sfa05_sfa06 = s.Sum(item => item.sfa05_sfa06) }).ToList();
            //MC发料表（排除未发料为0的记录）带-K,RM,-J的物料编号 List<cxcr006_raw_material>
            var financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list = financedata_raw_material_Long.Where(c => mc_unissuedata_K_RM_J_material_number_list.Contains(c.tc_cxc01)).ToList();
            //追加未发料之和
            foreach (var item in financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list)
            {
                var record_add = mc_unissuedata_K_RM_J_material_number_list_sum_by_sfa03.Where(c => c.sfa03 == item.tc_cxc01).FirstOrDefault();
                if (record_add != null)
                {
                    item.sfb01 = record_add.sfb01;
                    item.sfbud01 = record_add.sfbud01;
                    item.sfb81 = record_add.sfb81;
                    item.sfa12 = record_add.sfa12;
                    item.sfa05 = record_add.sfa05;
                    item.sfa06 = record_add.sfa06;
                    item.sfa05_sfa06 = record_add.sfa05_sfa06;
                    //本月结存数>未发料之和,拆成两部分（未发料之和，本月结存数-未发料之和），第二部分转到无订单需求
                    if (item.tc_cxc04 > item.sfa05_sfa06)
                    {
                        //no_order_record无订单需求
                        cxcr006_raw_material no_order_record = new cxcr006_raw_material()
                        {
                            tc_cxc01 = item.tc_cxc01,
                            tc_cxc02 = item.tc_cxc02,
                            tc_cxc03 = item.tc_cxc03,
                            area = item.area,
                            tc_cxc04 = item.tc_cxc04 - item.sfa05_sfa06,
                            tc_cxc05 = item.tc_cxc05,
                            tc_cxc06 = (item.tc_cxc06 / item.tc_cxc04) * (item.tc_cxc04 - item.sfa05_sfa06),
                            tc_cxc07 = 0,
                            tc_cxc08 = 0,
                            tc_cxc09 = 0,
                            tc_cxc10 = 0,
                            tc_cxc11 = 0,
                            tc_cxc12 = 0,
                            tc_cxc13 = 0,
                            tc_cxc14 = 0,
                            AccountingSubject = item.AccountingSubject,
                            WarehouseNumber = item.WarehouseNumber,
                            sfb01 = item.sfb01,
                            sfbud01 = item.sfbud01,
                            sfb81 = item.sfb81,
                            sfa12 = item.sfa12,
                            sfa05 = 0,
                            sfa06 = 0,
                            sfa05_sfa06 = 0
                        };
                        double nu_send = item.sfa05_sfa06;
                        double endjine = item.tc_cxc06;
                        item.tc_cxc06 = (endjine / item.tc_cxc04) * item.sfa05_sfa06;
                        item.tc_cxc04 = nu_send; //备库订单.本月结存数
                        double item_tc_cxc04 = item.tc_cxc04;
                        if (item.tc_cxc14 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc14 = item.tc_cxc14;
                                item.tc_cxc14 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc14 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc14;
                            }
                            else
                            {
                                no_order_record.tc_cxc14 = item.tc_cxc14 - item_tc_cxc04;
                                item.tc_cxc14 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc13 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc13 = item.tc_cxc13;
                                item.tc_cxc13 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc13 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc13;
                            }
                            else
                            {
                                no_order_record.tc_cxc13 = item.tc_cxc13 - item_tc_cxc04;
                                item.tc_cxc13 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc12 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc12 = item.tc_cxc12;
                                item.tc_cxc12 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc12 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc12;
                            }
                            else
                            {
                                no_order_record.tc_cxc12 = item.tc_cxc12 - item_tc_cxc04;
                                item.tc_cxc12 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc11 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc11 = item.tc_cxc11;
                                item.tc_cxc11 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc11 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc11;
                            }
                            else
                            {
                                no_order_record.tc_cxc11 = item.tc_cxc11 - item_tc_cxc04;
                                item.tc_cxc11 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc10 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc10 = item.tc_cxc10;
                                item.tc_cxc10 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc10 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc10;
                            }
                            else
                            {
                                no_order_record.tc_cxc10 = item.tc_cxc10 - item_tc_cxc04;
                                item.tc_cxc10 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc09 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc09 = item.tc_cxc09;
                                item.tc_cxc09 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc09 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc09;
                            }
                            else
                            {
                                no_order_record.tc_cxc09 = item.tc_cxc09 - item_tc_cxc04;
                                item.tc_cxc09 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc08 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc08 = item.tc_cxc08;
                                item.tc_cxc08 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc08 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc08;
                            }
                            else
                            {
                                no_order_record.tc_cxc08 = item.tc_cxc08 - item_tc_cxc04;
                                item.tc_cxc08 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc07 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc07 = item.tc_cxc07;
                                item.tc_cxc07 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc07 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc07;
                            }
                            else
                            {
                                no_order_record.tc_cxc07 = item.tc_cxc07 - item_tc_cxc04;
                                item.tc_cxc07 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        financedata_raw_material_Long_ExceptbySum.Add(no_order_record);
                    }
                }
            }

            //本月结存数<=未发料之和，按本月结存数统计
            //原材料 1.备库订单
            resultrecord.Add("类别", "原材料类");
            resultrecord.Add("分类明细", "备库订单(原材料)");
            var raw_material1month1 = financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", raw_material1month1.ToString("n4"));
            var raw_material2_3month1 = financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", raw_material2_3month1.ToString("n4"));
            var raw_material4_6month1 = financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", raw_material4_6month1.ToString("n4"));
            var raw_material7_12month1 = financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", raw_material7_12month1.ToString("n4"));
            var raw_material1_2year1 = financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", raw_material1_2year1.ToString("n4"));
            var raw_material2_3year1 = financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", raw_material2_3year1.ToString("n4"));
            var raw_material3_5year1 = financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", raw_material3_5year1.ToString("n4"));
            var raw_materialover5year1 = financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", raw_materialover5year1.ToString("n4"));
            var raw_materialtotal1 = raw_material1month1 + raw_material2_3month1 + raw_material4_6month1 + raw_material7_12month1 + raw_material1_2year1 + raw_material2_3year1 + raw_material3_5year1 + raw_materialover5year1;
            resultrecord.Add("合计金额", raw_materialtotal1.ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();


            //2.MC发料表（排除未发料为0的记录）不带-K,RM,-J的物料编号 List<string>
            var mc_unissuedata_Except_K_RM_J_material_number_list = mc_unissuedata.Select(c => c.sfa03).Distinct().Except(mc_unissuedata_K_RM_J_material_number_list).ToList();
            var mc_unissuedata_Except_K_RM_J_material_number_list_sum_by_sfa03 = mc_unissuedata.Where(c => mc_unissuedata_Except_K_RM_J_material_number_list.Contains(c.sfa03)).GroupBy(c => c.sfa03).Select(s => new csfr008 { sfa03 = s.FirstOrDefault().sfa03, sfa05 = s.Sum(item => item.sfa05), sfa06 = s.Sum(item => item.sfa06), sfa05_sfa06 = s.Sum(item => item.sfa05_sfa06) }).ToList();
            //MC发料表（排除未发料为0的记录）不带-K,RM,-J的物料编号 List<cxcr006_raw_material>
            var financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list = financedata_raw_material_Long.Where(c => mc_unissuedata_Except_K_RM_J_material_number_list.Contains(c.tc_cxc01)).ToList();
            //追加未发料之和
            foreach (var item in financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list)
            {
                var record_add = mc_unissuedata_Except_K_RM_J_material_number_list_sum_by_sfa03.Where(c => c.sfa03 == item.tc_cxc01).FirstOrDefault();
                if (record_add != null)
                {
                    item.sfb01 = record_add.sfb01;
                    item.sfbud01 = record_add.sfbud01;
                    item.sfb81 = record_add.sfb81;
                    item.sfa12 = record_add.sfa12;
                    item.sfa05 = record_add.sfa05;
                    item.sfa06 = record_add.sfa06;
                    item.sfa05_sfa06 = record_add.sfa05_sfa06;
                    //本月结存数>未发料之和,拆成两部分（未发料之和，本月结存数-未发料之和），第二部分转到无订单需求
                    if (item.tc_cxc04 > item.sfa05_sfa06)
                    {
                        //no_order_record无订单需求
                        cxcr006_raw_material no_order_record = new cxcr006_raw_material()
                        {
                            tc_cxc01 = item.tc_cxc01,
                            tc_cxc02 = item.tc_cxc02,
                            tc_cxc03 = item.tc_cxc03,
                            area = item.area,
                            tc_cxc04 = item.tc_cxc04 - item.sfa05_sfa06,
                            tc_cxc05 = item.tc_cxc05,
                            tc_cxc06 = (item.tc_cxc06 / item.tc_cxc04) * (item.tc_cxc04 - item.sfa05_sfa06),
                            tc_cxc07 = 0,
                            tc_cxc08 = 0,
                            tc_cxc09 = 0,
                            tc_cxc10 = 0,
                            tc_cxc11 = 0,
                            tc_cxc12 = 0,
                            tc_cxc13 = 0,
                            tc_cxc14 = 0,
                            AccountingSubject = item.AccountingSubject,
                            WarehouseNumber = item.WarehouseNumber,
                            sfb01 = item.sfb01,
                            sfbud01 = item.sfbud01,
                            sfb81 = item.sfb81,
                            sfa12 = item.sfa12,
                            sfa05 = 0,
                            sfa06 = 0,
                            sfa05_sfa06 = 0
                        };
                        double nu_send = item.sfa05_sfa06;
                        double endjine = item.tc_cxc06;
                        item.tc_cxc06 = (endjine / item.tc_cxc04) * item.sfa05_sfa06;
                        item.tc_cxc04 = nu_send; //备库订单.本月结存数
                        double item_tc_cxc04 = item.tc_cxc04;
                        if (item.tc_cxc14 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc14 = item.tc_cxc14;
                                item.tc_cxc14 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc14 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc14;
                            }
                            else
                            {
                                no_order_record.tc_cxc14 = item.tc_cxc14 - item_tc_cxc04;
                                item.tc_cxc14 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc13 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc13 = item.tc_cxc13;
                                item.tc_cxc13 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc13 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc13;
                            }
                            else
                            {
                                no_order_record.tc_cxc13 = item.tc_cxc13 - item_tc_cxc04;
                                item.tc_cxc13 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc12 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc12 = item.tc_cxc12;
                                item.tc_cxc12 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc12 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc12;
                            }
                            else
                            {
                                no_order_record.tc_cxc12 = item.tc_cxc12 - item_tc_cxc04;
                                item.tc_cxc12 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc11 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc11 = item.tc_cxc11;
                                item.tc_cxc11 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc11 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc11;
                            }
                            else
                            {
                                no_order_record.tc_cxc11 = item.tc_cxc11 - item_tc_cxc04;
                                item.tc_cxc11 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc10 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc10 = item.tc_cxc10;
                                item.tc_cxc10 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc10 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc10;
                            }
                            else
                            {
                                no_order_record.tc_cxc10 = item.tc_cxc10 - item_tc_cxc04;
                                item.tc_cxc10 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc09 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc09 = item.tc_cxc09;
                                item.tc_cxc09 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc09 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc09;
                            }
                            else
                            {
                                no_order_record.tc_cxc09 = item.tc_cxc09 - item_tc_cxc04;
                                item.tc_cxc09 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc08 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc08 = item.tc_cxc08;
                                item.tc_cxc08 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc08 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc08;
                            }
                            else
                            {
                                no_order_record.tc_cxc08 = item.tc_cxc08 - item_tc_cxc04;
                                item.tc_cxc08 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        if (item.tc_cxc07 > 0 && item_tc_cxc04 >= 0)
                        {
                            if (item_tc_cxc04 == 0)
                            {
                                no_order_record.tc_cxc07 = item.tc_cxc07;
                                item.tc_cxc07 = 0;
                            }
                            else if (item_tc_cxc04 - item.tc_cxc07 > 0)
                            {
                                item_tc_cxc04 = item_tc_cxc04 - item.tc_cxc07;
                            }
                            else
                            {
                                no_order_record.tc_cxc07 = item.tc_cxc07 - item_tc_cxc04;
                                item.tc_cxc07 = item_tc_cxc04;
                                item_tc_cxc04 = 0;
                            }
                        }
                        financedata_raw_material_Long_ExceptbySum.Add(no_order_record);
                    }
                }
            }
            //本月结存数<=未发料之和，按本月结存数统计

            //原材料 2.销售订单
            resultrecord.Add("类别", "原材料类");
            resultrecord.Add("分类明细", "销售订单(原材料)");
            var raw_material1month2 = financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", raw_material1month2.ToString("n4"));
            var raw_material2_3month2 = financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", raw_material2_3month2.ToString("n4"));
            var raw_material4_6month2 = financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", raw_material4_6month2.ToString("n4"));
            var raw_material7_12month2 = financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", raw_material7_12month2.ToString("n4"));
            var raw_material1_2year2 = financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", raw_material1_2year2.ToString("n4"));
            var raw_material2_3year2 = financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", raw_material2_3year2.ToString("n4"));
            var raw_material3_5year2 = financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", raw_material3_5year2.ToString("n4"));
            var raw_materialover5year2 = financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", raw_materialover5year2.ToString("n4"));
            var raw_materialtotal2 = raw_material1month2 + raw_material2_3month2 + raw_material4_6month2 + raw_material7_12month2 + raw_material1_2year2 + raw_material2_3year2 + raw_material3_5year2 + raw_materialover5year2;
            resultrecord.Add("合计金额", raw_materialtotal2.ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            //3.MC发料表（排除未发料为0的记录）无订单需求 List<cxcr006_raw_material>
            var financedata_raw_material_Long_Others = financedata_raw_material_Long.Except(financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list).Except(financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list).ToList();
            //追加1.备库订单与2.销售订单以外的物料清单
            financedata_raw_material_Long_Others.AddRange(financedata_raw_material_Long_ExceptbySum);

            //原材料(含半成品) 3.无订单需求
            resultrecord.Add("类别", "原材料类");
            resultrecord.Add("分类明细", "无订单需求(原材料)");
            var raw_material1month3 = financedata_raw_material_Long_Others.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", raw_material1month3.ToString("n4"));
            var raw_material2_3month3 = financedata_raw_material_Long_Others.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", raw_material2_3month3.ToString("n4"));
            var raw_material4_6month3 = financedata_raw_material_Long_Others.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", raw_material4_6month3.ToString("n4"));
            var raw_material7_12month3 = financedata_raw_material_Long_Others.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", raw_material7_12month3.ToString("n4"));
            var raw_material1_2year3 = financedata_raw_material_Long_Others.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", raw_material1_2year3.ToString("n4"));
            var raw_material2_3year3 = financedata_raw_material_Long_Others.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", raw_material2_3year3.ToString("n4"));
            var raw_material3_5year3 = financedata_raw_material_Long_Others.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", raw_material3_5year3.ToString("n4"));
            var raw_materialover5year3 = financedata_raw_material_Long_Others.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", raw_materialover5year3.ToString("n4"));
            var raw_materialtotal3 = raw_material1month3 + raw_material2_3month3 + raw_material4_6month3 + raw_material7_12month3 + raw_material1_2year3 + raw_material2_3year3 + raw_material3_5year3 + raw_materialover5year3;
            resultrecord.Add("合计金额", raw_materialtotal3.ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_Long_Others.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            resultrecord.Add("5年以上", "全部合计");
            resultrecord.Add("合计金额", (raw_materialtotal1 + raw_materialtotal2 + raw_materialtotal3).ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_Long_by_mc_unissuedata_K_RM_J_material_number_list.Count + financedata_raw_material_Long_by_mc_unissuedata_Except_K_RM_J_material_number_list.Count + financedata_raw_material_Long_Others.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();


            //var dt1 = DataTableTool.ToDataTable(financedata_raw_material_mc_unissuedata_K_RM_J);
            //string ddddd = "";

            #endregion

            #region----修改后MC未发料方案
            //MC未发料表(修改后方案)
            var raw_material_nuissus = CommonERPDB.ERP_MC_NuIssueDetialsQuery2();
            List<cxcr006_raw_material> result7 = new List<cxcr006_raw_material>();
            //取到原材料表记录
            var financedata_Long2 = CXCR_ConvertType(financealldata.Where(c => c.AccountingSubject != 140501).ToList());
            result7 = Calculate_raw(financedata_Long2, raw_material_nuissus);


            //MC表发料记录表(原材料)
            resultrecord.Add("类别", "MC表发料记录表(专用记录表)");
            resultrecord.Add("分类明细", "");
            results.Add(resultrecord);
            resultrecord = new JObject();


            //原材料2   1.2.公司常规备库单、投标备库单
            var financedata_raw_material_1_2 = result7.Where(c => c.Classification == "1.2.公司常规备库单、投标备库单").ToList();
            resultrecord.Add("类别", "原材料类2");
            resultrecord.Add("分类明细", "1.2.公司常规备库单、投标备库单(-K0)");
            var raw_material1month4 = financedata_raw_material_1_2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", raw_material1month4.ToString("n4"));
            var raw_material2_3month4 = financedata_raw_material_1_2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", raw_material2_3month4.ToString("n4"));
            var raw_material4_6month4 = financedata_raw_material_1_2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", raw_material4_6month4.ToString("n4"));
            var raw_material7_12month4 = financedata_raw_material_1_2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", raw_material7_12month4.ToString("n4"));
            var raw_material1_2year4 = financedata_raw_material_1_2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", raw_material1_2year4.ToString("n4"));
            var raw_material2_3year4 = financedata_raw_material_1_2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", raw_material2_3year4.ToString("n4"));
            var raw_material3_5year4 = financedata_raw_material_1_2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", raw_material3_5year4.ToString("n4"));
            var raw_materialover5year4 = financedata_raw_material_1_2.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", raw_materialover5year4.ToString("n4"));
            var raw_materialtotal4 = raw_material1month4 + raw_material2_3month4 + raw_material4_6month4 + raw_material7_12month4 + raw_material1_2year4 + raw_material2_3year4 + raw_material3_5year4 + raw_materialover5year4;
            resultrecord.Add("合计金额", raw_materialtotal4.ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_1_2.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            //原材料2   3.业务借样单
            var financedata_raw_material_3 = result7.Where(c => c.Classification == "3.业务借样单").ToList();
            resultrecord.Add("类别", "原材料类2");
            resultrecord.Add("分类明细", "3.业务借样单(-J)");
            var raw_material1month5 = financedata_raw_material_3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", raw_material1month5.ToString("n4"));
            var raw_material2_3month5 = financedata_raw_material_3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", raw_material2_3month5.ToString("n4"));
            var raw_material4_6month5 = financedata_raw_material_3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", raw_material4_6month5.ToString("n4"));
            var raw_material7_12month5 = financedata_raw_material_3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", raw_material7_12month5.ToString("n4"));
            var raw_material1_2year5 = financedata_raw_material_3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", raw_material1_2year5.ToString("n4"));
            var raw_material2_3year5 = financedata_raw_material_3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", raw_material2_3year5.ToString("n4"));
            var raw_material3_5year5 = financedata_raw_material_3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", raw_material3_5year5.ToString("n4"));
            var raw_materialover5year5 = financedata_raw_material_3.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", raw_materialover5year5.ToString("n4"));
            var raw_materialtotal5 = raw_material1month5 + raw_material2_3month5 + raw_material4_6month5 + raw_material7_12month5 + raw_material1_2year5 + raw_material2_3year5 + raw_material3_5year5 + raw_materialover5year5;
            resultrecord.Add("合计金额", raw_materialtotal5.ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_3.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            //原材料2   4.5.公司展厅单、各大区展厅单
            var financedata_raw_material_4_5 = result7.Where(c => c.Classification == "4.5.公司展厅单、各大区展厅单").ToList();
            resultrecord.Add("类别", "原材料类2");
            resultrecord.Add("分类明细", "4.5.公司展厅单、各大区展厅单(-RM)");
            var raw_material1month6 = financedata_raw_material_4_5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", raw_material1month6.ToString("n4"));
            var raw_material2_3month6 = financedata_raw_material_4_5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", raw_material2_3month6.ToString("n4"));
            var raw_material4_6month6 = financedata_raw_material_4_5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", raw_material4_6month6.ToString("n4"));
            var raw_material7_12month6 = financedata_raw_material_4_5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", raw_material7_12month6.ToString("n4"));
            var raw_material1_2year6 = financedata_raw_material_4_5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", raw_material1_2year6.ToString("n4"));
            var raw_material2_3year6 = financedata_raw_material_4_5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", raw_material2_3year6.ToString("n4"));
            var raw_material3_5year6 = financedata_raw_material_4_5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", raw_material3_5year6.ToString("n4"));
            var raw_materialover5year6 = financedata_raw_material_4_5.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", raw_materialover5year6.ToString("n4"));
            var raw_materialtotal6 = raw_material1month6 + raw_material2_3month6 + raw_material4_6month6 + raw_material7_12month6 + raw_material1_2year6 + raw_material2_3year6 + raw_material3_5year6 + raw_materialover5year6;
            resultrecord.Add("合计金额", raw_materialtotal6.ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_4_5.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            //原材料2   6.公司参展单
            var financedata_raw_material_6 = result7.Where(c => c.Classification == "6.公司参展单").ToList();
            resultrecord.Add("类别", "原材料类2");
            resultrecord.Add("分类明细", "6.公司参展单(-C)");
            var raw_material1month7 = financedata_raw_material_6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", raw_material1month7.ToString("n4"));
            var raw_material2_3month7 = financedata_raw_material_6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", raw_material2_3month7.ToString("n4"));
            var raw_material4_6month7 = financedata_raw_material_6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", raw_material4_6month7.ToString("n4"));
            var raw_material7_12month7 = financedata_raw_material_6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", raw_material7_12month7.ToString("n4"));
            var raw_material1_2year7 = financedata_raw_material_6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", raw_material1_2year7.ToString("n4"));
            var raw_material2_3year7 = financedata_raw_material_6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", raw_material2_3year7.ToString("n4"));
            var raw_material3_5year7 = financedata_raw_material_6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", raw_material3_5year7.ToString("n4"));
            var raw_materialover5year7 = financedata_raw_material_6.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", raw_materialover5year7.ToString("n4"));
            var raw_materialtotal7 = raw_material1month7 + raw_material2_3month7 + raw_material4_6month7 + raw_material7_12month7 + raw_material1_2year7 + raw_material2_3year7 + raw_material3_5year7 + raw_materialover5year7;
            resultrecord.Add("合计金额", raw_materialtotal7.ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_6.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            //原材料2   7.品质客诉单
            var financedata_raw_material_7 = result7.Where(c => c.Classification == "7.品质客诉单").ToList();
            resultrecord.Add("类别", "原材料类2");
            resultrecord.Add("分类明细", "7.品质客诉单(P1～P10)");
            var raw_material1month8 = financedata_raw_material_7.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", raw_material1month8.ToString("n4"));
            var raw_material2_3month8 = financedata_raw_material_7.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", raw_material2_3month8.ToString("n4"));
            var raw_material4_6month8 = financedata_raw_material_7.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", raw_material4_6month8.ToString("n4"));
            var raw_material7_12month8 = financedata_raw_material_7.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", raw_material7_12month8.ToString("n4"));
            var raw_material1_2year8 = financedata_raw_material_7.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", raw_material1_2year8.ToString("n4"));
            var raw_material2_3year8 = financedata_raw_material_7.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", raw_material2_3year8.ToString("n4"));
            var raw_material3_5year8 = financedata_raw_material_7.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", raw_material3_5year8.ToString("n4"));
            var raw_materialover5year8 = financedata_raw_material_7.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", raw_materialover5year8.ToString("n4"));
            var raw_materialtotal8 = raw_material1month8 + raw_material2_3month8 + raw_material4_6month8 + raw_material7_12month8 + raw_material1_2year8 + raw_material2_3year8 + raw_material3_5year8 + raw_materialover5year8;
            resultrecord.Add("合计金额", raw_materialtotal8.ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_7.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            //原材料2   8.出货后增加物料单
            var financedata_raw_material_8 = result7.Where(c => c.Classification == "8.出货后增加物料单").ToList();
            resultrecord.Add("类别", "原材料类2");
            resultrecord.Add("分类明细", "8.出货后增加物料单(B1～B10)");
            var raw_material1month9 = financedata_raw_material_8.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", raw_material1month9.ToString("n4"));
            var raw_material2_3month9 = financedata_raw_material_8.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", raw_material2_3month9.ToString("n4"));
            var raw_material4_6month9 = financedata_raw_material_8.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", raw_material4_6month9.ToString("n4"));
            var raw_material7_12month9 = financedata_raw_material_8.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", raw_material7_12month9.ToString("n4"));
            var raw_material1_2year9 = financedata_raw_material_8.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", raw_material1_2year9.ToString("n4"));
            var raw_material2_3year9 = financedata_raw_material_8.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", raw_material2_3year9.ToString("n4"));
            var raw_material3_5year9 = financedata_raw_material_8.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", raw_material3_5year9.ToString("n4"));
            var raw_materialover5year9 = financedata_raw_material_8.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", raw_materialover5year9.ToString("n4"));
            var raw_materialtotal9 = raw_material1month9 + raw_material2_3month9 + raw_material4_6month9 + raw_material7_12month9 + raw_material1_2year9 + raw_material2_3year9 + raw_material3_5year9 + raw_materialover5year9;
            resultrecord.Add("合计金额", raw_materialtotal9.ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_8.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();


            //原材料2   9.费用挂大区单及赠送单
            var financedata_raw_material_9 = result7.Where(c => c.Classification == "9.费用挂大区单及赠送单").ToList();
            resultrecord.Add("类别", "原材料类2");
            resultrecord.Add("分类明细", "9.费用挂大区单及赠送单(-S)");
            var raw_material1month10 = financedata_raw_material_9.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", raw_material1month10.ToString("n4"));
            var raw_material2_3month10 = financedata_raw_material_9.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", raw_material2_3month10.ToString("n4"));
            var raw_material4_6month10 = financedata_raw_material_9.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", raw_material4_6month10.ToString("n4"));
            var raw_material7_12month10 = financedata_raw_material_9.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", raw_material7_12month10.ToString("n4"));
            var raw_material1_2year10 = financedata_raw_material_9.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", raw_material1_2year10.ToString("n4"));
            var raw_material2_3year10 = financedata_raw_material_9.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", raw_material2_3year10.ToString("n4"));
            var raw_material3_5year10 = financedata_raw_material_9.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", raw_material3_5year10.ToString("n4"));
            var raw_materialover5year10 = financedata_raw_material_9.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", raw_materialover5year10.ToString("n4"));
            var raw_materialtotal10 = raw_material1month10 + raw_material2_3month10 + raw_material4_6month10 + raw_material7_12month10 + raw_material1_2year10 + raw_material2_3year10 + raw_material3_5year10 + raw_materialover5year10;
            resultrecord.Add("合计金额", raw_materialtotal10.ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_9.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();


            //原材料2   10.工厂品质单
            var financedata_raw_material_10 = result7.Where(c => c.Classification == "10.工厂品质单").ToList();
            resultrecord.Add("类别", "原材料类2");
            resultrecord.Add("分类明细", "10.工厂品质单(-Q)");
            var raw_material1month11 = financedata_raw_material_10.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", raw_material1month11.ToString("n4"));
            var raw_material2_3month11 = financedata_raw_material_10.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", raw_material2_3month11.ToString("n4"));
            var raw_material4_6month11 = financedata_raw_material_10.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", raw_material4_6month11.ToString("n4"));
            var raw_material7_12month11 = financedata_raw_material_10.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", raw_material7_12month11.ToString("n4"));
            var raw_material1_2year11 = financedata_raw_material_10.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", raw_material1_2year11.ToString("n4"));
            var raw_material2_3year11 = financedata_raw_material_10.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", raw_material2_3year11.ToString("n4"));
            var raw_material3_5year11 = financedata_raw_material_10.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", raw_material3_5year11.ToString("n4"));
            var raw_materialover5year11 = financedata_raw_material_10.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", raw_materialover5year11.ToString("n4"));
            var raw_materialtotal11 = raw_material1month11 + raw_material2_3month11 + raw_material4_6month11 + raw_material7_12month11 + raw_material1_2year11 + raw_material2_3year11 + raw_material3_5year11 + raw_materialover5year11;
            resultrecord.Add("合计金额", raw_materialtotal11.ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_10.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();


            //原材料2   11.研发样品单
            var financedata_raw_material_11 = result7.Where(c => c.Classification == "11.研发样品单").ToList();
            resultrecord.Add("类别", "原材料类2");
            resultrecord.Add("分类明细", "11.研发样品单(-R0)");
            var raw_material1month12 = financedata_raw_material_11.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", raw_material1month12.ToString("n4"));
            var raw_material2_3month12 = financedata_raw_material_11.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", raw_material2_3month12.ToString("n4"));
            var raw_material4_6month12 = financedata_raw_material_11.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", raw_material4_6month12.ToString("n4"));
            var raw_material7_12month12 = financedata_raw_material_11.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", raw_material7_12month12.ToString("n4"));
            var raw_material1_2year12 = financedata_raw_material_11.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", raw_material1_2year12.ToString("n4"));
            var raw_material2_3year12 = financedata_raw_material_11.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", raw_material2_3year12.ToString("n4"));
            var raw_material3_5year12 = financedata_raw_material_11.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", raw_material3_5year12.ToString("n4"));
            var raw_materialover5year12 = financedata_raw_material_11.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", raw_materialover5year12.ToString("n4"));
            var raw_materialtotal12 = raw_material1month12 + raw_material2_3month12 + raw_material4_6month12 + raw_material7_12month12 + raw_material1_2year12 + raw_material2_3year12 + raw_material3_5year12 + raw_materialover5year12;
            resultrecord.Add("合计金额", raw_materialtotal12.ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_11.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();


            //原材料2   销售订单
            var financedata_raw_material_12 = result7.Where(c => c.Classification == "销售订单").ToList();
            resultrecord.Add("类别", "原材料类2");
            resultrecord.Add("分类明细", "销售订单(非上述条件的未发料需求)");
            var raw_material1month13 = financedata_raw_material_12.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", raw_material1month13.ToString("n4"));
            var raw_material2_3month13 = financedata_raw_material_12.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", raw_material2_3month13.ToString("n4"));
            var raw_material4_6month13 = financedata_raw_material_12.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", raw_material4_6month13.ToString("n4"));
            var raw_material7_12month13 = financedata_raw_material_12.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", raw_material7_12month13.ToString("n4"));
            var raw_material1_2year13 = financedata_raw_material_12.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", raw_material1_2year13.ToString("n4"));
            var raw_material2_3year13 = financedata_raw_material_12.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", raw_material2_3year13.ToString("n4"));
            var raw_material3_5year13 = financedata_raw_material_12.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", raw_material3_5year13.ToString("n4"));
            var raw_materialover5year13 = financedata_raw_material_12.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", raw_materialover5year13.ToString("n4"));
            var raw_materialtotal13 = raw_material1month13 + raw_material2_3month13 + raw_material4_6month13 + raw_material7_12month13 + raw_material1_2year13 + raw_material2_3year13 + raw_material3_5year13 + raw_materialover5year13;
            resultrecord.Add("合计金额", raw_materialtotal13.ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_12.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();


            //原材料2   无订单需求
            var financedata_raw_material_13 = result7.Where(c => c.Classification == "无订单需求").ToList();
            resultrecord.Add("类别", "原材料类2");
            resultrecord.Add("分类明细", "无订单需求(未发料需求以外的库存结存情况)");
            var raw_material1month14 = financedata_raw_material_13.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc07);
            resultrecord.Add("1个月以内", raw_material1month14.ToString("n4"));
            var raw_material2_3month14 = financedata_raw_material_13.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc08);
            resultrecord.Add("2-3个月", raw_material2_3month14.ToString("n4"));
            var raw_material4_6month14 = financedata_raw_material_13.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc09);
            resultrecord.Add("4-6个月", raw_material4_6month14.ToString("n4"));
            var raw_material7_12month14 = financedata_raw_material_13.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc10);
            resultrecord.Add("7-12个月", raw_material7_12month14.ToString("n4"));
            var raw_material1_2year14 = financedata_raw_material_13.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc11);
            resultrecord.Add("1-2年", raw_material1_2year14.ToString("n4"));
            var raw_material2_3year14 = financedata_raw_material_13.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc12);
            resultrecord.Add("2-3年", raw_material2_3year14.ToString("n4"));
            var raw_material3_5year14 = financedata_raw_material_13.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc13);
            resultrecord.Add("3-5年", raw_material3_5year14.ToString("n4"));
            var raw_materialover5year14 = financedata_raw_material_13.Sum(c => (c.tc_cxc06 / c.tc_cxc04) * c.tc_cxc14);
            resultrecord.Add("5年以上", raw_materialover5year14.ToString("n4"));
            var raw_materialtotal14 = raw_material1month14 + raw_material2_3month14 + raw_material4_6month14 + raw_material7_12month14 + raw_material1_2year14 + raw_material2_3year14 + raw_material3_5year14 + raw_materialover5year14;
            resultrecord.Add("合计金额", raw_materialtotal14.ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_13.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            resultrecord.Add("5年以上", "单项求和");
            resultrecord.Add("合计金额", (raw_materialtotal4 + raw_materialtotal5 + raw_materialtotal6 + raw_materialtotal7 + raw_materialtotal8 + raw_materialtotal9 + raw_materialtotal10 + raw_materialtotal11 + raw_materialtotal12 + raw_materialtotal13 + raw_materialtotal14).ToString("n4"));
            resultrecord.Add("记录条数", financedata_raw_material_1_2.Count + financedata_raw_material_3.Count + financedata_raw_material_4_5.Count + financedata_raw_material_6.Count + financedata_raw_material_7.Count + financedata_raw_material_8.Count + financedata_raw_material_9.Count + financedata_raw_material_10.Count + financedata_raw_material_11.Count + financedata_raw_material_12.Count + financedata_raw_material_13.Count);
            results.Add(resultrecord);
            resultrecord = new JObject();

            resultrecord.Add("5年以上", "汇总结果求和");
            resultrecord.Add("合计金额", result7.Where(c => c.Classification != "原始记录").Sum(c => c.tc_cxc06).ToString("n4"));
            resultrecord.Add("记录条数", result7.Where(c => c.Classification != "原始记录").Count());
            results.Add(resultrecord);
            resultrecord = new JObject();


            #endregion


            return Content(JsonConvert.SerializeObject(results));
        }
        #endregion

        #region---导出excel
        [HttpPost]
        public FileContentResult ExportExcel(string tableData, DateTime enddate)
        {
            DataTable table = new DataTable();
            var array = JsonConvert.DeserializeObject(tableData) as JArray;
            if (array.Count > 0)
            {
                StringBuilder columns = new StringBuilder();
                JObject objColumns = array[0] as JObject;
                //构造表头
                foreach (JToken jkon in objColumns.AsEnumerable<JToken>())
                {
                    string name = ((JProperty)(jkon)).Name;
                    columns.Append(name + ",");
                    table.Columns.Add(name);
                }
                //向表中添加数据
                for (int i = 0; i < array.Count; i++)
                {
                    DataRow row = table.NewRow();
                    JObject obj = array[i] as JObject;
                    foreach (JToken jkon in obj.AsEnumerable<JToken>())
                    {

                        string name = ((JProperty)(jkon)).Name;
                        string value = ((JProperty)(jkon)).Value.ToString();
                        row[name] = value;
                    }
                    table.Rows.Add(row);
                }
            }
            byte[] filecontent = ExcelExportHelper.ExportExcel(table, "库存金额表（统计截止日期:" + enddate.ToString("yyyy-MM-dd") + ")", false);
            return File(filecontent, ExcelExportHelper.ExcelContentType, "金额表" + ".xlsx");
        }
        #endregion

        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                db.Dispose();
            }
            base.Dispose(disposing);
        }



    }
}
