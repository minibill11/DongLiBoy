
@{
    ViewBag.Title = "SPC_PrintOuterBoxLable";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/Content/styleFile/packaging/index.css" rel="stylesheet" />
<script src="~/Content/styleFile/packaging/index.js"></script>
<script src="~/Scripts/axios.min.js"></script>
<style>
    .query {
        width: 300px;
        text-align: right;
        margin: 2px auto;
    }
</style>
<div id="app">
    <div class="text-center">
        <h3 class="text-center">打印外箱标签</h3>
        <a href="/Packagings/SPC_QueryByOrderNumber"><el-button size="small" class="cret" type="primary" plain>首页</el-button></a>
        <a href="/Packagings/SPC_Display" style="margin-left:2px"><el-button size="small" type="primary" plain>查询基本信息</el-button></a>
        <a href="/Packagings/SPC_Addbasic_information"><el-button size="small" class="cret" type="primary" plain>物料基本信息录入</el-button></a>
        <a href="/Packagings/SPC_MaterialLablePrint"><el-button size="small" type="primary" plain style="margin:2px">打印物料标签</el-button></a>
        <a href="/Packagings/SPC_StockConfirm"><el-button size="small" type="primary" plain style="margin:2px" v-show="materialPreparation">物料备料</el-button></a>
        <a href="/Packagings/SPC_Packaging" style="margin-left:2px"><el-button size="small" type="primary" plain v-show="packingMaterial">备品配件检验</el-button></a>
        <a href="/Packagings/SPC_Packaging_Modify"><el-button size="small" class="cret" type="primary" plain>修改包装信息</el-button></a>
    </div>
    <div class="text-center" v-loading="loading">
        <div class="query">
            订单号：
            <select-input v-model.trim="orderNum"
                          :options="options"
                          :isfocus="true"
                          :ismultiple="false"
                          size="medium"
                          style="width:190px"
                          allow-create filterable clearable>
            </select-input>
        </div>
        <div class="query">
            <span>选打印机：</span>
            <el-select v-model="printProt" clearable placeholder="选择打印机" size="medium" style="width:190px">
                <el-option v-for="item in printOptions"
                           :key="item.value"
                           :label="item.label"
                           :value="item.value">
                </el-option>
            </el-select>
        </div>
        <div class="query">
            <span>语言：</span>
            <el-select v-model="Language" clearable placeholder="选择语言" size="medium" style="width:190px">
                <el-option v-for="item in LanguageOptions"
                           :key="item.value"
                           :value="item.value">
                </el-option>
            </el-select>
        </div>
        <div class="query">
            <el-switch class="affirm2"
                       v-model="imgShow"
                       width="35"
                       active-text="使用Logo">
            </el-switch>
        </div>
        <div class="query">
            <el-input v-model.trim="outerBox" placeholder="请输入要导出的外箱号" style="width:180px" size="medium" clearable></el-input>
            <el-button v-on:click="eproxd" size="mini" plain type="primary" class="btn">导出清单</el-button><br />
            <form style="display:none;" action="~/Packagings/ExportExcel" method="post">
                <input type="text" name="spc_OuterBoxBarcode" v-model="outerBox" />
                <button type="submit" id="submits"></button>
            </form>
        </div>
        <div class="query" style="margin-top:5px">
            <el-button v-on:click="lookImage" size="mini" plain type="primary" style="margin-left:40px">查看勾选条码</el-button>
            <el-button v-on:click="printMaterialBarcode" size="mini" plain type="primary" v-show="printOutsibox">打印选中的外箱标签</el-button><br />
            <el-checkbox @@change="CheckAll" size="mini" border style="padding:1px 3px;height:22px;margin:1px">全选</el-checkbox>
            <span style="color:#409EFF">此订单已存在条码：</span>
            <div style="max-height:150px;overflow:auto">
                <template v-for="item in OuterBarcodeList">
                    <el-checkbox v-model="item.state" size="mini" border style="padding:1px 3px;height:22px;margin:1px">{{item.value}}</el-checkbox>
                </template>
            </div>
        </div>
        <div>
            <div id="img"></div>
        </div>
    </div>
</div>
@RenderPage("~/Views/Shared/_SelectInput.cshtml")
<script>
    var app = new Vue({
        el: '#app',
        data: {
            orderNum: '',         //订单号
            options: [],
            materialPreparation: false,//物料备料权限
            printOutsibox: false,//打印外箱标签权限
            OuterBarcodeList: [],
            loading: false,
            imgNumber: 0,  //用于空值加载
            printProt: '',
            Language: '中文',//语言
            LanguageOptions: [{ label: '选项一', value: '中文' }, { label: '选项一', value: '英文' }],//语言选项框
            printOptions: printIpAddress,
            imgShow: true,
            outerBox: '',
            packingMaterial: false,//物料检验权限
        },
        //获取订单号
        mounted() {
            axios.post('/Packagings/GetOrderList').then(res => {
                this.options = res.data;
            }).catch(err => {
                console.warn("获取选择列表失败")
            });
            let printIP = localStorage.getItem('printIP');
            if (printIP != null) {
                this.printPort = printIP;
            };
            var roles = JSON.parse(localStorage.getItem("rigths"))
            if (checkRoles(roles, '物料备料')) {
                this.materialPreparation = true
            } else {
                this.materialPreparation = false
            };
            if (checkRoles(roles, '打印外箱标签')) {
                this.printOutsibox = true
            } else {
                this.printOutsibox = false
            };  
            if (checkRoles(roles, '物料装箱')) {
                this.packingMaterial = true
            } else {
                this.packingMaterial = false
            }
        },
        methods: {
            //清单导出
            eproxd() {
                if (this.outerBox != '') {
                    $("#submits").click();
                } else {
                    this.$message({
                        message: "请输入要导入的外箱号",
                        type: "warning"
                    });
                }
            },
            //查看标签图片方法
            lookImage: function () {
                let arr = this.OuterBarcodeList, checkList = [];  //勾选的数组
                if (arr.length > 0) {
                    for (let i in arr) {
                        if (arr[i].state == true) {
                            checkList.push(arr[i].value);

                        };
                    };
                    if (checkList.length > 0) {
                        $("#img>img").remove();
                        app.loading = true;
                        this.imgNumber = 0;
                        for (let i in checkList) {
                            this.getPicture(checkList[i], checkList.length);
                        };
                    } else {
                        this.$message({
                            showClose: true,
                            message: '没有勾选查询清单！',
                            type: 'error'
                        });
                    };
                } else {
                    this.$message({
                        showClose: true,
                        message: '没有可查询的清单！',
                        type: 'error'
                    });
                }
            },
            //输出查询出的图片
            getPicture: function (outerBarcodeNum, number) {
                axios.post('/Packagings/Outspc_OutsideBoxLabelToImg', {
                    orderNumber: this.orderNum,
                    spc_OuterBoxBarcode: outerBarcodeNum,
                    language: this.Language,
                    logo: this.imgShow
                }, {
                        responseType: "arraybuffer",
                    }).then(function (response) {
                        return 'data:image/png;base64,' + btoa(
                            new Uint8Array(response.data).reduce((data, byte) => data + String.fromCharCode(byte), '')
                        );
                    }).then(function (data) {
                        let cc = new Image();
                        cc.src = data;
                        document.getElementById("img").appendChild(cc);
                        app.imgNumber++;
                        if (app.imgNumber == number) {
                            app.loading = false;
                        };
                    }).catch(err => {
                        app.imgNumber++;
                        if (app.imgNumber == number) {
                            app.loading = false;
                        };
                        console.warn("显示失败");
                    });
            },
            //打印勾选中的物料条码
            printMaterialBarcode() {
                let arr = this.OuterBarcodeList, postList = [];
                if (arr.length > 0) {
                    for (let i in arr) {
                        if (arr[i].state == true) {
                            postList.push(arr[i].value);
                        };
                    };
                    console.log(postList)
                    if (postList.length > 0) {
                        app.loading = true;
                        this.imgNumber = 0;
                        for (let i in postList) {
                            axios.post('/Packagings/Outspc_OutsideBoxLabelAgain', {
                                spc_OuterBoxBarcode: postList[i],  //物料号
                                orderNumber: this.orderNum,       //订单号
                                ip: this.printProt,            //ip地址
                                port: 9101,                   //端口
                                language: this.Language,
                                logo: this.imgShow
                            }
                            ).then(res => {
                                if (res.data == '打印成功！') {
                                    this.$message({
                                        showClose: true,
                                        message: res.data,
                                        type: 'success'
                                    });
                                } else {
                                    this.$message({
                                        showClose: true,
                                        message: res.data,
                                        type: 'error'
                                    });
                                };
                                this.imgNumber++;
                                if (this.imgNumber == postList.length) {
                                    app.loading = false;
                                };
                            }).catch(err => {
                                this.$message({
                                    showClose: true,
                                    message: '打印出错！',
                                    type: 'error'
                                });
                                this.imgNumber++;
                                if (this.imgNumber == postList.length) {
                                    app.loading = false;
                                };
                            });
                        };
                    } else {
                        this.$message({
                            showClose: true,
                            message: '没有勾选需要打印的外箱号！',
                            type: 'error'
                        });
                    };
                } else {
                    this.$message({
                        showClose: true,
                        message: '外箱号清单为空！',
                        type: 'error'
                    });
                };
            },
            //全选按钮
            CheckAll: function (v) {
                let checkList = this.OuterBarcodeList;
                for (let i in checkList) {
                    checkList[i].state = v;
                };
            },

        },
        watch: {
            orderNum() {
                //获取外箱列表
                if (this.orderNum != '' && this.orderNum.length > 10) {
                    this.OuterBarcodeList =[]
                    axios.post("/Packagings/Output_CartonNumber", {
                        orderNum: this.orderNum
                    }).then(res => {
                        if (res.data.length > 0) {
                            let arr = res.data;
                            list = this.OuterBarcodeList
                            for (let item in arr) {
                                list.push({
                                    value: arr[item],
                                    state: false
                                })
                            }
                        } else {
                            this.$message({
                                showClose: true,
                                message: '此订单号还没有可打印的外箱标签！',
                                type: 'error'
                            });
                        }
                    })
                }
            },

        }

    })
    //检测权限
    function checkRoles(list, roleName) {
        var flag = false
        if (list && roleName) {
            for (let item in list) {
                if (list[item] == roleName) {
                    flag = true
                }
            }
        }
        return flag
    }

</script>
