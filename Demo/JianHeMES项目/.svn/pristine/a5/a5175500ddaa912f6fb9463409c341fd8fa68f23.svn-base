
@{
    ViewBag.Title = "钣金修改录入数据";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/Content/styleFile/packaging/index.css" rel="stylesheet" />
<script src="~/Content/styleFile/packaging/index.js"></script>
<script src="~/Scripts/axios.min.js"></script>

<style>
    .el-input__inner {
        border-color: #fff
    }

    .el-table__header tr, .el-table__header th, .el-table td {
        padding: 0.8%;
        text-align: center;
        padding-left: 0px;
        font-size: 14px;
    }

    .el-button {
        padding: 5px
    }

    #selectBox {
        border-color: #409EFF;
        margin: 2px;
    }
</style>

<div id="app">
    <div style="text-align:center">
        <h4>修改基本信息</h4>
        <label>订&nbsp;&nbsp;单&nbsp;&nbsp;号:</label>
        <el-select v-model="orderNum"
                   clearable
                   allow-create filterable
                   placeholder="请选择订单号" id="selectBox">
            <el-option v-for="item in orderNumOptions"
                       :key="item.value"
                       :value="item.value">
            </el-option>
        </el-select>
        <el-table v-bind:data="tableData"
                  style="width: 1031px;font-size: 13px;margin:auto" border max-height="300">
            <el-table-column prop="OrderNum"
                             label="订单号"
                             width="130">
            </el-table-column>

            <el-table-column prop="Quantity"
                             label="数量"
                             width="85">
                <template scope="scope">
                    <el-input v-model="scope.row.Quantity" placeholder="数量" type="text" size="mini"></el-input>
                </template>
            </el-table-column>
            <el-table-column prop="ProductionType"
                             label="生产类型"
                             width="85">
            </el-table-column>

            <el-table-column prop=""
                             label="生产排期起始时间"
                             width="215">
                <template scope="scope">
                    <el-date-picker v-model="scope.row.ProductScheduleStartTime"
                                    type="datetime"
                                    placeholder="生产排期起始时间"
                                    style="width:195px" size="mini">
                    </el-date-picker>
                </template>
            </el-table-column>
            <el-table-column prop=""
                             label="部门交货时间"
                             width="215">
                <template scope="scope">
                    <el-date-picker v-model="scope.row.DepartmentalDeliveryTime"
                                    type="datetime"
                                    placeholder="部门交货时间"
                                    style="width:195px" size="mini">
                    </el-date-picker>
                </template>
            </el-table-column>
            <el-table-column prop=""
                             label="生产开始时间"
                             width="220">
                <template scope="scope">
                    <el-date-picker v-model="scope.row.ProductionStartTime"
                                    type="datetime"
                                    placeholder="选择生产开始时间"
                                    style="width:195px" v-bind:disabled="scope.row.ProductionStartTime==''||scope.row.ProductionStartTime==null" size="mini">
                    </el-date-picker>
                </template>
            </el-table-column>
            <el-table-column prop=""
                             label="操作"
                             width="80">
                <template scope="scope">
                    <el-button v-on:click="saveBasicInfo(scope.row)" size="mini" type="primary">保存</el-button>
                </template>
            </el-table-column>
        </el-table>
        <br />
        <h4>修改生产信息</h4>
        <label>订&nbsp;&nbsp;单&nbsp;&nbsp;号:</label>
        <el-select v-model="ordernum"
                   clearable
                   allow-create filterable
                   placeholder="请选择订单号" id="selectBox">
            <el-option v-for="item in ordernumOptions"
                       :key="item.value"
                       :value="item.value">
            </el-option>
        </el-select>
        <el-table v-bind:data="productionData"
                  style="width: 1031px;font-size: 13px;margin:auto" border max-height="310">
            <el-table-column prop="OrderNum"
                             label="订单号"
                             width="150">
            </el-table-column>
            <el-table-column prop="ProductionType"
                             label="生产类型"
                             width="110">
            </el-table-column>
            <el-table-column prop="Section"
                             label="工段"
                             width="200">
            </el-table-column>
            <el-table-column prop="NormalQuantity"
                             label="正常数"
                             width="95">
                <template scope="scope">
                    <el-input v-model="scope.row.NormalQuantity" placeholder="" type="text" size="mini"></el-input>
                </template>
            </el-table-column>
            <el-table-column prop="AbnormaQuantity"
                             label="异常数"
                             width="95">
                <template scope="scope">
                    <el-input v-model="scope.row.AbnormaQuantity" placeholder="" type="text" size="mini"></el-input>
                </template>
            </el-table-column>
            <el-table-column prop=""
                             label="生产开始时间/入库完成时间"
                             width="230">
                <template scope="scope">
                    <el-date-picker v-model="scope.row.InputTime"
                                    type="datetime"
                                    placeholder="选择生产开始时间"
                                    style="width:195px" v-bind:disabled="scope.row.Section!='图纸编程'&&scope.row.Section!='入库'" size="mini">
                    </el-date-picker>
                </template>
            </el-table-column>
            <el-table-column prop=""
                             label="操作"
                             width="150">
                <template scope="scope">
                    <div style="display:inline-flex">
                        <el-button v-on:click="saveProduction(scope.row)" size="mini" type="primary">保存</el-button>
                        <el-button v-on:click="delProduction(scope.row)" size="mini" type="danger">删除</el-button>
                    </div>
                </template>
            </el-table-column>
        </el-table>
    </div>

</div>

<script>
    var app = new Vue({
        el: '#app',
        data: {
            ordernum: '',
            ordernumOptions: [],
            orderNum: '',
            orderNumOptions: [],
            tableData: [],
            productionData: [],
        },
        mounted() {
            axios.post('/MetalPlate/GetorderNum').then(res => {
                this.ordernumOptions = res.data;
                this.orderNumOptions = res.data;
                console.log(res.data)
            }).catch(err => {
                console.warn("获取选择列表失败")
            });
        },
        methods: {
            getData() {
                axios.post('/MetalPlate/getBasicInfo', {
                    ordernum: this.orderNum,
                }).then(res => {
                    console.log(res.data)
                    this.tableData = res.data
                })
            },
            getProduction() {
                axios.post('/MetalPlate/getProduction', {
                    ordernum: this.ordernum,
                }).then(res => {
                    console.log(res.data)
                    this.productionData = res.data
                })
            },
            saveBasicInfo(row) {
                let obj = {
                    Id: row.Id, OrderNum: row.OrderNum, Quantity: row.Quantity, ProductionType: row.ProductionType, ProductScheduleStartTime: row.ProductScheduleStartTime,
                    DepartmentalDeliveryTime: row.DepartmentalDeliveryTime, ProductionStartTime: row.ProductionStartTime, CompletionState: row.CompletionState, Remark: row.Remark
                }
                axios.post('/MetalPlate/MetalPlateBasicInfo_modify', {
                    newList: obj,
                }).then(res => {
                    if (res.data == "修改成功！") {
                        this.$message({
                            message: "修改成功!",
                            type: "success"
                        });
                        this.getData()
                    } else {
                        this.$message({
                            message: res.data,
                            type: "warning"
                        })
                    }
                }).catch(err => {
                    console.log("请求失败")
                })
            },
            saveProduction(row) {
                console.log(row)
                let obj = {
                    Id: row.Id, OrderNum: row.OrderNum, Section: row.Section, ProductionType: row.ProductionType, NormalQuantity: row.NormalQuantity, AbnormaQuantity: row.AbnormaQuantity,
                    InputTime: row.InputTime, InputPerson: row.InputPerson, Department: row.Department, Group: row.Group, Remark: row.Remark
                }
                axios.post('/MetalPlate/MetalPlateProduction_modify', {
                    newList: obj,
                }).then(res => {
                    if (res.data == "修改成功！") {
                        this.$message({
                            message: "修改成功!",
                            type: "success"
                        });
                        this.getProduction()
                    } else if (res.data == "修改失败,录入数量大于订单总数！") {
                        this.$message({
                            message: res.data,
                            type: "warning"
                        })
                        this.getProduction()
                    }
                    else {
                        this.$message({
                            message: res.data,
                            type: "warning"
                        })
                    }
                }).catch(err => {
                    console.log("请求失败")
                })
            }
        },
        watch: {
            orderNum() {
                if (this.orderNum != '') {
                    this.getData()
                } else this.tableData=[]
            },
            ordernum() {
                if (this.ordernum != '') {
                    this.getProduction()
                } else this.productionData=[]
            }
        }
    })
</script>
