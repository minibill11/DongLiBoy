
@{
    ViewBag.Title = "设备报修单查询";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Scripts/Bootstraps/Element-ui.css" rel="stylesheet" />
<script src="~/Scripts/axios.min.js"></script>
<script src="~/Scripts/Bootstraps/Element-ui.js"></script>
<h4 style="text-align:center;">设备报修单查询</h4>
<style>
    .topContainer{
        display:flex;
        justify-content:space-around;
    }
    .topContainer div{
        width:88%;
    }
</style>
<div id="app">
    <div class="topContainer">
        <div>
            <el-input v-model="EName" size="small" placeholder="设备名称"></el-input>
        </div>
        <div>
            <el-select v-model="ENunber" size="small" filterable placeholder="请选择设备编号">
                <el-option v-for="item in options"
                           v-bind:key="item.value"
                           v-bind:label="item.label"
                           v-bind:value="item.value">
                </el-option>
            </el-select>
        </div>
        <div>
            <el-date-picker v-model="fualtTime"
                            type="date"
                            v-bind:disabled="fualtTimeFlag"
                            size="small"
                            placeholder="故障日期">
            </el-date-picker>
        </div>
        <div>
            <el-date-picker v-model="TimeRange"
                            type="daterange"
                            size="small"
                            v-bind:disabled="fualtTimeRangeFlag"
                            range-separator="至"
                            start-placeholder="开始日期"
                            end-placeholder="结束日期">
            </el-date-picker>
        </div>
        <el-button id="search" type="success" size="small" v-on:click="query">查询</el-button>
    </div>
    <div class="bottomContainer">
        <el-table v-bind:data="tableData"
                  style="width: 100%">
            <el-table-column prop="EquipmentNumber"
                             label="设备编号"
                             sortable
                             width="180">
            </el-table-column>
            <el-table-column prop="EquipmentName"
                             label="设备名称"
                             sortable
                             width="180">
            </el-table-column>
            <el-table-column prop="FaultTime"
                             label="故障时间">
            </el-table-column>
            <el-table-column prop="Emergency"
                             label="紧急状态">
            </el-table-column>
            <el-table-column label="操作">
                <template slot-scope="scope">
                    <el-button type="primary" size="small" v-on:click="showDetials(scope.row,scope.$index)">详细</el-button>
                    <el-button type="success" size="small" v-on:click="changeInfos(scope.row,scope.$index)">修改</el-button>
                </template>
            </el-table-column>
        </el-table>
    </div>
</div>

<script>
    document.onkeydown = function (event) {
        var e = event || window.event;    // 兼容IE
        if (e && e.keyCode == 13) { //回车键的键值为13
            $("#search").click();
        }
    };
    function getTime(val){
        let dd = new Date(val);
        let year = dd.getFullYear();
        let month = (dd.getMonth() + 1).toString().padStart(2, 0);
        let days = dd.getDate().toString().padStart(2, 0);
        return `${year}年${month}月${days}日`
    }
    let app = new Vue({
        el: "#app",
        data: {
            EName: null,
            ENunber: null,
            fualtTime: null,
            TimeRange: null,
            options: [],
            fualtTimeFlag: false,
            fualtTimeRangeFlag: false,
            tableData: [],
        },
        methods: {
            query() {
                if (this.EName != null || this.ENunber != null || this.fualtTime != null || this.TimeRange != null) {
                    axios.post("/Equipment/EquipmentRepairbill_Query", { equnumber: this.ENunber, equipname: this.EName, date: this.fualtTime, starttime: this.TimeRange != null ? this.TimeRange[0] : null, endtime: this.TimeRange != null ? this.TimeRange[1] : null }).then(res=> {
                        console.log(res.data)
                        res.data.forEach(item=> {
                            item.FaultTime = getTime(item.FaultTime)
                        })
                        this.tableData = res.data
                    }).catch(err=> {
                        this.$message({
                            message: "查询失败",
                            type: "warning"
                        })
                    })
                } else {
                    this.$message({
                        message: "请补全需要查询的信息",
                        type: "warning"
                    })
                }
            },
            showDetials(item, index) {
                let timedata = item.FaultTime.match(/\d+/g);
                let faultime = `${timedata[0]}-${timedata[1]}-${timedata[2]}`
                //console.log(timedata)
                window.location.href = "/Equipment/EquipmentRepairbill?" + "num=" + item.EquipmentNumber + "&time=" + faultime + "&canchange=false";
            },
            changeInfos(item, index) {
                let timedata = item.FaultTime.match(/\d+/g);
                let faultime = `${timedata[0]}-${timedata[1]}-${timedata[2]}`
                window.location.href = "/Equipment/EquipmentRepairbill?" + "num=" + item.EquipmentNumber + "&time=" + faultime + "&canchange=true";
            }
        },
        mounted() {
            axios.post("/Equipment/InstrumentList").then(res=> {
                res.data.forEach(item=> {
                    let obj = { value: item, label: item };
                    this.options.push(obj)
                })
            }).catch(err=> {
                this.$message({
                    message: "获取设备编号列表失败",
                    type:"warning"
                })
            })
        },
        watch: {
            fualtTime() {
                if (this.fualtTime != null) {
                    this.fualtTimeRangeFlag = true;
                } else {
                    this.fualtTimeRangeFlag = false;
                }
            },
            TimeRange() {
                if (this.TimeRange != null) {
                    this.fualtTimeFlag = true;
                } else {
                    this.fualtTimeFlag = false;
                }
            }
        }
    })
</script>
