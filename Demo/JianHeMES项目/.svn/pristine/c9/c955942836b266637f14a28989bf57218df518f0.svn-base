@{
    //ViewBag.Title = "客诉损失明细按故障及平台分类查询";
    Layout = "~/Views/Shared/_Layout2.cshtml";
}

@* css放置处 *@
@section cssStyle {
    <link rel="stylesheet/less" type="text/css" href="~/Content/styleFile/moduleManagement/module.less" />
    <style>
        .table-top {
            margin-bottom: 20px;
        }
        .m-right {
            margin-left: 10px;
            margin-right: 10px;
        }
        .table .cell, .el-table th, .el-table td, .el-table tr {
            padding: 2px;
            font-size: 12px;
            height: 28px;
            line-height: 28px;
        }
        .lineh {
            line-height:18px;  
            cursor:pointer;
        }
        .el-table .warning-row {
            background: #eff2f7;
            color:#000000;
            font-size: 25px !important;
            font-weight: 700;
        }
    </style>
}

<div id="app" v-cloak>
    <el-container>
        <el-header class="text-center">
            <h3 class="top-title">客诉损失明细按故障及平台分类查询</h3>
        </el-header>
        <el-main>
            @*日期选择框 *@
            <el-row class="text-center table-top">
                <el-select v-model="queryCondition"
                           @@change="selectCondition"
                           placeholder="请选择查询方式"
                           size="medium"
                           style="width:120px;">
                    <el-option label="按年查询" value="y">
                    </el-option>
                    <el-option label="按年月查询" value="m">
                    </el-option>
                </el-select>

                <el-date-picker v-show="queryCondition=='y'"
                                class="m-right"
                                v-model="selectTime"
                                @@change="selectDate"
                                type="year"
                                size="medium"
                                style="width:150px;"
                                placeholder="选择年">
                </el-date-picker>

                <el-date-picker v-show="queryCondition=='m'"
                                class="m-right"
                                v-model="selectTime"
                                @@change="selectDate"
                                type="month"
                                size="medium"
                                style="width:150px;"
                                placeholder="选择年月">
                </el-date-picker>
                <el-button type="primary" v-on:click="queryData" size="medium">查询</el-button>
                <a href="Customer_loss" target="_blank"><el-button type="primary" size="medium" plain>添加明细</el-button></a>
                <el-button type="success" plain size="medium" v-show="tableData.length" v-on:click="exportExcel">导出结果</el-button>
            </el-row>
            <el-row class="text-center">
                <el-table :data="tableData"
                          min-height="234"
                          max-height="660"
                          cell-class-name="cellParent"
                          stripe
                          border
                          v-bind:cell-style="yellowBg" :row-class-name="tableRowClassName"  v-bind:span-method="cellMerge">
                    <el-table-column prop="Classification"
                                     label="分类"
                                     align="center"
                                     min-width="98" style="background:#ff6a00">
                    </el-table-column>
                    <el-table-column prop="Fault_Classification"
                                     label="故障分类"
                                     align="center"
                                     min-width="98" style="background:#ff6a00">
                    </el-table-column>
                    <el-table-column prop=""
                                     label="产品平台"
                                     align="center">
                        <el-table-column prop="VF_Platform"
                                         label="VF平台"
                                         align="center"
                                         min-width="78">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.VF_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.VF_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="VA_Platform"
                                         label="VA平台"
                                         align="center"
                                         min-width="78">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.VA_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.VA_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="VL_Platform"
                                         label="VL平台"
                                         align="center"
                                         min-width="78">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.VL_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.VL_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="VK_Platform"
                                         label="VK平台"
                                         align="center"
                                         min-width="78">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.VK_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.VK_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="VH_Platform"
                                         label="VH平台"
                                         align="center"
                                         min-width="78">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.VH_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.VH_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="RE_Platform"
                                         label="RE平台"
                                         align="center"
                                         min-width="78">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.RE_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.RE_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="VMQ_Platform"
                                         label="VMQ平台"
                                         align="center"
                                         min-width="78">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.VMQ_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.VMQ_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="VPQ_Platform"
                                         label="VPQ平台"
                                         align="center"
                                         min-width="78">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.VPQ_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.VPQ_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="FM_Platform"
                                         label="FM平台"
                                         align="center"
                                         min-width="78">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.FM_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.FM_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="F_FS_Platform"
                                         label="F/FS平台"
                                         align="center"
                                         min-width="78">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.F_FS_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.F_FS_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="FI_FL_Platform"
                                         label="FI/FL平台"
                                         align="center"
                                         min-width="78">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.FI_FL_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.FI_FL_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="L_LS_Platform"
                                         label="L/LS平台"
                                         align="center"
                                         min-width="78">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.L_LS_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.L_LS_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="Customization_Platform"
                                         label="定制屏"
                                         align="center"
                                         min-width="78">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.Customization_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.Customization_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="AllInOne_Platform"
                                         label="一体机"
                                         align="center"
                                         min-width="74">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.AllInOne_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.AllInOne_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="Others_Platform"
                                         label="其他"
                                         align="center"
                                         min-width="78">
                            <template scope="scope">
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.Others_Platform.count|countFilter}}</div>
                                <div class="lineh" @@click="onSelectData(scope)">{{scope.row.Others_Platform.sum|sumFilter}}</div>
                            </template>
                        </el-table-column>
                    </el-table-column>
                    <el-table-column prop="Times"
                                     label="发生次数"
                                     align="center"
                                     min-width="78">
                        <template scope="scope">
                            <div @@click="onSelectData(scope)">{{scope.row.Times.count|countFilter}}</div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="TotalLoss"
                                     label="累计损失金额"
                                     align="center"
                                     min-width="78">
                        <template scope="scope">
                            <div @@click="onSelectData(scope)">{{scope.row.TotalLoss.sum|sumFilter}}</div>
                        </template>
                    </el-table-column>
                </el-table>
            </el-row>
        </el-main>
    </el-container>
</div>
@* 分部页放置处 *@
@section renderPage {
    @RenderPage("~/Views/Warehouse_Material/_wareEdit.cshtml")
}
@* js放置处 *@
@section jsScript {
    <script src="~/Content/styleFile/moduleManagement/module.js"></script>
    <script>
        Vue.filter("countFilter", function (val) {
            if (val == 0 || val == undefined) {
                return ''
            } else if (val == '小计') {
                return val
            }
            else return `${val}`+"次"            
        })
        Vue.filter("sumFilter", function (val) {
           if (val == 0 || val == undefined) return '';
            else return "￥"+`${val}`
        })
        const app = {
            data: function () {
                return {                    
                    queryCondition: 'y',
                    selectTime: null,     // 所选时间
                    year: '',
                    month: '',
                    tableData: [],        // 客诉损失表格        
                    spanArr: [],   //存放第一列合并的数据
                    pos: '',       //spanArr数组的索引
                }
            },
            created: function () {
            },
            mounted: function () {
                this.selectDate();
            },
            //函数方法
            methods: {    
                //合并相同数据的方法  合并第一个表格第一列相同的数据
                getSpanArr(data) {
                    for (var i = 0; i < data.length; i++) {
                        if (i === 0) {     //判断是否是第一条数据
                            this.spanArr.push(1);
                            this.pos = 0
                        } else {
                            //判断与上一元素是否相同
                            if (data[i].Classification === data[i - 1].Classification) {
                                //合并行数+1
                                this.spanArr[this.pos] += 1;
                                this.spanArr.push(0);
                            } else {
                                this.spanArr.push(1);
                                this.pos = i;
                            }
                        }
                    };
                },
                cellMerge({ row, column, rowIndex, columnIndex }) {
                    if (columnIndex === 0) {
                        const _row = this.spanArr[rowIndex];
                        const _col = _row > 0 ? 1 : 0;
                        return {
                            rowspan: _row,
                            colspan: _col
                        }
                    };
                },
                //处理合计行的样式
                tableRowClassName({ row, rowIndex }) {
                    if (row.Others_Platform.count == "小计") {
                        return 'warning-row';
                    }
                    return '';
                },
                selectCondition() {
                    this.selectDate(this.selectTime);
                },
                //选择时间
                selectDate(v) {
                    if (v != "" && v != null) {
                        let dd = new Date(this.selectTime)
                        if (this.queryCondition == 'y') {//按月
                            this.year = dd.getFullYear()
                            this.month = 0
                        };
                        if (this.queryCondition == 'm') {//按年月
                            this.year = dd.getFullYear()
                            this.month = dd.getMonth() + 1
                        };
                    }
                },

                //查询 表格渲染
                queryData() {
                    if (this.year == "" &&this.month == "") {                    
                        return;
                    }
                    axios.post("/Customer_Complaints/Customer_loss_byFaultOrType_Query", { year: this.year, month: this.month }).then(res => {
                        this.spanArr = [];
                        this.pos = '';
                        console.log(res.data)
                        this.tableData = res.data
                        this.getSpanArr(this.tableData)
                    })

                },

                yellowBg({ row, column, rowIndex, columnIndex }) {
                    if (columnIndex == 0) {
                        return {
                            background: '#E4ECF7',
                        }                    
                    } else {
                        return {
                            color: '',
                        }
                    };
                },

                onSelectData(scope) {
                    if (scope.row.Classification == null) {
                        return
                    } else {
                        if (scope.row.Fault_Classification != "累计发生次数" && scope.row.Fault_Classification != "累计损失金额" && scope.column.label != "发生次数" && scope.column.label != "累计损失金额") {
                            window.open("/Customer_Complaints/Customer_loss?" + "year=" + this.year + "&month=" + this.month + "&PlatformOptions_value=" + scope.column.label + "&Fault_Classification_Options_value=" + scope.row.Fault_Classification)
                        }
                        else if ((scope.row.Fault_Classification == "累计发生次数" || scope.row.Fault_Classification == "累计损失金额") && (scope.column.label == "发生次数" || scope.column.label == "累计损失金额")) {
                            window.open("/Customer_Complaints/Customer_loss?" + "year=" + this.year + "&month=" + this.month + "&PlatformOptions_value=" + "" + "&Fault_Classification_Options_value=" + "")
                        }
                        else if ((scope.row.Fault_Classification == "累计发生次数" || scope.row.Fault_Classification == "累计损失金额") && (scope.column.label != "发生次数" || scope.column.label != "累计损失金额")) {
                            window.open("/Customer_Complaints/Customer_loss?" + "year=" + this.year + "&month=" + this.month + "&PlatformOptions_value=" + scope.column.label + "&Fault_Classification_Options_value=" + "")
                        }
                        else {
                            window.open("/Customer_Complaints/Customer_loss?" + "year=" + this.year + "&month=" + this.month + "&PlatformOptions_value=" + "" + "&Fault_Classification_Options_value=" + scope.row.Fault_Classification)
                        }
                    }                   
                },
                //导出excel表格
                exportExcel() {
                    axios.post("/Customer_Complaints/FaultOrType_ExportExcel", { year: this.year, month: this.month },{
                        responseType: "blob",
                    }).then(function (res) {
                        console.log(res.data)
                        let fileName = '客诉损失明细按故障及平台分类.xlsx'
                        let url = window.URL.createObjectURL(new Blob([res.data]))
                        let link = document.createElement('a')
                        link.style.display = 'none'
                        link.href = url
                        link.setAttribute('download', fileName)
                        document.body.appendChild(link)
                        link.click()
                    })

                }               
            },
        };
    </script>
}