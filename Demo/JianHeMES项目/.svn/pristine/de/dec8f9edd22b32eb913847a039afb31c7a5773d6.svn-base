
@{
    ViewBag.Title = "EquipmentRepairbill";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Scripts/Bootstraps/Element-ui.css" rel="stylesheet" />
<script src="~/Scripts/axios.min.js"></script>
<script src="~/Scripts/Bootstraps/Element-ui.js"></script>
<style>
    table tr th{
        text-align:center;
    }
    .el-date-editor{
        width:100% !important;
        height:100%;
    }
    .el-textarea{
        width:100% !important;
        height:100%;
    }
    textarea{
        max-width: 1112px !important;
    }
    input{
        max-width: 382px !important;
    }
    .el-radio-group{
        vertical-align:baseline !important;
    }
    .searchContainer{
        text-align:center;
    }
    .searchContainer .el-date-editor{
        
        width:150px !important;
    }
    .searchContainer .el-input__inner{
        width:150px !important;
    }
</style>
<h4 style="text-align:center;">仪器设备保修单</h4>

<div id="app">
    @*<div class="searchContainer">
        <el-date-picker v-model="selectTime"
                        type="date"
                        size="small"
                        placeholder="选择日期">
        </el-date-picker>
        
    </div>*@
    <table style="width:100%;" border="1">
        <thead>
            <tr style="height:40px;">
                <th>设备名称</th>
                <th colspan="2">{{EquipmentName}}</th>
                <th>设备编号</th>
                <th colspan="2">{{assetNumber}}</th>
                <th>故障时间</th>
                <th colspan="2">
                    <el-date-picker v-model="guzhangtime"
                                    type="datetime"
                                    placeholder="选择日期时间">
                    </el-date-picker>
                </th>
                <th>紧急状态</th>
                <th colspan="3">
                    <el-input v-model="mergencyStatus" placeholder="请输入内容"></el-input>
                </th>
            </tr>
        </thead>
        <tbody>
            <tr style="height:130px;">
                <td style="text-align:center;">故障描述:</td>
                <td colspan="11">
                    <el-input type="textarea" v-model="guzhangDiscri" v-bind:autosize="{ minRows: 5, maxRows: 6}"></el-input>
                </td>
            </tr>
            <tr style="height:35px;">
                <td>维修人员</td>
                <td>
                    <el-input v-model="repairWorker" placeholder="请输入内容"></el-input>
                </td>
                <td>日期</td>
                <td colspan="1">
                    <el-date-picker v-model="repiarDate"
                                    type="datetime"
                                    placeholder="选择日期时间">
                    </el-date-picker>
                </td>
                <td>主管经理审核</td>
                <td colspan="1">
                    <el-select v-model="jinglizhuguanOpinon" placeholder="请选择">
                        <el-option v-for="item in options"
                                   v-bind:key="item.value"
                                   v-bind:label="item.label"
                                   v-bind:value="item.value">
                        </el-option>
                    </el-select>
                </td>
                <td colspan="2">
                    <el-date-picker v-model="bumenpizhunate"
                                    type="datetime"
                                    placeholder="选择日期时间">
                    </el-date-picker>
                </td>
                <td>中心总监批准</td>
                <td colspan="1">
                    <el-select v-model="zhongxinzongjianOpinon" placeholder="请选择">
                        <el-option v-for="item in options"
                                   v-bind:key="item.value"
                                   v-bind:label="item.label"
                                   v-bind:value="item.value">
                        </el-option>
                    </el-select>
                </td>
                <td colspan="2">
                    <el-date-picker v-model="zhongxinpizhunDate"
                                    type="datetime"
                                    placeholder="选择日期时间">
                    </el-date-picker>
                </td>
            </tr>

            <tr style="height:130px;">
                <td style="text-align:center;">技术部意见:</td>
                <td colspan="11">
                    <el-input type="textarea" v-model="jishubuOpinon" v-bind:autosize="{ minRows: 5, maxRows: 6}"></el-input>
                </td>
            </tr>
            <tr style="height:35px;">
                <td>ME工程师</td>
                <td colspan="1">
                    <el-input v-model="MEWorker" placeholder="请输入内容"></el-input>
                </td>
                <td>日期</td>
                <td colspan="1">
                    <el-date-picker v-model="MEgivenOpinonDate"
                                    type="datetime"
                                    placeholder="选择日期时间">
                    </el-date-picker>
                </td>
                <td>主管经理审核</td>
                <td colspan="1">
                    <el-select v-model="jinglizhuguanshenhe" placeholder="请选择">
                        <el-option v-for="item in options"
                                   v-bind:key="item.value"
                                   v-bind:label="item.label"
                                   v-bind:value="item.value">
                        </el-option>
                    </el-select>
                </td>
                <td colspan="2">
                    <el-date-picker v-model="jinglizhuguanshenheDate"
                                    type="datetime"
                                    placeholder="选择日期时间">
                    </el-date-picker>
                </td>
                <td>中心总监批准</td>
                <td colspan="1">
                    <el-select v-model="zhongxinzongjianpizhun" placeholder="请选择">
                        <el-option v-for="item in options"
                                   v-bind:key="item.value"
                                   v-bind:label="item.label"
                                   v-bind:value="item.value">
                        </el-option>
                    </el-select>
                </td>
                <td colspan="2">
                    <el-date-picker v-model="zhongxinzongjianpizhunDate"
                                    type="datetime"
                                    placeholder="选择日期时间">
                    </el-date-picker>
                </td>
            </tr>

            <tr style="height:130px;">
                <td style="text-align:center;">联建采购意见:</td>
                <td colspan="11">
                    <el-input type="textarea" v-model="jianliancaigoujianyi" v-bind:autosize="{ minRows: 5, maxRows: 6}"></el-input>
                </td>
            </tr>
            <tr style="height:35px;">
                <td>意见人</td>
                <td>
                    <el-input v-model="caigoujianyiren" placeholder="请输入内容"></el-input>
                </td>
                <td>日期</td>
                <td>
                    <el-date-picker v-model="caigoujianyiDate"
                                    type="datetime"
                                    placeholder="选择日期时间">
                    </el-date-picker>
                </td>
                <td>审核人</td>
                <td>
                    <el-input v-model="caogoushenheren" placeholder="请输入内容"></el-input>
                </td>
                <td>日期</td>
                <td>
                    <el-date-picker v-model="caigoushenheDate"
                                    type="datetime"
                                    placeholder="选择日期时间">
                    </el-date-picker>
                </td>
                <td>批准人</td>
                <td>
                    <el-input v-model="caigoupizhunren" placeholder="请输入内容"></el-input>
                </td>
                <td>日期</td>
                <td>
                    <el-date-picker v-model="caigoupizhunriqi"
                                    type="datetime"
                                    placeholder="选择日期时间">
                    </el-date-picker>
                </td>
            </tr>

            <tr style="height:40px;">
                <td colspan="2">维修时间</td>
                <td colspan="4">
                    <el-date-picker v-model="weixiuDate"
                                    type="datetime"
                                    placeholder="选择日期时间">
                    </el-date-picker>
                </td>
                <td colspan="2">维修人/厂家</td>
                <td colspan="4">
                    <el-input v-model="weixiuWorker" placeholder="请输入内容"></el-input>
                </td>
            </tr>
            <tr>
                <td colspan="6">维修后效果确认（维修需求部门）</td>
                <td colspan="6">维修后效果确认（技术部）</td>
            </tr>
            <tr style="height:120px;">
                <td colspan="6">
                    <el-input type="textarea" v-model="xuqiubumenWrite" v-bind:autosize="{ minRows: 5, maxRows: 6}"></el-input>
                </td>
                <td colspan="6">
                    <el-input type="textarea" v-model="jishubumenWrite" v-bind:autosize="{ minRows: 5, maxRows: 6}" ></el-input>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    保修问题是否解决
                </td>
                <td colspan="4">
                    <el-radio-group v-model="xuqiubumenComfirm">
                        <el-radio v-bind:label="true">是</el-radio>
                        <el-radio v-bind:label="false">否</el-radio>
                    </el-radio-group>
                </td>
                <td colspan="2">
                    保修问题是否解决
                </td>
                <td colspan="4">
                    <el-radio-group v-model="jishuubumenComfirm">
                        <el-radio v-bind:label="true">是</el-radio>
                        <el-radio v-bind:label="false">否</el-radio>
                    </el-radio-group>
                </td>
            </tr>
            <tr>
                <td>确认人</td>
                <td colspan="2">
                    <el-input v-model="xuqiubumenquerenren" placeholder="请输入内容"></el-input>
                </td>
                <td>日期</td>
                <td colspan="2">
                    <el-date-picker v-model="xuqiubumenquerenDate"
                                    type="datetime"
                                    placeholder="选择日期时间">
                    </el-date-picker>
                </td>
                <td>确认人</td>
                <td colspan="2">
                    <el-input v-model="jishubuquerenren" placeholder="请输入内容"></el-input>
                </td>
                <td>日期</td>
                <td colspan="3">
                    <el-date-picker v-model="jishubuquerenshijian"
                                    type="datetime"
                                    placeholder="选择日期时间">
                    </el-date-picker>
                </td>
            </tr>
        </tbody>
    </table>
    {{xuqiubumenComfirm}}
    <div style="display:flex;justify-content:space-between;">
        <el-button style="margin-left:0;" size="small" type="primary" v-on:click="goback">返回</el-button>
        <el-button size="small" v-show="showChangeBtn" type="success" v-on:click="saveChange">保存修改</el-button>
        <el-button size="small" v-show="showAddBtn" type="success" v-on:click="addNewForm">新建报修单</el-button>
    </div>
</div>

<script>
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]); return null;
    }
    let app = new Vue({
        el: "#app",
        data: {
            showChangeBtn:false,
            showAddBtn:false,
            selectTime: null,
            radio2:null,

            assetNumber: null,
            EquipmentName:null,
            guzhangtime: null,
            mergencyStatus: null,
            guzhangDiscri: null,
            repairWorker: null,
            repiarDate: null,
            jinglizhuguanOpinon: null,
            zhongxinpizhunDate:null,
            zhongxinzongjianOpinon: null,
            bumenpizhunate:null,
            jishubuOpinon: null,
            MEgivenOpinonDate: null,
            jinglizhuguanshenhe: null,
            jinglizhuguanshenheDate:null,
            zhongxinzongjianpizhun: null,
            zhongxinzongjianpizhunDate:null,
            jianliancaigoujianyi: null,
            caigoujianyiren:null,
            MEWorker: null,
            caigoujianyiDate: null,
            caogoushenheren: null,
            caigoushenheDate: null,
            caigoupizhunren: null,
            caigoupizhunriqi: null,
            weixiuDate: null,
            weixiuWorker: null,
            xuqiubumenWrite: null,
            jishubumenWrite: null,
            xuqiubumenComfirm: null,
            jishuubumenComfirm: null,
            xuqiubumenquerenren: null,
            xuqiubumenquerenDate: null,
            jishubuquerenren: null,
            jishubuquerenshijian:null,
            input: null,

            options: [{
                value: '批准',
                label: '批准'
            }, {
                value: '驳回',
                label: '驳回'
            }],
            value: ''
        },
        methods: {
            goback() {
                window.history.back();
            },
            saveChange() {
                axios.post("/Equipment/Modify_repairs", {
                    EquipmentNumber: this.assetNumber, EquipmentName: this.EquipmentName, FaultTime: this.guzhangtime, Emergency: this.mergencyStatus, FauDescription: this.guzhangDiscri, RepairName: this.repairWorker,
                    RepairDate: this.repiarDate, DeparAssessor: this.jinglizhuguanOpinon, DeparAssessedDate: this.bumenpizhunate, CenterApprove: this.zhongxinzongjianOpinon, CenterApprovedDate:this.zhongxinpizhunDate,
                    TecDepar_opinion: this.jishubuOpinon, MEName: this.MEWorker, MEDate: this.MEgivenOpinonDate, TecDeparAssessor: this.jinglizhuguanshenhe, TecDeparAssessedDate: this.jinglizhuguanshenheDate, CeApprove: this.zhongxinzongjianpizhun,
                    CeApprovedDate: this.zhongxinzongjianpizhunDate, Purchasing_opinion: this.jianliancaigoujianyi, OpinionName: this.caigoujianyiren, OpinionDate: this.caigoujianyiDate, OpinAssessor: this.caogoushenheren, OpinAssessedDate: this.caigoushenheDate,
                    OpinApprove: this.caigoupizhunren, OpinApprovedDate: this.caigoupizhunriqi, MaintenanceDate: this.weixiuDate, MainName: this.weixiuWorker, AfterMain: this.xuqiubumenWrite, RepairProblem: this.xuqiubumenComfirm,
                    ConfirmName: this.xuqiubumenquerenren, ConfirmDate: this.xuqiubumenquerenDate, TcAfterMin: this.jishubumenWrite, TcRepairProblem: this.jishuubumenComfirm, TcConfirmName: this.jishubuquerenren, TcConfirmDate: this.jishubuquerenshijian
                }).then(res=> {
                    console.log(res.data)
                    if (res.data == true) {
                        this.$message({
                            message: "保存成功！",
                            type: "success"
                        });
                        this.clearData();
                    } else {
                        this.$message({
                            message: "保存修改失败",
                            type: "warning"
                        })
                    }
                }).catch(err=> {
                    this.$message({
                        message: "连接失败",
                        type: "warning"
                    })
                })
            },

            // 定义一个清空数据的方法
            clearData() {
                this.guzhangtime = null;
                this.mergencyStatus = null;
                this.guzhangDiscri = null
                this.repairWorker = null
                this.repiarDate = null;   // 维修日期
                this.jinglizhuguanOpinon = null;
                this.zhongxinpizhunDate = null;
                this.zhongxinzongjianOpinon = null;
                this.bumenpizhunate = null;
                this.jishubuOpinon = null;
                this.MEWorker = null;
                this.MEgivenOpinonDate = null;
                this.jinglizhuguanshenhe = null;
                this.jinglizhuguanshenheDate = null;
                this.zhongxinzongjianpizhun = null;
                this.zhongxinzongjianpizhunDate = null;
                this.jianliancaigoujianyi = null;
                this.caigoujianyiren = null;
                this.caigoujianyiDate = null;
                this.caogoushenheren = null
                this.caigoushenheDate = null
                this.caigoupizhunren = null
                this.caigoupizhunriqi = null
                this.weixiuDate = null
                this.weixiuWorker = null
                this.xuqiubumenWrite = null
                this.jishubumenWrite = null
                this.xuqiubumenComfirm = null
                this.jishuubumenComfirm = null
                this.xuqiubumenquerenren = null
                this.xuqiubumenquerenDate = null
                this.jishubuquerenren = null
                this.jishubuquerenshijian = null
            },
            //新建报修单
            addNewForm() {
                axios.post("/Equipment/ADDmaintenance", {
                    EquipmentNumber: this.assetNumber, EquipmentName: this.EquipmentName, FaultTime: this.guzhangtime, Emergency: this.mergencyStatus, FauDescription: this.guzhangDiscri, RepairName: this.repairWorker,
                    RepairDate: this.repiarDate, DeparAssessor: this.jinglizhuguanOpinon, DeparAssessedDate: this.bumenpizhunate, CenterApprove: this.zhongxinzongjianOpinon, CenterApprovedDate: this.zhongxinpizhunDate,
                    TecDepar_opinion: this.jishubuOpinon, MEName: this.MEWorker, MEDate: this.MEgivenOpinonDate, TecDeparAssessor: this.jinglizhuguanshenhe, TecDeparAssessedDate: this.jinglizhuguanshenheDate, CeApprove: this.zhongxinzongjianpizhun,
                    CeApprovedDate: this.zhongxinzongjianpizhunDate, Purchasing_opinion: this.jianliancaigoujianyi, OpinionName: this.caigoujianyiren, OpinionDate: this.caigoujianyiDate, OpinAssessor: this.caogoushenheren, OpinAssessedDate: this.caigoushenheDate,
                    OpinApprove: this.caigoupizhunren, OpinApprovedDate: this.caigoupizhunriqi, MaintenanceDate: this.weixiuDate, MainName: this.weixiuWorker, AfterMain: this.xuqiubumenWrite, RepairProblem: this.xuqiubumenComfirm,
                    ConfirmName: this.xuqiubumenquerenren, ConfirmDate: this.xuqiubumenquerenDate, TcAfterMin: this.jishubumenWrite, TcRepairProblem: this.jishuubumenComfirm, TcConfirmName: this.jishubuquerenren, TcConfirmDate: this.jishubuquerenshijian
                }).then(res=> {
                    if (res.data==true) {
                        this.$message({
                            message: "新增设备报修单成功",
                            type: "success"
                        });
                        this.clearData();
                    } else {
                        this.$message({
                            message: res.data,
                            type: "warning"
                        })
                    }
                }).catch(err=> {
                    this.$message({
                        message: "新建报修单时连接失败",
                        type: "warning"
                    })
                })
            }
        },
        mounted() {
            this.assetNumber = getUrlParam('num');
            if (this.guzhangtime == null) {
                this.showAddBtn = true;
            }
        },
        watch: {
            // 根据资产编号获取设备的信息
            assetNumber() {
                if (this.assetNumber != null) {
                    axios.post("/Equipment/Particulars", { assetnumber: this.assetNumber }).then(res=> {
                        console.log(res.data)
                        this.EquipmentName = res.data[0].EquipmentName
                        this.$message({
                            message: "获取设备详细成功",
                            type: "success"
                        });

                    }).catch(err=> {
                        this.$message({
                            message: "获取设备详细失败",
                            type:"warning"
                        })
                    })
                }
            },
            //选择框时间改变则请求对应报修单数据
            guzhangtime() {
                if (this.guzhangtime != null) {
                    //let dd = new Date(this.selectTime);
                    axios.post("/Equipment/Reveal_Equipment", { equnumber: this.assetNumber, equipname: this.EquipmentName, date: this.guzhangtime }).then(res=> {
                        console.log(res.data)
                        if (res.data.length > 0) {
                            this.showChangeBtn = true;
                            this.showAddBtn = false;
                            //赋值
                            this.mergencyStatus = res.data[0].Emergency;
                            this.guzhangDiscri = res.data[0].FauDescription;
                            this.repairWorker = res.data[0].RepairName;
                            this.repiarDate = res.data[0].RepairDate;   // 维修日期
                            this.jinglizhuguanOpinon = res.data[0].DeparAssessor;
                            this.zhongxinpizhunDate = res.data[0].CenterApprovedDate;
                            this.zhongxinzongjianOpinon = res.data[0].CenterApprove;
                            this.bumenpizhunate = res.data[0].DeparAssessedDate;
                            this.jishubuOpinon = res.data[0].TecDepar_opinion;
                            this.MEWorker = res.data[0].MEName;
                            this.MEgivenOpinonDate = res.data[0].MEDate;
                            this.jinglizhuguanshenhe = res.data[0].TecDeparAssessor;
                            this.jinglizhuguanshenheDate = res.data[0].TecDeparAssessedDate;
                            this.zhongxinzongjianpizhun = res.data[0].CeApprovedDate;
                            this.zhongxinzongjianpizhunDate = res.data[0].Purchasing_opinion;
                            this.jianliancaigoujianyi = res.data[0].Purchasing_opinion;
                            this.caigoujianyiren = res.data[0].OpinionName;
                            this.caigoujianyiDate = res.data[0].OpinionDate;
                            this.caogoushenheren = res.data[0].OpinAssessor;
                            this.caigoushenheDate = res.data[0].OpinAssessedDate;
                            this.caigoupizhunren = res.data[0].OpinApprove;
                            this.caigoupizhunriqi = res.data[0].OpinApprovedDate;
                            this.weixiuDate = res.data[0].MaintenanceDate;
                            this.weixiuWorker = res.data[0].MainName;
                            this.xuqiubumenWrite = res.data[0].AfterMain;
                            this.jishubumenWrite = res.data[0].TcAfterMin;
                            this.xuqiubumenComfirm = res.data[0].RepairProblem;
                            this.jishuubumenComfirm = res.data[0].TcRepairProblem;
                            this.xuqiubumenquerenren = res.data[0].ConfirmName;
                            this.xuqiubumenquerenDate = res.data[0].ConfirmDate;
                            this.jishubuquerenren = res.data[0].TcConfirmName;
                            this.jishubuquerenshijian = res.data[0].TcConfirmDate;
                        } else {
                            this.$message({
                                message: "没有对应数据",
                                type: "warning"
                            });
                            this.clearData();
                        };

                        
                    }).catch(err=> {
                        this.$message({
                            message: "获取报修单信息失败",
                            type: "warning"
                        })
                    })
                } else {
                    this.showAddBtn = true;
                    this.showChangeBtn = false;
                    this.clearData();
                }
            },
        }
    })
</script>