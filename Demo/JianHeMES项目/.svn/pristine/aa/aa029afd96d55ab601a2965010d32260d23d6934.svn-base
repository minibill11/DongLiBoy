
<script type="text/template" id="KPI_Inspection_Input_Component">
    <el-row>
        <el-row class="table-top">
            <div class="table-top-left">
                <el-input v-model="pasteExcel" placeholder="表格粘贴处" type="textarea" resize="none" rows="1" size="medium"></el-input>
            </div>
            <div class="table-top-right">
                <el-date-picker v-model="changeAllTime"
                                type="date"
                                size="medium"
                                placeholder="选择时间">
                </el-date-picker>
            </div>
        </el-row>
        <el-row class="table-mid">
            <el-table :data="tableList"
                      @*row-class-name="zero-padding"*@
                      max-height="600"
                      size="medium"
                      border>
                <el-table-column type="index" label="序号" width="50"></el-table-column>
                <el-table-column label="订单" min-width="120">
                    <template slot-scope="scope">
                        <el-input v-model.trim="scope.row.OrderNum" size="mini"></el-input>
                    </template>
                </el-table-column>
                <el-table-column label="部门" min-width="110">
                    <template slot-scope="scope">
                        <el-input v-model.trim="scope.row.Department" size="mini"></el-input>
                    </template>
                </el-table-column>
                <el-table-column label="班组" min-width="110">
                    <template slot-scope="scope">
                        <el-input v-model.trim="scope.row.Group" size="mini"></el-input>
                    </template>
                </el-table-column>
                <el-table-column label="工段" min-width="110">
                    <template slot-scope="scope">
                        <el-input v-model.trim="scope.row.Section" size="mini"></el-input>
                    </template>
                </el-table-column>
                <el-table-column label="工序" min-width="110">
                    <template slot-scope="scope">
                        <el-input v-model.trim="scope.row.Process" size="mini"></el-input>
                    </template>
                </el-table-column>
                <el-table-column label="品质/效率" min-width="100">
                    <template slot-scope="scope">
                        <el-select v-model="scope.row.IndicatorsType" size="mini">
                            <el-option label="品质" value="品质"></el-option>
                            <el-option label="效率" value="效率"></el-option>
                        </el-select>
                    </template>
                </el-table-column>
                <el-table-column label="正常数量" min-width="120">
                    <template slot-scope="scope">
                        <el-input-number v-model="scope.row.ActualNormalNum"
                                         :min="0"
                                         controls-position="right"
                                         size="mini"
                                         style="width:auto"></el-input-number>
                    </template>
                </el-table-column>
                <el-table-column label="异常数量" min-width="120">
                    <template slot-scope="scope">
                        <el-input-number v-model="scope.row.ActualAbnormalNum"
                                         :min="0"
                                         controls-position="right"
                                         size="mini"
                                         style="width:auto"></el-input-number>
                    </template>
                </el-table-column>
                <el-table-column label="时间" min-width="140">
                    <template slot-scope="scope">
                        <el-date-picker v-model="scope.row.ActualTime"
                                        type="date"
                                        size="mini"
                                        placeholder="选择时间">
                        </el-date-picker>
                    </template>
                </el-table-column>
                <el-table-column label="操作" width="50">
                    <template slot-scope="scope">
                        <el-button @@click="deleteClick(scope.$index)" class="cbtn red" type="text">清除</el-button>
                    </template>
                </el-table-column>
            </el-table>
        </el-row>
        <el-row class="table-bottom">
            <div class="table-bottom-left">
                <el-button type="primary" @@click="onInputSubmit" size="medium">录入</el-button>
                <el-button @@click="showChange" size="medium">取消</el-button>
            </div>
            <div class="table-bottom-right">
                <el-button @@click="addRowVisible = true" class="addbtn" type="info" size="medium" plain>增加一行</el-button>
            </div>
        </el-row>
        <el-row>
            <el-dialog title="计划信息录入"
                       @@close="close('ruleForm')"
                       :visible.sync="addRowVisible">
                <el-form label-width="30%"
                         label-position="right"
                         class="addRowDia"
                         ref="ruleForm"
                         size="medium"
                         :rules="rules"
                         :model="addRowForm">
                    <el-form-item label="订单" prop="OrderNum">
                        <el-select v-model="addRowForm.OrderNum"
                                   placeholder="请选择订单"
                                   filterable
                                   clearable>
                            <el-option v-for="item in ordernumlist"
                                       :key="item.value"
                                       :label="item.value"
                                       :value="item.value">
                            </el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="部门" prop="Department">
                        <el-select v-model="addRowForm.Department"
                                   placeholder="请选择部门"
                                   filterable
                                   clearable>
                            <el-option v-for="item in departmentlist"
                                       :key="item.value"
                                       :label="item.value"
                                       :value="item.value">
                            </el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="班组" prop="Group">
                        <el-select v-model="addRowForm.Group"
                                   placeholder="请选择班组"
                                   filterable
                                   clearable>
                            <el-option v-for="item in grouplist"
                                       :key="item.value"
                                       :label="item.value"
                                       :value="item.value">
                            </el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="工段" prop="Section">
                        <el-select v-model="addRowForm.Section"
                                   placeholder="请选择工段"
                                   @@change="getProcess"
                                   filterable
                                   clearable>
                            <el-option v-for="item in sectionlist"
                                       :key="item.value"
                                       :label="item.value"
                                       :value="item.value">
                            </el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="工序" prop="Process">
                        <el-select v-model="addRowForm.Process"
                                   placeholder="请选择工序"
                                   filterable
                                   clearable>
                            <el-option v-for="item in processlist"
                                       :key="item.value"
                                       :label="item.value"
                                       :value="item.value">
                            </el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="品质/效率" prop="IndicatorsType">
                        <el-select v-model="addRowForm.IndicatorsType">
                            <el-option label="品质" value="品质"></el-option>
                            <el-option label="效率" value="效率"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="正常数量" prop="ActualNormalNum">
                        <el-input-number v-model="addRowForm.ActualNormalNum"
                                         :min="0"
                                         style="width:auto"></el-input-number>
                    </el-form-item>
                    <el-form-item label="异常数量" prop="ActualAbnormalNum">
                        <el-input-number v-model="addRowForm.ActualAbnormalNum"
                                         :min="0"
                                         style="width:auto"></el-input-number>
                    </el-form-item>
                    <el-form-item label="时间" prop="ActualTime">
                        <el-date-picker v-model="addRowForm.ActualTime"
                                        type="date"
                                        placeholder="选择日期时间">
                        </el-date-picker>
                    </el-form-item>
                    <el-form-item>
                        <el-button @@click="addRowVisible = false">取 消</el-button>
                        <el-button type="primary" @@click="submitForm('ruleForm')">确 定</el-button>
                    </el-form-item>
                </el-form>
            </el-dialog>
        </el-row>
    </el-row>
</script>
<script>
    Vue.component('kpi-inspection-input-component', {
        props: ['ordernumlist', 'departmentlist', 'grouplist', 'sectionlist', 'processlist'],
        template: document.getElementById("KPI_Inspection_Input_Component"),
        data: function () {
            return {
                pasteExcel: '',
                tableList: [],
                addRowForm: {
                    OrderNum: '',
                    Department: '',
                    Group: '',
                    Section: '',
                    Process: '',
                    IndicatorsType: '',
                    ActualNormalNum: '',
                    ActualAbnormalNum: '',
                    ActualTime: null,
                },
                addRowVisible: false,
                rules: {},
                changeAllTime: null
            }
        },
        mounted: function () {
            const stringTest = [{ required: true, message: '不能为空', trigger: 'blur' }],
                changeTest = [{ required: true, message: '不能为空', trigger: 'change' }],
                numberTest = [
                    { required: true, message: '数量不能为空', trigger: 'blur' },
                    { type: 'number', message: '必须为数字值' }
                ];
            this.rules = {
                OrderNum: changeTest,
                Department: changeTest,
                Group: changeTest,
                Section: changeTest,
                Process: changeTest,
                IndicatorsType: changeTest,
                ActualNormalNum: numberTest,
                ActualAbnormalNum: numberTest,
                ActualTime: changeTest,
            };
        },
        methods: {
            onInputSubmit() {
                vm.mainLoading = true;
                if (!this.checkData()) {
                    vm.mainLoading = false;
                    return;
                };
                axios.post("/KPI/AddActualRecord", { actualRecord: this.tableList }).then(res => {
                    if (res.data == '新增成功') {
                        setTimeout(() => {
                            this.$emit("input", true);
                            this.$message.success('录入成功');
                            this.tableList = [];
                            vm.mainLoading = false;
                        }, 500);
                    } else {
                        this.$alert(res.data, {
                            closeOnClickModal: true,
                            closeOnPressEscape: true,
                            type: "error",
                        });
                        vm.mainLoading = false;
                    };
                }).catch(err => {
                    console.warn(err);
                    vm.mainLoading = false;
                });
            },
            //检查数据
            checkData() {
                for (let row of this.tableList) {
                    for (let [key, value] of Object.entries(row)) {
                        if ((key != 'ActualNormalNum' && key != 'ActualAbnormalNum') && (value == '' || value == null)) {
                            this.$message.warning('数据不完整,请检查数据是否为空');
                            return false;
                        };
                    };
                };
                return true;
            },
            showChange() {
                vm.mainLoading = true;
                setTimeout(() => {
                    this.tableList = [];
                    this.$emit("input", true);
                    vm.mainLoading = false;
                }, 500);
            },
            //删除
            deleteClick(index) {
                this.tableList.splice(index, 1);
            },
            //关闭模态框
            close(formName) {
                this.$refs[formName].resetFields();
            },
            //验证值
            submitForm(formName) {
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        this.tableList.push({ ...this.addRowForm });
                        this.addRowVisible = false;
                    } else {
                        console.log('error submit!!');
                        return false;
                    };
                });
            },
            getProcess(v) {
                vm.GetProcessList(v);
            }
        },
        watch: {
            pasteExcel(val) {
                if (val == '') {
                    return false;
                };
                this.tableList = [];
                let rows = val.split('\n');
                rows.pop();
                rows.forEach((v, i) => {
                    let col = v.split("\t")
                    rows[i] = col;
                });
                for (let i of rows) {
                    this.tableList.push({
                        OrderNum: i[0],
                        Department: i[1],
                        Group: i[2],
                        Section: i[3],
                        Process: i[4],
                        IndicatorsType: i[5],
                        ActualNormalNum: i[6],
                        ActualAbnormalNum: i[7],
                        ActualTime: i[8],
                    });
                };
                this.pasteExcel = '';
            },
            changeAllTime(v) {
                for (let i of this.tableList) {
                    i.ActualTime = v;
                };
            }
        },
    });
</script>