@model IEnumerable<JianHeMES.Models.Warehouse_Material_BaseInfo>

@{
    ViewBag.Title = "查看物料基本信息";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Content/styleFile/packaging/index.css" rel="stylesheet" />
<script src="~/Content/styleFile/packaging/index.js"></script>
<script src="~/Scripts/axios.min.js"></script>
<style>
    .table .cell, .el-table th, .el-table td {
        text-align: center;
        padding: 8px;
    }

    .el-upload__input {
        display: none !important;
    }
    .spcolor {
        color: darkturquoise
    }
</style>
<div id="app">
    <el-header style="text-align: center;">
        <h3>@ViewBag.Title</h3>
        <a href="/Packagings/SPC_Addbasic_information"><el-button size="small" class="cret" type="primary" plain>物料基本信息录入</el-button></a>&nbsp;&nbsp;
        <a href="/Packagings/SPC_Packaging" style="margin-left:2px"><el-button size="small" type="primary" plain>录入包装信息</el-button></a>&nbsp;&nbsp;
        <a href="/Packagings/SPC_Packaging_Modify"><el-button size="small" class="cret" type="primary" plain>修改包装信息</el-button></a>

    </el-header>
    <el-main>
        <div style="width:1081px;margin: 0 auto;">
            <div style="margin-bottom: 5px;text-align: center;">
                <el-input size="small" style="width: 180px;" clearable v-model="materialCode" placeholder="请输入物料条码"></el-input>
                <el-input size="small" style="width: 180px;" v-model="materialName" placeholder="请输入物料名"></el-input>
                <el-button size="mini" type="primary" v-on:click="selectInfor">查询</el-button>
            </div>
            <el-table border v-bind:data="tableData">
                <el-table-column prop="MaterialNumber" label="物料编码" width="120"></el-table-column>
                <el-table-column prop="Specifications" label="规格描述" width="210">
                    <template slot-scope="scope">
                        <span class="spcolor" type="text" size="middle" v-on:click="process(scope.row)">{{scope.row.Specifications}}</span>
                    </template>
                </el-table-column>
                <el-table-column prop="" label="产品图片" width="500">
                    <template slot-scope="scope">
                        <div style="display: inline;">
                            <el-image v-for="url in imimgurl"
                                      :key="url"
                                      :preview-src-list="imimgurl"
                                      :src="url" style="width:130px;height:120px;margin:2px" lazy>
                            </el-image>
                            <el-button size="mini" type="primary" style="margin-top: 2px;" v-on:click="shangchuang(1,scope.row)">上传照片</el-button>
                        </div>
                    </template>
                </el-table-column>
                <el-table-column prop="" label="图纸" width="250">
                    <template slot-scope="scope">
                        <div style="display: inline;">
                            <el-image v-for="url in imimgur2"
                                      :key="url"
                                      :preview-src-list="imimgur2"
                                      :src="url" style="width:220px;height:180px;margin:2px" lazy>
                            </el-image>
                            <el-button size="mini" type="primary" style="margin-top: 2px;" v-on:click="shangchuang(2,scope.row)">上传图纸</el-button>
                        </div>
                    </template>
                </el-table-column>
            </el-table>
        </div>
    </el-main>

    <!--上传照片-->
    <el-dialog v-bind:visible.sync="dialogVisible" width="500px">
        <div>
            <el-form model="uploadForm" ref="numberValidateForm" label-width="100px" class="demo-ruleForm">
                <el-form-item label="物料编码">
                    <el-input type="" v-model="mCode"></el-input>
                </el-form-item>
                <el-form-item label="上传照片">
                    <el-upload action="/Packagings/UploadFile_Ingredients"
                               v-bind:on-change="selectFile"
                               accept=".jpg,.pdf"
                               v-bind:on-remove="handleRemove"
                               v-bind:file-list="fileList" v-bind:auto-upload="false">
                        <el-button slot="trigger" size="small" type="primary">选取文件</el-button>
                    </el-upload>
                </el-form-item>
            </el-form>
        </div>
        <span slot="footer" class="dialog-footer">
            <el-button v-on:click="dialogVisible = false">取 消</el-button>
            <el-button type="primary" v-on:click="uploadFile">确定上传</el-button>
        </span>
    </el-dialog>

    <el-dialog v-bind:visible.sync="dialogVisible1" width="600px">
        <div>
            <el-form model="uploadForm" ref="numberValidateForm" label-width="100px" class="demo-ruleForm">
                <el-form-item label="规格描述">
                    <textarea v-model="ChangeSpecifications"  style="width:600px;height:150px;max-height:400px;"></textarea>
                </el-form-item>               
            </el-form>
        </div>
        <span slot="footer" class="dialog-footer">
            <el-button v-on:click="dialogVisible1 = false">取 消</el-button>
            <el-button type="primary" v-on:click="saveSpecifications">保存</el-button>
        </span>
    </el-dialog>

</div>
<script>
    var app = new Vue({
        el: '#app',
        data: {
            materialCode: '',      //物料条码
            materialName: '',     //物料名
            mCode: '',           //弹框物料编码
            pType: '',           //照片类型
            dialogVisible: false,
            dialogVisible1: false,
            fileList: [],         //照片list
            file1: [],          //存储选中的照片
            filename: [],
            imimgurl: [],
            imimgur2:[],
            tableData: [],
            ChangeSpecifications:'',

        },
        methods: {
            process(item) {
                this.dialogVisible1 = true
                this.ChangeSpecifications = item.Specifications
                
            },
            saveSpecifications() {
                axios.post("/Packagings/SPC_Addbasic_information_Modify", {
                    inputList_modify: this.ChangeSpecifications
                })

            },
            shangchuang(val,row) {
                if (val == 1) {                   
                    this.dialogVisible = true
                    this.file1 = fileList = [];
                    this.filename = [];
                    this.pType = "Picture"  
                    let str = JSON.stringify(row.MaterialNumber)
                    let str1 = str.replace("\"", "").replace("\"", "");
                    this.mCode = str1                  
                } else {
                    this.dialogVisible = true
                    this.file1 = fileList = [];
                    this.filename = [];
                    this.pType = "Draw"
                    let str = JSON.stringify(row.MaterialNumber)
                    let str1 = str.replace("\"", "").replace("\"", "");
                    this.mCode = str1 
                }
                
                $('ul').empty();            
            },
            //查询数据方法
            selectInfor() {
                this.tableData = [];
                if (this.materialCode != '' || this.materialName != '') {
                    axios.post("/Packagings/SPC_Display", {
                        materialNumber: this.materialCode,
                        specifications: this.materialName
                    }).then(res => {
                        this.imimgurl = res.data.picture
                        this.imimgur2 = res.data.draw
                        console.log(res.data)
                        this.tableData.push(res.data.mes)
                        //this.tableData.push(res.data.picture)
                        //this.tableData.push(res.data.draw)
                        console.log(this.tableData)
                    }).catch(err => {
                        console.log("请求失败")
                    })
                }
            },
            //移除照片方法
            handleRemove(file, fileList) {
                for (let i in this.file1) {
                    if (this.file1[i].uid == file.uid) {
                        this.file1.splice(i, 1)                        
                    }
                }
                for (let i in this.filename) {
                    console.log()
                    if (this.filename[i] == file.name) {
                        this.filename.splice(i, 1)
                        console.log(this.filename)
                    }
                }
            },
            uploadFile() {                
                let fd = new FormData();
                fd.append('pictureType', this.pType)
                fd.append('MaterialNumber', this.mCode)
                this.filename.forEach(file => { fd.append("pictureFile", file);})
                ii = 0;
                this.file1.forEach(item => {fd.append("UploadFile_Ingredients" + ii, item); ii++; })
                axios.post("/Packagings/UploadFile_Ingredients", fd).then(res => {
                    if (res.data == 'True') {
                        this.$message({
                            message: '文件上传成功！',
                            type: 'success'
                        });
                        this.dialogVisible = false
                        this.file1 = fileList = filename = [];
                    } else {
                        this.$message({
                            message: '连接出错',
                            type: 'warning'
                        });
                        this.dialogVisible = false
                    }
                })
            },
            //选取照片方法
            selectFile(file, fileList) {
                this.file1.push(file.raw)
                this.filename.push(file.name)                
            },
        },
        watch:{
            materialCode() {
                if (this.materialCode == '' || this.tableData==null) {
                    this.tableData =[]
                }
            }
        }

    })

</script>