
@{
    ViewBag.Title = "设备报修单查询";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Scripts/Bootstraps/Element-ui.css" rel="stylesheet" />
<script src="~/Scripts/axios.min.js"></script>
<script src="~/Scripts/Bootstraps/Element-ui.js"></script>
<script src="~/Content/styleFile/solder/solderJavascript.js"></script>
<h4 style="text-align:center;margin-top:15px;margin-bottom:5px;font-size:21px;">仪器设备报修单</h4>
<style>
    .topContainer{
        display:flex;
        justify-content:flex-start;
    }
    .topContainer div{
        /*width:88%;*/
    }
    .el-date-editor.el-input{
        width:122px;
    }
</style>
<div id="app">
    @* 导航按钮 *@
    <p style="display:flex;justify-content:center;margin-top:10px;">
        <a class="shebeitaizhang" href="/Equipment/First_equipment"><el-button type="primary" size="mini" plain>设备台账</el-button></a>
        <a class="chechTimePlan" href="/Equipment/Equipment_MonthlyMaintenance_plan"><el-button type="primary" size="mini" plain>月保养计划</el-button></a>
        <a class="checkTally" href="/Equipment/Equipment_Tally"><el-button type="primary" size="mini" plain>点检表记录表</el-button></a>
        <a class="checkRepiabill" href="/Equipment/EquipmentRepairbill_Query"><el-button type="primary" size="mini" plain>仪器设备报修单</el-button></a>
        <a class="checkRepiabill" href="/Equipment/Equipment_safety"><el-button type="primary" size="mini" plain>安全库存清单</el-button></a>
        <a class="targetSumary" href="/Equipment/Equipment_Quality_target"><el-button type="primary" size="mini" plain>指标达成率</el-button></a>
    </p>
    <div class="topContainer">
        @* 查询选择 *@
        <div>
            <el-select v-model="ENunber" size="mini" clearable filterable placeholder="请选择设备编号">
                <el-option v-for="item in options"
                           v-bind:key="item.value"
                           v-bind:label="item.label"
                           v-bind:value="item.value">
                </el-option>
            </el-select>
        </div>
        <div>
            <el-select v-model="userdepart" size="mini" clearable filterable placeholder="请选择使用部门">
                <el-option v-for="item in deparlist"
                           v-bind:key="item.value"
                           v-bind:label="item.label"
                           v-bind:value="item.value">
                </el-option>
            </el-select>
        </div>
        <div>
            <el-input v-model="EName" size="mini" placeholder="设备名称"></el-input>
        </div>
        <div>
            <el-date-picker v-model="fualtTime"
                            type="date"
                            v-bind:disabled="fualtTimeFlag"
                            size="mini"
                            placeholder="故障日期">
            </el-date-picker>
        </div>
        <div>
            <el-date-picker v-model="TimeRange"
                            type="daterange"
                            size="mini"
                            v-bind:disabled="fualtTimeRangeFlag"
                            range-separator="至"
                            start-placeholder="开始日期"
                            end-placeholder="结束日期">
            </el-date-picker>
        </div>
        <div>
            <el-date-picker v-model="yearSamry"
                            align="right"
                            size="mini"
                            type="year"
                            v-bind:disabled="yearSamryFlag"
                            placeholder="选择年">
            </el-date-picker>
        </div>
        <div>
            <el-select v-model="monthSamry" size="mini" v-bind:disabled="monthSamryFlag" clearable filterable placeholder="请选择月">
                <el-option v-for="item in 12"
                           v-bind:key="item"
                           v-bind:label="item"
                           v-bind:value="item">
                </el-option>
            </el-select>
        </div>
        <el-button id="search" type="success" size="mini" v-on:click="query">查询</el-button>
    </div>
    @* 查询结果表格 *@
    <div class="bottomContainer">
        <el-table v-bind:data="tableData"
                  height="600"
                  style="width: 100%">
            <el-table-column prop="EquipmentNumber"
                             label="设备编号"
                             sortable
                             width="180">
            </el-table-column>
            <el-table-column prop="EquipmentName"
                             label="设备名称"
                             sortable
                             width="180">
            </el-table-column>
            <el-table-column prop="FaultTime"
                             label="故障时间">
            </el-table-column>
            <el-table-column prop="Emergency"
                             label="紧急状态">
            </el-table-column>
            <el-table-column label="操作">
                <template slot-scope="scope">
                    @*<el-button type="primary" size="small" v-on:click="showDetials(scope.row,scope.$index)">详细</el-button>*@
                    <a v-bind:href=`/Equipment/EquipmentRepairbill?num=${scope.row.EquipmentNumber}&time=${timeformats(scope.row.FaultTime)}&canchange=false` target="_blank">
                        <el-button type="primary" size="small" >详细</el-button>
                    </a>
                    @*<el-button type="success" size="small" v-on:click="changeInfos(scope.row,scope.$index)">修改</el-button>*@
                </template>
            </el-table-column>
        </el-table>
    </div>
</div>

<script>
    // 监听回车事件
    document.onkeydown = function (event) {
        var e = event || window.event;    // 兼容IE
        if (e && e.keyCode == 13) { //回车键的键值为13
            $("#search").click();
        }
    };
    // 返回首页
    function goback() {
        window.location.href = "/Equipment/index"
    }
    // 时间过滤器  年月日
    function getTime(val){
        let dd = new Date(val);
        let year = dd.getFullYear();
        let month = (dd.getMonth() + 1).toString().padStart(2, 0);
        let days = dd.getDate().toString().padStart(2, 0);
        return `${year}年${month}月${days}日`
    }
    let app = new Vue({
        el: "#app",
        data: {
            EName: null,
            ENunber: null,
            fualtTime: null,
            TimeRange: null,
            userdepart:null,
            options: [],
            fualtTimeFlag: false,
            fualtTimeRangeFlag: false,
            yearSamryFlag: false,
            monthSamryFlag:false,
            tableData: [],
            deparlist: [],
            yearSamry: null,
            monthSamry:null
        },
        methods: {
            // 时间过滤器  拼串
            timeformats(val){
                let timedata = val.match(/\d+/g);
                let faultime = `${timedata[0]}-${timedata[1]}-${timedata[2]}`
                return faultime
            },
            // 查询
            query() {
                if (this.EName != null || this.ENunber != null || this.fualtTime != null || this.TimeRange != null || this.userdepart != null || this.yearSamry != null || (this.monthSamry != null && this.monthSamry != '')) {
                    let year = null
                    if(this.yearSamry!=null){
                        let dd = new Date(this.yearSamry)
                        year = dd.getFullYear()
                    }
                    axios.post("/Equipment/EquipmentRepairbill_Query", { month: this.monthSamry, year: year, userdepartment: this.userdepart, equnumber: this.ENunber, equipname: this.EName, date: this.fualtTime, starttime: this.TimeRange != null ? this.TimeRange[0] : null, endtime: this.TimeRange != null ? this.TimeRange[1] : null }).then(res=> {
                        console.log(res.data)
                        if(res.data.length>0){
                            res.data.forEach(item=> {
                            item.FaultTime = getTime(item.FaultTime)
                        })
                            this.tableData = res.data
                        } else {
                            this.$message({
                                message: "查无对应数据",
                                type: "warning"
                            })
                        }
                    }).catch(err=> {
                        this.$message({
                            message: "查询失败",
                            type: "warning"
                        })
                    })
                } else {
                    this.$message({
                        message: "请补全需要查询的信息",
                        type: "warning"
                    });
                }
            },
            // 详细按钮跳转传参
            showDetials(item, index) {
                let timedata = item.FaultTime.match(/\d+/g);
                let faultime = `${timedata[0]}-${timedata[1]}-${timedata[2]}`
                window.location.href = "/Equipment/EquipmentRepairbill?" + "num=" + item.EquipmentNumber + "&time=" + faultime + "&canchange=false";
            },
            // 修改按钮跳转传参
            changeInfos(item, index) {
                let timedata = item.FaultTime.match(/\d+/g);
                let faultime = `${timedata[0]}-${timedata[1]}-${timedata[2]}`
                window.location.href = "/Equipment/EquipmentRepairbill?" + "num=" + item.EquipmentNumber + "&time=" + faultime + "&canchange=true";
            }
        },
        mounted() {
            // 页面加载时获取所有可选设备编号列表以及使用部门列表
            axios.post("/Equipment/InstrumentList").then(res=> {
                res.data.forEach(item=> {
                    let obj = { value: item, label: item };
                    this.options.push(obj)
                })
            }).catch(err=> {
                this.$message({
                    message: "获取设备编号列表失败",
                    type: "warning"
                })
            });
            axios.post("/Equipment/Deparlist").then(res=> {
                res.data.forEach(item=> {
                    let obj = { value: item, label: item };
                    this.deparlist.push(obj)
                })
            }).catch(err=> {
                this.$message({
                    message: "获取设备使用部门列表失败",
                    type: "warning"
                })
            });

        },
        watch: {
            // 监听故障时间
            fualtTime() {
                if (this.fualtTime != null) {
                    this.fualtTimeRangeFlag = true;
                    this.yearSamryFlag = true
                    this.monthSamryFlag = true
                } else {
                    this.fualtTimeRangeFlag = false;
                    this.yearSamryFlag = false
                    this.monthSamryFlag = false
                }
            },
            //监听所选时间段
            TimeRange() {
                if (this.TimeRange != null) {
                    this.fualtTimeFlag = true;
                    this.yearSamryFlag = true
                    this.monthSamryFlag = true
                } else {
                    this.fualtTimeFlag = false;
                    this.yearSamryFlag = false
                    this.monthSamryFlag = false

                }
            },
            // 监听年
            yearSamry() {
                if (this.yearSamry != null) {
                    this.fualtTimeRangeFlag = true;
                    this.fualtTimeFlag = true;
                    //this.monthSamryFlag = true
                } else {
                    this.fualtTimeRangeFlag = false;
                    this.fualtTimeFlag = false;
                    //this.monthSamryFlag = false
                }
            },
            // 监听月
            monthSamry() {
                if (this.monthSamry != null && this.monthSamry != '') {
                    this.fualtTimeRangeFlag = true;
                    //this.yearSamryFlag = true
                    this.fualtTimeFlag = true;
                } else {
                    this.fualtTimeRangeFlag = false;
                    //this.yearSamryFlag = false
                    this.fualtTimeFlag = false;
                }
            }

        }
    })
</script>
