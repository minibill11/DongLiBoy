@{
    ViewBag.Title = "打印条码测试";
    Layout = "~/Views/Shared/_Layout2.cshtml";
}
@* css放置处 *@
@section cssStyle {

}

<div id="app">
    <el-button @@click="onPrint" type="primary" size="small">打印条形码</el-button>
    @*<canvas id="barcode"></canvas>*@
    <div id="printArea">
        <div v-for="(item,index) in codelist">
            <div>
                <div>{{item.num}}</div>
                <img :id="item.id" />
                @*<canvas :id="item.id"></canvas>*@
                <div>{{item.str}}</div>
            </div>
        </div>
    </div>
</div>
@* 分部页放置处 *@
@section renderPage {
}
@* js放置处 *@
@section jsScript {
    <script src="~/Scripts/printJS/jquery-2.1.0.js"></script>
    <script src="~/Scripts/printJS/jquery.PrintArea.js"></script>
    <script src="~/Scripts/printJS/jquery-barcode.min.js"></script>
    <script src="~/Scripts/printJS/JsBarcode.all.min.js"></script>
    <script src="~/Scripts/printJS/LodopFuncs.js"></script>
    <script>
        const app = {
            data: function () {
                return {
                    codelist: [
                        {
                            id: 'barcode0',
                            proportion:'1:1',
                            num: "220050180-200710-00001",
                            str: "联建视频控制器，LCTRL1600.内含某某控制器嵌入式软件",
                        }, {
                            id: 'barcode1',
                            proportion: '1:1',
                            num: "220050180-200710-00002",
                            str: "联建视频控制器，LCTRL1600.内含某某控制器嵌入式软件",
                        }, {
                            id: 'barcode2',
                            proportion: '1:1',
                            num: "220050180-200710-00003",
                            str: "联建视频控制器，LCTRL1600.内含某某控制器嵌入式软件",
                        }, {
                            id: 'barcode3',
                            proportion: '1:1',
                            num: "220050180-200710-00004",
                            str: "联建视频控制器，LCTRL1600.内含某某控制器嵌入式软件",
                        }, {
                            id: 'barcode4',
                            proportion: '1:1',
                            num: "220050180-200710-00005",
                            str: "联建视频控制器，LCTRL1600.内含某某控制器嵌入式软件",
                        }, {
                            id: 'barcode5',
                            proportion: '1:1',
                            num: "220050180-200710-00006",
                            str: "联建视频控制器，LCTRL1600.内含某某控制器嵌入式软件",
                        }, {
                            id: 'barcode6',
                            proportion:'1:1',
                            num: "220050180-200710-00001",
                            str: "联建视频控制器，LCTRL1600.内含某某控制器嵌入式软件",
                        }, {
                            id: 'barcode7',
                            proportion: '1:1',
                            num: "220050180-200710-00002",
                            str: "联建视频控制器，LCTRL1600.内含某某控制器嵌入式软件",
                        }, {
                            id: 'barcode8',
                            proportion: '1:1',
                            num: "220050180-200710-00003",
                            str: "联建视频控制器，LCTRL1600.内含某某控制器嵌入式软件",
                        }, {
                            id: 'barcode9',
                            proportion: '1:1',
                            num: "220050180-200710-00004",
                            str: "联建视频控制器，LCTRL1600.内含某某控制器嵌入式软件",
                        }, {
                            id: 'barcode10',
                            proportion: '1:1',
                            num: "220050180-200710-00005",
                            str: "联建视频控制器，LCTRL1600.内含某某控制器嵌入式软件",
                        }, {
                            id: 'barcode11',
                            proportion: '1:1',
                            num: "220050180-200710-00006",
                            str: "联建视频控制器，LCTRL1600.内含某某控制器嵌入式软件",
                        }
                    ]
                }
            },
            created: function () {
            },
            mounted: function () {
                this.initData();

            },
            //函数方法
            methods: {
                //生成数据
                initData() {
                    //for (let i = 0; i < 5; i++) {
                    //    let obj = {
                    //        id: 'barcode' + i,
                    //        proportion: '1:1',
                    //        num: '220050180-200710-0000' + i,
                    //        str:'联建视频控制器，LCTRL1600.内含某某控制器嵌入式软件'
                    //    }
                    //    this.codelist.push(obj);
                    //}
                    this.codelist.forEach(item => {
                        JsBarcode(`#${item.id}`, item.num, {
                            format: "CODE128",
                            width: 2,
                            height: 40,
                            displayValue: false
                        });
                    })
                },
                onPrint() {
                    //this.codelist.forEach(item => {
                    //    JsBarcode(`#${item.id}`, item.num, {
                    //        format: "CODE128",
                    //        width: 2,
                    //        height: 40,
                    //        displayValue: false
                    //    });
                    //})
                    $("div#printArea").attr("style", "display:block");
                    $("div#printArea").printArea();

                    $("div#printArea").attr("style", "display:none");

                },
                // 获取打印机列表
                getPrintList() {
                    let LODOP = getLodop();
                    if (!LODOP) return
                    // 获取打印机个数
                    let count = LODOP.GET_PRINTER_COUNT()
                    let printValue = LODOP.GET_PRINTER_NAME(-1) //获取默认打印机
                    this.printList = Array(count).fill(null).map((...args) => {
                        if (printValue === LODOP.GET_PRINTER_NAME(args[1])) {
                            this.printDefault = args[1]
                        }
                        return {
                            value: args[1], // args[1]为数组索引
                            label: LODOP.GET_PRINTER_NAME(args[1]) // 获取打印机名称
                        }
                    })

                },
                // 多选
                handleSelectionChange(val) {
                    this.multipleSelection = val;
                },
                // 批量打印
                async batchPrint() {
                    if (!this.multipleSelection.length) {
                        this.$utils.commonUtils.tip('请选择', 'warning')
                        return
                    }
                    for await (const key of this.multipleSelection) {
                        this.getPrintData(key.printUrl)
                    }
                },
                // 打印
                handleReview(index, row) {
                    this.getPrintData(row.printUrl)
                },
                // 获取面单信息数组数据
                async getPrintData(url) {
                    if (url) {
                        this.printUrlList = url.split(';')
                        this.printInfo()
                    }
                },
                // 打印面单 
                async printInfo() {
                    for await (const item of this.printUrlList) {
                        this.printEveryItem(item)
                    }
                },
                // 打印每项
                printEveryItem(item) {
                    let self = this;
                    let LODOP = getLodop(); //调用getLodop获取LODOP对象
                    return new Promise(function (resolve) {
                        setTimeout(() => {
                            LODOP.PRINT_INIT("");
                            let strStyleCSS = `<style type='text/css' rel='stylesheet'>.img1{display:block;margin:10px;width:360;height:360}</style>`
                            let html = `<head>${strStyleCSS}</head><body><div class='print-card'>
                <img src=${item} class='img1' />
            </div><body>`
                            LODOP.ADD_PRINT_HTM(0, 0, 380, 380, html);
                            LODOP.SET_PRINT_PAGESIZE(1, 1000, 1000, "");
                            LODOP.PRINT();
                        }, 1000);
                    });
                }  
            }
        };
    </script>
}