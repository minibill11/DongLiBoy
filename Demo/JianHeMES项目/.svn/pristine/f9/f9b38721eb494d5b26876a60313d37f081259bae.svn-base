@*Dialog新建数据对话框*@
<script type="text/template" id="addDialog">
    <div>
        <el-button type="primary" icon="el-icon-edit-outline" size="small" @@click="newDataVisible = true" style="float:left;">新建记录</el-button>
        @*<slot></slot>*@
        <el-dialog title="新建数据"
                   @@close="close('ruleForm')"
                   :visible.sync="newDataVisible">
            <div>
                <el-form label-width="30%"
                         label-position="right"
                         ref="ruleForm"
                         size="medium"
                         :rules="rules"
                         :model="newDataForm">
                    <el-form-item label="粘贴excel内容">
                        <el-input type="textarea"
                                  :autosize="{ minRows: 1, maxRows: 1}"
                                  placeholder="请粘贴内容"
                                  v-model="pasteExcel"
                                  resize="none">
                        </el-input>
                    </el-form-item>
                    <el-form-item label="平台" prop="platform">
                        <el-input v-model="newDataForm.platform"></el-input>
                    </el-form-item>
                    <el-form-item label="型号" prop="type">
                        <el-input v-model="newDataForm.type"></el-input>
                    </el-form-item>
                    <el-form-item label="平台模块" prop="plafromodule">
                        <el-input v-model="newDataForm.plafromodule"></el-input>
                    </el-form-item>
                    <el-form-item label="产品PCB编号" prop="pcbnumber">
                        <el-input type="textarea"
                                  :autosize="{ minRows: 1, maxRows: 2}"
                                  v-model="newDataForm.pcbnumber"
                                  resize="none">
                        </el-input>
                    </el-form-item>
                    <el-form-item label="维护方式" prop="maintenance">
                        <el-input v-model="newDataForm.maintenance"></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button @@click="newDataVisible = false">取 消</el-button>
                        <el-button type="primary" @@click="submitForm('ruleForm')">确 定</el-button>
                    </el-form-item>
                </el-form>
            </div>
        </el-dialog>
    </div>
</script>
@*input新增框*@
<script type="text/template" id="inputNew">
    <div>
        <el-button @@click="newInputVisible = true" size="mini" class="miniBtn" type="success" plain round>新增</el-button>
        <el-dialog :title="statu+'新增'"
                   :visible.sync="newInputVisible"
                   :append-to-body="true"
                   @@close="close('ruleForm')">
            @*<div class="el-form-item el-form-item--medium">
                    <label for="Name" class="el-form-item__label" style="width: 30%;">粘贴excel内容</label>
                    <div class="el-form-item__content" style="margin-left: 30%;">
                        <div class="el-input el-input--medium">
                            <el-input type="textarea"
                                      :autosize="{ minRows: 1, maxRows: 1}"
                                      placeholder="请粘贴内容"
                                      v-model="pasteExcel"
                                      resize="none">
                            </el-input>
                        </div>
                    </div>
                </div>*@
            <div v-if="statu=='插件'">
                <el-form label-width="30%"
                         label-position="right"
                         ref="ruleForm"
                         size="medium"
                         :rules="rules"
                         :model="newDataForm">
                    <el-form-item label="设备名称" prop="Name">
                        <el-input v-model="newDataForm.Name='插件'"></el-input>
                    </el-form-item>
                    @*<el-form-item label="模组需求数量" prop="ModuleNeedNum2">
                            <el-input v-model.number="newDataForm.ModuleNeedNum2"></el-input>
                        </el-form-item>*@
                    <el-form-item label="PCBA插件单灯数" prop="PCBASingleLampNumber">
                        <el-input v-model.number="newDataForm.PCBASingleLampNumber"></el-input>
                    </el-form-item>
                    <el-form-item label="插件标配人数" prop="PluginStandardNumber">
                        <el-input v-model.number="newDataForm.PluginStandardNumber"></el-input>
                    </el-form-item>
                </el-form>
            </div>
            <div v-if="statu=='三防'">
                <el-form label-width="30%"
                         label-position="right"
                         ref="ruleForm"
                         size="medium"
                         :rules="rules"
                         :model="newDataForm">
                    <el-form-item label="工序名称" prop="ThreeProfProcessName">
                        <el-input v-model="newDataForm.ThreeProfProcessName"></el-input>
                    </el-form-item>
                    @*<el-form-item label="模组需求数量" prop="ModuleNeedNum2">
                            <el-input v-model.number="newDataForm.ModuleNeedNum2"></el-input>
                        </el-form-item>*@
                    <el-form-item label="标准总人数" prop="ThreeProfStandardTotal">
                        <el-input v-model.number="newDataForm.ThreeProfStandardTotal"></el-input>
                    </el-form-item>
                    <el-form-item label="标准产量" prop="ThreeProfStabdardOutput">
                        <el-input v-model="newDataForm.ThreeProfStabdardOutput"></el-input>
                    </el-form-item>
                </el-form>
            </div>
            @*<div v-if="statu=='装磁吸安装板'">
                    <el-form label-width="30%"
                             label-position="right"
                             ref="ruleForm"
                             size="medium"
                             :rules="rules"
                             :model="newDataForm">
                        <el-form-item label="工序名称" prop="MagneticProcessName">
                            <el-input v-model="newDataForm.MagneticProcessName"></el-input>
                        </el-form-item>
                        <el-form-item label="标准总人数" prop="MagneticStandardTotal">
                            <el-input v-model.number="newDataForm.MagneticStandardTotal"></el-input>
                        </el-form-item>
                        <el-form-item label="标准产量" prop="MagneticStabdardOutput">
                            <el-input v-model="newDataForm.MagneticStabdardOutput"></el-input>
                        </el-form-item>
                    </el-form>
                </div>*@
            <div v-if="statu=='喷墨'">
                <el-form label-width="30%"
                         label-position="right"
                         ref="ruleForm"
                         size="medium"
                         :rules="rules"
                         :model="newDataForm">
                    <el-form-item label="工序名称" prop="InkjetProcessName">
                        <el-input v-model="newDataForm.InkjetProcessName='喷墨测试'"></el-input>
                    </el-form-item>
                    @*<el-form-item label="模组需求数量" prop="ModuleNeedNum2">
                            <el-input v-model.number="newDataForm.ModuleNeedNum2"></el-input>
                        </el-form-item>*@
                    <el-form-item label="配置人数" prop="InkjetSuctionStandardTotal">
                        <el-input v-model.number="newDataForm.InkjetSuctionStandardTotal"></el-input>
                    </el-form-item>
                    <el-form-item label="每小时产量" prop="InkjetStabdardOutputPerHour">
                        <el-input v-model="newDataForm.InkjetStabdardOutputPerHour"></el-input>
                    </el-form-item>
                </el-form>
            </div>
            <div v-if="statu=='灌胶'">
                <el-form label-width="30%"
                         label-position="right"
                         ref="ruleForm"
                         size="medium"
                         :rules="rules"
                         :model="newDataForm">
                    <el-form-item label="工序名称" prop="GlueProcessName">
                        <el-input v-model="newDataForm.GlueProcessName"></el-input>
                    </el-form-item>
                    @*<el-form-item label="模组需求数量" prop="ModuleNeedNum2">
                            <el-input v-model.number="newDataForm.ModuleNeedNum2"></el-input>
                        </el-form-item>*@
                    <el-form-item label="标准总人数" prop="GlueStandardTotal">
                        <el-input v-model.number="newDataForm.GlueStandardTotal"></el-input>
                    </el-form-item>
                    <el-form-item label="标准产量" prop="GlueStabdardOutput">
                        <el-input v-model="newDataForm.GlueStabdardOutput"></el-input>
                    </el-form-item>
                </el-form>
            </div>
            <div v-if="statu=='气密'">
                <el-form label-width="30%"
                         label-position="right"
                         ref="ruleForm"
                         size="medium"
                         :rules="rules"
                         :model="newDataForm">
                    <el-form-item label="工序名称" prop="AirtightProcessName">
                        <el-input v-model="newDataForm.AirtightProcessName='气密测试'"></el-input>
                    </el-form-item>
                    @*<el-form-item label="模组需求数量" prop="ModuleNeedNum2">
                            <el-input v-model.number="newDataForm.ModuleNeedNum2"></el-input>
                        </el-form-item>*@
                    <el-form-item label="标准总人数" prop="AirtightStandardTotal">
                        <el-input v-model.number="newDataForm.AirtightStandardTotal"></el-input>
                    </el-form-item>
                    <el-form-item label="标准产量" prop="AirtightStabdardOutput">
                        <el-input v-model="newDataForm.AirtightStabdardOutput"></el-input>
                    </el-form-item>
                </el-form>
            </div>
            <div v-if="statu=='老化'">
                <el-form label-width="30%"
                         label-position="right"
                         ref="ruleForm"
                         size="medium"
                         :rules="rules"
                         :model="newDataForm">
                    <el-form-item label="老化1工序名称" prop="BurinOneProcessName">
                        <el-input v-model="newDataForm.BurinOneProcessName='拼屏'"></el-input>
                    </el-form-item>
                    <el-form-item label="老化1标配人数" prop="BurninOneSuctionStandardTotal">
                        <el-input v-model.number="newDataForm.BurninOneSuctionStandardTotal"></el-input>
                    </el-form-item>
                    <el-form-item label="老化1每小时标准产量" prop="BurinOneStabdardOutputPerHour">
                        <el-input v-model="newDataForm.BurinOneStabdardOutputPerHour"></el-input>
                    </el-form-item>
                    <el-form-item label="老化2工序名称" prop="BurinTwoProcessName">
                        <el-input v-model="newDataForm.BurinTwoProcessName='拆屏'"></el-input>
                    </el-form-item>
                    <el-form-item label="老化2标配人数" prop="BurinTwoSuctionStandardTotal">
                        <el-input v-model.number="newDataForm.BurinTwoSuctionStandardTotal"></el-input>
                    </el-form-item>
                    <el-form-item label="老化2每小时标准产量" prop="BurinTwoStabdardOutputPerHour">
                        <el-input v-model="newDataForm.BurinTwoStabdardOutputPerHour"></el-input>
                    </el-form-item>
                    @*<el-form-item label="模组需求数量" prop="ModuleNeedNum2">
                            <el-input v-model.number="newDataForm.ModuleNeedNum2"></el-input>
                        </el-form-item>*@
                </el-form>
            </div>
            <span slot="footer" class="dialog-footer">
                <el-button @@click="newInputVisible = false">取 消</el-button>
                <el-button type="primary" @@click="submitForm('ruleForm')">确 定</el-button>
            </span>
        </el-dialog>
    </div>
</script>
<script>
    //新增整行数据框
    Vue.component('newdata-dialog', {
        template: document.getElementById("addDialog"),
        data: function () {
            return {
                newDataForm: {
                    type: "",
                    pcbnumber: "",
                    platform: "",
                    plafromodule: "",
                    maintenance: ""
                },
                newDataVisible: false,
                pasteExcel: "",
                rules: {
                    type: [{ required: true, message: '请填写型号', trigger: 'blur' }],
                    platform: [{ required: true, message: '请填写平台', trigger: 'blur' }],
                    plafromodule: [{ required: true, message: '请填写平台模块', trigger: 'blur' }],
                    maintenance: [{ required: true, message: '请填写维护方式', trigger: 'blur' }],
                    pcbnumber: [{ required: true, message: '请填写产品PCB编号', trigger: 'blur' }],
                }
            }
        },
        methods: {
            //新建总表记录
            addNewData() {
                this.newDataVisible = false;
                app.loading = true;
                axios.post('/Process_Capacity/AddTotalProcess_Capacity', {
                    type: this.newDataForm.type,
                    pcbnumber: this.newDataForm.pcbnumber,
                    platform: this.newDataForm.platform,
                    plafromodule: this.newDataForm.plafromodule,
                    Maintenance: this.newDataForm.maintenance
                }).then(res => {
                    //console.log(res.data)
                    if (res.data.content == null) {
                        this.$message.error(res.data.message);
                    } else {
                        app.tableList.unshift(res.data.content);
                        this.$message.success(res.data.message);
                    };
                    app.loading = false;
                }).catch(err => {
                    this.$message.error('新建失败！');
                    app.loading = false;
                });
            },
            //关闭模态框
            close(formName) {
                this.$refs[formName].resetFields();
            },
            //验证值
            submitForm(formName) {
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        this.addNewData();
                    } else {
                        console.log('error submit!!');
                        return false;
                    };
                });
            }
        },
        watch: {
            //粘贴型号平台和产品PCB编号
            pasteExcel: function (val) {
                if (val == "") {
                    return false;
                };
                let rtArr = [];
                //按\t切割
                let cutT = val.split("\t");
                //console.log(cutT);
                //按\n切割
                for (let t of cutT) {
                    //console.log(t);
                    if (t == "\n" || t == "") {
                        continue;
                    };
                    let cutN = t.split("\n");
                    for (let n of cutN) {
                        //console.log(n);
                        let rt = n.replace(/\"|\s|\(|\)|\（|\）/g, "");
                        rtArr.push(rt);
                        //console.log(rt);
                    };
                };
                //console.log(rtArr);
                this.newDataForm.type = rtArr[0]
                this.newDataForm.platform = rtArr[1];
                this.newDataForm.pcbnumber = rtArr[2] + "(" + rtArr[3] + ")";
                //pasteQuantity.pop();
                this.pasteExcel = "";
            },
        }
    });

    //新增工段数据框
    Vue.component('input-new', {
        props: ['thisrow', 'thisitem', 'thisid', 'statu'],
        template: document.getElementById("inputNew"),
        data: function () {
            return {
                newDataForm: {},
                newInputVisible: false,
                address: "",
                rules: {}
            }
        },
        mounted: function () {
            let checkFloat = (rule, value, callback) => {
                if (value == undefined || value == '') { callback() };
                let reg = /^(0|([1-9]\d*))(\.\d{0,2})?$/g;
                if (reg.test(value)) {
                    callback();
                } else {
                    callback(new Error('请输入正确的数值，数值最多为2位小数'));
                };
            };
            let stringTest = [{ required: true, message: '请填写名称', trigger: 'blur' }],
                numberTest = [
                    { required: true, message: '数量不能为空', trigger: 'blur' },
                    { type: 'number', message: '必须为数字值' }
                ],
                floatTest = [
                    { required: true, message: '数值不能为空', trigger: 'blur' },
                    { validator: checkFloat, trigger: 'blur' }
                ];
            switch (this.statu) {
                case '插件':
                    this.address = "Add_Plug_In";
                    this.rules = {
                        Name: stringTest,
                        PCBASingleLampNumber: numberTest,
                        PluginStandardNumber: numberTest,
                        //ModuleNeedNum2: numberTest,
                    };
                    break;
                case '三防':
                    this.address = "Add_ThreeProf";
                    this.rules = {
                        ThreeProfProcessName: stringTest,
                        ThreeProfStandardTotal: numberTest,
                        ThreeProfStabdardOutput: floatTest,
                        //ModuleNeedNum2: numberTest,
                    };
                    break;
                //case '装磁吸安装板':
                //    this.address = "Add_MagneticSuction";
                //    this.rules = {
                //        MagneticProcessName: stringTest,
                //        MagneticStandardTotal: numberTest,
                //        MagneticStabdardOutput: floatTest,
                //    };
                //    break;
                case '喷墨':
                    this.address = "Add_Inkjet";
                    this.rules = {
                        InkjetProcessName: stringTest,
                        InkjetSuctionStandardTotal: numberTest,
                        InkjetStabdardOutputPerHour: floatTest,
                        //ModuleNeedNum2: numberTest,
                    };
                    break;
                case '灌胶':
                    this.address = "Add_Glue";
                    this.rules = {
                        GlueProcessName: stringTest,
                        GlueStandardTotal: numberTest,
                        GlueStabdardOutput: floatTest,
                        //ModuleNeedNum2: numberTest,
                    };
                    break;
                case '气密':
                    this.address = "Add_Airtight";
                    this.rules = {
                        AirtightProcessName: stringTest,
                        AirtightStandardTotal: numberTest,
                        AirtightStabdardOutput: floatTest,
                        //ModuleNeedNum2: numberTest,
                    };
                    break;
                case '老化':
                    this.address = "Add_Burin";
                    this.rules = {
                        BurinOneProcessName: stringTest,
                        BurninOneSuctionStandardTotal: [{ type: 'number', message: '必须为数字值' }],
                        BurinOneStabdardOutputPerHour: [{ validator: checkFloat, trigger: 'blur' }],
                        BurinTwoProcessName: stringTest,
                        BurinTwoSuctionStandardTotal: [{ type: 'number', message: '必须为数字值' }],
                        BurinTwoStabdardOutputPerHour: [{ validator: checkFloat, trigger: 'blur' }],
                        //ModuleNeedNum2: numberTest,
                    };
                    break;
                //default:
            };
        },
        methods: {
            addNewData() {
                this.newInputVisible = false;
                app.loading = true;
                let obj = this.newDataForm;
                obj['Type'] = this.thisrow.Type;
                obj['Platform'] = this.thisrow.Platform;
                obj['PlatformModul'] = this.thisrow.PlatformModul;
                obj['ProductPCBnumber'] = this.thisrow.PCB;
                obj['Maintenance'] = this.thisrow.Maintenance;

                axios.post('/Process_Capacity/' + this.address, {
                    newData: obj,
                    statu: "添加"
                }).then(res => {
                    if (res.data.message == true) {
                        //app.getTableData();
                        this.addNewItem(res.data.content);
                    } else {
                        this.$message({
                            message: res.data.content,
                            type: 'error'
                        });
                    };
                    app.loading = false;
                }).catch(err => {
                    this.$message({
                        message: '添加失败！',
                        type: 'error'
                    });
                    app.loading = false;
                });
            },
            addNewItem(newitem) {
                let item = this.thisitem, row = this.thisrow;
                if (item == null) {
                    switch (this.statu) {
                        case '插件':
                            row.PluginDevice = [];
                            row.PluginDevice.push(newitem)
                            break;
                        case '三防':
                            row.ThreeProf = [];
                            row.ThreeProf.push(newitem)
                            break;
                        //case '装磁吸安装板':
                        //    row.Magnetic = [];
                        //    row.Magnetic.push(newitem)
                        //    break;
                        case '喷墨':
                            row.Inkjet = [];
                            row.Inkjet.push(newitem)
                            break;
                        case '灌胶':
                            row.Glue = [];
                            row.Glue.push(newitem)
                            break;
                        case '气密':
                            row.Airtight = [];
                            row.Airtight.push(newitem)
                            break;
                        case '老化':
                            row.Burin = [];
                            row.Burin.push(newitem)
                            break;
                        //default:
                    };
                } else {
                    item.push(newitem);
                };
                this.$message({
                    message: '添加成功！',
                    type: 'success'
                });
            },
            //关闭模态框
            close(formName) {
                this.$refs[formName].resetFields();
                //this.newDataForm = {}
            },
            //验证值
            submitForm(formName) {
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        this.addNewData();
                    } else {
                        //console.log('error submit!!');
                        return false;
                    };
                });
            }
        }
    });
</script>
