@* 设备模态框 *@
<script type="text/template" id="equipmentBtn">
    <div>
        <el-button size="mini" @@click="equipmentVisible = true" class="miniBtn" type="danger" plain round>设备</el-button>
        @*<slot></slot>*@
        <el-dialog @@open="open"
                   @@close="close('ruleForm')"
                   title="设备内容"
                   :visible.sync="equipmentVisible"
                   :append-to-body="true">
            @*<div slot="title"></div>*@
            <el-table :data="shebeiList">
                <el-table-column prop="EquipmentName"
                                 label="设备名称">
                </el-table-column>
                <el-table-column prop="EquipmentNum"
                                 label="设备数量">
                </el-table-column>
                <el-table-column prop="EquipmentCapacity"
                                 label="设备产能">
                </el-table-column>
                <el-table-column label="操作">
                    <template slot-scope="scope">
                        <el-button size="mini" type="danger" @@click="shebeiDelete(scope.row)">删除</el-button>
                        <el-button size="mini" type="primary" @@click="formOpen(scope.row)">修改</el-button>
                    </template>
                </el-table-column>
            </el-table>
            <el-form label-width="30%"
                     label-position="right"
                     ref="ruleForm"
                     size="medium"
                     style="border:1px solid #333;padding-top:10px;margin-top:10px;"
                     v-show="formAddShow || formEditShow"
                     :rules="rules"
                     :model="equipmentForm">
                <el-form-item label="设备名称" prop="EquipmentName">
                    <el-select v-model="equipmentForm.EquipmentName" placeholder="请选择设备">
                        <el-option label="喷三防机" value="喷三防机"></el-option>
                        <el-option label="点三防机" value="点三防机"></el-option>
                        <el-option label="螺丝机" value="螺丝机"></el-option>
                        <el-option label="灌胶机" value="灌胶机"></el-option>
                        <el-option label="气密测试机" value="气密测试机"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="设备配置数量(台)" prop="EquipmentNum">
                    <el-input-number v-model="equipmentForm.EquipmentNum" :min="0"></el-input-number>
                </el-form-item>
                <el-form-item label="设备单机产能(PCS/H)" prop="EquipmentCapacity">
                    <el-input v-model="equipmentForm.EquipmentCapacity"></el-input>
                </el-form-item>
                <el-form-item>
                    <el-button @@click="formHide">取 消</el-button>
                    <el-button type="success" @@click="submitForm('ruleForm','添加')" v-show="formAddShow">确定添加</el-button>
                    <el-button type="primary" @@click="submitForm('ruleForm','修改')" v-show="formEditShow">确定修改</el-button>
                </el-form-item>
            </el-form>
            <span slot="footer" class="dialog-footer">
                <el-button type="success" @@click="formEditShow = false;formAddShow = true;" v-show="!formAddShow">添 加</el-button>
                <el-button @@click="equipmentVisible = false">关 闭</el-button>
            </span>
        </el-dialog>
    </div>
</script>
<script>
    Vue.component('equipment-dialog', {
        template: document.getElementById("equipmentBtn"),
        props: ['thisrow', 'thisitem', 'statu'],
        data: function () {
            return {
                equipmentForm: {
                    id: "",
                    EquipmentName: "",
                    EquipmentNum: "",
                    EquipmentCapacity: "",
                },
                equipmentVisible: false,
                rules: {},
                shebeiList: [],
                thisid: [],
                formAddShow: false,
                formEditShow: false,
            }
        },
        mounted: function () {
            let nameinfo = app.getSectionInfo(this.statu);
            if (this.statu === 'SMT') {
                this.thisid = this.thisrow[nameinfo.idName];
            } else {
                this.thisid = this.thisitem[nameinfo.idName];
            };
            //验证规则
            let checkFloat = (rule, value, callback) => {
                if (value == undefined || value == '') { callback() };
                let reg = /^(0|([1-9]\d*))(\.\d{0,2})?$/g;
                if (reg.test(value)) {
                    callback();
                } else {
                    callback(new Error('请输入正确的数值，数值最多为2位小数'));
                };
            };
            this.rules = {
                EquipmentName: [{ required: true, message: '请选择设备', trigger: 'change' }],
                EquipmentNum: [
                    { required: true, message: '设备数量不能为空', trigger: 'blur' },
                    { type: 'number', message: '必须为数字值' }
                ],
                EquipmentCapacity: [
                    { required: true, message: '设备产能不能为空', trigger: 'blur' },
                    { validator: checkFloat, trigger: 'blur' }
                ],
            };
        },
        methods: {
            //设备数据 增删改
            equipmentData(statu, deleteval) {
                app.loading = true;
                let Form = {
                    Type: this.thisrow.Type,
                    Platform: this.thisrow.Platform,
                    ProductPCBnumber: this.thisrow.PCB,
                    PlatformModul: this.thisrow.PlatformModul,
                    Maintenance: this.thisrow.Maintenance,
                    Seaction: this.statu,
                    SeactionID: this.thisid,
                };
                if (statu == '删除') {
                    Form['Id'] = deleteval.id;
                    Form['EquipmentName'] = deleteval.EquipmentName;
                    Form['EquipmentNum'] = deleteval.EquipmentNum;
                    Form['EquipmentCapacity'] = deleteval.EquipmentCapacity;
                } else {
                    Form['EquipmentName'] = this.equipmentForm.EquipmentName;
                    Form['EquipmentNum'] = this.equipmentForm.EquipmentNum;
                    Form['EquipmentCapacity'] = this.equipmentForm.EquipmentCapacity;
                    if (statu == '修改') {
                        Form['Id'] = this.equipmentForm.id;
                    };
                };
                axios.post('/Process_Capacity/AddEquipment', {
                    Process_Capacity_Equipment: Form,
                    statu: statu
                }).then(res => {
                    //console.log(res.data);
                    if (res.data) {
                        this.$message.success(statu + "成功！");
                        //this.shebeiList = [];
                        this.displayEquipment();
                        this.formAddShow = false;
                        this.formEditShow = false;
                        this.equipmentForm = {
                            id: "",
                            EquipmentName: "",
                            EquipmentNum: "",
                            EquipmentCapacity: ""
                        };
                    } else {
                        this.$message.error(statu + "失败！");
                    };
                    app.loading = false;
                }).catch(err => {
                    this.$message.error('操作失败！');
                    this.equipmentVisible = false;
                    app.loading = false;
                });
            },
            //获取设备信息
            displayEquipment() {
                axios.post('/Process_Capacity/DisplayEquipment', {
                    type: this.thisrow.Type,
                    pcbnumber: this.thisrow.PCB,
                    platform: this.thisrow.Platform,
                    plafromodule: this.thisrow.PlatformModul,
                    Maintenance: this.thisrow.Maintenance,
                    seaction: this.statu,
                    id: this.thisid
                }).then(res => {
                    this.shebeiList = res.data;
                }).catch(err => {
                    this.$message.error('读取设备信息失败！');
                });
            },
            //打开模态框
            open() {
                this.displayEquipment();
            },
            //关闭模态框
            close(formName) {
                this.$refs[formName].resetFields();
                this.shebeiList = [];
            },
            //验证值
            submitForm(formName, statu) {
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        this.equipmentData(statu);
                    } else {
                        console.log('error submit!!');
                        return false;
                    };
                });
            },
            formOpen(row) {
                this.formAddShow = false;
                this.equipmentForm = {
                    id: row.id,
                    EquipmentName: row.EquipmentName,
                    EquipmentNum: row.EquipmentNum,
                    EquipmentCapacity: row.EquipmentCapacity
                };
                this.formEditShow = true;
            },
            shebeiDelete(row) {
                this.$confirm('确认删除此设备?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.equipmentData('删除', row);
                }).catch(() => {

                });
            },
            formHide() {
                this.equipmentForm = {
                    id: "",
                    EquipmentName: "",
                    EquipmentNum: "",
                    EquipmentCapacity: ""
                };
                this.formAddShow = false;
                this.formEditShow = false;
            },
        },
    });
</script>
