@model JianHeMES.Models.Small_Sample

@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link href="~/Content/styleFile/packaging/index.css" rel="stylesheet" />
<script src="~/Content/styleFile/packaging/index.js"></script>
<script src="~/Scripts/axios.min.js"></script>

<style>
    table td {
        font-size: 13px;
        text-align: center;
        line-height: 28px;
    }

    .red {
        color: red;
    }

    .pass {
        color: green;
    }

    .tdco {
        border-left: solid 1px #ffffff;
        border-right: solid 1px #ffffff;
    }

    .el-upload__input {
        display: none !important;
    }

    .bt {
        margin-left: 430px;
        margin-top: 20px;
        margin-bottom: 10px;
    }

    .el-upload-list__item:first-child {
        margin-left: 50px;
        height: 20px;
        margin-top: 2px;
    }

    .color {
        color: red;
    }
</style>
<div id="app">
    <div style="display:flex">
        <h2 class="bt">小样光电参数测试报告</h2>
        <span id="testid" style="margin-left:50px; margin-top:40px;margin-bottom:10px">{{list.ReportDate | timeFilter}}</span>
        <el-upload class="upload-demo"
                   v-bind:on-change="testchange"
                   ref="upload"
                   action="Create"
                   v-bind:on-preview="handlePreview"
                   v-bind:on-remove="handleRemove"
                   v-bind:file-list="fileList"
                   v-bind:limit="1"
                   v-bind:on-exceed="handleExceed"
                   v-bind:auto-upload="false" style="float:left">
            <el-button slot="trigger" size="small" type="primary" style="margin-top:5px;margin-left:65px">选取文件</el-button>
            <el-button style="margin-top:5px" size="small" type="success" v-on:click="submitUpload">上传</el-button>
        </el-upload>
    </div>
    <form id="myform">
        <input type="file" name="fileup" id="fileup" v-on:change="fileChange()" style="display:none" />
        <img src="~/Content/Images/upload.png" width="50" v-on:click="upclick()">
    </form>
    <table border="1" cellspacing="0" style="margin:0 auto">
        <colgroup>
            <col width="30">
            <col width="75">
            <col width="75">
            <col width="55">
            <col width="60">
            <col width="68">
            <col width="68">
            <col width="80">
            <col width="90">
            <col width="70">
            <col width="70">
            <col width="80">
        </colgroup>
        <tr>
            <td colspan="2">客户名称</td>
            <td colspan="2">{{list.Customer}}</td>
            <td>生产单号</td>
            <td colspan="2">{{list.OrderNumber}}</td>
            <td>规格型号</td>
            <td>{{list.Mo1}}</td>
            <td colspan="2">模块数量(单位：PCS)</td>
            <td>{{list.Module_Number}}</td>
        </tr>
        <tr>
            <td colspan="12" class="tdco">&nbsp</td>
        </tr>

        <tr>
            <td colspan="7" style="text-align:left">{{list.Te1}}</td>
            <td>实际点间距</td>
            <td>{{list.Actual_point}}</td>
            <td colspan="3"></td>
        </tr>
        <tr>
            <td colspan="8" style="text-align:left">{{list.Te2}}</td>
            <td>订单接收卡：</td>
            <td colspan="3">{{list.ReceivingCard}}</td>
        </tr>
        <tr>
            <td colspan="2">模块型号：</td>
            <td colspan="2">{{list.Mo2}}</td>
            <td>点数：</td>
            <td>{{list.Points}}</td>
            <td>扫描数</td>
            <td>{{list.Scanningway}}</td>
            <td>调试系统</td>
            <td colspan="3">{{list.system}}</td>
        </tr>
        <tr>
            <td colspan="2">测试条件:</td>
            <td>{{list.Te3}}</td>
            <td>{{list.fixed_value}}</td>
            <td colspan="2">驱动板电压(V)</td>
            <td>{{list.Driveplate}}</td>
            <td colspan="5">电源型号</td>
        </tr>

        <tr>
            <td colspan="12" class="tdco">样品参数实测值</td>
        </tr>
        <tr>
            <td colspan="2">角度</td>
            <td>颜色</td>
            <td colspan="2">R</td>
            <td colspan="2">G</td>
            <td colspan="2">B</td>
            <td colspan="3">W</td>
        </tr>
        <tr>
            <td colspan="2" rowspan="2">0°</td>
            <td>亮度</td>
            <td colspan="2" class="luminance">{{list.Angle_R1}}</td>
            <td colspan="2" class="luminance">{{list.Angle_G1}}</td>
            <td colspan="2" class="luminance">{{list.Angle_B1}}</td>
            <td colspan="3">{{list.Angle_W1}}</td>
        </tr>
        <tr>
            <td>坐标</td>
            <td>{{list.Angle_R2}}</td>
            <td>{{list.Angle_R3}}</td>
            <td>{{list.Angle_G2}}</td>
            <td>{{list.Angle_G3}}</td>
            <td>{{list.Angle_B2}}</td>
            <td>{{list.Angle_B3}}</td>
            <td colspan="2" class="colorTmin">{{list.Angle_W2}}</td>
            <td class="colorTmax">{{list.Angle_W3}}</td>
        </tr>
        <tr>
            <td colspan="2" rowspan="2">客户要求</td>
            <td>亮度</td>
            <td colspan="2"></td>
            <td colspan="2"></td>
            <td colspan="2"></td>
            <td>{{list.Client_W1}}</td>
            <td class="front">{{list.Client_W1_V}}</td>
            <td>{{list.Client_W2}}</td>
        </tr>
        <tr>
            <td>坐标</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td colspan="2">{{list.Client_W3}}</td>
            <td>{{list.Client_W4}}</td>
        </tr>
        <tr>
            <td colspan="3">分压电/排阻阻值(欧)</td>
            <td colspan="2">{{list.Points_R}}</td>
            <td colspan="2">/</td>
            <td colspan="2">/</td>
            <td colspan="3">/</td>
        </tr>
        <tr>
            <td colspan="3">可调用电阻阻值(欧)</td>
            <td colspan="2">{{list.Adju_R}}</td>
            <td colspan="2">{{list.Adju_G}}</td>
            <td colspan="2">{{list.Adju_B}}</td>
            <td colspan="3">/</td>
        </tr>
        <tr>
            <td colspan="3">单IC引脚电流(mA)</td>
            <td class="targetOne" colspan="2">{{list.IC_R1}}</td>
            <td class="targetTwo" colspan="2">{{list.IC_G1}}</td>
            <td class="targetThree" colspan="2">{{list.IC_B1}}</td>
            <td colspan="3"></td>
        </tr>
        <tr>
            <td colspan="3">IC   VDS</td>
            <td colspan="2">{{list.IC_R2}}</td>
            <td colspan="2">{{list.IC_G2}}</td>
            <td colspan="2">{{list.IC_B2}}</td>
            <td colspan="3"></td>
        </tr>
        <tr>
            <td colspan="3">模 块 电 流(A)</td>
            <td colspan="4" class="electricity">{{list.Module_current}}</td>
            <td colspan="2">IC 型号</td>
            <td colspan="3">{{list.IC3}}</td>
        </tr>
        <tr>
            <td colspan="3">刷新频率</td>
            <td colspan="2">{{list.R1}}</td>
            <td colspan="2">接收卡Data包</td>
            <td colspan="5">{{list.R2}}</td>
        </tr>
        <tr>
            <td colspan="3">接收卡带载点数</td>
            <td>{{list.R3}}</td>
            <td>{{list.R4}}</td>
            <td colspan="2">LCT版本</td>
            <td colspan="5">{{list.LCT}}</td>
        </tr>
        <tr>
            <td colspan="3">亮度有效率(%)</td>
            <td colspan="2">{{list.De1_dec}}</td>
            <td colspan="2">灰度等级</td>
            <td colspan="2">{{list.De2}}</td>
            <td>DCLK</td>
            <td colspan="2">{{list.DCLK}}</td>
        </tr>
        <tr>
            <td colspan="3">电源带载率(%)</td>
            <td colspan="2">{{list.Load}}</td>
            <td colspan="2">每平方最大功耗(W/m²)</td>
            <td colspan="2">{{list.Per}}</td>
            <td>GCLK</td>
            <td colspan="2">{{list.GCLK}}</td>
        </tr>
        <tr>
            <td colspan="3">MOS管型号</td>
            <td colspan="2">{{list.MOS1}}</td>
            <td colspan="2">MOS压降(V)</td>
            <td colspan="2">{{list.MOS2}}</td>
            <td>电流增益</td>
            <td colspan="2">{{list.Current}}</td>
        </tr>

        <tr>
            <td colspan="12" class="tdco">小样灯管及参数(供应商测试值)</td>
        </tr>
        <tr>
            <td colspan="3">LED厂家及型号</td>
            <td colspan="2"></td>
            <td colspan="2">IV(mcd)</td>
            <td colspan="2">WD(nm)</td>
            <td colspan="2">正向电压（vf）</td>
            <td>IV@IF(mA)</td>
        </tr>
        <tr>
            <td rowspan="2">R</td>
            <td colspan="2" rowspan="2">{{list.LED_R1}}</td>
            <td colspan="2">实际范围</td>
            <td>{{list.LED_R2}}</td>
            <td>{{list.LED_R4}}</td>
            <td>{{list.LED_R6}}</td>
            <td>{{list.LED_R7}}</td>
            <td rowspan="2">{{list.LED_R9}}</td>
            <td rowspan="2">{{list.LED_R10}}</td>
            <td rowspan="2">{{list.LED_R11}}</td>
        </tr>
        <tr>
            <td colspan="2">Min:Max</td>
            <td>{{list.LED_R3}}</td>
            <td>{{list.LED_R5}}</td>
            <td colspan="2">{{list.LED_R8}}</td>
        </tr>

        <tr>
            <td rowspan="2">G</td>
            <td colspan="2" rowspan="2">{{list.LED_G1}}</td>
            <td colspan="2">实际范围</td>
            <td>{{list.LED_G2}}</td>
            <td>{{list.LED_G4}}</td>
            <td>{{list.LED_G6}}</td>
            <td>{{list.LED_G7}}</td>
            <td rowspan="2">{{list.LED_G9}}</td>
            <td rowspan="2">{{list.LED_G10}}</td>
            <td rowspan="2">{{list.LED_G11}}</td>
        </tr>
        <tr>
            <td colspan="2">Min:Max</td>
            <td>{{list.LED_G3}}</td>
            <td>{{list.LED_G5}}</td>
            <td colspan="2">{{list.LED_G8}}</td>
        </tr>

        <tr>
            <td rowspan="2">B</td>
            <td colspan="2" rowspan="2">{{list.LED_B1}}</td>
            <td colspan="2">实际范围</td>
            <td>{{list.LED_B2}}</td>
            <td>{{list.LED_B4}}</td>
            <td>{{list.LED_B6}}</td>
            <td>{{list.LED_B7}}</td>
            <td rowspan="2">{{list.LED_B9}}</td>
            <td rowspan="2">{{list.LED_B10}}</td>
            <td rowspan="2">{{list.LED_B11}}</td>
        </tr>
        <tr>
            <td colspan="2">Min:Max</td>
            <td>{{list.LED_B3}}</td>
            <td>{{list.LED_B5}}</td>
            <td colspan="2">{{list.LED_B8}}</td>
        </tr>

        <tr>
            <td colspan="12" class="tdco">小样灯管及参数(联建测试值)</td>
        </tr>
        <tr>
            <td colspan="3">LED厂家及型号</td>
            <td colspan="2"></td>
            <td colspan="2">IV(mcd)</td>
            <td colspan="2">WD(nm)</td>
            <td colspan="2">正向电压（vf）</td>
            <td>IV@IF(mA)</td>
        </tr>
        <tr>
            <td rowspan="2">R</td>
            <td colspan="2" rowspan="2">{{list.Small_R1}}</td>
            <td colspan="2">实际范围</td>
            <td>{{list.Small_R2}}</td>
            <td>{{list.Small_R4}}</td>
            <td>{{list.Small_R6}}</td>
            <td>{{list.Small_R7}}</td>
            <td rowspan="2">{{list.Small_R9}}</td>
            <td rowspan="2">{{list.Small_R10}}</td>
            <td rowspan="2">{{list.Small_R11}}</td>
        </tr>
        <tr>
            <td colspan="2">Min:Max</td>
            <td>{{list.Small_R3}}</td>
            <td>{{list.Small_R5}}</td>
            <td colspan="2">{{list.Small_R8}}</td>
        </tr>

        <tr>
            <td rowspan="2">G</td>
            <td colspan="2" rowspan="2">{{list.Small_G1}}</td>
            <td colspan="2">实际范围</td>
            <td>{{list.Small_G2}}</td>
            <td>{{list.Small_G4}}</td>
            <td>{{list.Small_G6}}</td>
            <td>{{list.Small_G7}}</td>
            <td rowspan="2">{{list.Small_G9}}</td>
            <td rowspan="2">{{list.Small_G10}}</td>
            <td rowspan="2">{{list.Small_G11}}</td>
        </tr>
        <tr>
            <td colspan="2">Min:Max</td>
            <td>{{list.Small_G3}}</td>
            <td>{{list.Small_G5}}</td>
            <td colspan="2">{{list.Small_G8}}</td>
        </tr>

        <tr>
            <td rowspan="2">B</td>
            <td colspan="2" rowspan="2">{{list.Small_B1}}</td>
            <td colspan="2">实际范围</td>
            <td>{{list.Small_B2}}</td>
            <td>{{list.Small_B4}}</td>
            <td>{{list.Small_B6}}</td>
            <td>{{list.Small_B7}}</td>
            <td rowspan="2">{{list.Small_B9}}</td>
            <td rowspan="2">{{list.Small_B10}}</td>
            <td rowspan="2">{{list.Small_B11}}</td>
        </tr>
        <tr>
            <td colspan="2">Min:Max</td>
            <td>{{list.Small_B3}}</td>
            <td>{{list.Small_B5}}</td>
            <td colspan="2">{{list.Small_B8}}</td>
        </tr>

        <tr>
            <td colspan="12" style="text-align:left">备注：{{list.ReportRemark}}</td>
        </tr>
    </table>
    <br>
    <div style="float:inherit">
        <span style="margin-left:180px">
            核准：{{list.Approved}}
        </span>
        <span style="margin-left:240px">
            审核：{{list.Assessor}}
        </span>
        <span style="margin-left:240px">
            测试：{{list.Tester}}
        </span>
    </div>
    <div style="float:inherit">
        <el-button type="success"  size="mini" v-on:click="saveFile" style="margin-left:170px;margin-top:5px" v-bind:disabled="flag">保存</el-button>
    </div>
</div>
<script>
    Vue.filter("timeFilter", function (val) {
        if (!val) return '';
        let dd = val.match(/\d+/g)[0]
        var date = new Date(parseInt(dd)); //获取一个时间对象
        //console.log(dd / 1000)
        console.log(date)
        //let dd = new Date(dds)
        let year = date.getFullYear();
        let month = date.getMonth() + 1;
        let day = date.getDate();
        return `${year}年${month}月${day}日`
    })
    var app = new Vue({
        el: "#app",
        data: {
            list: {},
            fileList: [],
            file: null,
            flag: true,
        },
        methods: {
            submitUpload() {
                //this.$refs.upload.submit();
                let form = new FormData();
                form.append("fileup", this.file)
                form.get("fileup");
                axios.post('/Small_Sample/Upload_small_Sample_report', form).then(res => {
                    console.log(res.data)
                    this.list = res.data;
                    this.flag = false;
                }).catch(err => {
                    this.$message.error('文件上传失败');
                })
            },
            handleRemove(file, fileList) {
                //console.log(file, fileList);
            },
            handlePreview(file) {
                //console.log(file);
            },
            testchange(file, fileList) {
                //console.log(file.raw);
                this.file = file.raw
                console.log(fileList)

            },
            handleExceed(ile, fileList) {
                this.$message.warning(`当前限制选择1个文件`)
            },
            upclick: function () {
                document.getElementById("fileup").click();
            },
            fileChange: function () {
                if (!document.getElementById("fileup").files[0].size) return;
                var obj = new FormData(document.getElementById("myform"));
                obj.append("name", "wzh");
                var _this = this;
                $.ajax({
                    type: 'post',
                    url: '/Small_Sample/Upload_small_Sample_report',
                    data: obj,
                    cache: false,
                    processData: false, // 不处理发送的数据，因为data值是Formdata对象，不需要对数据做处理
                    contentType: false, // 不设置Content-type请求头
                    success: function (data) {
                        if (data != "no") {
                            _this.list = data;
                            console.log(data);  
                            _this.flag = false;
                        } else {
                            alert(data);
                        }
                    },
                });
            },
            saveFile: function () {
                if (this.list != "{}") {
                    this.flag = false;                    
                    var x1 = document.getElementById("testid").innerText;
                    var list1 = this.list;
                    list1.ReportDate = x1;
                    console.log(list1)
                    axios.post("/Small_Sample/Create", { small_Sample:list1 }).then(res => {
                        console.log(res.data)
                    }).catch(err => {

                    })
                } else { };
            },
        },
        watch: {
            list() {
                if (JSON.stringify(this.list) != "{}") {
                    let vallist = [];
                    vallist.push(this.list.Adju_R, this.list.Adju_G, this.list.Adju_B)
                    axios.post("/Small_Sample/Current", { resistances: vallist, ic_type: this.list.IC3 }).then(res => {
                        if (parseInt(res.data[0]).toFixed(2) != parseInt(this.list.IC_R1).toFixed(2)) {
                            $(".targetOne").addClass("color")
                            $(".targetOne").attr('title', res.data[0])
                        } else {
                            $(".targetOne").removeClass("color")
                            $(".targetOne").removeAttr("title")
                        };
                        if (parseInt(res.data[1]).toFixed(2) != parseInt(this.list.IC_G1).toFixed(2)) {
                            $(".targetTwo").addClass("color")
                            $(".targetTwo").attr("title", res.data[1])
                        } else {
                            $(".targetTwo").removeClass("color");
                            $(".targetTwo").removeAttr("title")
                        };
                        if (parseInt(res.data[2]).toFixed(2) != parseInt(this.list.IC_B1).toFixed(2)) {
                            $(".targetThree").addClass("color")
                            $(".targetThree").attr("title", res.data[2])
                        } else {
                            $(".targetThree").removeClass("color")
                            $(".targetThree").removeAttr("title")
                        };
                    }).catch(err => {

                    })
                };

                //白色亮度确认
                var rgbs = ((this.list.Angle_R1 + this.list.Angle_G1 + this.list.Angle_B1) * 0.98).toFixed(2);
                var rgb1 = ((this.list.Angle_R1 + this.list.Angle_G1 + this.list.Angle_B1) * 1.02).toFixed(2);
                if (rgbs > this.list.Angle_W1 || this.list.Angle_W1 > rgb1) {
                    $(".luminance").removeClass("pass")
                    $(".luminance").addClass("red")
                    $(".luminance").attr("title", 'R+G+B之和应在' + rgbs + '-' + rgb1 + '之间')
                } else {
                    $(".luminance").removeClass("red")
                    $(".luminance").addClass("pass")
                    $(".luminance").removeAttr("title")
                };

                //白色温度确认
                if (this.list.Client_W2 === 8500) { //8500K
                    if (0.285 > this.list.Angle_W2 || this.list.Angle_W2 > 0.291) {
                        $(".colorTmin").removeClass("pass")
                        $(".colorTmin").addClass("red")
                        $(".colorTmin").attr("title", '色温范围应在0.285-0.291之间')
                    } else {
                        $(".colorTmin").removeClass("red")
                        $(".colorTmin").addClass("pass")
                        $(".colorTmin").removeAttr("title")
                    };
                    if (0.302 > this.list.Angle_W3 || this.list.Angle_W3 > 0.308) {
                        $(".colorTmax").removeClass("pass")
                        $(".colorTmax").addClass("red")
                        $(".colorTmax").attr("title", '色温范围应在0.302-0.308之间')
                    } else {
                        $(".colorTmax").removeClass("red")
                        $(".colorTmax").addClass("pass")
                        $(".colorTmax").removeAttr("title")
                    };
                } else if (this.list.Client_W2 === 6500) { //6500K
                    if (0.310 > this.list.Angle_W2 || this.list.Angle_W2 > 0.316) {
                        $(".colorTmin").removeClass("pass")
                        $(".colorTmin").addClass("red")
                        $(".colorTmin").attr("title", '色温范围应在0.310-0.316之间')
                    } else {
                        $(".colorTmin").removeClass("red")
                        $(".colorTmin").addClass("pass")
                        $(".colorTmin").removeAttr("title")

                    };
                    if (0.325 > this.list.Angle_W3 || this.list.Angle_W3 > 0.331) {
                        $(".colorTmax").removeClass("pass")
                        $(".colorTmax").addClass("red")
                        $(".colorTmax").attr("title", '色温范围应在0.325-0.331之间')
                    } else {
                        $(".colorTmax").removeClass("red")
                        $(".colorTmax").addClass("pass")
                        $(".colorTmax").removeAttr("title")

                    }
                } else { };

                //白平衡确认
                if (this.list.Client_W1 === '校正前') {
                    //console.log("这是校正前")
                    var minq = (this.list.Client_W1_V * 1.1 * 0.97).toFixed(2);
                    var maxq = (this.list.Client_W1_V * 1.1 * 1.03).toFixed(2);
                    if (minq > this.list.Angle_W1 || this.list.Angle_W1 > maxq) {
                        $(".front").removeClass("pass")
                        $(".front").addClass("red")
                        $(".front").attr("title", '白平衡范围应在' + minq + '-' + maxq + '之间')
                    } else {
                        $(".front").removeClass("red")
                        $(".front").addClass("pass")
                        $(".front").removeAttr("title")
                    }
                } else if (this.list.Client_W1 === '校正后') {
                    //console.log("这是校正后")
                    var minh = (this.list.Client_W1_V * 1.17 * 0.97).toFixed(2);
                    var maxh = (this.list.Client_W1_V * 1.17 * 1.03).toFixed(2);
                    if (minh > this.list.Angle_W1 || this.list.Angle_W1 > maxh) {
                        $(".front").removeClass("pass")
                        $(".front").addClass("red")
                        $(".front").attr("title", '白平衡范围应在' + minh + '-' + maxh + '之间')
                    } else {
                        $(".front").removeClass("red")
                        $(".front").addClass("pass")
                        $(".front").removeAttr("title")
                    }
                } else { };

                //单板电流确认
                if (this.list.Mo1 != '' || null) {
                    axios.post("/Small_Sample/IC_ModelRange", {
                        IC_R1: this.list.IC_R1,
                        IC_G1: this.list.IC_G1,
                        IC_B1: this.list.IC_B1,
                        Points: this.list.Points,
                        Scanningway: this.list.Scanningway,
                        Mo1: this.list.Mo1
                    }).then(res => {
                        //console.log(res.data)
                        var arry = {};
                        arry = res.data;
                        //console.log(arry.最高值)
                        if (arry.最低值 > this.list.Module_current || this.list.Module_current > arry.最高值) {
                            $(".electricity").removeClass("pass")
                            $(".electricity").addClass("red")
                            $(".electricity").attr("title", '单板电流应在' + arry.最低值 + '-' + arry.最高值 + '之间')
                        } else {
                            $(".electricity").removeClass("red")
                            $(".electricity").addClass("pass")
                            $(".electricity").removeAttr("title")
                        }
                    }).catch(err => {

                    })
                };

            }
        }
    });
</script>