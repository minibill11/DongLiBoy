@{
    ViewBag.Title = "内箱装箱确认";
}
@*<script src="~/Scripts/vue.js"></script>*@
<script src="~/Scripts/Bootstraps/Element-ui.js"></script>
<link href="~/Scripts/Bootstraps/Element-ui.css" rel="stylesheet" />

<style>
    /*全局样式*/
    *, body {
        margin: 0;
        padding: 0;
    }

    .body-content, .container {
        padding-left: 0px;
        padding-right: 0px;
    }

    #app {
        padding: 50px 0 0;
    }

    .el-header {
        height: auto !important;
        padding: 0;
    }

    .el-main {
        min-height: 600px;
        padding: 20px 0 0;
    }

    [v-cloak] {
        display: none;
    }

    a:hover {
        text-decoration: none;
        color: #000;
    }

    .inputframe {
        width: 300px;
        text-align: right;
        margin: 1px auto;
    }

    .el-input {
        width: 220px;
    }

    .divframe {
        width: 300px;
        margin: 1px auto;
        text-align: center;
        border: 1px solid #ccc;
        max-height: 300px;
    }

    a:hover {
        text-decoration: none;
        color: #000;
    }

    .el-button--small {
        padding: 8px 12px;
    }

    .el-table th {
        padding: 5px 0;
        background-color: #f4df42;
        color: #000;
        text-align: center;
    }

    .el-table td {
        padding: 2px 0;
        text-align: center;
    }

    .el-table .warning-row {
        background: #fcd2d2;
    }

    .el-table .success-row {
        background: #f0f9eb;
    }

    .green {
        color: #67c23a;
    }

    .red {
        color: #f56c6c;
    }

    .adiv {
        display: inline-block;
    }

    .el-message-box {
        width: 300px;
    }

    .el-message {
        min-width: 300px;
    }
</style>

<div id="app" v-cloak>
    <el-container>
        <el-header class="text-center">
            <div v-show="screenSize>=768">
                <h2 class="text-center">@ViewBag.Title</h2>
                <a href="/Packagings/board"><el-button size="small">产值看板</el-button></a>
                <a href="/Packagings/inputPackaging"><el-button size="small">录入包装箱基本信息</el-button></a>
                @*<a href="/Packagings/insidePrint"><el-button size="small">内箱标签打印</el-button></a>*@
                <div class="adiv" href="/Packagings/insideConfirm"><el-button size="small" type="primary" plain disabled style="cursor:default">内箱装箱确认</el-button></div>
                @*<a href="/Packagings/outsideBinningPrint"><el-button size="small">外箱(重新)装箱和标签打印</el-button></a>
                            <a href="/Packagings/outsideConfirm"><el-button size="small">外箱装箱确认</el-button></a>
                            <a href="/Packagings/inStockConfirm"><el-button size="small">外箱入库确认</el-button></a>
                            <a href="/Packagings/PingZhioutStockConfirm"><el-button size="small">品质外箱入库确认</el-button></a>
                    <a href="/Packagings/stockNumEdit"><el-button size="small">外箱库位号修改</el-button></a>
                    <a href="/Packagings/outStockConfirm"><el-button size="small">外箱出库确认</el-button></a>*@
            </div>
            <div v-show="screenSize<768">
                <h3>@ViewBag.Title</h3>
                <el-dropdown placement="bottom">
                    <el-button size="medium ">
                        更多菜单<i class="el-icon-arrow-down el-icon--right"></i>
                    </el-button>
                    <el-dropdown-menu slot="dropdown">
                        <a href="/Packagings/board"><el-dropdown-item>产值看板</el-dropdown-item></a>
                        <a href="/Packagings/inputPackaging"><el-dropdown-item>录入包装箱基本信息</el-dropdown-item></a>
                        @*<a href="/Packagings/insidePrint"><el-dropdown-item>内箱标签打印</el-dropdown-item></a>*@
                        <div href="/Packagings/insideConfirm"><el-dropdown-item disabled>内箱装箱确认</el-dropdown-item></div>
                        @*<a href="/Packagings/outsideBinningPrint"><el-dropdown-item>外箱(重新)装箱和标签打印</el-dropdown-item></a>
                            <a href="/Packagings/outsideConfirm"><el-dropdown-item>外箱装箱确认</el-dropdown-item></a>
                                            <a href="/Packagings/inStockConfirm"><el-dropdown-item>外箱入库确认</el-dropdown-item></a>
                                            <a href="/Packagings/PingZhioutStockConfirm"><el-dropdown-item>品质外箱入库确认</el-dropdown-item></a>
                                            <a href="/Packagings/stockNumEdit"><el-dropdown-item>外箱库位号修改</el-dropdown-item></a>
                                            <a href="/Packagings/outStockConfirm"><el-dropdown-item>外箱出库确认</el-dropdown-item></a>*@
                    </el-dropdown-menu>
                </el-dropdown>
            </div>
        </el-header>
        <el-main v-loading="loading">
            <el-row>
                <div class="text-center">
                    <div class="inputframe">
                        <span>订单号：</span>
                        <el-select v-model="selectVal" placeholder="输入内容可查询" filterable clearable size="medium" :disabled="mozutable.length>0">
                            <el-option v-for="item in selectOptions"
                                       :key="item.value"
                                       :value="item.value">
                            </el-option>
                        </el-select>
                    </div>
                    <div class="inputframe">
                        <span class="inputtext">条码数量：</span>
                        <el-input-number v-model.trim="barCount"
                                         size="medium"
                                         :min="1"
                                         style="width:auto"
                                         :disabled="mozutable.length>0"
                                         clearable>
                        </el-input-number>
                    </div>
                    <div class="inputframe">
                        <el-button size="medium" @@click="clear">重置</el-button>
                        <el-button size="medium" @@click="confirmCheck">确认</el-button>
                    </div>
                </div>
            </el-row>
            <el-row style="text-align:center;margin-top:20px;">
                <div style="display:inline-block">
                    <div class="inputframe" v-if="mozutable.length==barCount">
                        <span>内箱条码：</span>
                        <el-input placeholder="请输入条码号"
                                  v-model.trim="innerVal"
                                  style="text-align:right;display:inline-block;"
                                  onKeyUp="value=value.replace(/[^A-Za-z0-9]/g, '')"
                                  v-on:keyup.enter.native="innerscan"
                                  maxlength="15"
                                  size="medium"
                                  :disabled="innertable.length==barCount"
                                  clearable>
                        </el-input>
                    </div>
                    <div class="inputframe" v-else>
                        <span>模组条码：</span>
                        <el-input placeholder="请输入模组号"
                                  v-model.trim="printMozhu"
                                  style="text-align:right;display:inline-block;"
                                  v-on:keyup.enter.native="mozuscan"
                                  maxlength="15"
                                  size="medium"
                                  :disabled="mozutable.length==barCount"
                                  clearable>
                        </el-input>
                    </div>
                    <div class="divframe">
                        <el-table :data="mozutable"
                                  border
                                  :row-class-name="tableRowClassName">
                            <el-table-column prop="barcode"
                                             label="条码号"
                                             width="150">
                            </el-table-column>
                            <el-table-column prop="boxcode"
                                             label="箱体号">
                            </el-table-column>
                            <el-table-column prop="edit"
                                             label=""
                                             width="50">
                                <template slot-scope="scope">
                                    <el-button @@click.native.prevent="deleteRow(scope.$index,scope.row ,mozutable)"
                                               type="text"
                                               size="mini"
                                               style="margin:0;padding:0;width:100%;"
                                               :class="scope.row.status=='success'?'green':scope.row.status=='warning'?'red':''">
                                        <i class="el-icon-error"></i>
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>
                    <div class="divframe">
                        <el-table :data="innertable"
                                  border
                                  :row-class-name="tableRowClassName"
                                  :header-row-style="headerRowStyle">
                            <el-table-column prop="barcode"
                                             label="条码号"
                                             width="150">
                            </el-table-column>
                            <el-table-column prop="boxcode"
                                             label="箱体号">
                            </el-table-column>
                            <el-table-column prop="edit"
                                             label=""
                                             width="50">
                                <template slot-scope="scope">
                                    <el-button @@click.native.prevent="deleteRow(scope.$index,scope.row, innertable)"
                                               type="text"
                                               size="mini"
                                               style="margin:0;padding:0;width:100%;"
                                               :class="scope.row.status=='success'?'green':scope.row.status=='warning'?'red':''">
                                        <i class="el-icon-error"></i>
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>
                </div>
            </el-row>
        </el-main>
    </el-container>
</div>
<script>
    var app = new Vue({
        el: "#app",
        data: {
            innerVal: "",
            printMozhu: "",
            selectOptions: [],
            selectVal: '',
            mozutable: [],
            innertable: [],
            screenSize: document.body.clientWidth,
            loading: false,
            barCount: 2
        },
        created: function () {
            axios.post('/Packagings/GetOrderList').then(rer => {
                this.selectOptions = rer.data;
            }).catch(err => {
                console.warn("获取选择列表失败")
            });
            window.onresize = function () {
                app.screenSize = document.body.clientWidth;
            };
        },
        mounted: function () {
            let localOrder = localStorage.getItem('Order');
            if (localOrder != null) {
                this.selectVal = localOrder;
            };
            let localbarCount = localStorage.getItem('innerCount');
            if (localbarCount != null) {
                this.barCount = localbarCount;
            };
        },
        methods: {
            mozuscan: function () {
                if (this.printMozhu.length == 15) {
                    this.loading = true;
                    //检查重复
                    for (let i in this.mozutable) {
                        if (this.mozutable[i].barcode == this.printMozhu) {
                            this.$message({
                                showClose: true,
                                duration: 5000,
                                dangerouslyUseHTMLString: true,
                                message: '<h4 style="margin:0">已有重复条码！</h4>',
                                type: 'warning'
                            });
                            this.loading = false;
                            return;
                        };
                    };

                    //验证条码号和所选订单是否匹配
                    axios.post('/Packagings/IsCheckBarcode',
                        {
                            ordernum: this.selectVal,
                            barcode: this.printMozhu,
                            isInner:true,
                        }
                    ).then(res => {
                        if (res.data == true) {
                            this.getNum(this.printMozhu, this.mozutable, "printMozhu");
                        } else {
                            this.$message({
                                showClose: true,
                                duration: 5000,
                                dangerouslyUseHTMLString: true,
                                message: '<h4 style="margin:0">' + res.data + '</h4>',
                                type: 'error'
                            });
                            this.loading = false;
                        };
                    }).catch(err => {
                        console.warn("验证失败")
                    });
                };
            },
            innerscan: function () {
                if (this.innerVal.length == 15) {
                    this.loading = true;
                    //检查重复
                    for (let i in this.innertable) {
                        if (this.innertable[i].barcode == this.innerVal) {
                            this.$message({
                                showClose: true,
                                duration: 5000,
                                dangerouslyUseHTMLString: true,
                                message: '<h4 style="margin:0">已有重复条码！</h4>',
                                type: 'warning'
                            });
                            this.loading = false;
                            return;
                        };
                    };

                    //验证条码号和所选订单是否匹配
                    axios.post('/Packagings/IsCheckBarcode',
                        {
                            ordernum: this.selectVal,
                            barcode: this.innerVal,
                            isInner: true,
                        }
                    ).then(res => {
                        if (res.data == true) {
                            this.getNum(this.innerVal, this.innertable, "innerVal");
                        } else {
                            this.$message({
                                showClose: true,
                                duration: 5000,
                                dangerouslyUseHTMLString: true,
                                message: '<h4 style="margin:0">' + res.data + '</h4>',
                                type: 'error'
                            });
                            this.loading = false;
                        };
                    }).catch(err => {
                        console.warn("验证失败")
                    });
                };
            },
            //获取箱体号
            getNum: function (bar, table, text) {
                axios.post('/Packagings/GetModulbarCode',
                    { barcode: bar }
                ).then(res => {
                    //console.log(res.data)
                    table.push({
                        barcode: bar,
                        boxcode: res.data,
                        status: ""
                    });
                    if (text == "printMozhu") {
                        this.printMozhu = "";
                    } else {
                        this.innerVal = "";
                    };
                    this.loading = false;
                }).catch(err => {
                    console.warn("获取模组号失败")
                });
            },
            //删除行
            deleteRow: function (index, row, data) {
                data.splice(index, 1);
            },
            //确认按钮
            confirmCheck: function () {
                let mozu = this.mozutable, inner = this.innertable, iswarning = 0;
                //验证模组表
                for (let m in mozu) {
                    let isok = 0;
                    for (let i in inner) {
                        if (mozu[m].barcode == inner[i].barcode) {
                            mozu[m].status = "success";
                            isok = 1;
                        };
                    };
                    if (isok == 0) {
                        mozu[m].status = "warning";
                        iswarning++;
                    };
                };
                //验证内箱表
                for (let i in inner) {
                    let isok = 0;
                    for (let m in mozu) {
                        if (inner[i].barcode == mozu[m].barcode) {
                            inner[i].status = "success";
                            isok = 1;
                        };
                    };
                    if (isok == 0) {
                        inner[i].status = "warning";
                        iswarning++;
                    };
                };

                if (iswarning == 0) {
                    //存入记录
                    let packingInnerChecks = [];
                    for (let i in mozu) {
                        packingInnerChecks.push({
                            OrderNum: this.selectVal,
                            Barcode: mozu[i].barcode,
                            ModuleNum: mozu[i].boxcode,
                        });
                    };

                    axios.post('/Packagings/InnerBoxCheck',
                        { packing_InnerChecks: packingInnerChecks }
                    ).then(res => {
                        //console.log(res.data);
                        if (res.data == true) {
                            this.$confirm('<h4 style="margin:0">是否进行下一组验证?</h4>', '确认成功!', {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'success',
                                center: true,
                                dangerouslyUseHTMLString: true,
                            }).then(() => {
                                this.clear();
                            }).catch(() => {
                            });
                        } else {
                            this.$message({
                                showClose: true,
                                duration: 5000,
                                dangerouslyUseHTMLString: true,
                                message: '<h4 style="margin:0">确认不成功</h4>',
                                type: 'error'
                            });
                        };
                    }).catch(err => {
                        console.warn("确认失败")
                    });
                } else {
                    this.$message({
                        showClose: true,
                        duration: 5000,
                        dangerouslyUseHTMLString: true,
                        message: '<h4 style="margin:0">检验完成，共有' + iswarning + '个条码不对！</h4>',
                        type: 'error'
                    });
                };

            },
            //行颜色
            tableRowClassName({ row, rowIndex }) {
                if (row.status == "success") {
                    return 'success-row';
                } else if (row.status == "warning") {
                    return 'warning-row';
                };
                return '';
            },
            //表头样式
            headerRowStyle({ row, rowIndex }) {
                return 'display:none';
            },
            //重置
            clear: function () {
                this.innerVal = "";
                this.printMozhu = "";
                this.mozutable = [];
                this.innertable = [];
                this.$message({
                    showClose: true,
                    dangerouslyUseHTMLString: true,
                    message: '<h4 style="margin:0">重置完毕</h4>'
                });
            }
        },
        watch: {
            //订单号
            selectVal: function (v) {
                localStorage.setItem('Order', v);
            },
            barCount: function (v) {
                localStorage.setItem("innerCount", v)
            }
        },
    });
</script>