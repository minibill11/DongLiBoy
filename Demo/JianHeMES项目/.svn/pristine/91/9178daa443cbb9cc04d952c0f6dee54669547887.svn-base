
@{
    ViewBag.Title = "SPC_MaterialLablePrint";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Content/styleFile/packaging/index.css" rel="stylesheet" />
<script src="~/Content/styleFile/packaging/index.js"></script>
<script src="~/Scripts/axios.min.js"></script>
<script src="~/Scripts/printJS/JsBarcode.all.min.js"></script>
<style>
    .query {
        width: 300px;
        text-align: right;
        margin: 2px auto;
    }
</style>
<div id="app">
    <div style="text-align:center">
        <h3>备品、配件物料标签打印</h3>
        <a href="/Packagings/SPC_Addbasic_information"><el-button size="small" class="cret" type="primary" plain>物料基本信息录入</el-button></a>
        <a href="/Packagings/SPC_Display" style="margin-left:2px"><el-button size="small" type="primary" plain>查询基本信息</el-button></a>
        <a href="/Packagings/SPC_Packaging" style="margin-left:2px"><el-button size="small" type="primary" plain>打印外箱标签</el-button></a>
        <a href="/Packagings/SPC_Packaging_Modify"><el-button size="small" class="cret" type="primary" plain>修改包装信息</el-button></a>
        <a href="/Packagings/SPC_StockConfirm"><el-button size="small" type="primary" plain style="margin:2px">备料确认</el-button></a>
    </div>
    <el-main v-loading="loading">
        <div class="query">

            订单号：
            <el-select v-model="orderNum" placeholder="请选择订单号" size="medium" allow-create filterable clearable>
                <el-option v-for="item in options"
                           :key="item.value"
                           :value="item.value">
                </el-option>
            </el-select>
        </div>
        <div class="query">
            <span>选打印机：</span>
            <el-select v-model="printProt" clearable placeholder="选择打印机" size="medium">
                <el-option v-for="item in printOptions"
                           :key="item.value"
                           :label="item.label"
                           :value="item.value">
                </el-option>
            </el-select>
        </div>
        <div class="query" style="text-align:center;min-height:0;max-height:200px;margin-top:5px;width:300px">
            <el-button v-on:click="lookImage" size="mini" plain type="primary" style="margin-left:40px">查看勾选条码</el-button>
            <el-button v-on:click="printMaterialBarcode" size="mini" plain type="primary">打印选中的物料条码</el-button><br />
            <el-checkbox @@change="CheckAll" size="mini" border style="padding:1px 3px;height:22px;margin:1px">全选</el-checkbox>
            <span style="color:#409EFF">此订单已存在条码：</span>
            <div style="max-height:150px;overflow:auto">
                <template v-for="item in MaterialList">
                    <el-checkbox v-model="item.state" size="mini" border style="padding:1px 3px;height:22px;margin:1px">{{item.value}}</el-checkbox>
                </template>
            </div>
        </div>
        <el-row class="text-center">
            <div id="img"></div>
        </el-row>
    </el-main>
</div>
<script>
    var app = new Vue({
        el: '#app',
        data: {
            orderNum: '', //订单号
            options: [],  //订单号选项
            printProt: '',//打印机
            printOptions: printIpAddress, //打印机选项
            materialName: '',
            specifications: '',
            visi: false,
            MaterialList: [],
            imgNumber: 0,  //用于空值加载
            loading: false,

        },
        //获取订单号
        mounted() {
            axios.post('/Packagings/GetOrderList').then(res => {
                this.options = res.data;
            }).catch(err => {
                console.warn("获取选择列表失败")
            });
            let printIP = localStorage.getItem('printIP');
            if (printIP != null) {
                this.printProt = printIP;
            };
        },
        methods: {
            //查看选中的条码图片
            lookImage: function () {
                let arr = this.MaterialList, postList = [];  //勾选的数组
                if (arr.length > 0) {
                    for (let i in arr) {
                        if (arr[i].state == true) {
                            postList.push(arr[i].value);

                        };
                    };
                    if (postList.length > 0) {
                        $("#img>img").remove();
                        this.loading = true;
                        this.imgNumber = 0;
                        for (let i in postList) {
                            this.getPicture(postList[i], postList.length);
                        };
                    } else {
                        this.$message({
                            showClose: true,
                            message: '没有勾选查询清单！',
                            type: 'error'
                        });
                    };
                } else {
                    this.$message({
                        showClose: true,
                        message: '没有可查询的清单！',
                        type: 'error'
                    });
                };
            },
            //输出查询出的图片
            getPicture: function (materialNumber, number) {
                axios.post('/Packagings/Outspc_MaterialLableToImg', {
                    materialNumber: materialNumber,
                    orderNum: this.orderNum
                }, {
                        responseType: "arraybuffer",
                    }).then(function (response) {
                        return 'data:image/png;base64,' + btoa(
                            new Uint8Array(response.data).reduce((data, byte) => data + String.fromCharCode(byte), '')
                        );
                    }).then(function (data) {
                        let cc = new Image();
                        cc.src = data;
                        document.getElementById("img").appendChild(cc);
                        app.imgNumber++;
                        if (app.imgNumber == number) {
                            app.loading = false;
                        };
                    }).catch(err => {
                        app.imgNumber++;
                        if (app.imgNumber == number) {
                            app.loading = false;
                        };
                        console.warn("显示失败");
                    });
            },
            //打印勾选中的物料条码
            printMaterialBarcode() {
                let arr = this.MaterialList, postList1 = [];
                if (arr.length > 0) {
                    for (let i in arr) {
                        if (arr[i].state == true) {
                            postList1.push(arr[i].value);
                        };
                    };
                    console.log(postList1)
                    if (postList1.length > 0) {
                        this.loading = true;
                        this.imgNumber = 0;
                        for (let i in postList1) {
                            axios.post('/Packagings/Outspc_MaterialLableAgain', {
                                materialNumber: postList1[i],  //物料号
                                orderNum: this.orderNum,       //订单号
                                ip: this.printProt,            //ip地址
                                port: 9101,                   //端口
                            }
                                //, {
                                //        responseType: "arraybuffer",
                                //    }).then(function (response) {
                                //        return 'data:image/png;base64,' + btoa(
                                //            new Uint8Array(response.data).reduce((data, byte) => data + String.fromCharCode(byte), '')
                                //        );
                                //    }).then(function (data) {
                                //        let aa = new Image();
                                //        aa.src = data;
                                //        document.getElementById("img").appendChild(aa);
                                //        app.imgNumber++;
                                //        if (app.imgNumber == postList1.length) {
                                //            app.loading = false;
                                //        };
                                //    }).catch(err => {
                                //        app.imgNumber++;
                                //        if (app.imgNumber == postList1.length) {
                                //            app.loading = false;
                                //        };
                                //        console.warn("显示失败");
                                //    });

                            ).then(res => {
                                if (res.data == '打印成功！') {
                                    this.$message({
                                        showClose: true,
                                        message: res.data,
                                        type: 'success'
                                    });
                                } else {
                                    this.$message({
                                        showClose: true,
                                        message: res.data,
                                        type: 'error'
                                    });
                                };
                                this.imgNumber++;
                                if (this.imgNumber == postList1.length) {
                                    this.loading = false;
                                };
                            }).catch(err => {
                                this.$message({
                                    showClose: true,
                                    message: '打印出错！',
                                    type: 'error'
                                });
                                this.imgNumber++;
                                if (this.imgNumber == postList1.length) {
                                    this.loading = false;
                                };
                            });
                        };
                    } else {
                        this.$message({
                            showClose: true,
                            message: '没有勾选条码！',
                            type: 'error'
                        });
                    };
                } else {
                    this.$message({
                        showClose: true,
                        message: '条码清单为空！',
                        type: 'error'
                    });
                };
            },
            //全选按钮
            CheckAll: function (v) {
                let checkList = this.MaterialList;
                for (let i in checkList) {
                    checkList[i].state = v;
                };
            },
        },
        watch: {
            materialNumber() {
                if (this.materialNumber == '') {
                    $("#imgcode").empty();
                    this.materialName = ''
                    this.specifications = ''
                }
            },
            orderNum() {
                if (this.orderNum != '') {
                    axios.post("/Packagings/Get_SPC_MaterialInfo", {
                        orderNumber: this.orderNum
                    }).then(res => {
                        if (res.data != []) {
                            let arr = res.data;
                            list = this.MaterialList
                            for (let item in arr) {
                                list.push({
                                    value: arr[item],
                                    state: false
                                })
                            }
                        }
                    }).catch(err => {
                        console.warn("出错")
                    })
                } else {
                    this.MaterialList = [];
                }
            }
        }
    })
</script>
