@model IEnumerable<JianHeMES.Models.Personnel_Reasons_for_leaving>

@{
    ViewBag.Title = "Index";
}
<link href="~/Scripts/Bootstraps/Element-ui.css" rel="stylesheet" />
<script src="~/Scripts/Bootstraps/Element-ui.js"></script>
<script src="~/Scripts/axios.min.js"></script>
<script src="~/Scripts/echarts.js"></script>
@*<h2>Index</h2>*@
<style>
    .el-table--small th,.el-table .cell, .el-table th div,.el-table--small td,.el-table .cell,.el-table .cell{
        padding:2px;
        padding-left:2px !important;
    }
    .el-button--mini{
        padding:5px;
    }
    .timePicker{
        text-align:center;
        margin: 15px auto;
    }
    .echartContainer {
        display: flex;
        justify-content: space-between;
        margin-top:10px;
      }

      #lineMain {
        margin: 0 auto;
        width: 48%;
        height: 300px;
      }

      #lineMain2 {
        margin: 0 auto;
        width: 48%;
        height: 300px;
      }
</style>
<p>
    @Html.ActionLink("Create New", "Create")
</p>

<div id="app">
    <div class="timePicker" >
        <el-date-picker v-model="times"
                        type="month"
                        size="small"
                        placeholder="选择月">
        </el-date-picker>
        各部门离职情况汇总
    </div>
    <el-table v-bind:data="tableData" style="width: 100%" size="small" show-summary v-bind:summary-method="getSummaries" v-loading.fullscreen="loading" >
        <el-table-column prop="department" label="部门" align="center" width="110" >
            <template slot-scope="scope">
                <el-popover placement="right"
                            width="auto"
                            trigger="click">
                    <el-table class="test" v-bind:data="gridData" max-height="450" size="small" >
                        <el-table-column width="50" align="center" property="Name" label="姓名"></el-table-column>
                        <el-table-column width="60" align="center" property="jobNum" label="工号"></el-table-column>
                        <el-table-column width="80" align="center" property="department" label="部门"></el-table-column>
                        <el-table-column width="80" align="center" property="Position" label="职位"></el-table-column>
                        <el-table-column width="50" align="center" property="levelType" label="族群"></el-table-column>
                        <el-table-column width="80" align="center" property="DP_group" label="组名"></el-table-column>
                        <el-table-column width="250" align="center" property="Remark" label="备注"></el-table-column>
                        <el-table-column width="60" align="center" property="Department_of_conclusion" label="部门结论"></el-table-column>
                        <el-table-column width="60" align="center" property="HR_conclusion" label="人事结论"></el-table-column>
                        <el-table-column width="50" align="center" property="Pay_dissatisfaction" label="薪酬不满意"></el-table-column>
                        <el-table-column width="50" align="center" property="NotSystem" label="制度不满意"></el-table-column>
                        <el-table-column width="50" align="center" property="Notmanagement" label="管理不满意"></el-table-column>
                        <el-table-column width="60" align="center" property="Jobenvironment" label="工作环境不满意"></el-table-column>
                        <el-table-column width="50" align="center" property="Better_development" label="更好的发展"></el-table-column>
                        <el-table-column prop="date" label="操作" align="center" width="108">
                            <template slot-scope="scope">
                                <el-button size="mini" v-on:click="handleEdit(scope.$index, scope.row)">编辑</el-button>
                                <el-button size="mini" style="display:none;" v-on:click="handleSave(scope.$index, scope.row)">保存</el-button>
                                <el-button size="mini" style="display:none;" v-on:click="handleCancel(scope.$index, scope.row)">取消</el-button>
                                <el-button size="mini" type="danger" v-on:click="handleDelete(scope.$index, scope.row)">删除</el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                    <el-button slot="reference" size="small" v-on:click="showDetials(scope.$index, scope.row)" >{{scope.row.department}}</el-button>
                </el-popover>
            </template>
        </el-table-column>
        <el-table-column prop="begin_day_of_month" align="center" label="月初人数" width="60">
        </el-table-column>
        <el-table-column prop="end_day_of_month" align="center" label="月末人数" width="60">
        </el-table-column>
        <el-table-column prop="average" align="center" label="平均人数" width="40">
        </el-table-column>
        <el-table-column prop="ru_departure_sum" align="center" label="入职人数" width="60">
        </el-table-column>
        <el-table-column prop="li_departure_sum" align="center" label="离职人数" width="60">
        </el-table-column>
        <el-table-column align="center" label="离职族群汇总">
            <el-table-column prop="levelTypecaozuo" align="center" label="操作族" width="55">
            </el-table-column>
            <el-table-column prop="levelTypejishu" align="center" label="技术族" width="55">
            </el-table-column>
            <el-table-column prop="levelTypezhuanye" align="center" label="专业族" width="55">
            </el-table-column>
            <el-table-column prop="levelTypefuwu" align="center" label="服务族" width="55">
            </el-table-column>
            <el-table-column prop="levelTypeguanli" align="center" label="管理族" width="55">
            </el-table-column>
        </el-table-column>
        <el-table-column align="center" label="离职原因">
            <el-table-column align="center" prop="py_couxin" label="薪酬不满意" width="70">
            </el-table-column>
            <el-table-column align="center" prop="py_zhidu" label="制度不满意" width="70">
            </el-table-column>
            <el-table-column align="center" prop="py_guan" label="管理不满意" width="70">
            </el-table-column>
            <el-table-column align="center" prop="py_gong" label="工作环境不满意" width="95">
            </el-table-column>
            <el-table-column align="center" prop="py_geng" label="更好的发展" width="70">
            </el-table-column>
        </el-table-column>
        <el-table-column prop="for_leaving" align="center" label="离职率
（含入职未满7天人员）" width="98">
        </el-table-column>
        
    </el-table>
    
    <el-table v-bind:data="tableBottmData" style="width: 100%;margin-top:10px;" size="small" show-summary v-bind:summary-method="bottomGetSummaries" >
        <el-table-column v-bind:label=`${Year}${Months}员工离职原因` align="center">
            <el-table-column prop="taps" align="center" label="离职原因" width="35">
            </el-table-column>
            <el-table-column align="center" label="操作族" width="100">
                <el-table-column prop="cause_couxin" align="center" label="薪酬不满意" width="48">
                </el-table-column>
                <el-table-column prop="cause_zhidu" align="center" label="制度不满意" width="69">
                </el-table-column>
                <el-table-column prop="cause_guanli" align="center" label="管理不满意" width="69">
                </el-table-column>
                <el-table-column prop="cause_gongzuo" align="center" label="工作环境不满意" width="82">
                </el-table-column>
                <el-table-column prop="cause_fazhang" align="center" label="更好的发展" width="69">
                </el-table-column>
            </el-table-column>
            <el-table-column prop="date" align="center" label="非操作族" width="100">
                <el-table-column prop="leave_xinzi" align="center" label="薪酬不满意" width="69">
                </el-table-column>
                <el-table-column prop="leave_zhidu" align="center" label="制度不满意" width="69">
                </el-table-column>
                <el-table-column prop="leave_guanli" align="center" label="管理不满意" width="69">
                </el-table-column>
                <el-table-column prop="leave_huanji" align="center" label="工作环境不满意" width="82">
                </el-table-column>
                <el-table-column prop="leave_genghao" align="center" label="更好的发展" width="69">
                </el-table-column>
            </el-table-column>
            <el-table-column prop="date" align="center" label="各项小计" width="100">
                <el-table-column prop="Pay_diss" align="center" label="薪酬不满意" width="69">
                </el-table-column>
                <el-table-column prop="System" align="center" label="制度不满意" width="69">
                </el-table-column>
                <el-table-column prop="management" align="center" label="管理不满意" width="69">
                </el-table-column>
                <el-table-column prop="Joben" align="center" label="工作环境不满意" width="82">
                </el-table-column>
                <el-table-column prop="Better" align="center" label="更好的发展" width="69">
                </el-table-column>
            </el-table-column>
            <el-table-column prop="cause_heji" align="center" label="合计" width="50">
            </el-table-column>
        </el-table-column>
    </el-table>
    @*{{Year}}*@
    <div class="echartContainer">
        <div id="lineMain"></div>
        <div id="lineMain2"></div>
    </div>
</div>



<script>
      var vm = new Vue({
        el: "#app",
        data: {
            flags:false,
            gridData:[],
            times: "",
            Year:'',
            Months:'',
            loading: false,
            totalCompleteRange:'',
            tableData: [],  //表格加载的数据必须是数组，否则报错
            tableBottmData:[],
            tableBottomRange:'',
            coporationTypeVal:[],
            leavingRangr:[],
            trOldVal:'',  //点击编辑之前的本行的数据---为了取消保存时方便给本行重新 赋值
        },
        methods: {
            handleEdit(index, row) {
                this.trOldVal = row;
                var targetTr = $(".test .el-table__body .el-table__row")
                console.log(index);
               // console.log(row);
                console.log(targetTr);

              //  var targetTr = $(".test .el-table__body .el-table__row")[index];
              //  console.log(targetTr)
              //  targetTr.children[0].innerHTML = "<input type='text' value=" + row.Name + " />";
              //  targetTr.children[1].innerHTML = "<input type='text' value=" + (row.jobNum==undefined ? '' : row.jobNum) + " >";
              //  targetTr.children[2].innerHTML = "<input type='text' value=" + (row.department == undefined ? '' : row.department) + " >";
              //  targetTr.children[3].innerHTML = "<input type='text' value=" + (row.DP_group == undefined ? '' : row.DP_group) + " >";
              //  targetTr.children[4].innerHTML = "<input type='text' value=" + (row.position == undefined ? '' : row.position) + " >";
              //  targetTr.children[5].innerHTML = "<input type='text' value=" + (row.agent == undefined ? '' : row.agent) + " >";
              //console.log(index, row);
          },
          handleDelete(index, row) {
            console.log(index, row);
          },
          getInfos() {
              this.tableData = [];
              this.tableBottmData = [];
              this.tableBottomRange = '';
              if (this.times != null) {
                  var d = new Date(this.times);
                  var timestamp = Date.parse(new Date());
                  if(d>timestamp){
                      this.$notify({
                          title: '警告',
                          message: '所选时间超前！',
                          type: 'warning'
                      });
                      this.tableData = [];
                      this.tableBottmData = [];
                      this.tableBottomRange = '';
                  }else{
                      this.loading = true;
                      year = d.getFullYear();
                      month = d.getMonth()+1;
                      months = month.toString().padStart(2, '0')
                      this.Year = year + '年';
                      this.Months = months + '月'
                      axios.post("/Personnel_Reasons_for_leaving/For_leaving", { Year: year, Month: months }).then(res=> {
                          for (let item in res.data.for_leaving_Table) {
                              if (item == 'month_average') {
                                  this.totalCompleteRange = res.data.for_leaving_Table[item];
                                  delete res.data.for_leaving_Table[item];
                              }
                          }
                          var arr = [];
                          for (let item in res.data.for_leaving_Table) {
                              res.data.for_leaving_Table[item].average = res.data.for_leaving_Table[item].average=='0'?'':res.data.for_leaving_Table[item].average;
                              res.data.for_leaving_Table[item].begin_day_of_month = res.data.for_leaving_Table[item].begin_day_of_month=='0'?'':res.data.for_leaving_Table[item].begin_day_of_month;
                              res.data.for_leaving_Table[item].end_day_of_month = res.data.for_leaving_Table[item].end_day_of_month=='0'?'':res.data.for_leaving_Table[item].end_day_of_month;
                              res.data.for_leaving_Table[item].levelTypecaozuo = res.data.for_leaving_Table[item].levelTypecaozuo=='0'?'':res.data.for_leaving_Table[item].levelTypecaozuo;
                              res.data.for_leaving_Table[item].levelTypefuwu = res.data.for_leaving_Table[item].levelTypefuwu=='0'?'':res.data.for_leaving_Table[item].levelTypefuwu;
                              res.data.for_leaving_Table[item].levelTypeguanli = res.data.for_leaving_Table[item].levelTypeguanli=='0'?'':res.data.for_leaving_Table[item].levelTypeguanli;
                              res.data.for_leaving_Table[item].levelTypejishu = res.data.for_leaving_Table[item].levelTypejishu=='0'?'':res.data.for_leaving_Table[item].levelTypejishu;
                              res.data.for_leaving_Table[item].levelTypezhuanye = res.data.for_leaving_Table[item].levelTypezhuanye=='0'?'':res.data.for_leaving_Table[item].levelTypezhuanye;
                              res.data.for_leaving_Table[item].li_departure_sum = res.data.for_leaving_Table[item].li_departure_sum=='0'?'':res.data.for_leaving_Table[item].li_departure_sum;
                              res.data.for_leaving_Table[item].py_couxin = res.data.for_leaving_Table[item].py_couxin=='0'?'':res.data.for_leaving_Table[item].py_couxin;
                              res.data.for_leaving_Table[item].py_geng = res.data.for_leaving_Table[item].py_geng=='0'?'':res.data.for_leaving_Table[item].py_geng;
                              res.data.for_leaving_Table[item].py_gong = res.data.for_leaving_Table[item].py_gong=='0'?'':res.data.for_leaving_Table[item].py_gong;
                              res.data.for_leaving_Table[item].py_guan = res.data.for_leaving_Table[item].py_guan=='0'?'':res.data.for_leaving_Table[item].py_guan;
                              res.data.for_leaving_Table[item].py_zhidu = res.data.for_leaving_Table[item].py_zhidu=='0'?'':res.data.for_leaving_Table[item].py_zhidu;
                              res.data.for_leaving_Table[item].ru_departure_sum = res.data.for_leaving_Table[item].ru_departure_sum=='0'?'':res.data.for_leaving_Table[item].ru_departure_sum;
                              arr.push(res.data.for_leaving_Table[item])
                          }
                          res.data.leave_record3.leave_record1.taps = '人数'
                          this.tableBottmData.push(res.data.leave_record3.leave_record1);
                          this.tableBottomRange = res.data.leave_record3.leave_record2;
                          this.tableData = arr;
                          this.loading = false;
                      }).catch(err=>{
                          console.log("请求失败！")
                      })
                  }
                  
              }else{
                  this.tableData = [];
                  this.tableBottmData = [];
                  this.tableBottomRange = '';
              }
          },
          getSummaries(param) {
              const { columns, data } = param;
              const sums = [];
              columns.forEach((column, index) => {
                  if (index === 0) {
                      sums[index] = '总计';
                      return;
                  }else if(index === 16){
                      sums[index] = this.totalCompleteRange;
                      return;
                  }
                  const values = data.map(item => Number(item[column.property]));
                  if (!values.every(value => isNaN(value))) {
                      sums[index] = values.reduce((prev, curr) => {
                          const value = Number(curr);
                          if (!isNaN(value)) {
                              return prev + curr;
                          } else {
                              return prev;
                          }
                      }, 0);
                      sums[index] += ' ';
                  } else {
                      sums[index] = '';
                  }
              });

              return sums;
          },
          bottomGetSummaries(param){
              const { columns, data } = param;
              const sums = [];
              columns.forEach((column, index) => {
                  if (index === 0) {
                      sums[index] = '占比';
                      return;
                  }else if(index === 1){
                      sums[index] = this.tableBottomRange.proportion_couxin;
                      return;
                  }
                  else if(index === 2){
                      sums[index] = this.tableBottomRange.proportion_zhidu;
                      return;
                  }
                  else if(index === 3){
                      sums[index] = this.tableBottomRange.proportion_guanli;
                      return;
                  }
                  else if(index === 4){
                      sums[index] = this.tableBottomRange.proportion_huanji;
                      return;
                  }
                  else if(index === 5){
                      sums[index] = this.tableBottomRange.proportion_genghao;
                      return;
                  }
                  else if(index === 6){
                      sums[index] = this.tableBottomRange.Leaving_salary;
                      return;
                  }
                  else if(index === 7){
                      sums[index] = this.tableBottomRange.Leaving_System;
                      return;
                  }
                  else if(index === 8){
                      sums[index] = this.tableBottomRange.Leaving_management;
                      return;
                  }
                  else if(index === 9){
                      sums[index] = this.tableBottomRange.Leaving_Joben;
                      return;
                  }
                  else if(index === 10){
                      sums[index] = this.tableBottomRange.Leaving_Better;
                      return;
                  }
                  else if(index === 11){
                      sums[index] = this.tableBottomRange.account_couxin;
                      return;
                  }
                  else if(index === 12){
                      sums[index] = this.tableBottomRange.account_zhidu;
                      return;
                  }
                  else if(index === 13){
                      sums[index] = this.tableBottomRange.account_guanli;
                      return;
                  }
                  else if(index === 14){
                      sums[index] = this.tableBottomRange.account_gongzuo;
                      return;
                  }
                  else if(index === 15){
                      sums[index] = this.tableBottomRange.account_fazhang;
                      return;
                  }
                  //const values = data.map(item => Number(item[column.property]));
                  //if (!values.every(value => isNaN(value))) {
                  //    sums[index] = values.reduce((prev, curr) => {
                  //        const value = Number(curr);
                  //        if (!isNaN(value)) {
                  //            return prev + curr;
                  //        } else {
                  //            return prev;
                  //        }
                  //    }, 0);
                  //    sums[index] += ' ';
                  //} else {
                  //    sums[index] = '';
                  //}
              });

              return sums;
          },
          showDetials(index,row){
              this.gridData = [];
              axios.post("/Personnel_Reasons_for_leaving/Leaving_reason",{department:row.department,year:parseInt(this.Year),mouth:parseInt(this.Months)}).then(res=>{
                  //console.log(res.data);
                  if(res.data !={}){
                      for(let item in res.data){
                          this.gridData.push(res.data[item]); 
                      }
                  }
              }).catch(err=>{
                  vm.$notify({
                      title: '警告',
                      message: '连接失败！',
                      type: 'warning'
                  });
              })
          },
        },
        watch: {
            times() {
                this.getInfos();
            },
            tableBottomRange(){
                this.coporationTypeVal = [];
                this.leavingRangr = [];
                if(this.tableBottomRange !=''){
                    this.flags = true;
                    console.log(this.tableBottomRange)
                    var obj1 = {name:'薪酬不满意',value:this.tableBottomRange.proportion_couxin.replace(/%/,'')};
                    var obj2 = {name:'制度不满意',value:this.tableBottomRange.proportion_zhidu.replace(/%/,'')};
                    var obj3 = {name:'管理不满意',value:this.tableBottomRange.proportion_guanli.replace(/%/,'')};
                    var obj4 = {name:'工作环境不满意',value:this.tableBottomRange.proportion_huanji.replace(/%/,'')};
                    var obj5 = {name:'更好的发展',value:this.tableBottomRange.proportion_genghao.replace(/%/,'')};
                    this.coporationTypeVal.push(obj1,obj2,obj3,obj4,obj5);

                    var obj11 = {name:'薪酬不满意',value:this.tableBottomRange.Leaving_salary.replace(/%/,'')};
                    var obj22 = {name:'制度不满意',value:this.tableBottomRange.Leaving_System.replace(/%/,'')};
                    var obj33 = {name:'管理不满意',value:this.tableBottomRange.Leaving_management.replace(/%/,'')};
                    var obj44 = {name:'工作环境不满意',value:this.tableBottomRange.Leaving_Joben.replace(/%/,'')};
                    var obj55 = {name:'更好的发展',value:this.tableBottomRange.Leaving_Better.replace(/%/,'')};

                    this.leavingRangr.push(obj11,obj22,obj33,obj44,obj55)
                    var LineChart = echarts.init(document.getElementById('lineMain'));
                    var LineChart2 = echarts.init(document.getElementById('lineMain2'));
                    //LineChart.showLoading();
                    //LineChart.hideLoading();
                    let option1 = {
                        title: {
                            text: '操作族离职原因',
                            //subtext: '纯属虚构',
                            x: 'center'
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: "{a} <br />{b} : {c} ({d}%)"
                        },
                        legend: {
                            orient: 'vertical',
                            left: 'right',
                            data: ['薪酬不满意', '制度不满意', '管理不满意', '工作环境不满意', '更好的发展']
                        },
                        series: [{
                            name: '详细占比',
                            type: 'pie',
                            radius: '55%',
                            center: ['50%', '60%'],
                            data:this.coporationTypeVal ,
                            itemStyle: {
                                emphasis: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }]
                    };
                    let option2 = {
                        title: {
                            text: '非操作族离职原因',
                            //subtext: '纯属虚构',
                            x: 'center'
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: "{a} <br />{b} : {c} ({d}%)"
                        },
                        legend: {
                            orient: 'vertical',
                            left: 'right',
                            data: ['薪酬不满意', '制度不满意', '管理不满意', '工作环境不满意', '更好的发展']
                        },
                        series: [{
                            name: '访问来源',
                            type: 'pie',
                            radius: '55%',
                            center: ['50%', '60%'],
                            data: this.leavingRangr,
                            itemStyle: {
                                emphasis: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            }
                        }]
                    };
                    LineChart.setOption(option1);
                    LineChart2.setOption(option2);


                }
            }
        }
      })
      $(".el-table__footer").click(function(){
          vm.$notify({
              title: '警告',
              message: '点击总计行显示相应信息！',
              type: 'warning'
          });
      })   //点击总计栏事件
     
    
</script>
