@model JianHeMES.Models.Warehouse_SparePartsAndComponents_Out

@{
    ViewBag.Title = "录入备品、配件包装信息";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Content/styleFile/packaging/index.css" rel="stylesheet" />
<script src="~/Content/styleFile/packaging/index.js"></script>
<script src="~/Scripts/axios.min.js"></script>
<script src="~/Scripts/printJS/JsBarcode.all.min.js"></script>

<style>
    .query {
        width: 300px;
        text-align: right;
        margin: 2px auto;
    }

    .TunnelLabel {
        margin: 0 auto;
        border: 1px solid #100f0f;
        width: 308px;
        height: 280px;
    }

    .tophei {
        height: 160px;
    }

        .tophei > div {
            height: 80px;
        }

        .tophei .tophei_1 {
            position: relative;
        }

        .tophei .tophei_2 {
            border-top: 1px solid #100f0f;
            border-bottom: 1px solid #100f0f;
        }

        .tophei .imgicon1 {
            margin: 0;
            padding-top: 33px;
            text-align: center;
        }

        .tophei .imgicon2 {
            margin: 0;
            padding-top: 25px;
            text-align: center;
        }

    .bottomhei {
        display: inline-flex;
        text-align: center;
        height: 60px;
        border-bottom: 1px solid #100f0f;
    }

    .bottomhei1 {
        display: inline-flex;
        text-align: center;
        height: 59px;
    }

        .bottomhei .mcFrame_top_3:nth-child(1), .bottomhei1 .mcFrame_top_3:nth-child(1) {
            border-right: 1px solid #100f0f;
            width: 78px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .bottomhei .mcFrame_top_3:nth-child(2), .bottomhei1 .mcFrame_top_3:nth-child(2) {
            border-right: 1px solid #100f0f;
            width: 78px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .bottomhei .mcFrame_top_3:nth-child(3), .bottomhei1 .mcFrame_top_3:nth-child(3) {
            border-right: 1px solid #100f0f;
            width: 76px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .bottomhei .mcFrame_top_3:nth-child(4), .bottomhei1 .mcFrame_top_3:nth-child(4) {
            width: 75px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

    h2 {
        margin: 0;
        padding-top: 35px;
        text-align: center;
    }

    .masterBarDiv {
        width: 100%;
        position: absolute;
        top: -3px;
    }

    .textCenter {
        text-align: center;
    }

    #imgcode {
        width: 240px;
    }

    .tophei_2 {
        position: relative;
    }

    .imgicon {
        position: absolute;
        width: 110px;
        top: 5px;
        left: 5px;
    }

    .divframe {
        width: 300px;
        margin: 1px auto;
        text-align: center;
        border: 1px solid #ccc;
        min-height: 300px;
    }

    @@media screen and (max-width:820px) {
        .affirm {
            margin-left: 250px;
        }

        .link {
            display: inline-block;
        }

        .tips {
            margin-left: 50px;
        }
    }

    @@media screen and (min-width:820px) {
        .affirm {
            margin-left: 280px;
        }

        .affirm2 {
            margin-left: 280px;
        }

        .affirm1 {
            margin-left: 350px;
        }

        .el-table th {
            font-size: 13px;
            padding: 5px 0;
            color: #000;
            text-align: center;
        }

        .el-table td {
            font-size: 13px;
            padding: 2px 0;
            text-align: center;
        }

        .el-table .cell, .el-table--border td:first-child .cell {
            padding: 0;
        }

        .el-table .warning-row {
            background: #fcd2d2;
        }

        .el-table .success-row {
            background: #f0f9eb;
        }

        .tips {
            margin-left: 240px;
        }
    }
</style>
<div id="app">
    <div class="text-center">
        <h3>@ViewBag.Title</h3>
        <div class="link">
            <a href="/Packagings/SPC_Addbasic_information"><el-button size="small" type="primary" plain style="margin:2px">物料基本信息录入</el-button></a>
            <a href="/Packagings/SPC_Display"><el-button size="small" type="primary" plain style="margin:2px">查询基本信息</el-button></a>
            <a href="/Packagings/SPC_MaterialLablePrint"><el-button size="small" type="primary" plain style="margin:2px">打印物料标签</el-button></a>
            <a href="/Packagings/SPC_Packaging_Modify"><el-button size="small" type="primary" plain style="margin:2px">修改包装信息</el-button></a>
            <a href="/Packagings/SPC_StockConfirm"><el-button size="small" type="primary" plain style="margin:2px">备料确认</el-button></a>
        </div>
    </div>
    <el-main>
        <el-col :md="12">
            <div class="query">
                订单号：
                <el-select v-model="orderNum" placeholder="请选择订单号" size="medium" allow-create filterable clearable v-bind:disabled="materialInfo.length>0">
                    <el-option v-for="item in options"
                               :key="item.value"
                               :value="item.value">
                    </el-option>
                </el-select>
            </div>
            <div class="query">
                屏序：<el-input v-model.trim="screenNum" placeholder="请输入屏序" style="width:191px" size="medium" clearable  v-bind:disabled="materialInfo.length>0"></el-input>
            </div>
            <div class="query">
                物品类型：
                <el-select v-model="materialType" placeholder="请选择类型" size="medium" allow-create filterable clearable v-bind:disabled="materialInfo.length>0">
                    <el-option v-for="item in materialTypeOptions"
                               :key="item.value"
                               :value="item.value">
                    </el-option>
                </el-select>
            </div>
            <div class="query">
                毛重量：<el-input v-model.trim="G_Weight" placeholder="请输入毛重量" style="width:191px" size="medium" clearable></el-input>
            </div>
            <span class="tips" style="color:red" v-show="VisiG_Weight">毛重量值只能输入整数或小数</span>
            <div class="query">
                净重：<el-input v-model.trim="N_Weight" placeholder="请输入净重量" style="width:191px" size="medium" clearable></el-input>
            </div>
            <span class="tips" style="color:red" v-if="VisiN_Weight">净重量值只能输入整数或小数</span>
            <div class="query">
                <span>选打印机：</span>
                <el-select v-model="printProt" clearable placeholder="选择打印机" size="medium">
                    <el-option v-for="item in printOptions"
                               :key="item.value"
                               :label="item.label"
                               :value="item.value">
                    </el-option>
                </el-select>
            </div>
            <div class="query">
                物料号：
                <el-input v-model.trim="materialNumber" placeholder="请输入物料号" style="width:191px" size="medium" clearable ></el-input>           
            </div>
            <div class="query">
                包装数量：
                <el-select v-model="quantity" clearable placeholder="请选择数量" size="medium">
                    <el-option v-for="item in quantityOptions"
                               :key="item"
                               :value="item">
                    </el-option>
                </el-select>
            </div>
            <div class="query">
                件号/数：<el-input v-model.trim="snt" placeholder="请输入件号/数" style="width:191px" size="medium" v-bind:disabled="materialInfo.length>0"></el-input>
            </div>
            <div class="query">
                批次：<el-input v-model.trim="Batch" placeholder="请输入批次" style="width:191px" size="medium" v-bind:disabled="materialInfo.length>0"></el-input>
            </div>
            <div>
                <el-switch class="affirm2"
                           v-model="imgShow"
                           width="35"
                           active-text="使用Logo">
                </el-switch>
                <el-button size="mini" type="primary" v-on:click="addMaterial">添加</el-button>
            </div>


            <div class="divframe">
                <el-table v-bind:data="materialInfo"
                          height="300"
                          border>
                    <el-table-column prop="MaterialNumber"
                                     label="物料号"
                                     width="100">
                    </el-table-column>
                    <el-table-column prop="Quantity"
                                     label="数量"
                                     width="60">
                    </el-table-column>
                    <el-table-column prop="ScreenNum"
                                     label="屏序">
                    </el-table-column>
                    <el-table-column prop="operate"
                                     label=""
                                     width="40">
                        <template slot-scope="scope">
                            <el-button v-on:click.native.prevent="deleteRow(scope.$index,scope.row ,materialInfo)"
                                       type="text"
                                       size="mini"
                                       style="margin:0;padding:0;width:100%;">
                                <i class="el-icon-error"></i>
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
                <span v-if="materialInfo.length!=0">条码数量：{{materialInfo.length}}</span>
            </div>
        </el-col>
        <el-col :md="12">
            <div class="TunnelLabel">
                <div class="tophei">
                    <div class="tophei_1">
                        <img v-show="imgShow" class="imgicon" src="~/Images/LOGO.jpg" />
                        <h1 v-show="imgShow" class="imgicon1">{{orderNum}}</h1>
                        <h1 v-show="!imgShow" class="imgicon2">{{orderNum}}</h1>
                    </div>
                    <div class="tophei_2">
                        <div class="masterBarDiv textCenter">
                            <svg id="imgcode"></svg>
                        </div>
                    </div>
                </div>
                <div class="bottomhei ">
                    <div class="mcFrame_top_3"><span>物料描述(DESC)</span></div>
                    <div class="mcFrame_top_3"><span>{{materialType}}</span></div>
                    <div class="mcFrame_top_3"><span>件号/数<br />(SN/TN)</span></div>
                    <div class="mcFrame_top_3"><span>{{snt}}</span></div>
                </div>
                <div class="bottomhei1 ">
                    <div class="mcFrame_top_3"><span>毛重量(G.W.)Kg</span></div>
                    <div class="mcFrame_top_3"><span>{{G_Weight}}</span></div>
                    <div class="mcFrame_top_3"><span>净重(N.W.)Kg</span></div>
                    <div class="mcFrame_top_3"><span>{{N_Weight}}</span></div>
                </div>

            </div>
            <el-row style="margin-top:5px">
                <el-button class="affirm" size="mini" type="primary" v-show="materialInfo.length>0" v-on:click="confirm">保存</el-button>
                <el-button class="affirm1" size="mini" v-show="visi" type="primary" v-on:click="printLabel">打印标签</el-button>
            </el-row>
        </el-col>
    </el-main>
    <div>
        <img id="cc" />
    </div>
</div>
<script>
    var app = new Vue({
        el: "#app",
        data: {
            orderNum: '',         //订单号
            options: [],
            materialNumber: '',    //物料编号
            materialNumOptions: [],
            outMaterialCode: '',  //外箱条码
            quantity: '',        //数量
            quantityOptions: [],
            screenNum: '',        //物料名
            imgShow: true,
            materialInfo: [],
            printOptions: printIpAddress,
            printProt: '',
            snt: '',            //SNTN
            arr: [],
            visi: false,
            G_Weight: '',   //毛重量
            N_Weight: '',   //净重
            VisiG_Weight: false,
            VisiN_Weight: false,
            Batch: '',  //批次
            materialTypeOptions: [{ label: '选项一', value: '备品' }, { label: '选项一', value: '配件' }, { label: '选项一', value: '备品、配件' }],
            materialType:'',//类型
        },
        //获取订单号
        mounted() {
            axios.post('/Packagings/GetOrderList').then(res => {
                this.options = res.data;                
            }).catch(err => {
                console.warn("获取选择列表失败")
            });
            let printIP = localStorage.getItem('printIP');
            if (printIP != null) {
                this.printPort = printIP;
            };
        },
        methods: {
            //添加物料信息
            addMaterial() {
                for (let item in this.materialInfo) {
                    if (this.materialInfo[item].MaterialNumber == this.materialNumber && this.materialInfo[item].Quantity == this.quantity) {
                        this.$message({
                            message: '已有重复物料号！',
                            type: 'warning'
                        });
                        return;
                    };
                };
                if (this.orderNum != '' && this.materialNumber != '' && this.quantity != '' && this.screenNum != '' && this.snt != '' && this.G_Weight != '' && this.N_Weight != '' && this.materialType!='') {
                    let arr1 = {
                        OrderNum: this.orderNum, SPC_OuterBoxBarcode: this.outMaterialCode, MaterialNumber: this.materialNumber, Quantity: this.quantity,
                        ScreenNum: this.screenNum, SNTN: this.snt, g_Weight: this.G_Weight, n_Weight: this.N_Weight, SPC_OuterBox_type: this.materialType
                    }
                    this.materialInfo.push(arr1)
                    this.arr.push(arr1)
                    console.log(this.materialInfo)
                    console.log(this.arr)
                } else {
                    this.$message({
                        message: '请填写完整在添加！',
                        type: 'warning'
                    });
                }
                console.log(this.materialInfo)
            },
            //获取条码信息
            getOutBoxNum() {
                axios.post("/Packagings/createOutBoxNum", { orderNumber: this.orderNum, screenNum: this.screenNum }).then(res => {
                    if (res.data != null && res.data != "创建外箱号出错!") {
                        this.outMaterialCode = res.data.OuterBoxBarCodeNum;
                    }
                    else {
                        this.$message({
                            message: '创建外箱号出错！',
                            type: 'warning'
                        });
                    }
                })
            },
            //使用后端返回的条码号生成条形码
            setmasterBarDiv() {
                JsBarcode("#imgcode", this.outMaterialCode, {
                    height: 60,                    //条形码的高度
                    format: "CODE128",            //选择要使用的条形码类型
                    font: "monospace",           //设置文本字体
                    textAlign: "center",        //设置文本的水平对齐方式
                    textMargin: 0,             //设置条形码和文本之间的间距
                    fontSize: 26,             //设置文本的大小
                    lineColor: "#000",       //条形码颜色
                    margin: 0,              //设置条形码周围的空白边距
                    marginTop: 0
                });
            },
            //保存
            confirm() {
                this.visi = true;
                axios.post("/Packagings/SPC_Packaging", {
                    spc_list: this.arr
                }).then(res => {
                    console.log(res.data)
                    //if (res.data == "true") {
                    //    this.$message({
                    //        message: '保存成功！',
                    //        type: 'success'
                    //    });
                    //} else {
                    //    this.$message({
                    //        message: '保存失败，此物料号已打印外箱标签',
                    //        type: 'warning'
                    //    });
                    //}

                })
            },
            //打印标签方法
            printLabel() {
                if (this.orderNum != '' && this.outMaterialCode != '' && this.materialInfo != "[]" && this.snt != '') {
                    axios.post("/Packagings/SPC_OutsideBoxLablePrint", {
                        orderNumber: this.orderNum,
                        spc_OuterBoxBarcode: this.outMaterialCode,
                        sntn: this.snt,
                        //spc_list: this.materialInfo,
                        ip: this.printProt,
                        logo: this.imgShow,
                        g_Weight: this.G_Weight,
                        n_Weight: this.N_Weight
                    },
                        {
                            responseType: "arraybuffer",
                        }).then(function (response) {
                            return 'data:image/png;base64,' + btoa(
                                new Uint8Array(response.data).reduce((data, byte) => data + String.fromCharCode(byte), '')
                            );
                        }).then(function (data) {
                            //接收转换后的Base64图片
                            console.log(data);
                            document.getElementById("cc").setAttribute("src", data)
                        }).catch(err => {
                            console.warn("打印出错")
                        });
                    //).then(res => {
                    //    console.log(res.data)
                    //    if (res.data == true) {

                    //    } else if (res.data.error != {})
                    //    {
                    //        this.$message({
                    //            message: res.data.error +'标签已打印！',
                    //            type: 'warning'
                    //        });
                    //    }
                    //})
                }
                else {
                    this.$message({
                        showClose: true,
                        message: '请填写完再确认！',
                        type: 'warning'
                    });
                }

            },
            //删除小表中的行
            deleteRow: function (index, row, data) {
                console.log('1232')
                data.splice(index, 1);               
                if (this.arr != []) {
                    this.arr.forEach((item, index) => {                        
                        if (index == index && item.Quantity == row.Quantity) {
                            this.arr.splice(index, 1)
                        }
                    })
                }
                console.log(this.arr)
                console.log(this.materialInfo)
            },
        },
        watch: {
            orderNum() {
                if (this.orderNum != '' && this.screenNum != '') {
                    this.getOutBoxNum();
                }
                if (this.orderNum != '') {
                    axios.post("/Packagings/GetMaterialNumberByOrderNumber", {
                        ordernumber: this.orderNum
                    }).then(res => {
                        if (res.data != []) {
                            let wuliao = [];
                            for (let item in res.data) {
                                wuliao.push(res.data[item].MaterialNumber)
                            }
                            this.materialNumOptions = wuliao;
                        }
                    })
                }
            },
            materialNumber() {
                if (this.materialNumber != '' && this.materialNumber.length == 10) {
                    this.quantityOptions =[]
                    axios.post("/Packagings/GetMaterialNumberByQuantity", {
                        ordernumber: this.orderNum,
                        materialNumber: this.materialNumber,
                    }).then(res => {
                        if (res.data == []) {
                            this.$message({
                                showClose: true,
                                message: '找不到物料号对应的数量',
                                type: 'warning'
                            });
                        } else {
                            let arr = [];
                            if (res.data.length == 1) {
                                this.quantity = res.data[0]
                            } else {
                                for (let item in res.data) {
                                    arr.push(res.data[item])

                                }
                                this.quantityOptions = arr;
                            }
                        }
                       
                    })
                } 
            },
            screenNum() {
                if (this.orderNum != '' && this.screenNum != '') {
                    this.getOutBoxNum();
                } else {
                    $("#imgcode").empty()
                }
            },
            outMaterialCode() {
                if (this.outMaterialCode != "") {
                    app.setmasterBarDiv(this.outMaterialCode);
                }
            },
            N_Weight() {
                if (this.N_Weight != '') {
                    if (!this.N_Weight.match(/^[0-9]+\.{0,1}[0-9]{0,4}$/)) {
                        this.VisiN_Weight = true;
                    } else { this.VisiN_Weight = false };
                } else {
                    this.VisiN_Weight = false
                }
            },
            G_Weight() {
                if (this.G_Weight != '') {
                    if (!this.G_Weight.match(/^[0-9]+\.{0,1}[0-9]{0,4}$/)) {
                        this.VisiG_Weight = true
                    } else {
                        this.VisiG_Weight = false
                    }
                } else {
                    this.VisiG_Weight = false
                }
            }
        }
    })
</script>