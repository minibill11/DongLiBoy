@{
    ViewBag.Title = "工序产能首页";
}

@*  <summary>
    1.工序产能首页
    </summary>*@

<link href="~/Content/styleFile/packaging/index.css" rel="stylesheet" />@*2.13版本 elementui css文件*@
<script src="~/Content/styleFile/packaging/index.js"></script>@*2.13版本 elementui js文件*@
<link href="~/Content/styleFile/processCapacity/indexStyle.css" rel="stylesheet" />@*工序产能公共样式文件*@
<style>
    /* 宽度设为屏幕宽度的96% */
    .container, .body-content {
        width: 96vw;
    }

    .el-table tbody tr td {
        padding: 0;
    }

    .el-main {
        padding-bottom: 0;
    }

    .fontsizelie {
        font-size: 14px;
    }

    .ulli {
        margin: 0;
        line-height: 16px;
        text-align: left;
        padding-left: 15px;
    }

        .ulli li {
            margin-bottom: 5px;
        }

    .el-table__expanded-cell[class*="cell"] {
        padding: 10px 5px;
        /*background-color: #fff4f4;*/
    }

    .el-table__body tr:hover > td[class="el-table__expanded-cell"] {
        background-color: #FFF !important;
    }

    .el-table__expanded-cell .detailTable > thead > tr:hover > td {
        background-color: #409eff !important;
    }

    .el-table__body tr:hover > td {
        /*#30BCF242*/
        background-color: #E4ECF7 !important;
    }

    .areaDiv {
        margin: 0 auto 5px;
        text-align: center;
    }

        .areaDiv .el-input, .areaDiv el-button, .areaDiv > div {
            display: inline-block;
            max-width: 180px;
        }

    .shebeiDiv {
        height: 28px;
        line-height: 28px;
    }

    .shebeiDivNew {
        display: inline-block;
    }

    /*.el-divider--vertical {
        margin: 0;
        width: 1px;
        height: 28px;
        background-color: #d5d7db;
        vertical-align: initial;
    }*/

    .danwei {
        font-size: 12px;
        height: 12px;
        line-height: 12px;
    }

    .jieguo {
        font-size: 19px;
        color: #f95f5f;
        max-width: 500px;
        padding-left: 10px;
    }

    .detailTable {
        border: 1px solid #d5d7db;
        border-collapse: unset;
        width: auto;
        margin: 0 auto;
    }

        .detailTable > thead > tr > td,
        .detailTable > tbody > tr > td,
        .detailTable > tfoot > tr > td {
            text-align: center;
            vertical-align: middle;
        }

            .detailTable > thead > tr > td > .cell,
            .detailTable > tbody > tr > td > .cell,
            .detailTable > tfoot > tr > td > .cell {
                height: 28px;
                line-height: 28px;
                text-align: center;
            }

    .shebeiDivNew > .cell {
        width: 80px;
        text-align: center;
    }

    .detailTable > thead > tr > td,
    .detailTable > tfoot > tr > td {
        font-weight: bold;
        height: 35px;
    }

    .trParent > tr > td {
        min-width: 70px;
    }

    .trParent tr td:first-child {
        width: 120px;
    }

    /*.bpstyle {
        background-color: #ededed !important;
    }

    .sbstyle {
        background-color: #ebf4f9 !important;
    }

    .phbsstyle {
        background-color: #fcfba3 !important;
    }

    .phstyle {
        background-color: #ffefda !important;
    }*/

    .detailTable > tbody > tr > td:first-child,
    .detailTable > tfoot > tr > td:first-child {
        background: #e4ecf7;
    }

    .detailTable > thead > tr > td {
        background: #409eff;
        color: #FFF;
    }

    .finalTable > thead > tr > td,
    .finalTable > tbody > tr > td,
    .finalTable > tfoot > tr > td {
        height: 40px;
    }

    .flexDiv {
        display: flex;
        justify-content: center;
    }

        .flexDiv > .shebeiDivNew:not(:last-child) {
            border-right: 1px solid #CCD3DE;
        }

    .el-table__empty-block {
        min-height: 50px;
    }
</style>
<div id="app" v-cloak>
    <el-container>
        <el-header class="text-center">
            @*标题*@
            <h2>@ViewBag.Title</h2>
        </el-header>
        <el-main v-loading="loading" style="min-height:600px">
            <el-row class="text-center">
                <el-form :inline="true" :model="queryTable" size="small">
                    <el-form-item label="筛选平台">
                        <select-input v-model.trim="queryTable.proplatform" :disabled="false" @@select-val="selectHandle" @@watchval="watchPlatform($event)" :appendbody="false" :options="options.proplatform" :isfocus="true" @*:ismultiple="true"*@ size="medium" :allowcreate="true"></select-input>
                    </el-form-item>
                    <el-form-item label="筛选型号">
                        <select-input v-model.trim="queryTable.protype" :disabled="false" @@watchval="watchType($event)" :appendbody="false" :options="options.protype" :isfocus="true" @*:ismultiple="true"*@ size="medium" :allowcreate="true"></select-input>
                    </el-form-item>
                    <el-button type="primary" @@click="onQuerySubmit" size="medium">查找</el-button>
                </el-form>
            </el-row>
            <el-row class="text-center">
                <el-table :data="expandData"
                          v-show="expandShow"
                          size="medium"
                          align="center"
                          cell-class-name="indexCellParent"
                          stripe
                          ref="thistable"
                          border>
                    <el-table-column type="expand" width="1">
                        <template slot-scope="props">
                            <div v-if="props.row.info!=''" style="overflow:auto">
                                @*<div>PCB编号：<b>{{ props.row.PCB }}</b></div>*@
                                <template v-if="detailList.data">
                                    <div class="areaDiv">
                                        <el-switch v-model="detailshow"
                                                   active-text="最终"
                                                   inactive-text="详细">
                                        </el-switch>
                                        <div v-show="false">
                                            <span class="danwei">模块瓶颈参考值</span><br />
                                            <el-select v-model="Reference.value" placeholder="请选择" @@change="selectCapHouse(props.row,$event)">
                                                <el-option v-for="(item,index) in Reference.options"
                                                           :key="index"
                                                           :label="item.name"
                                                           :value="index">
                                                </el-option>
                                            </el-select>
                                        </div>
                                        <div>
                                            <span class="danwei">单位：㎡(平方米)</span><br />
                                            <el-input v-model="props.row.area"
                                                      ref="computeInput"
                                                      v-on:keyup.enter.native="areaCompute(props.row,props.row.area)"
                                                      placeholder="请输入面积"></el-input>
                                        </div>
                                        <div>
                                            <span></span><br />
                                            <el-button type="success" :loading="props.row.btnloading" @@click="areaCompute(props.row,props.row.area)">计 算</el-button>
                                        </div>
                                        <span class="jieguo">{{props.row.info.resultMes}}</span>
                                    </div>
                                    <template v-if="detailshow">
                                        <table v-if="areaFinalComputeReturnList.length>0" class="el-table el-table--border detailTable finalTable">
                                            <colgroup>
                                                <col width="100" />
                                                <col v-for="i in areaFinalComputeReturnList.length" width="100" />
                                            </colgroup>
                                            <thead class="el-table__header-wrapper trParent">
                                                <tr class="">
                                                    <td>工段</td>
                                                    <td v-for="i in areaFinalComputeReturnList">{{i.title}}</td>
                                                </tr>
                                            </thead>
                                            <tbody class="el-table__body-wrapper trParent">
                                                <tr class="">
                                                    <td>人力</td>
                                                    <td v-for="i in areaFinalComputeReturnList">{{i.person}}</td>
                                                </tr>
                                                <tr class="">
                                                    <td>设备(线)</td>
                                                    <td v-for="i in areaFinalComputeReturnList">{{i.equipment}}</td>
                                                </tr>
                                                <tr class="">
                                                    <td>产能</td>
                                                    <td v-for="i in areaFinalComputeReturnList">
                                                        <span v-if="i.capacity!=''"><u>{{i.capacity}} (模块)</u><br /> / {{i.person}}人 / H</span>
                                                    </td>
                                                </tr>
                                                <tr class="">
                                                    <td>生产工时(H)</td>
                                                    <td v-for="i in areaFinalComputeReturnList">{{i.time}}</td>
                                                </tr>
                                            </tbody>
                                            <tfoot class="el-table__header-wrapper trParent">
                                                <tr class="">
                                                    <td>汇总</td>
                                                    <td v-bind:colspan="areaFinalComputeReturnList.length">{{areaFinalComputeReturnTotal}}</td>
                                                </tr>
                                            </tfoot>
                                        </table>

                                        <table v-else class="el-table el-table--border detailTable finalTable">
                                            <colgroup>
                                                <col width="200" />
                                                <col v-for="i in finalDetail.length" width="200" />
                                            </colgroup>
                                            <thead class="el-table__header-wrapper trParent">
                                                <tr class="">
                                                    <td>工段</td>
                                                    <td v-for="i in finalDetail">{{i.title}}</td>
                                                </tr>
                                            </thead>
                                            <tbody class="el-table__body-wrapper trParent">
                                                <tr class="">
                                                    <td>人力</td>
                                                    <td v-for="i in finalDetail">{{i.person}}</td>
                                                </tr>
                                                <tr class="">
                                                    <td>设备(线)</td>
                                                    <td v-for="i in finalDetail">{{i.equipment}}</td>
                                                </tr>
                                            </tbody>
                                            <tfoot class="el-table__header-wrapper trParent">
                                                <tr class="">
                                                    <td>产能</td>
                                                    <td v-for="i in finalDetail"><u>{{i.capacity}} (模块)</u><br /> / {{i.person}}人 / H</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </template>

                                    <template v-else>
                                        <table @*v-if="Object.keys(detailList).length!=0"*@ class="el-table el-table--border detailTable">
                                            <colgroup>
                                                <col width="120" />
                                                <col v-for="i in finalDetail.length" width="80" />
                                            </colgroup>
                                            <thead class="el-table__header-wrapper trParent">
                                                <tr class="">
                                                    <td style="min-width:120px">详细表</td>
                                                    <td v-for="i in finalDetail" v-bind:colspan="i.length">{{i.title}}</td>
                                                </tr>
                                            </thead>
                                            <tbody class="el-table__body-wrapper trParent">
                                                <tr>
                                                    <td>工段</td>
                                                    <td v-for="(item,index) in detailList.name">
                                                        <div class="cell">{{item}}</div>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>模组需求数</td>
                                                    <td v-for="(item,index) in detailList.moduleNeed"><div class="cell">{{item}}</div></td>
                                                </tr>
                                                <tr class="sbstyle">
                                                    <td>设备名字</td>
                                                    <td v-for="(item,index) in detailList.equipmentName">
                                                        <div class="flexDiv">
                                                            <template v-if="item==''">
                                                                <div class="shebeiDivNew"><div class="cell">/</div></div>
                                                            </template>
                                                            <template v-else class="flexDiv">
                                                                <template v-for="(i,idx) in item">
                                                                    <div class="shebeiDivNew"><div class="cell">{{i}}</div></div>
                                                                    @*<el-divider v-if="idx<(item.length-1)" direction="vertical"></el-divider>*@
                                                                </template>
                                                            </template>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="sbstyle">
                                                    <td>设备数量</td>
                                                    <td v-for="(item,index) in detailList.equipmentNum">
                                                        <div class="flexDiv">
                                                            <template v-if="item==''">
                                                                <div class="shebeiDivNew"><div class="cell">/</div></div>
                                                            </template>
                                                            <template v-else class="flexDiv">
                                                                <template v-for="(i,idx) in item">
                                                                    <div class="shebeiDivNew"><div class="cell">{{i}}</div></div>
                                                                    @*<el-divider v-if="idx<(item.length-1)" direction="vertical"></el-divider>*@
                                                                </template>
                                                            </template>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="sbstyle">
                                                    <td>产能(PCS/H)</td>
                                                    <td v-for="(item,index) in detailList.equipmentCapacity">
                                                        <div class="flexDiv">
                                                            <template v-if="item==''">
                                                                <div class="shebeiDivNew"><div class="cell">/</div></div>
                                                            </template>
                                                            <template v-else class="flexDiv">
                                                                <template v-for="(i,idx) in item">
                                                                    <div class="shebeiDivNew"><div class="cell">{{i}}</div></div>
                                                                    @*<el-divider v-if="idx<(item.length-1)" direction="vertical"></el-divider>*@
                                                                </template>
                                                            </template>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="sbstyle">
                                                    <td><span style="font-size:12px;">一人能控制的机台数</span></td>
                                                    <td v-for="(item,index) in detailList.controllerNum">
                                                        <div class="flexDiv">
                                                            <template v-if="item==''">
                                                                <div class="shebeiDivNew"><div class="cell">/</div></div>
                                                            </template>
                                                            <template v-else class="flexDiv">
                                                                <template v-for="(i,idx) in item">
                                                                    <div class="shebeiDivNew"><div class="cell">{{i}}</div></div>
                                                                    @*<el-divider v-if="idx<(item.length-1)" direction="vertical"></el-divider>*@
                                                                </template>
                                                            </template>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="sbstyle">
                                                    <td>人数</td>
                                                    <td v-for="(item,index) in detailList.person">
                                                        <div class="flexDiv">
                                                            <template v-if="item==''">
                                                                <div class="shebeiDivNew"><div class="cell">/</div></div>
                                                            </template>
                                                            <template v-else class="flexDiv">
                                                                <template v-for="(i,idx) in item">
                                                                    <div class="shebeiDivNew"><div class="cell">{{i}}</div></div>
                                                                    @*<el-divider v-if="idx<(item.length-1)" direction="vertical"></el-divider>*@
                                                                </template>
                                                            </template>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="phbsstyle">
                                                    <td>平衡后倍数</td>
                                                    <td v-for="(item,index) in detailList.balanceMultiple">
                                                        <div class="flexDiv">
                                                            <template v-if="item==''">
                                                                <div class="shebeiDivNew"><div class="cell">/</div></div>
                                                            </template>
                                                            <template v-else class="flexDiv">
                                                                <template v-for="(i,idx) in item">
                                                                    <div class="shebeiDivNew"><div class="cell">{{i}}</div></div>
                                                                    @*<el-divider v-if="idx<(item.length-1)" direction="vertical"></el-divider>*@
                                                                </template>
                                                            </template>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="phstyle">
                                                    <td>平衡后产能</td>
                                                    <td v-for="(item,index) in detailList.balanceCapacity">
                                                        <div class="flexDiv">
                                                            <template v-if="item==''">
                                                                <div class="shebeiDivNew"><div class="cell">/</div></div>
                                                            </template>
                                                            <template v-else class="flexDiv">
                                                                <template v-for="(i,idx) in item">
                                                                    <div class="shebeiDivNew"><div class="cell">{{i}}</div></div>
                                                                    @*<el-divider v-if="idx<(item.length-1)" direction="vertical"></el-divider>*@
                                                                </template>
                                                            </template>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="phstyle">
                                                    <td>平衡后人数</td>
                                                    <td v-for="(item,index) in detailList.balancePerson">
                                                        <div class="flexDiv">
                                                            <template v-if="item==''">
                                                                <div class="shebeiDivNew"><div class="cell">/</div></div>
                                                            </template>
                                                            <template v-else class="flexDiv">
                                                                <template v-for="(i,idx) in item">
                                                                    <div class="shebeiDivNew"><div class="cell">{{i}}</div></div>
                                                                    @*<el-divider v-if="idx<(item.length-1)" direction="vertical"></el-divider>*@
                                                                </template>
                                                            </template>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="phstyle">
                                                    <td><span style="font-size:13px;">平衡后设备需求数</span></td>
                                                    <td v-for="(item,index) in detailList.balanceEquipmentNum">
                                                        <div class="flexDiv">
                                                            <template v-if="item==''">
                                                                <div class="shebeiDivNew"><div class="cell">/</div></div>
                                                            </template>
                                                            <template v-else class="flexDiv">
                                                                <template v-for="(i,idx) in item">
                                                                    <div class="shebeiDivNew"><div class="cell">{{i}}</div></div>
                                                                    @*<el-divider v-if="idx<(item.length-1)" direction="vertical"></el-divider>*@
                                                                </template>
                                                            </template>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="phstyle">
                                                    <td>平衡率</td>
                                                    <td v-for="(item,index) in detailList.balanceRate">
                                                        <div class="flexDiv">
                                                            <template v-if="item==''">
                                                                <div class="shebeiDivNew"><div class="cell">/</div></div>
                                                            </template>
                                                            <template v-else class="flexDiv">
                                                                <template v-for="(i,idx) in item">
                                                                    <div class="shebeiDivNew"><div class="cell">{{i}}</div></div>
                                                                    @*<el-divider v-if="idx<(item.length-1)" direction="vertical"></el-divider>*@
                                                                </template>
                                                            </template>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tfoot class="el-table__header-wrapper trParent">
                                                <tr class="">
                                                    <td>产能</td>
                                                    <td v-for="i in finalDetail" v-bind:colspan="i.length">
                                                        <u>{{i.capacity}} (PCBA)</u> / {{i.person}}人 / H
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </template>
                                </template>
                                <template v-else>
                                    <table class="el-table el-table--border detailTable">
                                        <thead class="el-table__header-wrapper trParent">
                                            <tr>
                                                <td>暂无数据</td>
                                            </tr>
                                        </thead>
                                    </table>
                                </template>
                            </div>
                            <div v-else class="text-center">暂无数据</div>
                        </template>
                    </el-table-column>
                    <el-table-column type="index" label="序号" width="40">
                        <template slot-scope="scope">
                            <span style="font-size:16px;">{{scope.$index+1}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="platfrom"
                                     min-width="80"
                                     class-name="fontsizelie"
                                     sortable
                                     label="平台">
                        <template slot-scope="scope">
                            @*<el-link :href="`/Process_Capacity/index2?Type=${scope.row.type}&ProductPCBnumber=${scope.row.PCB}&Platform=${scope.row.platfrom}`"
                                target="_blank"
                                style="color:#409EFF"
                                :underline="false">{{scope.row.platfrom}}</el-link>*@
                            <span>{{scope.row.platfrom}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="type"
                                     sortable
                                     class-name="fontsizelie"
                                     min-width="80"
                                     label="型号">
                        <template slot-scope="scope">
                            <span>{{scope.row.type}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="PlatformModul"
                                     label="平台模块"
                                     class-name="fontsizelie"
                                     min-width="100">
                        <template slot-scope="scope">
                            <div v-if="scope.row.platformModule.length>0">
                                <div v-if="scope.row.platformModule.length>1">
                                    <el-select v-model="scope.row.ptmkVal" @@change="ptmkselect($event,scope.row)" placeholder="请选择">
                                        <el-option v-for="item in scope.row.platformModule"
                                                   :key="item.PlatformModul"
                                                   :label="item.PlatformModul"
                                                   :value="item.PlatformModul">
                                        </el-option>
                                    </el-select>
                                </div>
                                <div v-else>{{scope.row.ptmkVal}}</div>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="Maintenance"
                                     label="维护方式"
                                     class-name="fontsizelie"
                                     min-width="100">
                        <template slot-scope="scope">
                            <div v-if="scope.row.platformModule.length>0">
                                <div v-if="scope.row.platformModule[scope.row.ptmkIndex].Maintenance.length>1">
                                    <el-select v-model="scope.row.whVal" @@change="whselect(scope.row)" placeholder="请选择">
                                        <el-option v-for="item in scope.row.platformModule[scope.row.ptmkIndex].Maintenance"
                                                   :key="item"
                                                   :label="item"
                                                   :value="item">
                                        </el-option>
                                    </el-select>
                                </div>
                                <div v-else>{{scope.row.whVal}}</div>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="模组单位"
                                     min-width="65"
                                     prop="ModuleUnits">
                        <template slot-scope="scope">
                            <div v-if="scope.row.platformModule.length>0">
                                {{scope.row.platformModule[scope.row.ptmkIndex].ModuleUnits}}
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="模块"
                                     min-width="140">
                        <template slot-scope="scope">
                            <div v-if="scope.row.sgOption.length>1">
                                <el-select v-model="scope.row.sgID" @@change="sgselect(scope.row)" placeholder="请选择">
                                    <el-option v-for="item in scope.row.sgOption"
                                               :key="item.threeid+item.guleid"
                                               :label="sglabel(item.threename,item.gulename)"
                                               :value="item.threeid+'+'+item.guleid">
                                    </el-option>
                                </el-select>
                            </div>
                            <div v-else>
                                <div v-if="sglabel(scope.row.sgVal.split('+')[0],scope.row.sgVal.split('+')[1]).split('+').length>1">
                                    <ul class="ulli">
                                        <li v-for="i in sglabel(scope.row.sgVal.split('+')[0],scope.row.sgVal.split('+')[1]).split('+')">
                                            {{i}}
                                        </li>
                                    </ul>
                                </div>
                                <div v-else>{{sglabel(scope.row.sgVal.split('+')[0],scope.row.sgVal.split('+')[1])}}</div>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="模组">
                        <el-table-column label="出货方式"
                                         min-width="90">
                            <template slot-scope="scope">
                                <div v-if="scope.row.wayOption.length>1">
                                    <el-select v-model="scope.row.wayVal" @@change="wayselect(scope.row,$event)" placeholder="请选择">
                                        <el-option v-for="item in scope.row.wayOption"
                                                   :key="item"
                                                   :label="item"
                                                   :value="item">
                                        </el-option>
                                    </el-select>
                                </div>
                                <div v-else>
                                    {{scope.row.wayVal}}
                                </div>
                            </template>
                        </el-table-column>
                        <el-table-column label="模组类别"
                                         min-width="100">
                            <template slot-scope="scope">
                                <template v-if="scope.row.wayVal!=''">
                                    <div v-if="scope.row.categoryOption.length>1">
                                        <el-select v-model="scope.row.categoryVal" @@change="categoryselect(scope.row,$event)" placeholder="请选择">
                                            <el-option v-for="item in scope.row.categoryOption"
                                                       :key="item"
                                                       :label="item"
                                                       :value="item">
                                            </el-option>
                                        </el-select>
                                    </div>
                                    <div v-else>
                                        {{scope.row.categoryVal}}
                                    </div>
                                </template>
                            </template>
                        </el-table-column>
                        <el-table-column label="箱体尺寸"
                                         min-width="110">
                            <template slot-scope="scope">
                                <template v-if="scope.row.categoryVal!=''">
                                    <div v-if="scope.row.sizeOption.length>1">
                                        <el-select v-model="scope.row.sizeVal" @@change="sizeselect(scope.row,$event)" placeholder="请选择">
                                            <el-option v-for="item in scope.row.sizeOption"
                                                       :key="item"
                                                       :label="item"
                                                       :value="item">
                                            </el-option>
                                        </el-select>
                                    </div>
                                    <div v-else>
                                        {{scope.row.sizeVal}}
                                    </div>
                                </template>
                            </template>
                        </el-table-column>
                    </el-table-column>
                    <el-table-column label="包装"
                                     min-width="130">
                        <template slot-scope="scope">
                            <div v-if="scope.row.bzOption.length>1">
                                <el-select v-model="scope.row.bzID" @@change="bzselect(scope.row)" placeholder="请选择">
                                    <el-option v-for="item in scope.row.bzOption"
                                               :key="item.id"
                                               :label="item.name"
                                               :value="item.id">
                                    </el-option>
                                </el-select>
                            </div>
                            <div v-else>
                                <div v-if="scope.row.bzVal.split('+').length>1">
                                    <ul class="ulli">
                                        <li v-for="i in scope.row.bzVal.split('+')">
                                            {{i}}
                                        </li>
                                    </ul>
                                </div>
                                <div v-else>{{scope.row.bzVal}}</div>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="模组生产总工时(H)"
                                     min-width="75">
                        <template slot-scope="scope">
                            <div v-if="scope.row.info!=''">
                                {{scope.row.info.totalcapacityPerHour}}
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="所需人数"
                                     min-width="65">
                        <template slot-scope="scope">
                            <div v-if="scope.row.info!=''">
                                {{scope.row.info.totalperson}}
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="加工费用"
                                     min-width="65">
                        <template slot-scope="scope">
                            <div v-if="scope.row.info!=''">
                                {{scope.row.info.processingFee}}
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="详细信息"
                                     width="65">
                        <template slot-scope="scope">
                            @*<el-button type="text" size="medium" @@click="toogleExpand(scope.row)">查看</el-button>*@
                            <el-button type="text" size="medium" @@click="changeExpand(scope.row,false)">返回</el-button>
                        </template>
                    </el-table-column>
                </el-table>
                <el-button type="text" v-show="expandShow" @@click="changeExpand(expandData[0],false)" style="padding-bottom:0;">返回上一页</el-button>

                @* -------------·分割线·---------------- *@

                <el-table :data="filterResult"
                          v-show="!expandShow"
                          max-height="700"
                          size="medium"
                          align="center"
                          cell-class-name="indexCellParent"
                          stripe
                          border>
                    <el-table-column type="index" label="序号" width="40">
                        <template slot-scope="scope">
                            <span style="font-size:16px;">{{scope.$index+1}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="platfrom"
                                     min-width="80"
                                     class-name="fontsizelie"
                                     sortable
                                     label="平台">
                        <template slot-scope="scope">
                            @*<el-link :href="`/Process_Capacity/index2?Type=${scope.row.type}&ProductPCBnumber=${scope.row.PCB}&Platform=${scope.row.platfrom}`"
                                target="_blank"
                                style="color:#409EFF"
                                :underline="false">{{scope.row.platfrom}}</el-link>*@
                            <span>{{scope.row.platfrom}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="type"
                                     sortable
                                     min-width="80"
                                     class-name="fontsizelie"
                                     label="型号">
                        <template slot-scope="scope">
                            <span>{{scope.row.type}}</span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="PlatformModul"
                                     label="平台模块"
                                     class-name="fontsizelie"
                                     min-width="100">
                        <template slot-scope="scope">
                            <div v-if="scope.row.platformModule.length>0">
                                <div v-if="scope.row.platformModule.length>1">
                                    <el-select v-model="scope.row.ptmkVal" @@change="ptmkselect($event,scope.row)" placeholder="请选择">
                                        <el-option v-for="item in scope.row.platformModule"
                                                   :key="item.PlatformModul"
                                                   :label="item.PlatformModul"
                                                   :value="item.PlatformModul">
                                        </el-option>
                                    </el-select>
                                </div>
                                <div v-else>{{scope.row.ptmkVal}}</div>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column prop="Maintenance"
                                     label="维护方式"
                                     class-name="fontsizelie"
                                     min-width="100">
                        <template slot-scope="scope">
                            <div v-if="scope.row.platformModule.length>0">
                                <div v-if="scope.row.platformModule[scope.row.ptmkIndex].Maintenance.length>1">
                                    <el-select v-model="scope.row.whVal" @@change="whselect(scope.row)" placeholder="请选择">
                                        <el-option v-for="item in scope.row.platformModule[scope.row.ptmkIndex].Maintenance"
                                                   :key="item"
                                                   :label="item"
                                                   :value="item">
                                        </el-option>
                                    </el-select>
                                </div>
                                <div v-else>{{scope.row.whVal}}</div>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="模组单位"
                                     min-width="65"
                                     prop="ModuleUnits">
                        <template slot-scope="scope">
                            <div v-if="scope.row.platformModule.length>0">
                                {{scope.row.platformModule[scope.row.ptmkIndex].ModuleUnits}}
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="模块"
                                     min-width="140">
                        <template slot-scope="scope">
                            <div v-if="scope.row.sgOption.length>1">
                                <el-select v-model="scope.row.sgID" @@change="sgselect(scope.row)" placeholder="请选择">
                                    <el-option v-for="item in scope.row.sgOption"
                                               :key="item.threeid+item.guleid"
                                               :label="sglabel(item.threename,item.gulename)"
                                               :value="item.threeid+'+'+item.guleid">
                                    </el-option>
                                </el-select>
                            </div>
                            <div v-else>
                                <div v-if="sglabel(scope.row.sgVal.split('+')[0],scope.row.sgVal.split('+')[1]).split('+').length>1">
                                    <ul class="ulli">
                                        <li v-for="i in sglabel(scope.row.sgVal.split('+')[0],scope.row.sgVal.split('+')[1]).split('+')">
                                            {{i}}
                                        </li>
                                    </ul>
                                </div>
                                <div v-else>{{sglabel(scope.row.sgVal.split('+')[0],scope.row.sgVal.split('+')[1])}}</div>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="模组">
                        <el-table-column label="出货方式"
                                         min-width="90">
                            <template slot-scope="scope">
                                <div v-if="scope.row.wayOption.length>1">
                                    <el-select v-model="scope.row.wayVal" @@change="wayselect(scope.row,$event)" placeholder="请选择">
                                        <el-option v-for="item in scope.row.wayOption"
                                                   :key="item"
                                                   :label="item"
                                                   :value="item">
                                        </el-option>
                                    </el-select>
                                </div>
                                <div v-else>
                                    {{scope.row.wayVal}}
                                </div>
                            </template>
                        </el-table-column>
                        <el-table-column label="模组类别"
                                         min-width="100">
                            <template slot-scope="scope">
                                <template v-if="scope.row.wayVal!=''">
                                    <div v-if="scope.row.categoryOption.length>1">
                                        <el-select v-model="scope.row.categoryVal" @@change="categoryselect(scope.row,$event)" placeholder="请选择">
                                            <el-option v-for="item in scope.row.categoryOption"
                                                       :key="item"
                                                       :label="item"
                                                       :value="item">
                                            </el-option>
                                        </el-select>
                                    </div>
                                    <div v-else>
                                        {{scope.row.categoryVal}}
                                    </div>
                                </template>
                            </template>
                        </el-table-column>
                        <el-table-column label="箱体尺寸"
                                         min-width="110">
                            <template slot-scope="scope">
                                <template v-if="scope.row.categoryVal!=''">
                                    <div v-if="scope.row.sizeOption.length>1">
                                        <el-select v-model="scope.row.sizeVal" @@change="sizeselect(scope.row,$event)" placeholder="请选择">
                                            <el-option v-for="item in scope.row.sizeOption"
                                                       :key="item"
                                                       :label="item"
                                                       :value="item">
                                            </el-option>
                                        </el-select>
                                    </div>
                                    <div v-else>
                                        {{scope.row.sizeVal}}
                                    </div>
                                </template>
                            </template>
                        </el-table-column>
                    </el-table-column>
                    <el-table-column label="包装"
                                     min-width="130">
                        <template slot-scope="scope">
                            <div v-if="scope.row.bzOption.length>1">
                                <el-select v-model="scope.row.bzID" @@change="bzselect(scope.row)" placeholder="请选择">
                                    <el-option v-for="item in scope.row.bzOption"
                                               :key="item.id"
                                               :label="item.name"
                                               :value="item.id">
                                    </el-option>
                                </el-select>
                            </div>
                            <div v-else>
                                <div v-if="scope.row.bzVal.split('+').length>1">
                                    <ul class="ulli">
                                        <li v-for="i in scope.row.bzVal.split('+')">
                                            {{i}}
                                        </li>
                                    </ul>
                                </div>
                                <div v-else>{{scope.row.bzVal}}</div>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="模组生产总工时(H)"
                                     min-width="75">
                        <template slot-scope="scope">
                            <div v-if="scope.row.info!=''">
                                {{scope.row.info.totalcapacityPerHour}}
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="所需人数"
                                     min-width="65">
                        <template slot-scope="scope">
                            <div v-if="scope.row.info!=''">
                                {{scope.row.info.totalperson}}
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="加工费用"
                                     min-width="65">
                        <template slot-scope="scope">
                            <div v-if="scope.row.info!=''">
                                {{scope.row.info.processingFee}}
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column label="详细信息"
                                     width="65">
                        <template slot-scope="scope">
                            <el-button type="text" size="medium" @@click="changeExpand(scope.row,true)">查看</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </el-row>
        </el-main>
    </el-container>
</div>
@*  引入组件：
    1/_SelectInput，下拉选择框组件
*@
@RenderPage("~/Views/Shared/_SelectInput.cshtml")
<script>
    var app = new Vue({
        el: "#app",
        data: {
            loading: false,//控制页面loading等待状态
            tableList: [],//存储表格总数据
            filterResult: [],//存储筛选总数据后的结果
            queryTable: {
                protype: '',
                proplatform: 'VA',
            },
            options: {
                protype: [],
                proplatform: [],
            },
            detailList: {},
            Reference: {
                value: "",
                options: []
            },
            detailshow: true,
            finalDetail: [],
            expandData: [],
            expandShow: false,
            areaFinalComputePostList: [],
            areaFinalComputeReturnList: [],
            areaFinalComputeReturnTotal: '',
        },
        //页面打开时执行
        created: function () {
            //获取下拉型号列表
            this.getProtype();
            //获取下拉平台列表
            this.getPlatfrom();
        },
        //函数方法
        methods: {
            //总表条件查询
            onQuerySubmit() {
                if (this.queryTable.protype == "" && this.queryTable.proplatform == "") {
                    return;
                };
                this.loading = true;
                this.changeExpand(this.expandData[0], false)
                axios.post('/Process_Capacity/GetInfoByModule1', {
                    type: this.queryTable.protype,
                    Platform: this.queryTable.proplatform
                }).then(res => {
                    //console.log(JSON.parse(JSON.stringify(res.data)));
                    //for (let option of res.data) {
                    //    option['ptmkIndex'] = 0;
                    //    option['moduleNameVal'] = [];
                    //    if (option.list != '') {
                    //        option.moduleNameVal = option.list[0];
                    //        option.list = this.cascaderArr(option.list);
                    //    }
                    //};
                    let rtd = this.handleRTD(res.data);
                    this.tableList = rtd;
                    this.filterResult = rtd;
                    this.loading = false;
                    this.$message.success('查询成功！');
                }).catch(err => {
                    console.warn("查询数据失败");
                    this.loading = false;
                });
            },
            //型号下拉列表获取方法
            getProtype() {
                axios.post('/Process_Capacity/TypeList').then(res => {
                    //console.log(res.data);
                    this.options.protype = res.data;
                }).catch(err => {
                    console.warn("型号列表获取失败");
                });
            },
            //平台下拉列表获取方法
            getPlatfrom() {
                axios.post('/Process_Capacity/DisplayPlatfromFromType', { type: '' }).then(res => {
                    //console.log(res.data);
                    this.options.proplatform = res.data;
                }).catch(err => {
                    console.warn("型号列表获取失败");
                });
            },
            //监听平台选择，调用筛选方法，即时更新筛选后的表格
            watchPlatform(v) {
                //this.filterList();
            },
            selectHandle(v) {
                this.queryTable.protype = '';
                this.onQuerySubmit();
            },
            //监听型号选择，调用筛选方法，即时更新筛选后的表格
            watchType(v) {
                //this.filterList();
            },
            //筛选方法，
            filterList() {
                let array = this.tableList,//所有数据
                    arr1 = this.queryTable.proplatform,//下拉列表选择的平台值
                    arr2 = this.queryTable.protype,//下拉列表选择的型号值
                    thisArr1, thisArr2;
                //过滤平台值，筛选出过滤后的列表 存为thisArr1
                thisArr1 = array.filter(function (val) {
                    if (arr1 == null || arr1 == "") {
                        return val;
                    } else {
                        for (let i of arr1) {
                            //if (val.platfrom.toLowerCase().indexOf(i.toLowerCase()) > -1) {
                            //    return val;
                            //};
                            if (val.platfrom.toLowerCase() == i.toLowerCase()) {
                                return val;
                            };
                        };
                    };
                });
                //在thisArr1筛选后，继续过滤型号值
                thisArr2 = thisArr1.filter(function (val) {
                    if (arr2 == null || arr2 == "") {
                        return val;
                    } else {
                        for (let i of arr2) {
                            //if (val.type.toLowerCase().indexOf(i.toLowerCase()) > -1) {
                            //    return val;
                            //};
                            if (val.type.toLowerCase() == i.toLowerCase()) {
                                return val;
                            };
                        };
                    };
                });
                this.filterResult = thisArr2;//存储筛选后的数据
            },
            //处理联级数组
            cascaderArr(arr) {
                let rtd = [],//返回的数组
                    exitArr = [];//记录已存在的根节点数组
                //判断传入的数组长度，大于1代表还有子节点需要处理
                if (arr.length > 1) {
                    for (let item of arr) {
                        //从记录的根节点数组上 找是否存在此次遍历的二维数组的第一个值
                        if (exitArr.indexOf(item[0]) >= 0) {
                            continue;//若存在，说明此节点已经生成树，需要跳过
                        } else {
                            exitArr.push(item[0]);//否则把此次新值添加进根节点数组
                        };
                        let thisFirst = item[0],//存此次根节点值
                            remainArr = [];//用来存，除去根节点外的剩余数组
                        for (let i of arr) {
                            //循环二维数组，找到与此次根节点相同的子数组
                            if (thisFirst == i[0]) {
                                if (i.length > 1) {
                                    //若子数组的长度大于1，说明还存在剩余数组，把第一个值去掉后，加进remainArr
                                    remainArr.push(i.slice(1));
                                } else {
                                    //否则直接作为树节点存入
                                    rtd.push({
                                        value: thisFirst,
                                        label: thisFirst
                                    });
                                };
                            };
                        };
                        //剩余数组不为空，则递归下去
                        if (remainArr.length > 0) {
                            rtd.push({
                                value: thisFirst,
                                label: thisFirst,
                                children: this.cascaderArr(remainArr)
                            });
                        };
                    };
                    return rtd;
                } else {
                    //若传入的数组长度为1，则判断此子数组数量是不是大于1，大于1则往后添加子节点
                    if (arr[0].length > 1) {
                        rtd.push({
                            value: arr[0][0],
                            label: arr[0][0],
                            children: this.cascaderArr([arr[0].slice(1)])
                        });
                    } else {
                        //否则直接作为树节点存入
                        rtd.push({
                            value: arr[0][0],
                            label: arr[0][0]
                        });
                    };
                    return rtd;
                };
            },
            handleRTD(rtd) {
                for (let item of rtd) {
                    if (item.platformModule.length > 0) {
                        //平台模块部分
                        item['ptmkVal'] = item.platformModule[0].PlatformModul;
                        item['ptmkIndex'] = 0;
                        //维护方式部分
                        item['whVal'] = '';
                        this.ptmkselect(item.ptmkVal, item);
                        //三防+灌胶部分
                        item['sgID'] = '';
                        item['sgVal'] = '';
                        item['sgOption'] = [];
                        //模组部分
                        item['mzID'] = '';
                        item['mzVal'] = '';
                        item['mzOption'] = [];
                        //分三段
                        item['mzall'] = [];
                        item['wayVal'] = '';
                        item['wayOption'] = [];
                        item['categoryVal'] = '';
                        item['categoryOption'] = [];
                        item['sizeVal'] = '';
                        item['sizeOption'] = [];
                        //包装部分
                        item['bzID'] = '';
                        item['bzVal'] = '';
                        item['bzOption'] = [];
                        //汇总信息
                        item['info'] = '';
                        item['area'] = '';
                        item['btnloading'] = false;
                    };
                };
                return rtd;
            },
            //重置数据
            clear(row, from) {
                //this.$refs.thistable.toggleRowExpansion(row, false);
                this.detailList = {};
                this.finalDetail = [];
                this.areaFinalComputePostObj = [];
                this.areaFinalComputeReturnList = [];
                this.areaFinalComputeReturnTotal = '';
                row.info = '';
                //if (from == "ptmk" || from == "wh" || from == "sg" || from == "way" || from == "category" || from == "size" || from == "bz") {
                //};
                if (from == "ptmk" || from == "wh" || from == "sg" || from == "way" || from == "category" || from == "size") {
                    row.bzID = '';
                    row.bzVal = '';
                    row.bzOption = [];
                };
                if (from == "ptmk" || from == "wh" || from == "sg" || from == "way" || from == "category") {
                    row.sizeVal = '';
                    row.sizeOption = [];
                };
                if (from == "ptmk" || from == "wh" || from == "sg" || from == "way") {
                    row.categoryVal = '';
                    row.categoryOption = [];
                };
                if (from == "ptmk" || from == "wh" || from == "sg") {
                    row.mzID = '';
                    row.mzVal = '';
                    row.mzOption = [];
                    row.mzall = '';
                    row.wayVal = '';
                    row.wayOption = [];
                };
                if (from == "ptmk" || from == "wh") {
                    row.sgID = '';
                    row.sgVal = '';
                    row.sgOption = [];
                };
                if (from == "ptmk") {
                    row.whVal = '';
                };
            },
            //选择平台模块
            ptmkselect(value, row) {
                this.clear(row, "ptmk");
                for (let i in row.platformModule) {
                    if (value == row.platformModule[i].PlatformModul) {
                        row.ptmkIndex = i;
                        if (row.platformModule[i].Maintenance.length <= 1) {
                            row.whVal = row.platformModule[i].Maintenance[0];
                            this.whselect(row);
                        };
                    };
                };
            },
            whselect(row) {
                this.clear(row, "wh");
                axios.post('/Process_Capacity/GetThreeList', {
                    type: row.type,
                    Platform: row.platfrom,
                    modulelist: row.ptmkVal,
                    Maintenance: row.whVal
                }).then(res => {
                    //console.log(JSON.parse(JSON.stringify(res.data)));
                    if (res.data.length > 1) {
                        row.sgOption = res.data;
                    } else {
                        row.sgID = res.data[0].threeid + '+' + res.data[0].guleid;
                        row.sgVal = res.data[0].threename + '+' + res.data[0].gulename;
                        this.sgselect(row);
                    };
                }).catch(err => {
                    console.log(err);
                });
            },
            //三防灌胶显示
            sglabel(s, g) {
                let rtlabel = ''
                if (s != '' && s != null && s != 'null') {
                    let san = s.split('➵');
                    if (san.length > 1) {
                        for (let i in san) {
                            rtlabel += san[i];
                            if (i < (san.length - 1)) {
                                rtlabel += '+';
                            };
                        };
                    } else {
                        rtlabel += s;
                    };
                };
                if (s != "" && s != null && s != 'null' && g != "" && g != null && g != 'null') {
                    rtlabel += '+';
                };
                if (g != '' && g != null && g != 'null') {
                    let guan = g.split('➵');
                    if (guan.length > 1) {
                        for (let i in guan) {
                            rtlabel += guan[i];
                            if (i < (guan.length - 1)) {
                                rtlabel += '+';
                            };
                        };
                    } else {
                        rtlabel += g;
                    };
                };
                return rtlabel;
            },
            //选择三防+灌胶
            sgselect(row) {
                this.clear(row, "sg");
                let id = row.sgID.split("+");
                axios.post('/Process_Capacity/GetMoudleList', {
                    type: row.type,
                    Platform: row.platfrom,
                    modulelist: row.ptmkVal,
                    Maintenance: row.whVal,
                    threeid: id[0],
                    guleid: id[1]
                }).then(res => {
                    //console.log(JSON.parse(JSON.stringify(res.data)));
                    //select存储
                    row.mzall = res.data;
                    //模组
                    if (res.data.idArry.length > 1) {
                        row.mzOption = res.data.idArry;
                    } else {
                        row.mzID = res.data.idArry[0].id;
                        row.mzVal = res.data.idArry[0].name;
                    };
                    //出货方式
                    if (Array.isArray(row.mzall.selectOption.way)) {
                        if (row.mzall.selectOption.way.length > 1) {
                            row.wayOption = [...new Set(row.mzall.selectOption.way)];
                        } else {
                            row.wayVal = row.mzall.selectOption.way[0];
                            this.wayselect(row, row.wayVal);
                        };
                    } else {
                        row.wayVal = row.mzall.selectOption.way;
                        this.wayselect(row, row.wayVal);
                    };
                }).catch(err => {
                    console.log(err);
                });
            },
            wayselect(row, value) {
                this.clear(row, "way");
                if (row.mzOption.length > 1) {
                    for (let i of row.mzOption) {
                        let way = i.name.split("➸");
                        if (way.length == 3) {
                            if (way[0] == value) {
                                row.categoryOption.push(way[1]);
                            };
                        } else {

                        };
                    };

                    row.categoryOption = [...new Set(row.categoryOption)];
                    if (row.categoryOption.length <= 1) {
                        row.categoryVal = row.categoryOption[0];
                        this.categoryselect(row, row.categoryVal);
                    };
                    //暂时赋值
                    //row.categoryVal = row.categoryOption[0];
                    //this.categoryselect(row, row.categoryVal);
                } else {
                    row.categoryVal = row.mzVal.split("➸")[1];
                    this.categoryselect(row, row.categoryVal);
                };
            },
            categoryselect(row, value) {
                this.clear(row, "category");
                if (row.mzOption.length > 1) {
                    for (let i of row.mzOption) {
                        let category = i.name.split("➸");
                        if (category.length == 3) {
                            if (row.wayVal == category[0] && category[1] == value) {
                                row.sizeOption.push(category[2]);
                            };
                        } else {

                        };
                    };

                    row.sizeOption = [...new Set(row.sizeOption)];
                    if (row.sizeOption.length <= 1) {
                        row.sizeVal = row.sizeOption[0];
                        this.sizeselect(row, row.sizeVal);
                    };
                    //暂时赋值
                    //row.sizeVal = row.sizeOption[0];
                    //this.sizeselect(row, row.sizeVal);
                } else {
                    row.sizeVal = row.mzVal.split("➸")[2];
                    this.sizeselect(row, row.sizeVal);
                };
            },
            sizeselect(row, value) {
                this.clear(row, "size");
                let id = row.sgID.split("+");

                if (row.mzOption.length > 1) {
                    for (let i of row.mzOption) {
                        let size = i.name.split("➸");
                        if (row.wayVal == size[0] && row.categoryVal == size[1] && row.sizeVal == size[2]) {
                            row.mzID = i.id;
                        };
                    };
                } else {
                    row.mzID = row.mzID;
                };
                axios.post('/Process_Capacity/GetPackList', {
                    type: row.type,
                    Platform: row.platfrom,
                    modulelist: row.ptmkVal,
                    Maintenance: row.whVal,
                    threeid: id[0],
                    guleid: id[1],
                    moduleid: row.mzID
                }).then(res => {
                    //console.log(JSON.parse(JSON.stringify(res.data)));
                    if (res.data.length > 1) {
                        row.bzOption = res.data;
                        //暂时赋值
                        //row.bzID = res.data[0].id;
                        //row.bzVal = res.data[0].name;
                        //this.bzselect(row);
                    } else {
                        row.bzID = res.data[0].id;
                        row.bzVal = res.data[0].name;
                        this.bzselect(row);
                    };
                }).catch(err => {
                    console.log(err);
                });
            },
            //选择包装
            bzselect(row) {
                this.clear(row, "bz");
                this.getCapHouse(row);
                //this.toogleExpand(row);
            },
            //获取详细值
            getCapHouse(row) {
                let id = row.sgID.split("+");
                axios.post('/Process_Capacity/GetCapHouse', {
                    type: row.type,
                    Platform: row.platfrom,
                    modulelist: row.ptmkVal,
                    Maintenance: row.whVal,
                    threeid: id[0],
                    guleid: id[1],
                    moduleid: row.mzID,
                    packid: row.bzID
                }).then(res => {
                    //console.log(JSON.parse(JSON.stringify(res.data)));
                    row.info = {
                        totalperson: res.data.totalperson,
                        processingFee: res.data.processingFee,
                        totalcapacityPerHour: res.data.totalcapacityPerHour,
                        resultMes: ''
                    };
                    this.detailList = res.data;
                    this.$refs.thistable.$root.expandShow && this.finalDetailSum(res.data);
                    //瓶颈参考列表
                    this.Reference.options = this.setReference(res.data);
                    //瓶颈参考默认值
                    this.Reference.options.forEach((item, index) => {
                        if (item.name === res.data.referenceName) {
                            this.Reference.value = index;
                        };
                    });
                }).catch(err => {
                    console.log(err);
                });
            },
            //设置瓶颈参考值
            setReference(val) {
                let rtd = [];
                for (let i in val.name) {
                    if (val.name[i] != 'IC' && val.name[i] != '灯面' &&
                        val.name[i] != '插件' && val.name[i] != '后焊' &&
                        val.name[i] != '模组装配' && val.name[i] != '拼屏' &&
                        val.name[i] != '拆屏' && val.name[i] != '包装') {
                        //if (val.equipmentCapacity[i] == "") {
                        //    rtd.push({
                        //        Referencecapacity: val.capacity[i],
                        //        isEquipment: false,
                        //        name: val.name[i]
                        //    });
                        //} else {
                        if (val.equipmentName[i].length > 1) {
                            for (let s in val.equipmentName[i]) {
                                rtd.push({
                                    Referencecapacity: val.equipmentCapacity[i][s],
                                    ReferenceModuleNeed: val.moduleNeed[i],
                                    isEquipment: true,
                                    name: val.name[i] + ":" + val.equipmentName[i][s]
                                });
                            };
                        } else {
                            rtd.push({
                                Referencecapacity: val.equipmentCapacity[i][0],
                                ReferenceModuleNeed: val.moduleNeed[i],
                                isEquipment: true,
                                name: val.name[i]
                            });
                        };
                        //};
                    };
                };
                return rtd;
            },
            //选择瓶颈参考值
            selectCapHouse(row, val) {
                let reference = this.Reference.options[val];
                let id = row.sgID.split("+");
                axios.post('/Process_Capacity/GetCapHouse', {
                    type: row.type,
                    Platform: row.platfrom,
                    modulelist: row.ptmkVal,
                    Maintenance: row.whVal,
                    threeid: id[0],
                    guleid: id[1],
                    moduleid: row.mzID,
                    packid: row.bzID,
                    isEquipment: reference.isEquipment,//true是设备,false 是标准
                    Referencecapacity: reference.Referencecapacity,//瓶颈参考值
                    ReferenceModuleNeed: reference.ReferenceModuleNeed//瓶颈需求值
                }).then(res => {
                    //console.log(JSON.parse(JSON.stringify(res.data)));
                    row.info = {
                        totalperson: res.data.totalperson,
                        processingFee: res.data.processingFee,
                        totalcapacityPerHour: res.data.totalcapacityPerHour,
                        resultMes: ''
                    };
                    this.detailList = res.data;
                    this.finalDetailSum(res.data);
                }).catch(err => {
                    console.log(err);
                });
            },
            //详细展开切换
            toogleExpand(row, event, column) {
                //切换展开状态清空值
                let $table = this.$refs.thistable, isclear = true;
                this.filterResult.map((item) => {
                    if (row.platfrom == item.platfrom && row.type == item.type && row.PCB == item.PCB) {
                        isclear = false;
                    } else {
                        $table.toggleRowExpansion(item, false);
                    };
                });
                isclear && this.clear(row, 'qh');
                $table.toggleRowExpansion(row);
                //若该行值不为空，详细表取值
                if (row.type != '' && row.platfrom != '' && row.ptmkVal != '' && row.whVal != '' && row.sgID !== '' && row.mzID !== '' && row.bzID !== '') {
                    this.getCapHouse(row);
                };
                this.$nextTick(_ => {
                    let refs = this.$refs.computeInput;
                    if (refs) {
                        refs.focus();
                    };
                });
            },
            //切换成展开表
            changeExpand(row, from) {
                this.expandData = [];
                this.detailList = {};
                this.finalDetail = [];
                this.areaFinalComputePostObj = [];
                this.areaFinalComputeReturnList = [];
                this.areaFinalComputeReturnTotal = '';
                if (from) {
                    this.expandShow = true;
                    this.expandData.push(row);
                    if (row.type != '' && row.platfrom != '' && row.ptmkVal != '' && row.whVal != '' && row.sgID !== '' && row.mzID !== '' && row.bzID !== '') {
                        this.getCapHouse(row);
                    };
                    this.$nextTick(_ => {
                        this.$refs.thistable.toggleRowExpansion(row, true);
                    });
                } else {
                    this.expandShow = false;
                };
            },
            //综合计算最终结果需要的信息
            finalDetailSum(detailobj) {
                let rtd = {
                    smtlength: 0,
                    pmlength: 0,
                    mklength: 0,
                    mzlength: 0,

                    smtpersoncount: 0,
                    mkpersoncount: 0,

                    smtbalanceequipmentcount: 0,
                    mkbalanceequipmentcount: 0,

                    smtmincapacity: 0,
                    mkmincapacity: 0,

                    pmdata: {
                        person: 0,
                        capacity: 0,
                        equipment: 0,
                    },
                    mzarr: [],
                    jieguoxishu: 0,
                }, smtVal = [], pmVal = [], mkVal = [], mzVal = [],
                    smtTimeVal = [], pmTimeVal = [], mkTimeVal = [], mzTimeVal = [];
                //post数据计算部分
                let postNeed = {
                    smtNeed: [],
                    pmNeed: [],
                    mkNeed: [],
                    mzNeed: [],
                }, postList = [];
                //---
                //模块单独计算部分
                let mkNeed = [], mkArr = [];
                //---
                //老化调试版本的单独计算部分
                rtd['burninobjarr'] = {
                    zhuangpei: {
                        person: 0,
                        capacity: 0,
                        equipment: 0
                    },
                    laohua: {
                        person: 0,
                        capacity: 0,
                        equipment: 0
                    },
                    baozhuang: {
                        person: 0,
                        capacity: 0,
                        equipment: 0
                    }
                };
                //---
                detailobj.name.forEach((item, index) => {
                    if (item == 'IC' || item == '灯面' || item == '插件' || item == '后焊') {
                        //smt
                        for (let i in detailobj.equipmentName[index]) {
                            smtVal.push(detailobj.balanceCapacity[index][i]);
                            smtTimeVal.push((detailobj.moduleNeed[index] / detailobj.balanceCapacity[index][i]));
                            rtd.smtpersoncount += detailobj.balancePerson[index][i];
                            rtd.smtbalanceequipmentcount += (detailobj.balanceEquipmentNum[index][i] == undefined ? 1 : detailobj.balanceEquipmentNum[index][i]);
                            //post数据计算部分
                            postNeed.smtNeed.push({
                                name: 'SMT(线)',
                                number: detailobj.moduleNeed[index]
                            });
                            //---
                        };
                        rtd.smtlength++;
                    } else if (item == '模组装配' || item == '拼屏' || item == '拆屏' || item == '包装') {
                        //模组
                        for (let i in detailobj.equipmentName[index]) {
                            mzVal.push(detailobj.balanceCapacity[index][i]);
                            mzTimeVal.push((detailobj.moduleNeed[index] / detailobj.balanceCapacity[index][i]));

                            //老化调试版本的单独计算部分
                            if (item == '模组装配') {
                                rtd.burninobjarr.zhuangpei.person += detailobj.balancePerson[index][i];
                                rtd.burninobjarr.zhuangpei.capacity += detailobj.balanceCapacity[index][i];
                                rtd.burninobjarr.zhuangpei.equipment += (detailobj.balanceEquipmentNum[index][i] == undefined ? 1 : detailobj.balanceEquipmentNum[index][i]);
                            };
                            if (item == '拼屏' || item == '拆屏') {
                                rtd.burninobjarr.laohua.person += detailobj.balancePerson[index][i];
                                rtd.burninobjarr.laohua.capacity += ((detailobj.balancePerson[index][i] * 3600) / detailobj.balanceCapacity[index][i]);
                                rtd.burninobjarr.laohua.equipment += (detailobj.balanceEquipmentNum[index][i] == undefined ? 0 : detailobj.balanceEquipmentNum[index][i]);
                            };
                            if (item == '包装') {
                                rtd.burninobjarr.baozhuang.person += detailobj.balancePerson[index][i];
                                rtd.burninobjarr.baozhuang.capacity += detailobj.balanceCapacity[index][i];
                                rtd.burninobjarr.baozhuang.equipment += (detailobj.balanceEquipmentNum[index][i] == undefined ? 1 : detailobj.balanceEquipmentNum[index][i]);
                            };
                            //---

                            //post数据计算部分
                            let n = '';
                            switch (item) {
                                case '模组装配': n = '模组装配(线)'; break;
                                case '拼屏': n = '拼屏'; break;
                                case '拆屏': n = '拆屏'; break;
                                case '包装': n = '包装(线)'; break;
                            };
                            postNeed.mzNeed.push({
                                name: n,
                                number: detailobj.moduleNeed[index],
                                capacity: detailobj.balanceCapacity[index][i],
                            });
                            //分开模组
                            rtd.mzarr.push({
                                name: n,
                                person: detailobj.balancePerson[index][i],
                                capacity: detailobj.balanceCapacity[index][i],
                                equipment: (detailobj.balanceEquipmentNum[index][i] == undefined ? 1 : detailobj.balanceEquipmentNum[index][i]),
                            });
                            //---
                        };
                        rtd.mzlength++;
                    } else if (item == '喷墨测试') {
                        for (let i in detailobj.equipmentName[index]) {
                            pmVal.push(detailobj.balanceCapacity[index][i]);
                            pmTimeVal.push((detailobj.moduleNeed[index] / detailobj.balanceCapacity[index][i]));
                            rtd.pmdata = {
                                person: detailobj.balancePerson[index][i],
                                capacity: detailobj.balanceCapacity[index][i],
                                equipment: (detailobj.balanceEquipmentNum[index][i] == undefined ? 1 : detailobj.balanceEquipmentNum[index][i]),
                            };
                            //post数据计算部分
                            postNeed.pmNeed.push({
                                name: '喷墨(设备)',
                                number: detailobj.moduleNeed[index]
                            });
                            //---
                        };
                        rtd.pmlength++;
                    } else {
                        //模块单独计算部分
                        mkNeed.push(detailobj.moduleNeed[index]);
                        mkArr.push(detailobj.balanceCapacity[index]);
                        //---
                        for (let i in detailobj.equipmentName[index]) {
                            mkVal.push(detailobj.balanceCapacity[index][i]);//原本模块
                            mkTimeVal.push((detailobj.moduleNeed[index] / detailobj.balanceCapacity[index][i]));
                            rtd.mkpersoncount += detailobj.balancePerson[index][i];
                            rtd.mkbalanceequipmentcount += (detailobj.balanceEquipmentNum[index][i] == undefined ? 1 : detailobj.balanceEquipmentNum[index][i]);
                            //post数据计算部分
                            postNeed.mkNeed.push({
                                name: '模块(设备)',
                                number: detailobj.moduleNeed[index]
                            });
                            //---
                        };
                        rtd.mklength++;
                    };
                });
                //老化调试版本的单独计算部分
                rtd.burninobjarr.laohua.equipment = rtd.burninobjarr.laohua.equipment == 0 ? 1 : rtd.burninobjarr.laohua.equipment;
                rtd.burninobjarr.laohua.capacity = ((3600 / rtd.burninobjarr.laohua.capacity) * rtd.burninobjarr.laohua.person);
                //---
                //模块单独计算部分
                let mkMaxNeed = Math.max(...mkNeed),
                    mkMinNeed = Math.min(...mkNeed),
                    mklist = [];
                for (let i in mkNeed) {
                    if (mkNeed[i] == mkMaxNeed) {
                        for (let item of mkArr[i]) {
                            mklist.push(item / (mkMaxNeed / mkMinNeed));
                        };
                    } else {
                        for (let item of mkArr[i]) {
                            mklist.push(item);
                        };
                    };
                };
                rtd.mkmincapacity = Math.min(...mklist);
                //---
                rtd.jieguoxishu += Math.min(...smtTimeVal);
                for (let pm of pmTimeVal) {
                    rtd.jieguoxishu += pm;
                };
                rtd.jieguoxishu += Math.min(...mkTimeVal);
                for (let mz of mzTimeVal) {
                    rtd.jieguoxishu += mz;
                };
                rtd.smtmincapacity = Math.min(...smtVal);


                //生成post数据，且按顺序添加工段成数组
                let rtdlist = [];
                if (rtd.smtlength > 0) {
                    postList.push({
                        Name: postNeed.smtNeed[0].name,
                        Capacity: rtd.smtmincapacity,
                        ModuleNeed: postNeed.smtNeed[0].number,
                    });
                    // 👆post   👇表格数据
                    rtdlist.push({
                        title: postNeed.smtNeed[0].name,
                        length: rtd.smtlength,
                        capacity: rtd.smtmincapacity,
                        person: rtd.smtpersoncount,
                        equipment: rtd.smtbalanceequipmentcount
                    });
                };
                if (rtd.pmlength > 0) {
                    postList.push({
                        Name: postNeed.pmNeed[0].name,
                        Capacity: rtd.pmdata.capacity,
                        ModuleNeed: postNeed.smtNeed[0].number,
                    });
                    // 👆post   👇表格数据
                    rtdlist.push({
                        title: postNeed.pmNeed[0].name,
                        length: rtd.pmlength,
                        capacity: rtd.pmdata.capacity,
                        person: rtd.pmdata.person,
                        equipment: rtd.pmdata.equipment
                    });
                };
                if (rtd.mklength > 0) {
                    postList.push({
                        Name: postNeed.mkNeed[0].name,
                        Capacity: rtd.mkmincapacity,
                        ModuleNeed: postNeed.smtNeed[0].number,
                    });
                    // 👆post   👇表格数据
                    rtdlist.push({
                        title: postNeed.mkNeed[0].name,
                        length: rtd.mklength,
                        capacity: rtd.mkmincapacity,
                        person: rtd.mkpersoncount,
                        equipment: rtd.mkbalanceequipmentcount
                    });
                };
                if (rtd.mzlength > 0) {
                    for (let i of postNeed.mzNeed) {
                        postList.push({
                            Name: i.name,
                            Capacity: i.capacity,
                            ModuleNeed: i.number
                        });
                    };
                    // 👆post   👇表格数据
                    for (let i of rtd.mzarr) {
                        rtdlist.push({
                            title: i.name,
                            length: 1,
                            capacity: i.capacity,
                            person: i.person,
                            equipment: i.equipment
                        });
                    };
                };
                //--
                this.finalDetail = rtdlist;
                this.areaFinalComputePostList = postList;
                console.log(JSON.parse(JSON.stringify(this.finalDetail)));
            },
            areaCompute(row, areaVal) {
                row.info.resultMes = "";
                if (!Number(areaVal)) {
                    //this.$message.warning("请输入有效面积");
                    row.info.resultMes = "请输入有效面积";
                    return;
                };
                if (!row.btnloading) {
                    row.btnloading = true;
                    //setTimeout(()=> {
                    let mokSize = row.ptmkVal.split('*'),//切割模块
                        mokCount = 0,
                        mozSize = row.sizeVal.split('*'),//切割模组
                        mozCount = 0;
                    if (mokSize.length == 2) {
                        //mokCount = areaVal / ((Number(mokSize[0]) * Number(mokSize[1])) / 1000 / 1000);//模块数量
                    } else {
                        row.info.resultMes = "模块尺寸格式有误";
                        row.btnloading = false;
                        return;
                    };
                    if (mozSize.length == 2) {
                        //mozCount = areaVal / ((Number(mozSize[0]) * Number(mozSize[1])) / 1000 / 1000);//模组数量
                    } else {
                        row.info.resultMes = "箱体尺寸格式有误";
                        row.btnloading = false;
                        return;
                    };
                    this.areaFinalComputeReturnList = [];
                    axios.post('/Process_Capacity/GetTotalHours', {
                        area: areaVal,
                        platfrom: row.ptmkVal,
                        packageSize: row.sizeVal,
                        tips: 1.15,
                        totals: this.areaFinalComputePostList,
                    }).then(res => {
                        console.log(JSON.parse(JSON.stringify(res.data)));
                        //row.info.resultMes = `生产${areaVal}㎡总工时：${(mozCount * this.finalDetail.jieguoxishu).toFixed(2)}(H)`;

                        let detail = this.finalDetail, list = [], rtd = res.data;
                        for (let r of rtd) {
                            for (let d of detail) {
                                if (r.Name == d.title) {
                                    list.push({
                                        title: d.title,
                                        capacity: d.capacity,
                                        person: d.person,
                                        equipment: d.equipment,
                                        time: r.productionTime,
                                    });
                                    if (r.Name == '包装(线)') continue;
                                    list.push({
                                        title: '周转时间',
                                        capacity: '',
                                        person: '',
                                        equipment: '',
                                        time: r.turnoverTime,
                                    });
                                    break;
                                };
                            };
                            if (r.Name == '总时长') {
                                this.areaFinalComputeReturnTotal = `生产${areaVal}㎡总工时：${r.productionTime}(H)`;
                            };
                        };
                        this.areaFinalComputeReturnList = list;

                        //控制显示
                        row.btnloading = false;
                    }).catch(err => {
                        //控制显示
                        row.btnloading = false;
                        console.log(err);
                    });
                    //}, 500);
                };
            },
        },
        //页面加载完后执行
        mounted: function () {
            //页面加载完后 调用方法获取表格数据
            this.onQuerySubmit();
        },
    });
</script>