@{
    ViewBag.Title = "添加点检记录";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title></title>
    <link href="~/Scripts/Bootstraps/Element-ui.css" rel="stylesheet" />
    <script src="~/Scripts/axios.min.js"></script>
    <script src="~/Scripts/Bootstraps/Element-ui.js"></script>
    <script src="~/Content/styleFile/solder/solderJavascript.js"></script>
    <style>
        .taocontainer{
            display:flex;
            justify-content:space-around;
            margin-top:5px;
        }
        .bottomContainer {
        display: flex;
        justify-content: center;
        margin-top: 3px;
    }
        table > thead > tr > th, table > tbody > tr > td {
        text-align: center !important;
    }
        .el-table td{
            padding:0!important;
        }
    </style>
</head>

<body>
    <h2 style="text-align:center;margin-top:15px;margin-bottom:5px;font-size:21px;">点检表记录表</h2>

    <div id="app">
        @* 导航按钮 *@
        <p style="display:flex;justify-content:center;margin-top:10px;">
            <a href="/Equipment/Equipment_Rateof_grain"><el-button type="primary" size="mini" plain>稼动率</el-button></a>
            <a href="/Equipment/Equipment_Duration"><el-button type="primary" size="mini" plain>设备运行时长汇总</el-button></a>
            <a class="checkLines" href="/Equipment/Departmental_usage"><el-button type="primary" size="mini" plain>部门使用率</el-button></a>
            <a class="checkLines" href="/Equipment/index"><el-button type="primary" size="mini" plain>产线设备管理</el-button></a>
            <a class="shebeitaizhang" href="/Equipment/First_equipment"><el-button type="primary" size="mini" plain>设备台账</el-button></a>
            <a class="chechTimePlan" href="/Equipment/Equipment_MonthlyMaintenance_plan"><el-button type="primary" size="mini" plain>月保养计划</el-button></a>
            <a class="checkTally" href="/Equipment/Equipment_Tally"><el-button type="primary" size="mini">点检表记录表</el-button></a>
            <a class="checkRepiabill" href="/Equipment/EquipmentRepairbill_Query"><el-button type="primary" size="mini" plain>仪器设备报修单</el-button></a>
            <a class="checkRepiabill" href="/Equipment/Equipment_safety"><el-button type="primary" size="mini" plain>安全库存清单</el-button></a>
            <a class="targetSumary" href="/Equipment/Equipment_Quality_target"><el-button type="primary" size="mini" plain>指标达成率</el-button></a>
        </p>

        @* 查询选择框s *@
        <div class="taocontainer">
            <div class="topinner">
                <el-input placeholder="请输入设备名称"
                          size="mini"
                          v-model="Ename"
                          clearable>
                </el-input>
            </div>
            <div class="topinner">
                <el-input placeholder="请输入线别"
                          v-model="lineNum"
                          size="mini"
                          clearable>
                </el-input>
            </div>
            <div class="topinner">
                <el-select v-model="orderNum" size="mini" allow-create filterable clearable placeholder="请选择设备编号">
                    <el-option v-for="item in options"
                               v-bind:key="item.value"
                               v-bind:label="item.label"
                               v-bind:value="item.value">
                    </el-option>
                </el-select>
            </div>
            <div class="topinner">
                <el-select v-model="userdepar" size="mini" allow-create filterable clearable placeholder="请选择使用部门">
                    <el-option v-for="item in deparlist"
                               v-bind:key="item.value"
                               v-bind:label="item.label"
                               v-bind:value="item.value">
                    </el-option>
                </el-select>
            </div>
            <div class="topinner">
                <el-date-picker v-model="time"
                                type="date"
                                size="mini"
                                placeholder="选择日期">
                </el-date-picker>
            </div>
            <div class="topinner">
                <el-button id="search" type="success" size="mini" v-on:click="query">查询</el-button>
            </div>
        </div>

        @* 添加点检项目弹框 *@
        <el-dialog title="添加设备点检记录"
                   v-bind:visible.sync="centerDialogVisible"
                   width="30%"
                   center>
            <el-form label-width="80px" ref="ruleForm" model="formLabelAlign">
                <el-form-item label="设备编号">
                    <el-select v-model="formLabelAlign.Enumber2" v-on:change="selectChange" clearable filterable placeholder="请选择">
                        <el-option v-for="item in options"
                                   v-bind:key="item.value"
                                   v-bind:label="item.label"
                                   v-bind:value="item.value">
                        </el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="设备名称">
                    <el-input v-model="formLabelAlign.EName2"></el-input>
                </el-form-item>
                <el-form-item label="线别">
                    <el-input v-model="formLabelAlign.lineNum2"></el-input>
                </el-form-item>
                <el-form-item label="日期">
                    <el-date-picker v-model="formLabelAlign.times2"
                                    type="month"
                                    placeholder="选择月">
                    </el-date-picker>
                </el-form-item>
                <el-form-item>
                        <el-button v-on:click="centerDialogVisible = false">取 消</el-button>
                        <el-button type="primary" v-on:click="postAdd">确 定</el-button>
                </el-form-item>
          </el-form>
        </el-dialog>

        @* 点检表 *@
        <div class="bottomContainer">
            <div style="width:60.6%">
                <el-table v-bind:data="tableData"
                          border
                          max-height="650"
                          style="width: 100%">
                    <el-table-column prop="UserDepartment"
                                     width="120"
                                     label="部门">
                    </el-table-column>
                    <el-table-column prop="LineName"
                                     width="150"
                                     label="线别">
                    </el-table-column>
                    <el-table-column prop="EquipmentName"
                                     label="设备名称"
                                     width="140">
                    </el-table-column>
                    <el-table-column prop="EquipmentNumber"
                                     label="设备编号"
                                     width="130">
                    </el-table-column>
                    <el-table-column prop="times"
                                     width="120"
                                     label="时间">
                    </el-table-column>
                    <el-table-column prop=""
                                     width="92"
                                     label="操作">
                        <template slot-scope="scope">
                            <a v-bind:href=`/Equipment/Equipment_Tally_maintenance?num=${scope.row.EquipmentNumber}&year=${scope.row.Year}&month=${scope.row.Month}` target="_blank">
                                <el-button type="primary" size="small">详细</el-button>
                            </a>
                        </template>
                    </el-table-column>
                </el-table>
            </div>
        </div>
        
    </div>

    <script>
        // 返回上一页
        function goback() {
            window.history.back()
        }
        let app = new Vue({
            el: "#app",
            data: {
                Ename: null,   // 设备名称
                lineNum: null, // 产线
                orderNum: null,  // 订单号
                time: null,     //所选时间
                options: [],    
                tableData: [],   // 点检表数据
                centerDialogVisible: false,   // 控制添加项目弹框显示或显示
                formLabelAlign: {    // 设备基本信息
                    times2: null,
                    Enumber2: null,
                    lineNum2: null,
                    EName2: null,
                },
                userdepar: null,    // 使用部门
                deparlist:[]      // 部门列表
            },
            methods: {
                // 查找方法，根据所选设备名称、订单号、时间段、使用部门来获取点检表数据
                query() {
                    if (this.Ename != '' || this.lineNum != '' || this.orderNum != '' || this.time != '' || this.deparlist != '') {
                        console.log(this.time)
                        let dd = new Date(this.time);
                        let selectYear = dd.getFullYear();
                        let selectMonth = dd.getMonth() + 1
                        axios.post("/Equipment/Equipment_Tally", {
                            equipmentName: this.Ename,
                            lineNum: this.lineNum,
                            equipmentNumber: this.orderNum,
                            year: this.time == null ? null : selectYear,
                            month: this.time == null ? null : selectMonth,
                            userdepartment: this.userdepar
                        }).then(res => {
                            console.log(res.data)
                            if (res.data.length > 0) {
                                res.data.forEach(item=> {
                                    item.times = `${item.Year}年${item.Month}月`
                                })
                                this.tableData = res.data;
                            } else {
                                this.$message({
                                    message: "查无对应数据",
                                    type: "warning"
                                })
                            }
                        }).catch(err=> {

                        })
                    } else {
                        this.$message({
                            message: "请输入需要查询的信息",
                            type:"warning"
                        })
                    }
                },
                // 获取所有设备资产编号
                getEnumnbers() {
                    axios.post("/Equipment/TallyList").then(res=> {
                        console.log(res.data)
                        res.data.forEach(item=> {
                            let obj = { value: item, label: item }
                            this.options.push(obj)
                        })
                    }).catch(err=> {

                    })
                    axios.post("/Equipment/Tally_Deparlist").then(res=> {
                        console.log(res.data)
                        res.data.forEach(item=> {
                            let obj = { value: item, label: item }
                            this.deparlist.push(obj)
                        })
                    }).catch(err=> {

                    })
                },
                // 详细按钮跳转到详细页--传：资产编号、年、月
                goDetials(item) {
                    window.location.href = "/Equipment/Equipment_Tally_maintenance?" + "num=" + item.EquipmentNumber + "&year=" + item.Year + "&month=" + item.Month
                },
                // 添加点检项目
                addInfos() {
                    this.centerDialogVisible = true;
                },
                //提交保存新增的点检表
                postAdd() {
                    console.log(this.formLabelAlign.times2)
                    let dd = new Date(this.formLabelAlign.times2)
                    let y = dd.getFullYear();
                    let m = dd.getMonth() + 1;
                    axios.post("/Equipment/AddEquipment_Tally_maintenance_Add", {
                        eqname: this.formLabelAlign.EName2,
                        linename: this.formLabelAlign.lineNum2,
                        eqnum: this.formLabelAlign.Enumber2,
                        year: this.formLabelAlign.times2==null?null:y,
                        month: this.formLabelAlign.times2==null?null:m
                    }).then(res=> {
                        console.log(res.data)
                        if (res.data == "保存成功！") {
                            this.$message({
                                message: "保存成功",
                                type: "success"
                            });
                            this.centerDialogVisible = false;
                            // 清空表单--重置
                            //this.resetForm();
                        } else {
                            this.$message({
                                message: res.data,
                                type: "warning"
                            });
                        }
                    })
                },
                // 获取设备信息补全
                selectChange(val) {
                    axios.post("/Equipment/Particulars", { equipmentNumber: val }).then(res=> {
                        console.log(res.data.EquipmentName)
                        console.log(res.data.LineNum)
                        app.formLabelAlign.EName2 = res.data.EquipmentName;
                        this.formLabelAlign.lineNum2 = res.data.LineNum;
                    })
                }
            },
            mounted() {
                // 页面加载获取资产编号
                this.getEnumnbers()
            },
            watch: {
               
            }     
        })
        // 监听回车键--触发查找点检表
        document.onkeydown = function (event) {
            var e = event || window.event;    // 兼容IE
            if (e && e.keyCode == 13) { //回车键的键值为13
                $("#search").click();
            }
        };
    </script>
</body>
</html>
