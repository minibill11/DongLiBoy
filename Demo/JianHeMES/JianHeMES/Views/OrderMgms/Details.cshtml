@model JianHeMES.Models.OrderMgm

@{
    ViewBag.Title = "订单详细情况";
}
<style>
    body {
        overflow-y: scroll;
    }

    .titleRow div {
        font-size: 17px;
        padding: 10px;
    }

        .titleRow div span {
            font-weight: bold;
        }

    .modal-dialog {
        width: 80%;
        height: 100%;
        margin: 0px auto;
    }

    th {
        text-align: center;
    }

    @@media screen and (max-width:768px) {
        .modal-dialog {
            width: 100%;
        }

        .pdfViewer .page {
            margin: 0;
            border: 1px solid black;
        }

        #mainContainer {
            min-width: 300px;
        }
    }
</style>
<script src="~/Scripts/imgJS/exif.js"></script>
<script src="~/Scripts/imgJS/uploadImage.js"></script>
<h3>@ViewBag.Title</h3>
<hr />
<div class="row titleRow">
    <div class="col-md-3">
        <span>
            @Html.DisplayNameFor(model => model.OrderNum)
        </span>：
        @Html.DisplayFor(model => model.OrderNum, new { @id = "OrderNum" })
    </div>
    <div class="col-md-3">
        <span>
            @Html.DisplayNameFor(model => model.CustomerName)
        </span>：
        @Html.DisplayFor(model => model.CustomerName, new { @id = "CustomerName" })
    </div>
    <div class="col-md-3">
        <span>
            @Html.DisplayNameFor(model => model.Area)
        </span>：
        @Html.DisplayFor(model => model.Area)
    </div>
    <div class="col-md-3">
        <span>
            @Html.DisplayNameFor(model => model.PlatformType)
        </span>：
        @Html.DisplayFor(model => model.PlatformType)
    </div>
</div>
<div class="row titleRow">
    <div class="col-md-3">
        <span>
            @Html.DisplayNameFor(model => model.PlanInputTime)
        </span>：
        @Html.DisplayFor(model => model.PlanInputTime)
    </div>
    <div class="col-md-3">
        <span>
            @Html.DisplayNameFor(model => model.PlanCompleteTime)
        </span>：
        @Html.DisplayFor(model => model.PlanCompleteTime)
    </div>
    <div class="col-md-3">
        <span>
            @Html.DisplayNameFor(model => model.ContractDate)
        </span>：
        @Html.DisplayFor(model => model.ContractDate)
    </div>
    <div class="col-md-3">
        <span>
            @Html.DisplayNameFor(model => model.DeliveryDate)
        </span>：
        @Html.DisplayFor(model => model.DeliveryDate)
    </div>
</div>
<div class="row titleRow">
    <div class="col-md-3">
        <span>
            @Html.DisplayNameFor(model => model.IsRepertory)
        </span>：
        @Html.DisplayFor(model => model.IsRepertory)
    </div>
    <div class="col-md-3">
        <span>
            @Html.DisplayNameFor(model => model.IsAOD)
        </span>：
        @Html.DisplayFor(model => model.IsAOD)
    </div>
</div>
<hr />
<table class="table table-bordered">
    <colgroup>
        <col style="width:14%" />
        <col style="width:14%" />
        <col style="width:15%" />
        <col style="width:14%" />
        <col style="width:15%" />
        <col style="width:14%" />
        <col style="width:14%" />
    </colgroup>
    <tr>
        <td colspan="2">
            <span>
                @Html.DisplayNameFor(model => model.BarCodeCreated)
            </span>：
            <span id="createdBarcode">@Html.DisplayFor(model => model.BarCodeCreated, new { id = "BarCodeCreated" })</span>
        </td>
        <td colspan="5">
            <span>
                @Html.DisplayNameFor(model => model.OrderCreateDate)
            </span>：
            @Html.DisplayFor(model => model.OrderCreateDate, new { id = "BarCodeCreator" })
        </td>
    </tr>
    <tr>
        <td colspan="2">
            <span>
                @Html.DisplayNameFor(model => model.BarCodeCreator)
            </span>：
            @Html.DisplayFor(model => model.BarCodeCreator, new { id = "BarCodeCreator" })
        </td>
        <td colspan="3">
            <span>
                @Html.DisplayNameFor(model => model.BarCodeCreateDate)
            </span>：
            @Html.DisplayFor(model => model.BarCodeCreateDate, new { id = "BarCodeCreateDate" })
        </td>
        <td colspan="2">
            <span>
                @Html.DisplayNameFor(model => model.Remark)
            </span>：
            @Html.DisplayFor(model => model.Remark, new { id = "BarCodeCreator" })
        </td>
    </tr>
    <tr>
        <td>@Html.DisplayNameFor(model => model.Boxes)</td>
        <td>@Html.DisplayNameFor(model => model.Models)</td>
        <td>@Html.DisplayNameFor(model => model.ModelsMore)</td>
        <td>@Html.DisplayNameFor(model => model.Powers)</td>
        <td>@Html.DisplayNameFor(model => model.PowersMore)</td>
        <td>@Html.DisplayNameFor(model => model.AdapterCard)</td>
        <td>@Html.DisplayNameFor(model => model.AdapterCardMore)</td>
    </tr>
    <tr>
        <td>@Html.DisplayFor(model => model.Boxes, new { @id = "Boxes" })</td>
        <td>@Html.DisplayFor(model => model.Models, new { id = "Models" })</td>
        <td>@Html.DisplayFor(model => model.ModelsMore, new { id = "ModelsMore" })</td>
        <td>@Html.DisplayFor(model => model.Powers, new { id = "Powers" })</td>
        <td>@Html.DisplayFor(model => model.PowersMore, new { id = "PowersMore" })</td>
        <td>@Html.DisplayFor(model => model.AdapterCard, new { id = "AdapterCard" })</td>
        <td>@Html.DisplayFor(model => model.AdapterCardMore, new { id = "AdapterCardMore" })</td>
    </tr>
    @if (Model.IsAOD == true)
    {
        <tr>
            <td style="padding:8px 5px;">转为特采订单原因：</td>
            <td colspan="3"><span>@Html.DisplayFor(model => model.AOD_Description)</span></td>
            <td colspan="1">转单人：<span>@Html.DisplayFor(model => model.AODConverter)</span></td>
            <td colspan="2">转单时间：<span>@Html.DisplayFor(model => model.AODConvertDate)</span></td>
        </tr>
    }
</table>

<br />
<table id="summary" class="table table-bordered">
    <tr>
        <th>工段</th>
        <th>开始时间</th>
        <th>最后时间</th>
        <th>完成时间</th>
        <th>作业时长</th>
        <th>正常个数</th>
        <th>直通数</th>
        <th>直通率</th>
        <th>完成率</th>
        <th>合格率</th>
    </tr>
    <tr class="text-center">
        <td>组装<input id="detailsJson" value="@ViewBag.ProductionDetailsJson" style="display:none" /></td>
        <td>{{ProductionDetailsJson.AssembleBeginTime==""?'无记录':ProductionDetailsJson.AssembleBeginTime}}</td>
        <td>{{ProductionDetailsJson.AssembleEndTime}}</td>
        <td>{{ProductionDetailsJson.AssembleFinishTime}}</td>
        <td>{{newTime(ProductionDetailsJson.AssembleNewTime)}}</td>
        <td>{{ProductionDetailsJson.AssemblePassYieldCount=="0"?'':ProductionDetailsJson.AssemblePassYieldCount}}</td>
        <td>{{ProductionDetailsJson.AssembleFirstPassYieldCount=="0"?'':ProductionDetailsJson.AssembleFirstPassYieldCount}}</td>
        <td>{{ProductionDetailsJson.AssembleFirstPassYield_Rate==""?'':ProductionDetailsJson.AssembleFirstPassYield_Rate+'%'}}</td>
        <td>{{ProductionDetailsJson.AssembleFinisthRate==""?'':ProductionDetailsJson.AssembleFinisthRate+'%'}}</td>
        <td>{{ProductionDetailsJson.AssemblePassRate==""?'':ProductionDetailsJson.AssemblePassRate+'%'}}</td>
    </tr>
    <tr class="text-center">
        <td>FQC<input id="detailsJson" value="@ViewBag.ProductionDetailsJson" style="display:none" /></td>
        <td>{{ProductionDetailsJson.FinalQCBeginTime==""?'无记录':ProductionDetailsJson.FinalQCBeginTime}}</td>
        <td>{{ProductionDetailsJson.FinalQCEndTime}}</td>
        <td>{{ProductionDetailsJson.FinalQCFinishTime}}</td>
        <td>{{newTime(ProductionDetailsJson.FinalQCNewTime)}}</td>
        <td>{{ProductionDetailsJson.FinalQCPassYieldCount=="0"?'':ProductionDetailsJson.FinalQCPassYieldCount}}</td>
        <td>{{ProductionDetailsJson.FinalQCFirstPassYieldCount=="0"?'':ProductionDetailsJson.FinalQCFirstPassYieldCount}}</td>
        <td>{{ProductionDetailsJson.FinalQCFirstPassYield_Rate==""?'':ProductionDetailsJson.FinalQCFirstPassYield_Rate+'%'}}</td>
        <td>{{ProductionDetailsJson.FinalQCFinisthRate==""?'':ProductionDetailsJson.FinalQCFinisthRate+'%'}}</td>
        <td>{{ProductionDetailsJson.FinalQCPassRate==""?'':ProductionDetailsJson.FinalQCPassRate+'%'}}</td>
    </tr>
    <tr class="text-center">
        <td>老化</td>
        <td>{{ProductionDetailsJson.Burn_inBeginTime==""?'无记录':ProductionDetailsJson.Burn_inBeginTime}}</td>
        <td>{{ProductionDetailsJson.Burn_inEndTime}}</td>
        <td>{{ProductionDetailsJson.Burn_inFinishTime}}</td>
        <td>{{newTime(ProductionDetailsJson.Burn_inNewTime)}}</td>
        <td>{{ProductionDetailsJson.Burn_inPassYieldCount=="0"?'':ProductionDetailsJson.Burn_inPassYieldCount}}</td>
        <td>{{ProductionDetailsJson.Burn_inFirstPassYieldCount=="0"?'':ProductionDetailsJson.Burn_inFirstPassYieldCount}}</td>
        <td>{{ProductionDetailsJson.Burn_inFirstPassYield_Rate==""?'':ProductionDetailsJson.Burn_inFirstPassYield_Rate+'%'}}</td>
        <td>{{ProductionDetailsJson.Burn_inFinisthRate==""?'':ProductionDetailsJson.Burn_inFinisthRate+'%'}}</td>
        <td>{{ProductionDetailsJson.Burn_inPassRate==""?'':ProductionDetailsJson.Burn_inPassRate+'%'}}</td>
    </tr>
    <tr class="text-center">
        <td>校正</td>
        <td>{{ProductionDetailsJson.CalibrationBeginTime==""?'无记录':ProductionDetailsJson.CalibrationBeginTime}}</td>
        <td>{{ProductionDetailsJson.CalibrationEndTime}}</td>
        <td>{{ProductionDetailsJson.CalibrationFinishTime}}</td>
        <td>{{newTime(ProductionDetailsJson.CalibrationNewTime)}}</td>
        <td>{{ProductionDetailsJson.CalibrationPassYieldCount=="0"?'':ProductionDetailsJson.CalibrationPassYieldCount}}</td>
        <td>{{ProductionDetailsJson.CalibrationFirstPassYieldCount=="0"?'':ProductionDetailsJson.CalibrationFirstPassYieldCount}}</td>
        <td>{{ProductionDetailsJson.CalibrationFirstPassYield_Rate==""?'':ProductionDetailsJson.CalibrationFirstPassYield_Rate+'%'}}</td>
        <td>{{ProductionDetailsJson.CalibrationFinisthRate==""?'':ProductionDetailsJson.CalibrationFinisthRate+'%'}}</td>
        <td>{{ProductionDetailsJson.CalibrationPassRate==""?'':ProductionDetailsJson.CalibrationPassRate+'%'}}</td>
    </tr>
    <tr class="text-center">
        <td>包装</td>
        <td>{{ProductionDetailsJson.AppearanceBeginTime==""?'无记录':ProductionDetailsJson.AppearanceBeginTime}}</td>
        <td>{{ProductionDetailsJson.AppearanceEndTime}}</td>
        <td>{{ProductionDetailsJson.AppearanceFinishTime}}</td>
        <td>{{newTime(ProductionDetailsJson.AppearanceNewTime)}}</td>
        <td>{{ProductionDetailsJson.AppearancePassYieldCount=="0"?'':ProductionDetailsJson.AppearancePassYieldCount}}</td>
        <td>{{ProductionDetailsJson.AppearanceFirstPassYieldCount=="0"?'':ProductionDetailsJson.AppearanceFirstPassYieldCount}}</td>
        <td>{{ProductionDetailsJson.AppearanceFirstPassYield_Rate==""?'':ProductionDetailsJson.AppearanceFirstPassYield_Rate+'%'}}</td>
        <td>{{ProductionDetailsJson.AppearanceFinisthRate==""?'':ProductionDetailsJson.AppearanceFinisthRate+'%'}}</td>
        <td>{{ProductionDetailsJson.AppearancePassRate==""?'':ProductionDetailsJson.AppearancePassRate+'%'}}</td>
    </tr>
</table>
<hr />
<div class="row" id="app">
    <div class="col-md-4 form-group">
        @if (Model.BarCodeCreated != 1)
        {
            @Html.RouteLink("根据订单创建全部条码", "Default", new { Controller = "BarCodes", Action = "CreateBarCodes", id = Model.ID }, new { @class = "btn btn-default" })
        }
        @if (Model.BarCodeCreated == null && Model.Boxes > 0)
        {
            @Html.RouteLink("创建模组条码", "Default", new { Controller = "BarCodes", Action = "CreateModuleGroupBarCodes", id = Model.ID }, new { @class = "btn btn-default" })
        }
        @if (Model.ModulePieceBarCodeCreated == null && Model.Models > 0)
        {
            using (Html.BeginForm("CreateModulePieceBarCodes", "BarCodes", FormMethod.Post))
            {
                <button>创建模块条码</button>
                @Html.TextBox("id", Model.ID, new { style = "display:none" })
            }
            @*@Html.RouteLink("创建模块条码", "Default", new { Controller = "BarCodes", Action = "CreateModulePieceBarCodes", id = Model.ID }, new { @class = "btn btn-default" })*@
        }
        @if (Model.PowerBarCodeCreated == null && Model.Powers > 0)
        {
            @Html.RouteLink("创建电源条码", "Default", new { Controller = "BarCodes", Action = "CreatePowerBarCodes", id = Model.ID }, new { @class = "btn btn-default" })
        }
        @if (Model.AdapterCardBarCodeCreated == null && Model.AdapterCard > 0)
        {
            @Html.RouteLink("创建转接卡条码", "Default", new { Controller = "BarCodes", Action = "CreateAdapterCardBarCodes", id = Model.ID }, new { @class = "btn btn-default" })
        }


        @*@Html.RouteLink("SMT生产计划管理", "Default", new { Controller = "SMT", Action = "SMT_ProductionPlan", id = Model.ID }, new { @class = "btn btn-default" })*@
        @*<p class="text-center btn btn-default">
            @Html.ActionLink("生产计划管理", "SMT_ProductionPlan")
        </p>*@

        @Html.ActionLink("修改订单信息", "Edit", new { id = Model.ID }, new { @class = "btn btn-default" })

        &nbsp;&nbsp;
        @Html.ActionLink("返回", "Index", new { @class = "btn btn-default" })
    </div>
    <div class="col-md-4 form-group">
        @if (Model.BarCodeCreated == 1)
            {
                if (Model.IsAOD == false)
                {
        <div v-show="changeAOD" class="text-center">
            <button class="btn btn-default" v-on:click="changeAOD=!changeAOD">转为特产订单</button>
        </div>
        <div v-show="!changeAOD" class="text-center">
            <form action="/OrderMgms/AODConvert" method="post">
                <p class="text-success">请输入转为特采订单原因</p>
                <input type="hidden" value="@Model.ID" name="id" />
                <textarea cols="20" v-model.trim="AOD_Description" name="AOD_Description" rows="2" class="form-control" style="display: inline-block;"></textarea><br />
                <button class="btn btn-default" v-bind:disabled="AOD_Description!=''?disabled:''">确认转为特采订单</button>
                <button class="btn btn-default" v-on:click.stop.prevent="changeAOD=!changeAOD">取消</button>
            </form>
        </div>
        <br />
            }
            if (Model.IsAOD == true)
            {
        <button class="btn btn-warning" v-on:click="selectFile">选择文件</button>
        <button class="btn btn-primary" v-on:click="postFile">上传</button>
        <button class="btn btn-default" v-on:click="showIMG=!showIMG" v-show="( '@ViewBag.Picture'=='Exists')?true:false">显示特采单照片</button>
        <p id="filecontent" class="text-primary" style="margin-left:10px;font-size:17px;margin:0"></p>
            }
        }
    </div>
    <div class="col-md-4 form-group">
        @if (Model.BarCodeCreated == 1 && Model.IsAOD == true)
            {
        <button v-on:click="showModal" class="btn btn-default" v-show="('@ViewBag.PDf'=='Exists')?true:false">查看pdf文档</button>
        <button id="showModal" class="btn btn-default hidden" data-toggle="modal" data-target="#myModal"></button>
        @*<div class="btn btn-default" v-show="('@ViewBag.PDf'=='Exists')?true:false">
                @Html.ActionLink("直接查看pdf文档", "preview_pdf", new { ordernum = Model.OrderNum }, new { Target = "_blank" })
            </div>*@
        }
    </div>
    <div class="col-md-12 form-group">
        @if (Model.BarCodeCreated == 1 && Model.IsAOD == true)
            {
        <div class="row text-center" v-show="previewIMG">
            <p class="text-info">待上传图片预览</p>
            <img src="" id="imgPreview" style="width:40%;" alt="只能预览图片文件..." />
            <br />
            <hr />
        </div>
        <div class="row text-center" v-show="showIMG">
            <h4>特采订单已存在图片</h4>
            @if (ViewBag.jpgjson != null)
                {
                    foreach (var it in ViewBag.jpgjson)
                    {
            <img src="/AOD_Files/@Model.OrderNum/@it.Value" style="width:80%;" /><br /><br />
                    }
                }
        </div>
        }
    </div>
</div>

<div class="row">
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="padding:10px">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title text-center" id="myModalLabel">
                        特采订单
                    </h4>
                </div>
                <div class="modal-body text-center" style="padding:0px">
                    <iframe id="pdfIframe" name="pdfIframe" src="" style="width:100%;"></iframe>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="setA"></div>
<form id="uploadForm" enctype="multipart/form-data" method="post" style="display:none">
    <input type="hidden" value="@Model.ID" name="id" />
    <input type="text" name="ordernum" value="@Model.OrderNum" class="hidden" />
    <input type="file" id="uploadfile" name="uploadfile" accept="image/jpeg,application/pdf" />
</form>
<script>
    var summary = new Vue({
        el: "#summary",
        data: {
            ProductionDetailsJson: JSON.parse($("#detailsJson").val())
        },
        computed: {
            newTime() {
                return function (value) {
                    var newtimelength = value.split('.');
                    if (newtimelength.length == 1) {
                        if (value == "") {
                            return value;
                        } else {
                            var newtimeval = value.split(':');
                            return newtimeval[0] + "时" + newtimeval[1] + "分" + newtimeval[2] + "秒";
                        }
                    } else if (newtimelength.length == 2) {
                        var newtimeval = newtimelength[0].split(':');
                        return newtimeval[0] + "时" + newtimeval[1] + "分" + newtimeval[2] + "秒";
                    } else {
                        var newtimeval = newtimelength[1].split(':');
                        return newtimelength[0] + "天" + newtimeval[0] + "时" + newtimeval[1] + "分" + newtimeval[2] + "秒";
                    }
                }
            }
        }
    });
</script>
<script>
    var app = new Vue({
        el: "#app",
        data: {
            changeAOD: true,
            showIMG: false,
            previewIMG: false,
            AOD_Description: ""
        },
        mounted: function () {
            var fileInput = $('#uploadfile').get(0).files[0];
            if (fileInput) {
                $('#uploadfile').replaceWith('<input type="file" id="uploadfile" name="uploadfile" accept="image/jpeg,application/pdf" />');
            };
        },
        methods: {
            selectFile: function () {
                $("#uploadfile").click();
            },
            postFile: function () {
                var fileInput = $('#uploadfile').get(0).files[0];
                if (fileInput) {
                    var form = document.getElementById('uploadForm'),
          formData = new FormData(form);
                    $.ajax({
                        url: "/OrderMgms/UploadFile",
                        type: "post",
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (res) {
                            if (res) { alert("上传成功！"); }
                            //$("#imgReturn").attr("src", "/OrderMgms/GetImg" + "?ordernum=" + "@Model.OrderNum");
                            window.location.reload();
                        },
                        error: function (err) {
                            alert("上传失败", err);
                        }
                    })
                } else {
                    alert("请先选择上传文件！");
                }
            },
            showModal: function () {
                $.ajax({
                    url: "/OrderMgms/GetPDF",
                    type: "post",
                    cache: false,
                    data: {
                        ordernum: '@Model.OrderNum',
                    },
                    success: function (address) {
                        $("#setA").append('<a id="temporary" href="../../Scripts/pdf.js/web/viewer.html?file=\\AOD_Files\\' + '@Model.OrderNum\\' + '@Model.OrderNum' + '_AOD.pdf?' + Math.random() + '" target="pdfIframe" style="display:none"></a>');
                        document.getElementById("temporary").click();
                        $("#temporary").remove();
                        $("#pdfIframe").css({ "height": $(window).height() - 60 })//.attr("src", "");
                        $("#showModal").click();
                    },
                    error: function (err) {
                        alert("查看PDF失败", err);
                    }
                });
            }
        },
        watch: {
        }
    });
    $(function () {
        if ($("#createdBarcode").text() == 1) {
            $("#createdBarcode").text("是")
        } else {
            $("#createdBarcode").text("否")
        };
    })
    $("#uploadfile").change(function () {
        selectFileImage(this)
    });
</script>