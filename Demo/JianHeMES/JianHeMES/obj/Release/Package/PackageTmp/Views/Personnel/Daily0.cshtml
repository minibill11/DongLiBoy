@{
    ViewBag.Title = "人事日报表";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Scripts/easyui/easyui.css" rel="stylesheet" />
<link href="~/Scripts/easyui/icon.css" rel="stylesheet" />
<script src="~/Scripts/easyui/jquery.easyui.min.js"></script>
<style>
    /*更改表格文字大小*/
    .datagrid-header span, .datagrid-cell, .datagrid-cell-group {
        font-size: 12px !important;
    }

    .datagrid-body td, .datagrid-header td {
        border-color: rgba(35, 35, 35, 0.5);
    }
    /*表头，底部颜色*/
    .datagrid-header-row,
    .datagrid-view1 > .datagrid-body > .datagrid-body-inner > .datagrid-btable > tbody > .datagrid-row:last-child td,
    .datagrid-view2 > .datagrid-body > .datagrid-btable > tbody > .datagrid-row:last-child td {
        background-color: rgba(252, 213, 180, 0.8) !important;
    }

    .datagrid-row {
        height: 28px;
    }
    /*表格标题*/
    .panel-title {
        font-size: 20px;
        color: inherit;
        text-align: center;
        height: 26px;
        font-weight: 500;
    }
    /*高亮黄色*/
    .datagrid-view1 > .datagrid-body > .datagrid-body-inner > .datagrid-btable > tbody > .datagrid-row td:nth-child(4),
    .datagrid-view2 > .datagrid-body > .datagrid-btable > tbody > .datagrid-row td:nth-child(3),
    .datagrid-view2 > .datagrid-body > .datagrid-btable > tbody > .datagrid-row td:nth-child(16),
    .datagrid-view2 > .datagrid-body > .datagrid-btable > tbody > .datagrid-row td:nth-child(17),
    .datagrid-view2 > .datagrid-body > .datagrid-btable > tbody > .datagrid-row td:nth-child(18) {
        background-color: rgba(255, 255, 0, 0.8);
    }

    .datagrid-view2 > .datagrid-body > .datagrid-btable > tbody > .datagrid-row:last-child td:nth-child(6),
    .datagrid-view2 > .datagrid-body > .datagrid-btable > tbody > .datagrid-row:last-child td:nth-child(8),
    .datagrid-view2 > .datagrid-body > .datagrid-btable > tbody > .datagrid-row:last-child td:nth-child(10),
    .datagrid-view2 > .datagrid-body > .datagrid-btable > tbody > .datagrid-row:last-child td:nth-child(12),
    .datagrid-view2 > .datagrid-body > .datagrid-btable > tbody > .datagrid-row:last-child td:nth-child(14) {
        background-color: rgba(220, 230, 241, 0.8) !important;
    }

    #title {
        border-bottom: 1px solid #95B8E7;
        background: linear-gradient(to bottom,#eff5ff 0,#e0ecff 100%);
        height: 38px;
        padding: 5px;
    }

    .datagrid-cell {
        padding: 1px;
    }

    @@media screen and (max-width:768px) {
        .container, .body-content {
            padding: 1px;
        }
    }
</style>
<br />
<span class="btn btn-default">@Html.ActionLink("提交日报信息", "Create")</span>
@*<span class="btn btn-default">@Html.RouteLink("人事日报表2", "Default", new { controller = "Personnel", Action = "Daily2" })</span>*@
<br />
<div id="app">
    <br />
    <div id="title" class="text-center">
        <span style="font-size:20px">人事日报</span>
        <span style="float:right;">日期：<input type="date" name="date" v-model="SearchDate" /></span>
    </div>
    <table id="tableData" class="easyui-datagrid" toolbar="#title" style="width:100%;"></table>
</div>
@{
    var UserName = Session["User"] == null ? string.Empty : ((JianHeMES.Models.Users)Session["User"]).UserName;
    var UserRole = Session["User"] == null ? string.Empty : ((JianHeMES.Models.Users)Session["User"]).Role;
}
<script type="text/javascript">
    var app = new Vue({
        el: "#app",
        data: {
            SearchDate: "",
            isRecord: true,
            userName: "@UserName",
            userRole: "@UserRole"
        },
        created: function () {
            //日期格式化
            Date.prototype.Format = function (fmt) {
                var o = {
                    "M+": this.getMonth() + 1, //月份
                    "d+": this.getDate(), //日
                    "H+": this.getHours(), //小时
                    "m+": this.getMinutes(), //分
                    "s+": this.getSeconds(), //秒
                    "q+": Math.floor((this.getMonth() + 3) / 3), //季度
                    "S": this.getMilliseconds() //毫秒
                };
                if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
                for (var k in o)
                    if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                return fmt;
            };
        },
        mounted: function () {
            $('#tableData').datagrid({
                singleSelect: true,
                collapsible: true,
                nowrap: false,
                striped: true,
                frozenColumns: [[
                    { field: 'Department', title: '部门', align: 'center', width: 75 },
                    { field: 'Principal', title: '负责人', align: 'center', width: 42 },
                    { field: 'Aurhorized_personnel', title: '编制', align: 'center', width: 29 },
                    {
                        field: 'Need_personnel', title: '刚需<br />人数', align: 'center', width: 30,
                        styler: function (value, row, index) {
                            //return 'background-color: rgba(255, 255, 0, 0.8)';
                            //return '<span style="color:red">Edit Delete</span>';
                        }
                    },
                    {
                        field: 'Employees_personnel', title: '正式<br />人数', align: 'center', width: 30,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Workers_personnel', title: '劳务<br />工人数', align: 'center', width: 38,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    }
                ]],
                columns: [[
                    {
                        field: 'Today_on_board_employees', title: '当日入职<br />正式工人数', align: 'center', rowspan: 3, width: 62,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Today_on_board_workers', title: '当日入职<br />劳务工人数', align: 'center', rowspan: 3, width: 62,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Huizong', title: '汇总<br />人数', align: 'center', rowspan: 3, width: 30,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Dangqian_que', title: '当前<br />缺口人数', align: 'center', rowspan: 3, width: 52,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    { field: 'Interview', title: '预填表<br />人数', align: 'center', rowspan: 3, width: 40 },
                    { title: '实际每日<br />入职人数', colspan: 10, },
                    {
                        field: 'Week_total', title: '本周入职<br />人数合计', align: 'center', rowspan: 3, width: 52,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Month_on_board', title: '当月<br />入职人数', align: 'center', rowspan: 3, width: 52,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Month_dimission', title: '当月<br />离职人数', align: 'center', rowspan: 3, width: 52,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    { field: 'Resigned_that_month', title: '当月<br />待离职人数', align: 'center', rowspan: 3, width: 66 },
                    { field: 'Date', title: '时间', align: 'center', rowspan: 3, width: 70 },
                    {
                        field: 'Reporter', title: '上报人', align: 'center', rowspan: 3, width: 46,
                        styler: function (value, row, index) {
                            if (value == "未上报") {
                                return 'color: red';
                            };
                        },
                        formatter: function (value, row, index) {
                            if (value != null) {
                                if ((app.userName == value || app.userName == "刘露露" || app.userRole == "系统管理员") && (value != "未上报" && row.id != 0)) {
                                    return "<span>" + value + "<br/>" + "<a href='/Personnel/Edit/" + row.id + "'>修改</a></span>"
                                } else {
                                    return "<span>" + value + "</span>"
                                };
                            } else {
                                return ""
                            };
                        }
                    }
                ], [
                    {
                        title: '', colspan: 2, align: 'center',
                        //styler: function (value, row, index) {
                        //    return {class:'week',style:'color:red'}
                        //}
                    },
                    { title: '', colspan: 2, align: 'center' },
                    { title: '', colspan: 2, align: 'center' },
                    { title: '', colspan: 2, align: 'center' },
                    { title: '', colspan: 2, align: 'center' },
                ], [
                    {
                        field: 'Mon_workers', title: '劳务', align: 'center', width: 31,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Mon_employees', title: '正式', align: 'center', width: 31,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Tues_workers', title: '劳务', align: 'center', width: 31,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Tues_employees', title: '正式', align: 'center', width: 31,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Wednes_workers', title: '劳务', align: 'center', width: 31,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Wednes_employees', title: '正式', align: 'center', width: 31,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Thurs_workers', title: '劳务', align: 'center', width: 31,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Thurs_employees', title: '正式', align: 'center', width: 31,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Fri_workers', title: '劳务', align: 'center', width: 31,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                    {
                        field: 'Fri_employees', title: '正式', align: 'center', width: 31,
                        formatter: function (value, row, index) { return value == "0" ? "" : value; }
                    },
                ]],
                onLoadSuccess: function (data) {
                    if (app.isRecord == true) {
                        //添加“合计”列
                        $('#tableData').datagrid('appendRow', {
                            //第1部分
                            Department: '合计',
                            Principal: '/',
                            Aurhorized_personnel: '<span>' + compute("Aurhorized_personnel") + '</span>',
                            Need_personnel: '<span>' + compute("Need_personnel") + '</span>',
                            Employees_personnel: '<span>' + compute("Employees_personnel") + '</span>',
                            Workers_personnel: '<span>' + compute("Workers_personnel") + '</span>',
                            //第2部分
                            Today_on_board_employees: '<span>' + compute("Today_on_board_employees") + '</span>',
                            Today_on_board_workers: '<span>' + compute("Today_on_board_workers") + '</span>',
                            Huizong: '<span>' + compute("Huizong") + '</span>',
                            Dangqian_que: '<span>' + compute("Dangqian_que") + '</span>',
                            Interview: '<span>' + compute("Interview") + '</span>',
                            //第3部分
                            Mon_workers: '<span>' + compute("Mon_workers") + '</span>',
                            Mon_employees: '<span>' + compute("Mon_employees") + '</span>',
                            Tues_workers: '<span>' + compute("Tues_workers") + '</span>',
                            Tues_employees: '<span>' + compute("Tues_employees") + '</span>',
                            Wednes_workers: '<span>' + compute("Wednes_workers") + '</span>',
                            Wednes_employees: '<span>' + compute("Wednes_employees") + '</span>',
                            Thurs_workers: '<span>' + compute("Thurs_workers") + '</span>',
                            Thurs_employees: '<span>' + compute("Thurs_employees") + '</span>',
                            Fri_workers: '<span>' + compute("Fri_workers") + '</span>',
                            Fri_employees: '<span>' + compute("Fri_employees") + '</span>',
                            //第4部分
                            Week_total: '<span>' + compute("Week_total") + '</span>',
                            Month_on_board: '<span>' + compute("Month_on_board") + '</span>',
                            Month_dimission: '<span>' + compute("Month_dimission") + '</span>',
                            Resigned_that_month: '<span>' + compute("Resigned_that_month") + '</span>',
                            //Reporter: '',
                            //Rate: '<span class="subtotal">' + ((compute("TotalOrderScore") / compute("TotalTrailCount")) * 100).toFixed(2) + '</span>'
                        });
                    } else {
                        $('#tableData').datagrid('mergeCells', {
                            index: 0,
                            field: 'Department',
                            colspan: 6,
                            rowspan: 2
                        });
                        $('#tableData').datagrid('mergeCells', {
                            index: 0,
                            field: 'Today_on_board_employees',
                            colspan: 21,
                            rowspan: 2
                        });
                    };
                },
            });
            var nowDate = new Date().Format("yyyy-MM-dd");
            this.SearchDate = nowDate;
        },
        updated: function () {
            //this.$nextTick(function () {
            //    //此处填每次渲染完后执行的代码
            //});
        },
        watch: {
            SearchDate: function (selectDate) {
                if (selectDate != "") {
                    //this.$options.methods.weekdate(selectDate);
                    this.$options.methods.postJson(selectDate);
                };
            },
        },
        methods: {
            weekdate: function (selectDate) {
                var dt = new Date(selectDate);
                var selectTime = dt.getTime();
                var weekDay = dt.getDay();
                var oneDayTime = 24 * 60 * 60 * 1000;
                $(".datagrid-header-row:nth-child(2) > td >.datagrid-cell-group").each(function (index) {
                    if (weekDay == 0) {
                        var weekTime = new Date(selectTime - ((6 - index) * oneDayTime));//周
                        $(this).text((weekTime.getMonth() + 1) + "月" + weekTime.getDate() + "日");
                        $('#dg').datagrid('reload');
                    } else {
                        var weekTime = new Date(selectTime - (weekDay - 1 - index) * oneDayTime);//周
                        $(this).text((weekTime.getMonth() + 1) + "月" + weekTime.getDate() + "日")
                        $('#dg').datagrid('reload');
                    };
                });
            },
            postJson: function (selectDate) {
                $.ajax({
                    url: "/Personnel/getjsondata",
                    type: "post",
                    dataType: "json",
                    data: {
                        date: selectDate,
                    },
                    success: function (returnVal) {
                        console.log(returnVal);
                        if (returnVal.无记录 == "无记录") {
                            app.isRecord = false;
                            var data = {
                                rows: [{ "Department": "无记录", "Today_on_board_employees": "" },
                                    { "Department": "无记录", "Today_on_board_employees": "无记录" }]
                            };
                        } else {
                            app.isRecord = true;
                            var data = {
                                //total: 28,
                                rows: returnVal
                            };
                        };
                        $('#tableData').datagrid('loadData', data);
                        app.$options.methods.weekdate(selectDate);
                    },
                    error: function (err) {
                        alert("读取日期“" + selectDate + "”数据失败");
                    }
                });
            },
        },
    });
    function compute(colName) {
        var rows = $('#tableData').datagrid('getRows');
        var total = 0;
        for (var i = 0; i < rows.length; i++) {
            total += (parseFloat(rows[i][colName]) <= 0 ? 0 : parseFloat(rows[i][colName]));
        };
        return total;
    };
</script>