@model IEnumerable<JianHeMES.Models.Personnel_Turnoverrate>
@{
    ViewBag.Title = "月流失率查看页面";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<script src="~/Scripts/echarts.js"></script>
<style>
    [v-cloak] {
        display: none;
    }

    .table > tbody > tr > th {
        background-color: #f0da35;
    }

    .table > tbody > tr > th, .footTr {
        height: 30px;
    }

    .table-bordered > tbody > tr > th, .table-bordered > tbody > tr > td {
        border: 1px solid #555;
        text-align: center;
        vertical-align: middle;
        padding: 1px;
    }

    .table > tbody > tr > td:hover, .table > tbody > tr > th :hover {
        background-color: #f0da35;
    }

    .DepartmentStyle {
        cursor: pointer;
    }
</style>
<h3 class="text-center">月流失率查看</h3>
<p>@Html.ActionLink("月流失率输入页面", "TurnoverrateInput")</p>
<hr />
<div id="app" class="form-group text-center">
    <div class="row">
        <div class="col-md-5">
            <div style="margin-bottom:5px;">
                <select v-model="year">
                    <option></option>
                    <option>2019</option>
                    <option>2020</option>
                    <option>2021</option>
                    <option>2022</option>
                    <option>2023</option>
                </select>
                年
                <select v-model="month">
                    <option></option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                    <option>6</option>
                    <option>7</option>
                    <option>8</option>
                    <option>9</option>
                    <option>10</option>
                    <option>11</option>
                    <option>12</option>
                </select>
                月流失率
            </div>
            <div>
                <table class="table table-bordered">
                    <colgroup>
                        <col width="100" />
                        <col width="80" />
                        <col width="80" />
                        <col width="80" />
                        <col width="80" />
                        <col width="90" />
                        <col width="80" />
                    </colgroup>
                    <tr>
                        <th>部门</th>
                        <th>月初人数</th>
                        <th>月末人数</th>
                        <th>平均人数</th>
                        <th>离职人数</th>
                        <th>流失率</th>
                        <th>操作</th>
                    </tr>
                    <tr v-for="(item,index) in turnoverrateList" v-cloak>
                        <td v-on:click="getDepartmentYearMsg(item.Department)" class="DepartmentStyle">{{item.Department}}</td>
                        <td>{{item.Month_Beginning}}</td>
                        <td>{{item.Month_End}}</td>
                        <td>{{item.Average_Number}}</td>
                        <td>{{item.Departure}}</td>
                        <td>{{item.Turnover_Rate.toFixed(2)}}%</td>
                        @*[Display(Name = "平均数值")]
                            public decimal Average_Value { get; set; }*@
                        <td><a href="'/Personnel_Turnoverrate/Edit/' + item.Id" target="_blank">编辑</a></td>
                    </tr>
                    <tr class="footTr">
                        <td v-if="turnoverrateList==''" colspan="7">{{emptyMessage}}</td>
                        <td v-else colspan="5">平均数值</td>
                        <td v-if="turnoverrateList!=''" colspan="2" style="font-weight:bold;">{{monthAverageVal}}%</td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="col-md-7">
            <div id="echartMain" style="width: 700px;height:350px;"></div>
        </div>
    </div>
    <hr />
    <div class="row">
        <table class="table table-bordered">
            <colgroup>
                <col width="100" />
                <col width="100" />
                <col width="80" />
                <col width="80" />
                <col width="80" />
                <col width="80" />
                <col width="80" />
                <col width="80" />
                <col width="80" />
                <col width="80" />
                <col width="80" />
                <col width="80" />
                <col width="80" />
                <col width="80" />
                <col width="100" />
            </colgroup>
            <tr>
                <th colspan="2">月份</th>
                <th>1</th>
                <th>2</th>
                <th>3</th>
                <th>4</th>
                <th>5</th>
                <th>6</th>
                <th>7</th>
                <th>8</th>
                <th>9</th>
                <th>10</th>
                <th>11</th>
                <th>12</th>
                <th rowspan="5">平均数值</th>
            </tr>
            <tr>
                <td rowspan="5">部门</td>
                <td>月初人数</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>月末人数</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>平均人数</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>离职人数</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>流失率</td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td>100.00%</td>
            </tr>
        </table>
    </div>
</div>

<script>
    var app = new Vue({
        el: "#app",
        data: {
            year: "",
            month: "",
            turnoverrateList: [],
            lineArray: [],
            departmentList: [],
            monthAverageVal: "",
            emptyMessage: "请选择年/月查询数据"
        },
        created: function () {
            let nowDate = new Date();
            this.year = nowDate.getFullYear();
        },
        mounted: function () {
            //this.$options.methods.getTurnoverrateYearlyLineChartData();
        },
        methods: {
            postTime: function (y, m) {
                $.ajax({
                    url: "/Personnel_Turnoverrate/Turnoverrate",
                    type: "post",
                    data: {
                        Year: y,
                        Month: m,
                    },
                    success: function (data) {
                        let targetdata = JSON.parse(data);
                        //console.log(targetdata);
                        if (targetdata.length > 0) {
                            app.turnoverrateList = targetdata;
                        } else {
                            app.turnoverrateList = [];
                            //alert(y + "年" + m + "月没有记录或尚未输入数据！");
                            app.emptyMessage = y + "年" + m + "月没有记录或尚未输入数据！";
                        };
                    },
                    error: function (err) {
                        alert("查询失败！")
                    }
                });
            },
            getDepartmentYearMsg: function (departmentVal) {
                $.ajax({
                    url: "/Personnel_Turnoverrate/TurnoverrateYearly",
                    type: "post",
                    data: {
                        department: departmentVal,
                        year: app.year,
                    },
                    success: function (data) {
                        let dataJson = JSON.parse(data);
                        console.log(JSON.parse(data));
                    },
                    error: function (err) {
                        alert("查看失败！")
                    }
                });
            },
            getTurnoverrateYearlyLineChartData: function () {
                $.ajax({
                    url: "/Personnel_Turnoverrate/TurnoverrateYearlyLineChartData",
                    type: "post",
                    data: {
                        year: app.year,
                    },
                    success: function (data) {
                        app.lineArray = [];
                        let dataJson = JSON.parse(data);
                        for (let i in dataJson) {
                            app.lineArray[i - 1] = dataJson[i];
                        };
                        //赋值平均数
                        if (app.month != "") {
                            app.monthAverageVal = app.lineArray[app.month - 1];
                        };
                        myChart.setOption({
                            title: { subtext: app.year + '年记录' },
                            series: [{ data: app.lineArray }]
                        });
                    },
                    error: function (err) {
                        //alert("查看失败！")
                    }
                });
            },
        },
        watch: {
            year: function () {
                if (this.year != "" && this.month != "") {
                    this.$options.methods.postTime(this.year, this.month);
                } else {
                    this.turnoverrateList = [];
                    this.emptyMessage = "请选择年/月查询数据"
                };
                //折线图根据年查询
                if (this.year != "") {
                    this.$options.methods.getTurnoverrateYearlyLineChartData();
                } else {
                    this.lineArray = [];
                    myChart.setOption({
                        title: { subtext: app.year + '年记录' },
                        series: [{ data: this.lineArray }]
                    });
                };
            },
            month: function () {
                if (this.year != "" && this.month != "") {
                    this.$options.methods.postTime(this.year, this.month);
                    //赋值平均数
                    this.monthAverageVal = this.lineArray[this.month - 1];
                } else {
                    this.turnoverrateList = [];
                    this.emptyMessage = "请选择年/月查询数据"
                };
            },
        }
    });
    //echart折线图配置
    var myChart = echarts.init(document.getElementById('echartMain'));
    //myChart.showLoading();
    //myChart.hideLoading();
    var option = {
        title: {
            left: 'center',
            text: '月流失率变化',
        },
        tooltip: {
            trigger: 'axis',
        },
        xAxis: {
            type: 'category',
            data: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月']
        },
        yAxis: {
            type: 'value',
            axisLabel: {
                formatter: '{value} %'
            }
        },
        toolbox: {
            feature: {
                magicType: { type: ['line', 'bar'] },
                //restore: {},
                saveAsImage: {}
            },
            right: 60,
            top: 30,
        },
        series: [{
            name: "平均流失率(%)",
            type: 'line',
            toolbox: {
                show: true,
                feature: {
                    dataZoom: {
                        yAxisIndex: 'none'
                    },
                    dataView: { readOnly: false },
                    magicType: { type: ['line', 'bar'] },
                    restore: {},
                    saveAsImage: {}
                }
            },
            //markLine: {
            //    data: [
            //        { type: 'average', name: '平均值' },
            //        [{
            //            symbol: 'none',
            //            x: '90%',
            //            yAxis: 'max'
            //        }, {
            //            symbol: 'circle',
            //            label: {
            //                normal: {
            //                    position: 'start',
            //                    formatter: '最大值'
            //                }
            //            },
            //            type: 'max',
            //            name: '最高点'
            //        }]
            //    ]
            //}
        }]
    };
    myChart.setOption(option);
</script>