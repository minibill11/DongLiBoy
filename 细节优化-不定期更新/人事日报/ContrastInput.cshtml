@model IEnumerable<JianHeMES.Models.Personnel_of_Contrast>

@{
    ViewBag.Title = "周对比表输入";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Scripts/easyui/easyui.css" rel="stylesheet" />
<link href="~/Scripts/easyui/icon.css" rel="stylesheet" />
<script src="~/Scripts/easyui/jquery.easyui.min.js"></script>
<style>
    .datagrid-cell {
        height: 33px !important;
        line-height: 33px;
        padding: 0;
    }

    #title {
        border-bottom: 1px solid #95B8E7;
        background: linear-gradient(to bottom,#eff5ff 0,#e0ecff 100%);
        height: 38px;
        padding: 5px;
    }

    .datagrid {
        margin: 0 auto;
        width: 1002px;
    }
    /*表头，底部颜色*/
    .datagrid-header-row,
    .datagrid-view1 > .datagrid-body > .datagrid-body-inner > .datagrid-btable > tbody > .datagrid-row:last-child td,
    .datagrid-view2 > .datagrid-body > .datagrid-btable > tbody > .datagrid-row:last-child td {
        background-color: orange !important;
    }

    #yearVal, #monthVal, #weekVal {
        width: 30px;
        height: 24px;
        text-align: center;
    }
</style>
<div id="app">
    <h3 class="text-center">周对比表输入</h3>
    <div id="title" class="text-center">
        <span style="font-size:18px">
            <span>
                <select id="yearVal" style="width:65px;">
                    <option></option>
                    <option>2019</option>
                    <option>2020</option>
                    <option>2021</option>
                    <option>2022</option>
                    <option>2023</option>
                    <option>2024</option>
                    <option>2025</option>
                </select>
            </span>&nbsp;年
            <span>
                <select id="monthVal" style="width:52px;">
                    <option></option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                    <option>6</option>
                    <option>7</option>
                    <option>8</option>
                    <option>9</option>
                    <option>10</option>
                    <option>11</option>
                    <option>12</option>
                </select>
            </span>&nbsp;月&nbsp;第
            <span>
                <select id="weekVal" style="width:52px;">
                    <option></option>
                    <option>1</option>
                    <option>2</option>
                    <option>3</option>
                    <option>4</option>
                    <option>5</option>
                </select>
            </span>&nbsp;周各部门汇总
        </span>
    </div>
    <table id="tableData" class="easyui-datagrid" toolbar="#title"></table>
</div>
<script type="text/javascript">
    var app = new Vue({
        el: "#app",
        data: {
        },
        mounted: function () {
            var data = {
                rows: [
                    { "Department": "MC部", "Number": "", "Zhang_WorkingHour": "", "Zhang_Pay": "", "Total_Staff": "", "Overtime_Total": "", "Pay_Total": "", "Daily_Pay": "", "operation": "编辑" },
                    { "Department": "PC部", "Number": "", "Zhang_WorkingHour": "", "Zhang_Pay": "", "Total_Staff": "", "Overtime_Total": "", "Pay_Total": "", "Daily_Pay": "", "operation": "编辑" },
                    { "Department": "SMT部", "Number": "", "Zhang_WorkingHour": "", "Zhang_Pay": "", "Total_Staff": "", "Overtime_Total": "", "Pay_Total": "", "Daily_Pay": "", "operation": "编辑" },
                    { "Department": "配套加工部", "Number": "", "Zhang_WorkingHour": "", "Zhang_Pay": "", "Total_Staff": "", "Overtime_Total": "", "Pay_Total": "", "Daily_Pay": "", "operation": "编辑" },
                    { "Department": "装配1部", "Number": "", "Zhang_WorkingHour": "", "Zhang_Pay": "", "Total_Staff": "", "Overtime_Total": "", "Pay_Total": "", "Daily_Pay": "", "operation": "编辑" },
                    { "Department": "装配2部", "Number": "", "Zhang_WorkingHour": "", "Zhang_Pay": "", "Total_Staff": "", "Overtime_Total": "", "Pay_Total": "", "Daily_Pay": "", "operation": "编辑" },
                    { "Department": "制造中心", "Number": "", "Zhang_WorkingHour": "", "Zhang_Pay": "", "Total_Staff": "", "Overtime_Total": "", "Pay_Total": "", "Daily_Pay": "", "operation": "编辑" },
                    { "Department": "技术部", "Number": "", "Zhang_WorkingHour": "", "Zhang_Pay": "", "Total_Staff": "", "Overtime_Total": "", "Pay_Total": "", "Daily_Pay": "", "operation": "编辑" },
                    { "Department": "品质部", "Number": "", "Zhang_WorkingHour": "", "Zhang_Pay": "", "Total_Staff": "", "Overtime_Total": "", "Pay_Total": "", "Daily_Pay": "", "operation": "编辑" },
                    { "Department": "总经办", "Number": "", "Zhang_WorkingHour": "", "Zhang_Pay": "", "Total_Staff": "", "Overtime_Total": "", "Pay_Total": "", "Daily_Pay": "", "operation": "编辑" },
                    { "Department": "财务部", "Number": "", "Zhang_WorkingHour": "", "Zhang_Pay": "", "Total_Staff": "", "Overtime_Total": "", "Pay_Total": "", "Daily_Pay": "", "operation": "编辑" },
                    { "Department": "人力资源部", "Number": "", "Zhang_WorkingHour": "", "Zhang_Pay": "", "Total_Staff": "", "Overtime_Total": "", "Pay_Total": "", "Daily_Pay": "", "operation": "编辑" },
                    { "Department": "行政后勤部", "Number": "", "Zhang_WorkingHour": "", "Zhang_Pay": "", "Total_Staff": "", "Overtime_Total": "", "Pay_Total": "", "Daily_Pay": "", "operation": "编辑" },
                ]
            };
            $('#tableData').datagrid({
                singleSelect: true,
                checkOnSelect: false,
                nowrap: false,
                striped: true,
                frozenColumns: [[
                    {
                        field: 'Department', title: '部门', align: 'center', width: 110,
                        formatter: function (value, row, index) {
                            return value;
                        }
                    }
                ]],
                columns: [[
                    {
                        field: 'Number', title: '人数', align: 'center', width: 110, editor: 'numberbox'
                    },
                    { field: 'Zhang_WorkingHour', title: '正班工时', align: 'center', width: 110, editor: { type: 'numberbox', options: { precision: 1 } } },
                    { field: 'Zhang_Pay', title: '正班工资', align: 'center', width: 110, editor: { type: 'numberbox', options: { precision: 2 } } },
                    { field: 'Total_Staff', title: '人员加班总值（H)', align: 'center', width: 120, editor: { type: 'numberbox', options: { precision: 1 } } },
                    { field: 'Overtime_Total', title: '加班工资合计', align: 'center', width: 110, editor: { type: 'numberbox', options: { precision: 2 } } },
                    { field: 'Pay_Total', title: '工资合计', align: 'center', width: 110, editor: { type: 'numberbox', options: { precision: 2 } } },
                    { field: 'Daily_Pay', title: '日人均工资', align: 'center', width: 110, editor: { type: 'numberbox', options: { precision: 2 } } },
                    {
                        field: 'operation', title: '操作', align: 'center', width: 110,
                        formatter: function (value, row, index) {
                            if (value == "编辑") {
                                if (row.editing) {
                                    return '<a href="#" onclick="saverow(this)">完成此行</a> ';
                                } else {
                                    return '<a href="#" onclick="editrow(this)">编辑</a> ';
                                }
                            } else {
                                return '<a href="#" onclick="postJson(this)">提交</a> ';
                            }

                        }
                    }
                ]],
                onLoadSuccess: function (data) {
                    var rows = $('#tableData').datagrid('getRows');//返回当前页的行
                    for (var i = 0; i < rows.length; i++) {
                        $('#tableData').datagrid('beginEdit', i);
                    };
                    //添加“合计”列
                    $('#tableData').datagrid('appendRow', {
                        Department: '总计',
                        Number: '<span>' + compute("Number") + '</span>',
                        Zhang_WorkingHour: '<span>' + compute("Zhang_WorkingHour") + '</span>',
                        Zhang_Pay: '<span>' + compute("Zhang_Pay") + '</span>',
                        Total_Staff: '<span>' + compute("Total_Staff") + '</span>',
                        Overtime_Total: '<span>' + compute("Overtime_Total") + '</span>',
                        Pay_Total: '<span>' + compute("Pay_Total") + '</span>',
                        Daily_Pay: '<span>' + compute("Daily_Pay") + '</span>',
                        operation: '',
                    });
                },
                onBeforeEdit: function (rowIndex, rowData) {
                    rowData.editing = true;
                    $(this).datagrid('refreshRow', rowIndex);
                },
                onAfterEdit: function (rowIndex, rowData) {
                    rowData.editing = false;
                    $(this).datagrid('refreshRow', rowIndex);
                }
            });
            $('#tableData').datagrid('loadData', data);
        },
        methods: {

        },
    });

    function postJson() {
        var tableData = $('#tableData').datagrid('getData').rows;
        var Y = $("#yearVal").val();
        var M = $("#monthVal").val();
        var W = $("#weekVal").val();
        for (var i = 0; i < tableData.length - 1; i++) {
            if (tableData[i].editing == true) {
                alert("还有未填写完成的行，请填写完整后提交！");
                return false;
            };
        };
        if (Y == "" || M == "" || W == "") {
            alert("请选择年/月/周！");
            return false;
        };
        for (var i = 0; i < tableData.length - 1; i++) {
            tableData[i].Year = Y;
            tableData[i].Month = M;
            tableData[i].Week = W;
            //delete tableData[i].editing;
            //delete tableData[i].operation;
        };
        tableData.pop();
        console.log(tableData);
        $.ajax({
            type: 'post',
            url: "/Personnel_of_Contrast/ContrastInput/",
            data: JSON.stringify(tableData),
            contentType: 'application/json;charset=utf-8', //上传后直接是List，不需要反序列化，直接向后台传对象集合
            async: false,
            datatype: 'json',
            cache: false,
            success: function (data) {
                if (data == "保存成功") {
                    alert(data);
                    window.location.href = '../Personnel_of_Contrast/ContrastInput/';
                } else {
                    alert("提交失败");
                }
            },
            error: function (err) {
                alert(err);
            }
        });
    };

    function compute(colName) {
        var rows = $('#tableData').datagrid('getRows');//返回当前页的行
        var total = 0;
        for (var i = 0; i < rows.length - 1; i++) {
            var thisVal = rows[i][colName] == "" ? 0 : rows[i][colName];
            total += (parseFloat(thisVal) <= 0 ? 0 : parseFloat(rows[i][colName]));
        };
        return isNaN(total) ? 0 : total;
    };

    function getRowIndex(target) {
        var tr = $(target).closest('tr.datagrid-row');
        return parseInt(tr.attr('datagrid-row-index'));
    };
    function editrow(target) {
        $('#tableData').datagrid('beginEdit', getRowIndex(target));
    };
    function saverow(target) {
        var rowIndex = getRowIndex(target);
        var rowData = $('#tableData').datagrid('getEditors', rowIndex);
        for (var i = 0; i < rowData.length; i++) {
            if (rowData[i].target[0].value == "") {
                alert("行未填完整")
                return false;
            };
        };
        $('#tableData').datagrid('endEdit', rowIndex);
        $('#tableData').datagrid('updateRow', {
            index: 13,
            row: {
                Number: '<span>' + compute("Number") + '</span>',
                Zhang_WorkingHour: '<span>' + compute("Zhang_WorkingHour") + '</span>',
                Zhang_Pay: '<span>' + compute("Zhang_Pay") + '</span>',
                Total_Staff: '<span>' + compute("Total_Staff") + '</span>',
                Overtime_Total: '<span>' + compute("Overtime_Total") + '</span>',
                Pay_Total: '<span>' + compute("Pay_Total") + '</span>',
                Daily_Pay: '<span>' + compute("Daily_Pay") + '</span>',
            }
        });
    };
</script>