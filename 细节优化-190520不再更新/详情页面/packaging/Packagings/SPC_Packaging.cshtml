@model JianHeMES.Models.Warehouse_SparePartsAndComponents_Out

@{
    ViewBag.Title = "备品配件检验";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Content/styleFile/packaging/index.css" rel="stylesheet" />
<script src="~/Content/styleFile/packaging/index.js"></script>
<script src="~/Scripts/axios.min.js"></script>
<script src="~/Scripts/printJS/JsBarcode.all.min.js"></script>

<style>
    * {
        margin: 0;
        padding: 0;
    }

    .body-content, .container {
        padding-left: 0px;
        padding-right: 0px;
    }

    .container {
        width: 1300px;
    }

    .query {
        width: 300px;
        text-align: right;
        margin: 2px auto;
    }

    .TunnelLabel {
        margin: 0 auto;
        border: 1px solid #100f0f;
        width: 308px;
        height: 280px;
    }

    .tophei {
        height: 160px;
    }

        .tophei > div {
            height: 80px;
        }

        .tophei .tophei_1 {
            position: relative;
        }

        .tophei .tophei_2 {
            border-top: 1px solid #100f0f;
            border-bottom: 1px solid #100f0f;
        }

        .tophei .imgicon1 {
            margin: 0;
            padding-top: 33px;
            text-align: center;
        }

        .tophei .imgicon2 {
            margin: 0;
            padding-top: 25px;
            text-align: center;
        }

    .bottomhei {
        display: inline-flex;
        text-align: center;
        height: 60px;
        border-bottom: 1px solid #100f0f;
    }

        .bottomhei .separate {
            width: 76px;
            border-right: 1px solid #100f0f;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .bottomhei .separate1 {
            width: 75px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

    .bottomhei1 {
        display: inline-flex;
        text-align: center;
        height: 59px;
    }

        .bottomhei .mcFrame_top_3:nth-child(1), .bottomhei1 .mcFrame_top_3:nth-child(1) {
            border-right: 1px solid #100f0f;
            width: 78px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .bottomhei .mcFrame_top_3:nth-child(2), .bottomhei1 .mcFrame_top_3:nth-child(2) {
            border-right: 1px solid #100f0f;
            width: 78px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .bottomhei .mcFrame_top_3:nth-child(3), .bottomhei1 .mcFrame_top_3:nth-child(3) {
            border-right: 1px solid #100f0f;
            width: 76px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .bottomhei .mcFrame_top_3:nth-child(4), .bottomhei1 .mcFrame_top_3:nth-child(4) {
            width: 75px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

    h2 {
        margin: 0;
        padding-top: 35px;
        text-align: center;
    }

    .masterBarDiv {
        width: 100%;
        position: absolute;
        top: -3px;
    }

    .textCenter {
        text-align: center;
    }

    #imgcode {
        width: 240px;
    }

    .tophei_2 {
        position: relative;
    }

    .imgicon {
        position: absolute;
        width: 110px;
        top: 5px;
        left: 5px;
    }

    .divframe {
        width: 527px;
        margin: 1px auto;
        text-align: center;
        border: 1px solid #ccc;
        min-height: 260px;
        margin-right: 5px
    }

    .divframe1 {
        width: 300px;
        text-align: center;
        margin: 1px auto;
        margin-bottom: 5px;
    }

    .el-table__empty-block {
        min-height: 0;
    }

    @@media screen and (max-width:820px) {
        .link {
            display: inline-block;
        }

        .tips {
            margin-left: 50px;
        }
    }

    @@media screen and (min-width:820px) {

        .affirm2 {
            margin-left: 232px;
        }

        .affirm1 {
            margin-left: 350px;
        }

        .el-table th {
            font-size: 13px;
            padding: 5px 0;
            text-align: center;
            color: #444
        }

        .el-table td {
            font-size: 13px;
            padding: 2px 0;
            text-align: center;
        }

        .el-table .cell, .el-table--border td:first-child .cell {
            padding: 0;
        }

        .el-table .warning-row {
            background: #fcd2d2;
        }

        .el-table .success-row {
            background: #f0f9eb;
        }

        .tips {
            margin-left: 240px;
        }
    }
</style>
<div id="app">
    <div class="text-center">
        <h3>@ViewBag.Title</h3>
        <div class="link">
            <a href="/Packagings/SPC_QueryByOrderNumber"><el-button size="small" class="cret" type="primary" plain>首页</el-button></a>
            <a href="/Packagings/SPC_Display" style="margin-left:2px"><el-button size="small" type="primary" plain>查询基本信息</el-button></a>
            <a href="/Packagings/SPC_Addbasic_information" style="margin-left:2px"><el-button size="small" type="primary" plain>物料基本信息录入</el-button></a>
            <a href="/Packagings/SPC_MaterialLablePrint" style="margin-left:2px"><el-button size="small" type="primary" plain>打印物料标签</el-button></a>
            <a href="/Packagings/SPC_StockConfirm"><el-button size="small" type="primary" plain style="margin:2px" v-bind:disabled="materialPreparation==false">物料备料</el-button></a>
            <a href="/Packagings/SPC_Packaging" style="margin-left:2px"><el-button size="small" type="primary" plain v-bind:disabled="packingMaterial==false">备品配件检验</el-button></a>
            <a href="/Packagings/SPC_Packaging_Modify"><el-button size="small" class="cret" type="primary" plain>修改包装信息</el-button></a>
            <a href="/Packagings/SPC_PrintOuterBoxLable" style="margin-left:2px"><el-button size="small" type="primary" plain v-bind:disabled="printOutsibox==false">打印外箱标签</el-button></a>
        </div>
    </div>
    <el-main>
        <el-col :md="8">
            <div class="query">
                班&nbsp;&nbsp;组：
                <group-select style="width:191px"></group-select>
            </div>
            <div class="query">
                订单号：
                <select-input v-model.trim="orderNum"
                              v-bind:disabled="materialInfo.length>0"
                              :options="options"
                              :isfocus="true"
                              :ismultiple="false"
                              size="medium"
                              style="width:190px"
                              allow-create filterable clearable>
                </select-input>
            </div>
            <div class="query">
                批次：<el-input v-model.trim="Batch" placeholder="请输入批次" style="width:191px" size="medium" clearable v-bind:disabled="materialInfo.length>0"></el-input>
            </div>
            <div class="query">
                屏序：<el-input v-model.trim="screenNum" placeholder="请输入屏序" style="width:191px" size="medium" clearable v-bind:disabled="materialInfo.length>0"></el-input>
            </div>
            <div class="query">
                箱号：<el-input v-model.trim="outsideBox" placeholder="请输入箱号" style="width:191px" size="medium" clearable v-bind:disabled="materialInfo.length>0"></el-input>
            </div>
            <div class="query">
                外箱类型：
                <el-select v-model="OutsideType" placeholder="请选择类型" size="medium" allow-create filterable clearable v-bind:disabled="materialInfo.length>0" style="width:190px">
                    <el-option v-for="item in OutsideTypeOptions"
                               :key="item.value"
                               :value="item.value">
                    </el-option>
                </el-select>
            </div>
            <div class="query">
                物品类型：
                <el-select v-model="materialType" placeholder="请选择物品类型" size="medium" allow-create filterable clearable style="width:190px">
                    <el-option v-for="item in materialTypeOptions"
                               :key="item.value"
                               :value="item.value">
                    </el-option>
                </el-select>
            </div>
            <div class="query">
                物料号：
                <el-input v-model.trim="materialNumber"
                          placeholder="请输入物料号"
                          ref="inputRef"
                          style="width:191px"
                          v-on:keyup.enter.native="barScan"
                          size="medium"
                          clearable
                          autofocus
                          id="jiaodian">
                </el-input>
            </div>
            <div class="query">
                包装数量：
                <el-select v-model="quantity" clearable placeholder="请选择数量" size="medium" style="width:190px" id="select-box">
                    <el-option v-for="item in quantityOptions"
                               :key="item"
                               :value="item">
                    </el-option>
                </el-select>
            </div>
            <div style="display:inline-flex">
                <el-button class="affirm2" size="mini" type="info" v-on:click="reset" plain>重置</el-button>
                <el-button class="affirm2" size="mini" type="primary" v-on:click="addMaterial" v-show="packingMaterial" plain>确认</el-button>
            </div>
            <div class="divframe1">
                <el-table ref="multipleTable"
                          v-bind:data="tableDataOne"
                          tooltip-effect="dark"
                          style="width: 100%"
                          @@row-click="singleElectionOne" border v-show="bindone">
                    <el-table-column type="radio"
                                     width="50">
                        <template slot-scope="scope">
                            <el-radio class="radio" v-model="templateSelectionOne" :label="scope.$index">&nbsp;</el-radio>
                        </template>
                    </el-table-column>
                    <el-table-column prop="Material_Name" label="物料名称" width="150"></el-table-column>
                    <el-table-column prop="Quantity" label="数量" width="98"></el-table-column>
                </el-table>
            </div>
            <div class="divframe1">
                <el-table ref="multipleTable"
                          v-bind:data="spc_Description"
                          tooltip-effect="dark"
                          style="width: 100%"
                          @@row-click="singleElection" border v-show="bind">
                    <el-table-column type="selection"
                                     width="55">
                        <template slot-scope="scope">
                            <el-radio class="radio" v-model="templateSelection" :label="scope.$index">&nbsp;</el-radio>
                        </template>
                    </el-table-column>
                    <el-table-column prop="Specification_Description" label="规格描述" width="243"></el-table-column>
                </el-table>
            </div>
            <div class="divframe1">
                <el-table v-bind:data="stockData"
                          height="60"
                          border>
                    <el-table-column prop="orderNum"
                                     label="订单号"
                                     width="100">
                    </el-table-column>
                    <el-table-column prop="stocked"
                                     label="已检验物料"
                                     width="100">
                    </el-table-column>
                    <el-table-column prop="complete"
                                     label="完成率"
                                     width="99">
                    </el-table-column>
                </el-table>
            </div>

        </el-col>
        <el-col :md="16">
            <div style="display:inline-flex">
                <div class="divframe">
                    <el-table v-bind:data="materialInfo"
                              height="259"
                              border>
                        <el-table-column prop="Id"
                                         label="Id"
                                         width="60">
                        </el-table-column>
                        <el-table-column prop="MaterialNumber"
                                         label="物料号"
                                         width="110">
                        </el-table-column>
                        <el-table-column prop="Quantity"
                                         label="数量"
                                         width="80">
                        </el-table-column>
                        <el-table-column prop="ScreenNum"
                                         label="屏序"
                                         width="80">
                        </el-table-column>
                        <el-table-column prop="SPC_Material_Type"
                                         label="物品类型"
                                         width="95">
                        </el-table-column>
                        <el-table-column prop="" label="操作" width="98">
                            <template slot-scope="scope">
                                <div style="display:flex">
                                    <el-button size="mini" type="danger" v-on:click="deleteBoxNum(scope.row)" style="padding:3px" v-show="deleteOutsibox==true">删除</el-button>
                                    <el-button size="mini" type="primary" v-on:click="moveBoxNum(scope.row)" style="padding:3px" v-show="deleteOutsibox==true">移箱</el-button>
                                </div>
                            </template>
                        </el-table-column>
                    </el-table>
                    <span v-if="materialInfo.length!=0">条码数量：{{materialInfo.length}}</span>
                </div>
                <div class="TunnelLabel">
                    <div class="tophei">
                        <div class="tophei_1">
                            <img class="imgicon" src="~/Images/LOGO.jpg" />
                            <h1 class="imgicon1">{{orderNum}}</h1>
                        </div>
                        <div class="tophei_2">
                            <div class="masterBarDiv textCenter">
                                <svg id="imgcode"></svg>
                            </div>
                        </div>
                    </div>
                    <div class="bottomhei ">
                        <div class="mcFrame_top_3">
                            <span>物料描述(DESC)</span>
                        </div>
                        <div class="mcFrame_top_3">
                            <span>{{OutsideType}}</span>
                        </div>
                        <div class="separate">
                            <div class="one">
                                <span>件号/数</span>
                                <span>(SN/TN)</span>
                            </div>
                        </div>
                        <div class="separate1">
                            <div class="two"><span>{{snt}}</span></div>
                        </div>
                    </div>
                    <div class="bottomhei1 ">
                        <div class="mcFrame_top_3">
                            <span>毛重量(G.W.kg)</span>
                        </div>
                        <div class="mcFrame_top_3"><span></span></div>
                        <div class="mcFrame_top_3">
                            <span>净重(N.W.kg)</span>
                        </div>
                        <div class="mcFrame_top_3"><span></span></div>
                    </div>
                </div>
            </div>
            <el-table border v-bind:data="tableData" max-height="200px" style="margin-bottom:10px;width:855px;margin-top:10px;" v-bind:header-cell-style="{background:'#F0F8FF'}">
                <el-table-column prop="MaterialNumber" label="物料编码" width="120"></el-table-column>
                <el-table-column prop="Specifications" label="规格描述" width="314">
                </el-table-column>
                <el-table-column prop="picture" label="图片" width="200">
                    <template slot-scope="scope" class="replaceBlack">
                        <div style="display: inline;">
                            <el-image v-for="url in scope.row.picture.picturejpg_list"
                                      id="img-id"
                                      :key="url"
                                      :preview-src-list="scope.row.picture.picturejpg_list"
                                      :src="url"
                                      style="width:80px;height:65px;margin:2px"
                                      lazy>
                            </el-image>
                            <div class="she" v-for="(url,index) in scope.row.picture.picturepdf_list">
                                <a v-bind:href="`../../Scripts/pdf.js/web/viewer.html?file= ${url}`" target="_blank">查看PDF_{{index+1}}</a>
                            </div>
                        </div>
                    </template>
                </el-table-column>
                <el-table-column prop="draw" label="图纸" width="205">
                    <template slot-scope="scope">
                        <div style="display: inline;">
                            <el-image v-for="(url,index) in scope.row.draw.drawjpg_list"
                                      :key="index"
                                      :preview-src-list="scope.row.draw.drawjpg_list"
                                      :src="url"
                                      style="width:80px;height:65px;margin:2px"
                                      lazy>
                            </el-image>
                            <div class="she" v-for="(url,index) in scope.row.draw.drawpdf_list">
                                <a v-bind:href="`../../Scripts/pdf.js/web/viewer.html?file= ${url}`" target="_blank">查看PDF_{{index+1}}</a>
                            </div>
                        </div>
                    </template>
                </el-table-column>
            </el-table>
            <el-table v-bind:data="oderData" border v-bind:header-cell-style="{background:'#F0F8FF'}" max-height="300px" style="margin-top:10px;">
                <el-table-column prop="OrderNum" label="订单号" width="168">
                </el-table-column>
                <el-table-column prop="SPC_OuterBoxBarcode" label="外箱箱号" width="210">
                    <template slot-scope="scope">
                        <span class="spcolor" type="text" size="middle" v-on:click="packingMaterial==true?addMaterial(scope.row):''">{{scope.row.SPC_OuterBoxBarcode}}</span>
                    </template>
                </el-table-column>
                <el-table-column prop="SNTN" label="件号/数" width="120">
                </el-table-column>
                <el-table-column prop="ScreenNum" label="屏序" width="110">
                </el-table-column>
                <el-table-column property="Batch" label="批次" width="110">
                </el-table-column>
                <el-table-column property="SPC_OuterBox_Type" label="外箱类型" width="120">
                </el-table-column>
            </el-table>
        </el-col>
    </el-main>
    <!--移动外箱弹窗-->
    <el-dialog v-bind:visible.sync="dialogVisible" width="400px">
        <el-form model="uploadForm" ref="numberValidateForm" label-width="110px" class="demo-ruleForm">
            <el-form-item label="外箱号">
                <el-select v-model="outerBox" placeholder="请选择外箱号" size="medium" allow-create filterable clearable>
                    <el-option v-for="item in outerBoxOptions"
                               :key="item.value"
                               :value="item.value">
                    </el-option>
                </el-select>
            </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
            <el-button v-on:click="dialogVisible = false">取 消</el-button>
            <el-button type="primary" v-on:click="saveOuterBox">保存</el-button>
        </span>
    </el-dialog>
    <div>
        <div id="img"></div>
    </div>
</div>
@RenderPage("~/Views/Shared/_SelectInput.cshtml")
@RenderPage("~/Views/Users/_groupSelect.cshtml")
<script>
    var app = new Vue({
        el: "#app",
        data: {
            orderNum: '',         //订单号
            options: [],
            materialNumber: '',    //物料编号
            materialNumOptions: [],
            outMaterialCode: '',  //外箱条码
            quantity: '',        //数量
            quantityOptions: [],
            screenNum: '',        //屏序
            materialInfo: [],
            snt: '',            //SNTN
            Batch: '',  //批次
            OutsideTypeOptions: [{ label: '选项一', value: '备品' }, { label: '选项一', value: '配件' }, { label: '选项一', value: '配件、备品' }],
            OutsideType: '',//类型
            stockData: [],
            materialPreparation: false,//备料权限
            printOutsibox: false,//打印外箱标签权限
            packingMaterial: false,//物料检验
            tableData: [],//图片表格数据
            materialType: '',//物料类型
            materialTypeOptions: [{ label: '选项一', value: '备品' }, { label: '选项一', value: '配件' }, { label: '选项一', value: '其他' }],
            state: '',//用于判断从修改页面进来，就不请求后台重新生成外箱号
            tableDataOne: [],
            templateSelectionOne: [],
            templateRadio1: '',//没有物料号的
            bindone: false,
            spc_Description: [],
            bind: false,
            templateSelection: [],
            spctableData: [],
            visiQuatity: [],//用于存放未去重的数量
            outsideBox: '',//箱号
            dialogVisible: false,//控制弹窗显示
            outerBox: '',//弹框外箱号
            outerBoxOptions: [],
            id: '',
            oderData: [],
            deleteOutsibox:false,//删箱权限
        },
        //获取订单号
        mounted() {
            axios.post('/Packagings/GetOrderList').then(res => {
                this.options = res.data;
            }).catch(err => {
                console.warn("获取选择列表失败")
            });
            var roles = JSON.parse(localStorage.getItem("rigths"))
            if (checkRoles(roles, '物料备料')) {
                this.materialPreparation = true
            } else {
                this.materialPreparation = false
            };
            if (checkRoles(roles, '物料装箱')) {
                this.packingMaterial = true
            } else {
                this.packingMaterial = false
            };
            if (checkRoles(roles, '打印外箱标签')) {
                this.printOutsibox = true
            } else {
                this.printOutsibox = false
            };
            if (checkRoles(roles, '备品配件删除/移箱')) {
                this.deleteOutsibox = true
            } else {
                this.deleteOutsibox = false
            };
            // 若是从修改包装页面进来，就获取地址栏上的外箱号
            let lastUrl = document.referrer;
            if (lastUrl.toLowerCase().indexOf("SPC_Packaging_Modify") == -1) {
                this.outMaterialCode = getUrlParam('outMaterialCode')
                this.orderNum = getUrlParam('orderNum')
                this.screenNum = getUrlParam('ScreenNum')
                this.Batch = getUrlParam('Batch')
                this.OutsideType = getUrlParam('SPCOuterBoxType')
                this.state = getUrlParam('state')
                this.snt = getUrlParam('SNTN')
            };
        },
        methods: {
            //移箱方法
            moveBoxNum(item) {
                this.dialogVisible = true
                this.id = item.Id
                axios.post("/Packagings/getoutbox", { orderNum: this.orderNum }).then(res => {
                    this.outerBoxOptions = res.data
                }).catch(err => {
                    console.log("请求失败")
                })
            },
            saveOuterBox() {
                axios.post("/Packagings/SPC_moveBox", {
                    spc_OuterBoxBarcode: this.outerBox,
                    id: this.id
                }).then(res => {
                    console.log(res.data)
                    if (res.data == "移箱成功") {
                        this.$message({
                            message: "移箱成功",
                            type: 'success'
                        });
                        this.getdata()
                        this.dialogVisible = false
                    } else {
                        this.$message({
                            message: res.data,
                            type: 'warning'
                        });
                    }
                }).catch(err => {
                    console.log("请求失败")
                })
            },
            //删除箱号
            deleteBoxNum(row) {
                console.log(row.Id)
                axios.post("/Packagings/SPC_Packaging_Delete", { id: row.Id }).then(res => {
                    console.log(res.data)
                    if (res.data == "删除成功") {
                        this.$message({
                            message: "删除成功",
                            type: 'success'
                        });
                        this.getdata()
                    } else {
                        this.$message({
                            message: res.data,
                            type: 'warning'
                        });
                    }
                }).catch(err => {
                    console.log("请求失败")
                })
            },
            //重置
            reset() {
                window.location.href = "/Packagings/SPC_Packaging"
            },
            //选择规格描述
            singleElection(row) {
                this.templateSelection = this.tableData.indexOf(row);
                this.templateRadio = row.Specification_Description;
                this.templateRadio = row.Specification_Description;
            },
            //没有物料号的
            singleElectionOne(row) {
                this.templateSelectionOne = this.tableDataOne.indexOf(row);
                this.templateRadio1 = row.Id;
                console.log(this.tableDataOne.indexOf(row))
            },
            //添加物料信息
            addMaterial() {
                if ($("#banzuGroup").val() == "") {
                    this.$message.warning("请选择班组");
                    this.loading = false;
                    return;
                };
                document.getElementById("jiaodian").focus() // 文本框获得焦点
                //物料号为空的检验装箱方式
                if (this.materialNumber == "无") {
                    if (this.orderNum != '' && this.materialNumber != '' && this.templateSelectionOne.length != 0 && this.templateRadio1 != '' && this.screenNum != '' /*&& this.snt != ''*/ && this.Batch != '') {
                        axios.post("/Packagings/SPC_Packaging", {
                            id: this.templateRadio1,
                            orderNumber: this.orderNum,
                            spc_OuterBoxBarcode: this.outMaterialCode == '' ? null : this.outMaterialCode,
                            quantity: 0,
                            screenNum: this.screenNum,
                            batch: this.Batch,
                            sntn: this.snt == '' ? null : this.snt,
                            spc_OuterBox_Type: this.OutsideType,
                            spc_Description: null,
                            materialNumber: "无",
                            materialType: this.materialType,
                            Department: $("#banzuDepartment").val(),
                            Group: $("#banzuGroup").val()
                        }).then(res => {
                            console.log(res.data)
                            if (res.data == "保存成功！") {
                                this.$message({
                                    message: "检验成功！",
                                    type: 'success'
                                });
                                this.materialInfo = [];
                                this.tableData = []
                                this.materialNumber = this.quantity = ''
                                this.getdata()
                                this.getPackagingPlan()
                                this.bindone = false
                                this.templateRadio1 = ''
                                this.templateSelectionOne = []
                            } else {
                                this.$message({
                                    message: "数据保存失败！",
                                    type: 'warning'
                                });
                            }
                        })
                        this.materialNumber = this.quantity = ''
                    } else {
                        this.$message({
                            message: '请选择物料名称！',
                            type: 'warning'
                        });
                    }
                } else {//物料号不为空，判断数量是否相等
                    if (this.visiQuatity.length > 1) {//大于一代表有两个物料号相同
                        if (this.spc_Description.length > 1) {//规格描述信息表大于一代表有两个物料号相同并且数量也相同，需要传描述给后端
                            if (this.orderNum != '' && this.materialNumber != '' && this.templateSelection.length != 0 && this.templateRadio != '' && this.screenNum != '' /*&& this.snt != ''*/ && this.Batch != '' && this.quantity != '' && this.materialType != '') {
                                axios.post("/Packagings/SPC_Packaging", {
                                    id: 0,
                                    orderNumber: this.orderNum,
                                    spc_OuterBoxBarcode: this.outMaterialCode == '' ? null : this.outMaterialCode,
                                    quantity: this.quantity,
                                    screenNum: this.screenNum,
                                    batch: this.Batch,
                                    sntn: this.snt == '' ? null : this.snt,
                                    spc_OuterBox_Type: this.OutsideType,
                                    spc_Description: this.templateRadio,
                                    materialNumber: this.materialNumber,
                                    materialType: this.materialType,
                                    Department: $("#banzuDepartment").val(),
                                    Group: $("#banzuGroup").val()
                                }).then(res => {
                                    console.log(res.data)
                                    if (res.data == "检验成功！") {
                                        this.$message({
                                            message: res.data,
                                            type: 'success'
                                        });
                                        this.getdata()
                                        this.getPackagingPlan()
                                        this.bind = false
                                        this.templateSelection = this.tableData = this.visiQuatity = this.spc_Description = this.spctableData = []
                                        this.materialNumber = this.quantity = this.templateRadio = ''
                                    } else {
                                        this.$message({
                                            message: "检验失败！",
                                            type: 'warning'
                                        });
                                    }
                                })
                            } else {
                                this.$message({
                                    message: '请选择物料描述！',
                                    type: 'warning'
                                });
                            }
                        } else {//否则物料号相同，数量不相同
                            this.materialPackaging()
                        }
                    } else {//物料号是唯一的
                        this.materialPackaging()
                    }
                }
            },
            //物料号相同，数量不相同的检验装箱方式
            materialPackaging() {
                if (this.orderNum != '' && this.materialNumber != '' && this.screenNum != '' /*&& this.snt != ''*/ && this.Batch != '' && this.quantity != '' && this.materialType != '') {
                    axios.post("/Packagings/SPC_Packaging", {
                        id: 0,
                        orderNumber: this.orderNum,
                        spc_OuterBoxBarcode: this.outMaterialCode == '' ? null : this.outMaterialCode,
                        quantity: this.quantity,
                        screenNum: this.screenNum,
                        batch: this.Batch,
                        sntn: this.snt == '' ? null : this.snt,
                        spc_OuterBox_Type: this.OutsideType,
                        spc_Description: null,
                        materialNumber: this.materialNumber,
                        materialType: this.materialType,
                        Department: $("#banzuDepartment").val(),
                        Group: $("#banzuGroup").val()
                    }).then(res => {
                        console.log(res.data)
                        if (res.data == "检验成功！") {
                            this.$message({
                                message: res.data,
                                type: 'success'
                            });
                            this.getdata()
                            this.getPackagingPlan()
                            this.quantity = this.materialNumber = ''
                            $("#select-box").css('border', '');
                        } else {
                            this.$message({
                                message: "检验失败！",
                                type: 'warning'
                            });
                        }
                    })
                } else {
                    this.$message({
                        message: '请填写完整在确认！',
                        type: 'warning'
                    });
                }
            },
            //获取条码信息
            getOutBoxNum() {
                if (this.state != "无") {
                    axios.post("/Packagings/createOutBoxNum", {
                        orderNumber: this.orderNum,
                        screenNum: this.screenNum,
                        batch: this.Batch,
                        outsideBox: this.outsideBox
                    }).then(res => {
                        console.log(res.data)
                        if (res.data.res == "外箱号已存在！" && res.data.OuterBoxBarCodeNum != "") {
                            var comfirm = confirm(`${res.data.OuterBoxBarCodeNum}外箱号已存在，是否继续往该箱增加物料?`)
                            if (comfirm) {
                                this.outMaterialCode = res.data.OuterBoxBarCodeNum;
                                let str = res.data.OuterBoxBarCodeNum;//截取后2位
                                let str2 = str.substr(str.length - 2)
                                if (str2[0] == 0) {
                                    this.snt = str2[1]
                                } else {
                                    this.snt = str2
                                }
                                this.getdata()
                                this.OutsideType = res.data.type
                            } else {
                            }
                        } else if (res.data.res == "外箱号不存在！" && res.data.OuterBoxBarCodeNum != "") {
                            this.outMaterialCode = res.data.OuterBoxBarCodeNum;
                            let str = res.data.OuterBoxBarCodeNum;//截取后2位
                            let str2 = str.substr(str.length - 2)
                            if (str2[0] == 0) {
                                this.snt = str2[1]
                            } else {
                                this.snt = str2
                            }
                        } else {
                            this.$message({
                                message: res.data,
                                type: 'warning',
                                duration: 4000,
                            });
                        }
                    })
                }
            },
            //使用后端返回的条码号生成条形码
            setmasterBarDiv() {
                JsBarcode("#imgcode", this.outMaterialCode, {
                    height: 60,                    //条形码的高度
                    format: "CODE128",            //选择要使用的条形码类型
                    font: "monospace",           //设置文本字体
                    textAlign: "center",        //设置文本的水平对齐方式
                    textMargin: 0,             //设置条形码和文本之间的间距
                    fontSize: 26,             //设置文本的大小
                    lineColor: "#000",       //条形码颜色
                    margin: 0,              //设置条形码周围的空白边距
                    marginTop: 0
                });
            },
            //找出已装箱物料信息
            getdata() {
                axios.post("/Packagings/getBoxedMaterial", {
                    OutsideBarcode: this.outMaterialCode
                }).then(res => {
                    this.materialInfo = res.data
                }).catch(err => {
                    console.log("请求失败")
                })
            },
            //找出装箱进度(条件根据订单号、屏序、批次)
            getPackagingPlan() {
                axios.post("/Packagings/SPC_Containerised", {
                    orderNumber: this.orderNum,
                    batch: this.Batch,
                    screenNum: this.screenNum
                }).then(res => {
                    console.log(res.data)
                    this.stockData = res.data
                }).catch(err => {
                    console.log("请求失败")
                })
            },
            //获取右边表格信息（物料编码、描述、图片、图纸）
            getPictrueInfo() {
                this.tableData = [];
                if (this.materialNumber != "无" && this.materialNumber.length > 8) {
                    axios.post("/Packagings/SPC_Display", {
                        materialNumber: this.materialNumber,
                        productName: null
                    }).then(res => {
                        this.loading = false
                        console.log(res.data)
                        this.tableData = res.data
                    }).catch(err => {
                        console.log("请求失败")
                        this.loading = false
                    })
                }
            },
            barScan() {
                //根据订单号、物料号、屏序、批次、物料类型找出物料号对应的数量
                if (this.materialNumber != "无" && this.materialNumber != '' && this.materialType != '') {
                    this.quantityOptions = [];
                    axios.post("/Packagings/GetMaterialNumberByQuantity", {
                        ordernumber: this.orderNum,
                        materialNumber: this.materialNumber,
                        screenNum: this.screenNum,
                        batch: this.Batch,
                        materialType: this.materialType
                    }).then(res => {
                        console.log(res.data)
                        if (res.data == "没找到物料号对应的数量！") {
                            this.$message({
                                showClose: true,
                                message: '找不到物料号对应的数量',
                                type: 'warning'
                            });
                        } else if (res.data == "此物料已检验！") {
                            this.$message({
                                message: '此物料已检验！',
                                type: 'warning',
                                duration: 4000,
                            });
                        } else if (res.data.length > 0) {
                            let arr = [];
                            let list = [];
                            if (res.data.length == 1) {
                                this.quantity = res.data[0]
                            }
                            else {
                                for (let item in res.data) {
                                    arr.push(res.data[item].Quantity)
                                    list.push(res.data[item])
                                }
                                this.visiQuatity = arr
                                var newArr = Array.from(new Set(arr));//去重数量
                                if (newArr.length == 1) {
                                    this.quantity = newArr[0]
                                } else {
                                    this.quantityOptions = newArr;
                                }
                                this.spctableData = list
                                if (this.quantityOptions.length > 1) {
                                    $("#select-box").css({ 'border': '1px solid #FF0000', 'background': '#fff' })
                                } else {
                                    $("#select-box").css('border', '');
                                }
                            }
                        }
                    })
                }
                this.getPictrueInfo()
            }
        },
        watch: {
            quantity() {
                if (this.quantity != '') {
                    console.log(this.spctableData)
                    for (let item in this.spctableData) {                       
                        if (this.quantity == this.spctableData[item].Quantity) {                          
                            this.spc_Description.push(this.spctableData[item])
                            if (this.spc_Description.length > 1) {
                                this.bind = true
                            } else {
                                this.bind = false
                            }                           
                        } 
                    }
                } else {
                    this.spc_Description = []
                    this.bind = false
                }
            },
            materialNumber() {
                //根据订单号、物料号、屏序、批次、物料类型找出物料号对应的数量
                if (this.materialNumber == "无" && this.materialNumber != '' && this.materialType != '') {
                    axios.post("/Packagings/GetMaterialNumberByQuantity", {
                        ordernumber: this.orderNum,
                        materialNumber: "无",
                        screenNum: this.screenNum,
                        batch: this.Batch,
                        materialType: this.materialType
                    }).then(res => {
                        console.log(res.data)
                        if (res.data == "找不到没有物料号的记录") {
                            this.$message({
                                showClose: true,
                                message: res.data,
                                type: 'warning'
                            });
                        } else if (res.data.length > 0) {
                            this.tableDataOne = res.data
                            this.bindone = true
                        }
                    })
                };
                if (this.materialNumber != "无" && this.materialNumber != '') {
                    axios.post("/Packagings/checkOrdernum", {
                        MaterialNumber: this.materialNumber,
                        flag: true
                    }).then(res => {
                        console.log(res.data)
                        if (res.data.length > 1) {
                            this.$message({
                                showClose: true,
                                duration: 10000,
                                message: "此物料号对应有多个订单号，请认真核对您选的订单号是否正确",
                                type: 'warning'
                            });
                        }
                    }).catch(err => {
                        console.warn("请求失败！");
                    })
                };
            },
            outsideBox() {
                //获取条码号
                if (this.orderNum != '' && this.screenNum != '' && this.Batch != '' && this.outsideBox != '') {
                    this.getOutBoxNum();
                }
                //找出装箱进度(条件根据订单号、屏序、批次)
                if (this.orderNum != '' && this.Batch != '' && this.screenNum != '') {
                    this.getPackagingPlan()
                } else {
                    this.stockData = [];
                    this.snt = '';
                    this.state = ''
                }
                if (this.outsideBox == '') {
                    this.snt = '';
                    $("#imgcode").empty();
                }
            },
            outMaterialCode() {
                if (this.outMaterialCode != "") {
                    app.setmasterBarDiv(this.outMaterialCode);
                };
                if (this.outMaterialCode != '' && this.state == '无') {//找出此外箱已装箱的物料
                    this.getdata()
                }
            },
            screenNum() {
                if (this.orderNum != '' && this.Batch != '' && this.screenNum != '') {
                    this.getPackagingPlan()
                }
            },
            orderNum() {
                if (this.orderNum != '') {
                    axios.post("/Packagings/getOrderNumInfo", {
                        orderNum: this.orderNum
                    }).then(res => {
                        console.log(res.data)
                        this.oderData=res.data
                        })

                }

            }
        }
    })
    // 解析地址栏参数
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return decodeURI(r[2]); return '';
    }
    //检测权限
    function checkRoles(list, roleName) {
        var flag = false
        if (list && roleName) {
            for (let item in list) {
                if (list[item] == roleName) {
                    flag = true
                }
            }
        }
        return flag
    }
</script>